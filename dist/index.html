<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couchman Companies QSR Navigator - Restaurant Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="updated-checklist-system.js"></script>
    <script src="basecamp-integration.js"></script>
    <script src="basecamp-integration-fix.js"></script>
    <script>
        // Ensure BasecampIntegration is available
        window.addEventListener('DOMContentLoaded', () => {
            if (!window.BasecampIntegration) {
                console.error('BasecampIntegration not loaded!');
            } else {
                console.log('BasecampIntegration loaded successfully');
            }
        });
    </script>
    <script type="text/javascript">
        (function(){
            emailjs.init("YOUR_PUBLIC_KEY"); // You need to replace this with your EmailJS public key
        })();
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
            color: #2c3e50;
        }

        .logo h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: #3498db;
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
        }
        
        .location-selector {
            display: flex;
            align-items: center;
            background: #ecf0f1;
            padding: 8px 16px;
            border-radius: 25px;
        }
        
        .location-dropdown {
            padding: 5px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            margin: 100px auto;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header i {
            font-size: 3rem;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .auth-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        /* START OFFICE ADMINISTRATION SPECIFIC STYLES */
        .office-admin-schedule-cell {
            vertical-align: top;
            min-height: 80px;
            padding: 4px;
        }
        
        .office-entries {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .office-entry {
            display: flex;
            gap: 2px;
            align-items: center;
            background: #f8f9fa;
            padding: 2px;
            border-radius: 3px;
        }
        
        .office-location-select {
            font-size: 11px;
            padding: 2px;
            width: 100px;
        }
        
        .office-hours-input {
            font-size: 11px;
            padding: 2px;
            width: 50px;
        }
        
        .add-office-entry {
            font-size: 11px;
            padding: 2px 6px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            width: 100%;
            margin-top: 2px;
        }
        
        .add-office-entry:hover {
            background: #218838;
        }
        
        .remove-office-entry {
            font-size: 10px;
            padding: 1px 4px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            line-height: 1;
        }
        
        .remove-office-entry:hover {
            background: #c82333;
        }
        /* END OFFICE ADMINISTRATION SPECIFIC STYLES */

        /* Universal button styles - works on all devices */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px; /* WCAG touch target standard */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #3498db;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        /* Checklist layout - responsive by default */
        .checklist-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        #submitChecklistBtn {
            background: #e67e22;
            position: relative;
            z-index: 10;
        }
        
        #submitChecklistBtn:hover {
            background: #d35400;
        }
        
        #submitChecklistBtn:active {
            background: #d35400;
            transform: scale(0.98);
        }

        .error-message, .success-message {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .error-message {
            background: #e74c3c;
            color: white;
        }

        .success-message {
            background: #27ae60;
            color: white;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: #ecf0f1;
            color: #2c3e50;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            /* Improve click responsiveness */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #ecf0f1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .inventory-table th {
            background: #f8f9fa;
            color: #2c3e50;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .inventory-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        .inventory-table tr:hover {
            background: #f8f9fa;
        }

        .inventory-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #dfe6e9;
            border-radius: 5px;
            text-align: center;
            font-weight: 600;
        }

        .inventory-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .order-qty {
            font-weight: 700;
            color: #e74c3c;
            font-size: 1.1rem;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th {
            background: #f8f9fa;
            color: #2c3e50;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .users-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        .role-badge {
            background: #27ae60; /* Default green */
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        /* Role-specific colors */
        .role-badge-super_admin {
            background: #8b5cf6; /* Purple */
        }
        
        .role-badge-admin {
            background: #3b82f6; /* Blue */
        }
        
        .role-badge-general_manager {
            background: #10b981; /* Emerald */
        }
        
        .role-badge-manager {
            background: #f59e0b; /* Amber */
        }
        
        .role-badge-staff {
            background: #6b7280; /* Gray */
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #e74c3c;
        }

        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .tabs {
                justify-content: center;
            }
            
            /* Make budget cards stack nicely on mobile */
            .sales-section > div[style*="grid"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            .sales-section div[style*="font-size: 1.3rem"] {
                font-size: 1.1rem !important;
            }
            
            /* Mobile Schedule Improvements */
            
            /* Week Navigation - Stack vertically on mobile */
            .schedule-section .card-header > div[style*="flex"] {
                flex-direction: column !important;
                gap: 15px !important;
            }
            
            /* Advanced Week Features - Better mobile layout */
            .schedule-section div[style*="background: #e9ecef"] {
                flex-direction: column !important;
                gap: 15px !important;
                align-items: stretch !important;
            }
            
            .schedule-section div[style*="background: #e9ecef"] > div {
                justify-content: center !important;
                flex-wrap: wrap !important;
            }
            
            /* Week dropdown full width on mobile */
            #weekDropdown {
                min-width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Schedule buttons stack better */
            .schedule-section .card-header div[style*="display: flex; gap: 10px"] {
                justify-content: center !important;
                flex-wrap: wrap !important;
            }
            
            /* FIXED MOBILE SCHEDULE LAYOUT */
            /* Container must allow horizontal scrolling */
            .schedule-container {
                width: 100% !important;
                max-width: 100vw !important;
                padding: 10px 5px !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                position: relative !important;
                margin: 0 !important;
            }
            
            /* Table with fixed width for proper scrolling */
            .schedule-table {
                width: 1400px !important;  /* Fixed total width */
                min-width: 1400px !important;
                table-layout: fixed !important;
                font-size: 11px !important;
                border-collapse: collapse !important;
            }
            
            /* Fixed column widths for all columns */
            .schedule-table th,
            .schedule-table td {
                padding: 6px 4px !important;
                text-align: center !important;
                vertical-align: middle !important;
                border: 1px solid #ddd !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            /* Employee name column - sticky */
            .schedule-table th:first-child,
            .schedule-table td:first-child {
                width: 140px !important;
                min-width: 140px !important;
                max-width: 140px !important;
                position: sticky !important;
                left: 0 !important;
                background: white !important;
                z-index: 11 !important;
                box-shadow: 2px 0 4px rgba(0,0,0,0.1) !important;
                text-align: left !important;
                padding-left: 5px !important;
            }
            
            /* Role column */
            .schedule-table th:nth-child(2),
            .schedule-table td:nth-child(2) {
                width: 90px !important;
                min-width: 90px !important;
                max-width: 90px !important;
            }
            
            /* Day columns - Monday through Sunday */
            .schedule-table th:nth-child(3),
            .schedule-table td:nth-child(3),
            .schedule-table th:nth-child(4),
            .schedule-table td:nth-child(4),
            .schedule-table th:nth-child(5),
            .schedule-table td:nth-child(5),
            .schedule-table th:nth-child(6),
            .schedule-table td:nth-child(6),
            .schedule-table th:nth-child(7),
            .schedule-table td:nth-child(7),
            .schedule-table th:nth-child(8),
            .schedule-table td:nth-child(8),
            .schedule-table th:nth-child(9),
            .schedule-table td:nth-child(9) {
                width: 140px !important;
                min-width: 140px !important;
                max-width: 140px !important;
            }
            
            /* Total column */
            .schedule-table th:last-child,
            .schedule-table td:last-child {
                width: 90px !important;
                min-width: 90px !important;
                max-width: 90px !important;
                font-weight: bold !important;
                background: #f9f9f9 !important;
            }
            
            /* Header styling */
            .schedule-table thead th {
                background: #f8f9fa !important;
                font-weight: bold !important;
                font-size: 12px !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 10 !important;
            }
            
            .schedule-table th:first-child {
                z-index: 12 !important;
            }
            
            /* Input and select sizing */
            .schedule-table select {
                width: calc(100% - 4px) !important;
                max-width: 130px !important;
                font-size: 10px !important;
                padding: 3px 2px !important;
                margin: 1px !important;
            }
            
            .schedule-table input {
                width: calc(100% - 4px) !important;
                max-width: 130px !important;
                font-size: 10px !important;
                padding: 3px 2px !important;
                margin: 1px !important;
            }
            
            /* Employee name select */
            .schedule-table td:first-child select {
                width: 130px !important;
                font-size: 10px !important;
            }
            
            /* Shift selects */
            .shift-select {
                width: 130px !important;
                font-size: 10px !important;
            }
            
            /* Custom shift inputs */
            .custom-shift {
                width: 130px !important;
                font-size: 10px !important;
            }
            
            /* Daily sales inputs */
            .daily-sales {
                width: 60px !important;
                font-size: 10px !important;
                padding: 3px !important;
            }
            
            /* Mobile scrolling indicator */
            .schedule-container::after {
                content: "← Swipe to see more days →";
                display: block;
                text-align: center;
                font-size: 0.8rem;
                color: #666;
                margin-top: 10px;
                font-style: italic;
                padding: 5px;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.9), transparent);
            }
            
            /* Ensure schedule section doesn't overflow viewport */
            #scheduleSection {
                width: 100% !important;
                max-width: 100vw !important;
                overflow-x: hidden !important;
                padding: 0 !important;
            }
            
            #scheduleSection .card {
                margin: 0 !important;
                border-radius: 0 !important;
            }
            
            /* Visual scroll indicators */
            .schedule-container {
                box-shadow: inset -10px 0 10px -10px rgba(0,0,0,0.2),
                           inset 10px 0 10px -10px rgba(0,0,0,0.2);
            }
            
            /* Touch-friendly mobile table */
            .schedule-table th,
            .schedule-table td {
                touch-action: manipulation !important;
            }
            
            /* Better tap targets for mobile */
            .schedule-input,
            .employee-select,
            .daily-sales {
                min-height: 36px !important;
                touch-action: manipulation !important;
            }
            
            /* Mobile schedule container with better scroll behavior */
            .schedule-container {
                scroll-behavior: smooth !important;
                scrollbar-width: thin !important;
            }
            
            /* Hide scrollbar on mobile for cleaner look */
            .schedule-container::-webkit-scrollbar {
                height: 3px !important;
            }
            
            .schedule-container::-webkit-scrollbar-track {
                background: #f1f1f1 !important;
            }
            
            .schedule-container::-webkit-scrollbar-thumb {
                background: #c1c1c1 !important;
                border-radius: 3px !important;
            }
            
            /* Modal improvements for mobile */
            .modal-content {
                margin: 5% auto !important;
                width: 95% !important;
                max-width: 95% !important;
            }
            
            /* Employee modal mobile improvements */
            #employeeModal .modal-content {
                max-height: 90vh !important;
                overflow-y: auto !important;
            }
            
            /* Notes modal mobile improvements */
            #scheduleNotesModal textarea {
                min-height: 120px !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            /* Adjust button spacing for mobile */
            .btn {
                margin: 4px;
            }
            
            /* Week display text smaller on mobile */
            #currentWeekDisplay {
                font-size: 1rem !important;
            }
            
            #weekDateRange {
                font-size: 0.8rem !important;
            }
        }
        
        /* Extra small screens (phones in portrait) */
        @media (max-width: 480px) {
            /* Even more compact schedule navigation */
            .schedule-section .card-header {
                padding: 15px 10px !important;
            }
            
            /* Stack week navigation vertically */
            .schedule-section div[style*="background: #f8f9fa"] {
                padding: 10px !important;
            }
            
            .schedule-section div[style*="background: #e9ecef"] {
                padding: 8px !important;
            }
            
            /* Keep buttons touch-friendly on small screens */
            .btn {
                font-size: 0.85rem;
            }
            
            /* Smaller schedule table for tiny screens */
            .schedule-table {
                font-size: 0.7rem !important;
            }
            
            .schedule-table th,
            .schedule-table td {
                padding: 4px 2px !important;
                min-width: 70px !important;
            }
            
            .schedule-input,
            .employee-select {
                width: 60px !important;
                font-size: 0.7rem !important;
            }
            
            /* Special handling for name column on very small screens */
            .schedule-table td:first-child select {
                width: 100px !important;
                min-width: 90px !important;
                font-size: 10px !important;
            }
            
            .daily-sales {
                width: 50px !important;
                font-size: 0.7rem !important;
            }
            
            /* Week display more compact */
            #currentWeekDisplay {
                font-size: 0.9rem !important;
            }
            
            #weekDateRange {
                font-size: 0.75rem !important;
            }
        }
        
        /* Schedule Table Styles */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .schedule-table th {
            background: #f8f9fa;
            color: #2c3e50;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .schedule-table td {
            padding: 8px;
            border: 1px solid #ecf0f1;
            text-align: center;
        }
        
        .schedule-input {
            width: 90px;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .schedule-input:focus {
            outline: none;
            border-color: #3498db;
            background: #f8f9ff;
        }
        
        .daily-total {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .budget-display {
            font-size: 0.9rem;
            color: #27ae60;
            font-weight: 600;
        }
        
        .over-budget {
            color: #e74c3c;
        }
        
        .under-budget {
            color: #27ae60;
        }
        
        .schedule-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Fix modal scrolling for employee management */
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Enhanced Print styles for schedule */
        @media print {
            /* Landscape orientation with optimal margins */
            @page {
                size: landscape;
                margin: 0.4in 0.3in;
            }

            /* Hide authentication section and show main app */
            #authContainer {
                display: none !important;
            }
            
            #mainApp {
                display: block !important;
            }
            
            /* Special handling for Office Administration print */
            body.printing-office-admin #mainApp {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            body.printing-office-admin #mainApp.hidden {
                display: block !important;
            }
            
            body.printing-office-admin .office-admin-schedule {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Override hidden class during Office Admin print */
            body.printing-office-admin .hidden {
                display: block !important;
                visibility: visible !important;
            }
            
            body.printing-office-admin #scheduleSection.hidden {
                display: block !important;
            }
            
            /* Force all schedule elements visible */
            body.printing-office-admin #scheduleSection,
            body.printing-office-admin #scheduleSection * {
                display: revert !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Except hide specific elements */
            body.printing-office-admin .btn,
            body.printing-office-admin button,
            body.printing-office-admin .card-header {
                display: none !important;
            }
            
            /* Hide everything except schedule content */
            body > *:not(#mainApp):not(.container) {
                display: none !important;
            }
            
            .nav-tabs,
            .sidebar,
            .tabs,
            .tab-content > div:not(#scheduleSection),
            .card:not(:has(.schedule-container)),
            .card-header,
            .btn,
            button,
            #inventorySection,
            #usersSection,
            #settingsSection {
                display: none !important;
            }

            /* Make schedule section prominent */
            #scheduleSection {
                display: block !important;
                page-break-inside: avoid;
                margin: 0 !important;
                padding: 0 !important;
                visibility: visible !important;
            }
            
            /* Force schedule section visible for Office Admin */
            body.printing-office-admin #scheduleSection.tab-content {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Show card inside schedule section */
            body.printing-office-admin #scheduleSection .card {
                display: block !important;
                visibility: visible !important;
            }
            
            /* Ensure the header is visible but compact */
            .header {
                display: flex !important;
                padding: 10px !important;
                margin-bottom: 10px !important;
            }
            
            /* Hide user info and logout in print */
            .user-info {
                display: none !important;
            }

            .schedule-container {
                padding: 0 !important;
                overflow: visible !important;
                display: block !important;
                visibility: visible !important;
            }
            
            /* Ensure schedule container is visible for Office Admin */
            body.printing-office-admin .schedule-container {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            /* Enhanced schedule table formatting */
            .schedule-table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 9px !important;
                margin: 0 !important;
                page-break-inside: auto;
                font-family: 'Arial', sans-serif !important;
                display: table !important;
                visibility: visible !important;
            }
            
            /* Ensure table elements are visible */
            .schedule-table thead {
                display: table-header-group !important;
                visibility: visible !important;
            }
            
            .schedule-table tbody {
                display: table-row-group !important;
                visibility: visible !important;
            }
            
            .schedule-table tfoot {
                display: table-footer-group !important;
                visibility: visible !important;
            }
            
            .schedule-table tr {
                display: table-row !important;
                visibility: visible !important;
            }
            
            .schedule-table td,
            .schedule-table th {
                display: table-cell !important;
                visibility: visible !important;
            }

            .schedule-table th,
            .schedule-table td {
                border: 1px solid #333 !important;
                padding: 3px 2px !important;
                text-align: center !important;
                vertical-align: middle !important;
                font-size: 8px !important;
                line-height: 1.1 !important;
            }

            /* Header styling */
            .schedule-table th {
                background: #e8e8e8 !important;
                font-weight: bold !important;
                font-size: 9px !important;
            }

            /* Hide role column for more space */
            .schedule-table th:nth-child(2),
            .schedule-table td:nth-child(2),
            .print-role-cell {
                display: none !important;
            }

            /* Optimized column widths */
            .schedule-table th:first-child,
            .schedule-table td:first-child {
                width: 16% !important;
                text-align: left !important;
                font-size: 7px !important;
                padding-left: 4px !important;
            }

            .schedule-table th:nth-child(n+3):nth-child(-n+9),
            .schedule-table td:nth-child(n+3):nth-child(-n+9) {
                width: 12% !important;
            }

            .schedule-table th:last-child,
            .schedule-table td:last-child {
                width: 12% !important;
                font-weight: bold !important;
            }

            /* Footer rows styling */
            .schedule-table tfoot td {
                font-weight: bold !important;
                background: #f5f5f5 !important;
                border-top: 2px solid #333 !important;
            }

            .schedule-table tfoot td:first-child {
                text-align: left !important;
                font-size: 8px !important;
                padding-left: 4px !important;
            }

            .schedule-table tfoot input.daily-sales {
                width: 45px !important;
                font-size: 7px !important;
                padding: 1px !important;
                border: 1px solid #666 !important;
                text-align: center !important;
                background: white !important;
                font-weight: bold !important;
            }

            /* Print header */
            .schedule-container::before {
                content: "WEEKLY SCHEDULE - OPTIMUS PRIME COST - Week of " attr(data-week-date);
                display: block;
                text-align: center;
                font-size: 14px;
                font-weight: bold;
                margin-bottom: 15px;
                padding: 8px;
                border: 2px solid #333;
                background: #f0f0f0;
            }

            /* Ensure clean page breaks */
            .schedule-table thead {
                display: table-header-group;
            }

            .schedule-table tfoot {
                display: table-footer-group;
            }

            /* Remove all interactive elements */
            .schedule-input,
            select,
            input:not(.daily-sales) {
                display: none !important;
            }

            /* Show only the selected values for shifts */
            .schedule-table td {
                position: relative;
            }

            /* Print current date and time */
            .schedule-container::after {
                content: "Printed: " attr(data-print-date);
                display: block;
                text-align: right;
                font-size: 8px;
                margin-top: 10px;
                color: #666;
            }
            
            /* Print values styling */
            .print-value {
                display: inline !important;
                font-size: 8px !important;
                font-weight: normal !important;
            }
            
            /* START OFFICE ADMINISTRATION PRINT STYLES */
            /* Office Administration specific print styles - 15 rows on one page */
            .office-admin-schedule {
                display: block !important;
                visibility: visible !important;
            }
            
            .office-admin-schedule #scheduleTable {
                font-size: 7px !important;
                table-layout: fixed !important;
                width: 100% !important;
                display: table !important;
                visibility: visible !important;
            }
            
            .office-admin-schedule .schedule-table {
                table-layout: fixed !important;
                width: 100% !important;
                display: table !important;
                visibility: visible !important;
            }
            
            .office-admin-schedule .schedule-table td,
            .office-admin-schedule .schedule-table th {
                padding: 1px !important;
                font-size: 7px !important;
                height: auto !important;
                line-height: 1.0 !important;
                border: 0.5px solid #ccc !important;
            }
            
            /* Office Admin specific cells */
            .office-admin-schedule .office-admin-schedule-cell {
                padding: 1px !important;
                vertical-align: top !important;
                font-size: 6px !important;
            }
            
            .office-admin-schedule .office-entries {
                gap: 0 !important;
                margin: 0 !important;
            }
            
            .office-admin-schedule .office-entry {
                padding: 0 !important;
                background: none !important;
                margin: 0 !important;
                display: block !important;
                line-height: 1.0 !important;
            }
            
            /* Hide interactive elements */
            .office-admin-schedule .add-office-entry,
            .office-admin-schedule .remove-office-entry {
                display: none !important;
            }
            
            /* Show only values for location and hours */
            .office-admin-schedule .office-location-select,
            .office-admin-schedule .office-hours-input,
            .office-admin-schedule .remove-office-entry {
                display: none !important;
            }
            
            /* Show print values */
            .office-admin-schedule .office-print-value {
                display: inline !important;
                font-size: 6px !important;
                line-height: 1.0;
            }
            
            /* Optimize column widths for 15 rows */
            .office-admin-schedule .schedule-table th:first-child,
            .office-admin-schedule .schedule-table td:first-child {
                width: 15% !important;
                font-size: 7px !important;
                padding: 1px 2px !important;
            }
            
            .office-admin-schedule .schedule-table th:nth-child(2),
            .office-admin-schedule .schedule-table td:nth-child(2) {
                width: 5% !important;
                font-size: 6px !important;
                text-align: center !important;
            }
            
            /* Day columns - equal width and smaller */
            .office-admin-schedule .schedule-table th:nth-child(n+3):nth-child(-n+9),
            .office-admin-schedule .schedule-table td:nth-child(n+3):nth-child(-n+9) {
                width: 10.5% !important;
                font-size: 6px !important;
            }
            
            /* Total column */
            .office-admin-schedule .schedule-table th:last-child,
            .office-admin-schedule .schedule-table td:last-child {
                width: 7% !important;
                font-weight: bold !important;
                font-size: 8px !important;
                text-align: center !important;
                background-color: #f5f5f5 !important;
            }
            
            /* Show total hours in print */
            .office-admin-schedule .weekly-total {
                display: table-cell !important;
                font-weight: bold !important;
                color: #000 !important;
                font-size: 8px !important;
                text-align: center !important;
                visibility: visible !important;
            }
            
            /* Ensure all cells in Office Admin are visible */
            body.printing-office-admin .office-admin-schedule td,
            body.printing-office-admin .office-admin-schedule th {
                display: table-cell !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Force single page with aggressive scaling */
            .office-admin-schedule .schedule-container {
                transform: scale(0.80);
                transform-origin: top left;
                width: 125%; /* 100% / 0.80 to compensate for scale */
                max-width: 125%;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Reduce header/footer margins for Office Admin */
            .office-admin-schedule .card {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .office-admin-schedule .schedule-header {
                margin: 0 !important;
                padding: 5px !important;
            }
            
            /* Ensure dropdowns show selected value only */
            .office-admin-schedule select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                border: none !important;
                background: none !important;
                font-size: 7px !important;
                padding: 0 !important;
            }
            
            /* Hide footer and budget info for Office Admin print */
            .office-admin-schedule .schedule-footer,
            .office-admin-schedule .budget-comparison,
            .office-admin-schedule .schedule-actions,
            .office-admin-schedule .week-navigation {
                display: none !important;
            }
            
            /* Ensure Office Admin schedule table and rows are visible */
            body.printing-office-admin .office-admin-schedule #scheduleTable,
            body.printing-office-admin .office-admin-schedule .schedule-table {
                display: table !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            body.printing-office-admin .office-admin-schedule tbody tr {
                display: table-row !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Force entire schedule hierarchy visible */
            body.printing-office-admin #mainApp,
            body.printing-office-admin #scheduleSection,
            body.printing-office-admin .card,
            body.printing-office-admin .schedule-container,
            body.printing-office-admin .schedule-table {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            body.printing-office-admin .schedule-table {
                display: table !important;
            }
            
            /* Ensure schedule header is compact */
            .office-admin-schedule .schedule-header h3 {
                margin: 5px 0 !important;
                font-size: 14px !important;
            }
            
            /* Ensure empty cells show dash */
            .office-admin-schedule td:empty::after {
                content: "-";
                color: #999;
            }
            /* END OFFICE ADMINISTRATION PRINT STYLES */
        }
        
        /* Global click responsiveness improvements */
        button, select, input[type="button"], input[type="submit"], 
        .tab, .inventory-tab, .checklist-tab {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* Prevent double-click text selection on interactive elements */
        .tab, .inventory-tab, .checklist-tab, button {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Ensure dropdowns don't close on single click */
        select:focus {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }
        
        /* ===== COMPREHENSIVE MOBILE RESPONSIVE STYLES ===== */
        
        /* Tablets and below */
        @media (max-width: 1024px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            /* Make tables horizontally scrollable */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
        }
        
        
        /* Mobile devices */
        @media (max-width: 768px) {
            /* Header adjustments */
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .logo h1 {
                font-size: 1.4rem;
            }
            
            .logo i {
                font-size: 2rem;
            }
            
            .user-info {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            
            /* Ensure user-info section is visible on mobile */
            .user-info {
                display: flex !important;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
                width: 100%;
            }
            
            /* Force location selector to show on mobile when it has content */
            #locationSelector:not(.hidden) {
                display: flex !important;
                width: 100%;
                justify-content: center;
                visibility: visible !important;
            }
            
            /* Only hide if explicitly has hidden class */
            #locationSelector.hidden {
                display: none !important;
            }
            
            .location-dropdown {
                width: 100%;
                max-width: 300px;
            }
            
            /* Navigation tabs */
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                gap: 5px;
                padding: 10px 0;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                flex: 0 0 auto;
                white-space: nowrap;
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .tab i {
                display: none; /* Hide icons on mobile to save space */
            }
            
            /* Forms */
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 5px;
            }
            
            input[type="text"],
            input[type="email"],
            input[type="password"],
            input[type="number"],
            input[type="date"],
            select,
            textarea {
                width: 100%;
                padding: 12px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 8px;
            }
            
            /* Responsive checklist layout */
            .checklist-actions {
                flex-direction: column;
                position: relative;
                z-index: 10;
            }
            
            .checklist-actions .btn {
                width: 100%;
                position: relative;
                z-index: 10;
                -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            }
            
            .btn-group {
                flex-direction: column;
                gap: 10px;
            }
            
            /* Tables */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -15px;
                padding: 0 15px;
            }
            
            table {
                font-size: 0.85rem;
            }
            
            th, td {
                padding: 8px 6px;
            }
            
            /* Modals */
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Schedule specific */
            .schedule-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .week-navigation {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .schedule-input,
            .shift-select {
                font-size: 0.8rem;
                padding: 4px;
            }
            
            /* Hide less important columns on mobile */
            .hide-mobile {
                display: none;
            }
            
            /* Inventory cards for mobile */
            .inventory-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .area-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Employee table */
            #employeeTable th:nth-child(4),
            #employeeTable td:nth-child(4),
            #employeeTable th:nth-child(5),
            #employeeTable td:nth-child(5) {
                display: none; /* Hide less critical columns */
            }
        }
        
        /* Small phones */
        @media (max-width: 480px) {
            .logo h1 {
                font-size: 1.2rem;
            }
            
            .container {
                padding: 5px;
            }
            
            .header {
                border-radius: 10px;
                padding: 10px;
            }
            
            .main-content {
                border-radius: 10px;
                padding: 10px;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            /* Stack all form controls */
            .form-row {
                flex-direction: column;
            }
            
            /* Make all inputs full width */
            input[type="text"],
            input[type="email"],
            input[type="password"],
            input[type="number"],
            input[type="date"],
            select,
            textarea {
                width: 100% !important;
            }
            
            /* Optimize table for very small screens */
            table {
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 6px 4px;
            }
            
            /* Schedule week display */
            #currentWeekDisplay {
                font-size: 1rem;
            }
            
            #weekDateRange {
                font-size: 0.85rem;
            }
            
            /* Hide more columns on very small screens */
            .hide-small {
                display: none;
            }
            
            /* Authentication container */
            .auth-container {
                padding: 20px;
                margin: 10px;
            }
            
            .auth-container h2 {
                font-size: 1.5rem;
            }
        }
        
        /* Utility classes for mobile */
        @media (max-width: 768px) {
            .desktop-only {
                display: none !important;
            }
            
            .mobile-only {
                display: block !important;
            }
            
            .text-mobile-center {
                text-align: center !important;
            }
            
            .mobile-full-width {
                width: 100% !important;
            }
            
            /* Improve touch targets */
            button, 
            .btn, 
            select, 
            input[type="checkbox"], 
            input[type="radio"] {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Add spacing between interactive elements */
            .form-group + .form-group {
                margin-top: 20px;
            }
        }
        
        /* Fix for iOS Safari */
        @supports (-webkit-touch-callout: none) {
            input[type="date"],
            input[type="time"] {
                min-height: 44px;
            }
        }
        
        /* Landscape orientation adjustments */
        @media (max-width: 812px) and (orientation: landscape) {
            .header {
                padding: 10px;
            }
            
            .tabs {
                padding: 5px 0;
            }
            
            .tab {
                padding: 8px 12px;
            }
            
            .main-content {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Netlify Forms - Hidden form for checklist submissions -->
    <form name="checklist-email" method="POST" data-netlify="true" netlify-honeypot="bot-field" style="display: none;">
        <input type="text" name="bot-field">
        <input type="text" name="to" value="save-jSnJTgoL5CnR@3.basecamp.com">
        <input type="text" name="subject">
        <textarea name="message"></textarea>
        <input type="text" name="pdf-report">
        <input type="text" name="store">
        <input type="text" name="manager">
        <input type="text" name="completion-rate">
        <input type="text" name="datetime">
    </form>
    <!-- Authentication Section -->
    <div id="authContainer" class="auth-container">
        <div class="auth-header">
            <i class="fas fa-building"></i>
            <h2>Couchman Companies QSR Navigator</h2>
            <p style="color: #7f8c8d; margin-top: 10px;">Restaurant Management System</p>
        </div>
        
        <div id="errorMessage" class="error-message hidden"></div>
        <div id="successMessage" class="success-message hidden"></div>
        
        <form id="authForm">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
        </form>
        
        <div style="text-align: center; margin-top: 20px; color: #7f8c8d;">
            Need access? Contact your administrator
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container hidden">
        <header class="header">
            <div class="logo">
                <i class="fas fa-building"></i>
                <h1>Couchman Companies QSR Navigator</h1>
            </div>
            <div class="user-info">
                <div id="locationSelector" class="location-selector hidden">
                    <label for="currentLocation" style="margin-right: 10px; font-weight: 600;">Location:</label>
                    <select id="currentLocation" class="location-dropdown">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <div class="user-badge">
                    <i class="fas fa-user"></i>
                    <span id="currentUser"></span>
                </div>
                <button id="createTicketBtn" class="btn btn-primary" style="margin-right: 10px;">
                    <i class="fas fa-ticket-alt"></i> Create a Ticket
                </button>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <main class="main-content">
            <div class="tabs">
                <button class="tab active" data-tab="inventory">
                    <i class="fas fa-boxes"></i> Order
                </button>
                <button class="tab" data-tab="monthlyInventory">
                    <i class="fas fa-clipboard-check"></i> Monthly Inventory
                </button>
                <button class="tab" data-tab="prepList">
                    <i class="fas fa-clipboard-list"></i> Prep List
                </button>
                <button class="tab" data-tab="schedule">
                    <i class="fas fa-calendar-alt"></i> Schedule
                </button>
                <button class="tab" data-tab="users" id="usersTab">
                    <i class="fas fa-users"></i> User Management
                </button>
                <button class="tab" data-tab="settings">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="tab" data-tab="checklists">
                    <i class="fas fa-clipboard-check"></i> Checklists
                </button>
            </div>

            <!-- Inventory Section -->
            <div id="inventorySection" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-calculator"></i>
                            Sales & Budget Calculator
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label for="projectedSales">Projected Sales ($)</label>
                            <input type="number" id="projectedSales" placeholder="25000" min="15000" max="50000" value="25000">
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: center;">
                            <label>Food Budget (29%)</label>
                            <div style="font-size: 1.3rem; font-weight: 700; color: #27ae60; background: #d5f4e6; padding: 12px 15px; border-radius: 8px; text-align: center;" id="projectedBudget">$7,250.00</div>
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: center;">
                            <label>Estimated Order Total</label>
                            <div style="font-size: 1.3rem; font-weight: 700; color: #3498db; background: #e3f2fd; padding: 12px 15px; border-radius: 8px; text-align: center;" id="estimatedOrderTotal">$0.00</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-warehouse"></i>
                            Inventory Management
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" id="mobileInventoryBtn">
                                <i class="fas fa-mobile-alt"></i> Mobile Count
                            </button>
                            <button class="btn btn-warning" id="updatePricingBtn">
                                <i class="fas fa-dollar-sign"></i> Update Pricing
                            </button>
                            <button class="btn btn-success" id="printCategoriesBtn">
                                <i class="fas fa-print"></i> Print Categories
                            </button>
                            <button class="btn btn-primary" id="projectedOrderBtn">
                                <i class="fas fa-calculator"></i> Projected Order Cost
                            </button>
                        </div>
                    </div>
                    
                    <div class="tabs" style="margin-top: 0;">
                        <button class="tab active" data-area="freezer">Freezer</button>
                        <button class="tab" data-area="walkin">Walk-In</button>
                        <button class="tab" data-area="foh">FOH</button>
                        <button class="tab" data-area="boh">BOH</button>
                        <button class="tab" data-area="produce">Produce</button>
                        <button class="tab" data-area="soda">Soda</button>
                    </div>

                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Par Level</th>
                                <th>Current Stock</th>
                                <th>Order Qty</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Monthly Inventory Section -->
            <div id="monthlyInventorySection" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-clipboard-check"></i>
                            Monthly Inventory Management
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="monthlyMobileInventoryBtn">
                                <i class="fas fa-mobile-alt"></i> Mobile Inventory
                            </button>
                            <button class="btn btn-secondary" id="uploadCsvBtn">
                                <i class="fas fa-upload"></i> Upload CSV
                            </button>
                            <button class="btn btn-success" id="monthlyPrintCategoriesBtn">
                                <i class="fas fa-print"></i> Print Categories
                            </button>
                            <button class="btn btn-info" id="exportInventoryBtn">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                            <button class="btn btn-warning" id="testCalculationsBtn">
                                <i class="fas fa-calculator"></i> Test Calculations
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label for="inventoryMonth">Inventory Month</label>
                                <input type="month" id="inventoryMonth" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="inventoryLocation">Location</label>
                                <select id="inventoryLocation" class="form-control">
                                    <option value="">Select Location</option>
                                    <option value="main">Main Location</option>
                                    <option value="location2">Location 2</option>
                                    <option value="location3">Location 3</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4>Current Month Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #27ae60;">CHEESE MOZZARELLA</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="cheeseTotal">$0.00</div>
                            </div>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #856404;">CHEESE OTHER</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="cheeseOtherTotal">$0.00</div>
                            </div>
                            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #721c24;">MEAT TOTAL</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="meatTotal">$0.00</div>
                            </div>
                            <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #155724;">GROCERIES</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="groceriesTotal">$0.00</div>
                            </div>
                            <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #0c5460;">PRODUCE</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="produceTotal">$0.00</div>
                            </div>
                            <div style="background: #f4f4f4; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #333;">BOXES P&P</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="paperpTotal">$0.00</div>
                            </div>
                            <div style="background: #e2e3e5; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #383d41;">BEVERAGES</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="beveragesTotal">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Inventory Table -->
                    <div style="overflow-x: auto;">
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Count</th>
                                    <th>Total Value</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyInventoryTableBody">
                                <!-- Monthly inventory items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prep List Section -->
            <div id="prepListSection" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-clipboard-list"></i>
                            Daily Prep List
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label>Date:</label>
                            <input type="date" id="prepListDate" class="form-control" style="width: 150px;">
                        </div>
                        <div>
                            <label>Day:</label>
                            <select id="prepListDay" class="form-control" style="width: 120px;">
                                <option value="monday">Monday</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="friday">Friday</option>
                                <option value="saturday">Saturday</option>
                                <option value="sunday">Sunday</option>
                            </select>
                        </div>
                        <button onclick="loadPrepList()" class="btn btn-primary">Load Prep List</button>
                        <button onclick="savePrepList()" class="btn btn-success">Save Prep List</button>
                        <button onclick="printPrepList()" class="btn btn-secondary">Print</button>
                    </div>

                    <div id="prepListContainer">
                        <p>Select a date to load the prep list.</p>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background-color: #e8f4fd; border-radius: 5px; border-left: 4px solid #2196F3;">
                        <strong>🎯 Smart Prep Logic:</strong><br>
                        <small>All items are saved for reference. Items needing prep (current stock < 65% of par level) are highlighted in <span style="background-color: #fff3cd; padding: 2px 4px;">yellow</span>. Items adequately stocked (≥65%) are highlighted in <span style="background-color: #d4edda; padding: 2px 4px;">green</span>. This maintains complete records while clearly showing prep priorities!</small>
                    </div>
                </div>
                
                <!-- Par Level Configuration -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-cog"></i>
                            Configure Par Levels by Day
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label>Day:</label>
                            <select id="parConfigDay" class="form-control" style="width: 120px;">
                                <option value="monday">Monday</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="friday">Friday</option>
                                <option value="saturday">Saturday</option>
                                <option value="sunday">Sunday</option>
                            </select>
                        </div>
                        <button onclick="loadParConfig()" class="btn btn-primary">Load Par Levels</button>
                    </div>

                    <div id="parConfigContainer">
                        <p>Select a day to configure par levels.</p>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background-color: #e8f4fd; border-radius: 5px; border-left: 4px solid #2196F3;">
                        <strong>💡 How Prep Amounts Work:</strong><br>
                        <small>Prep Amount = Par Level - Current Stock<br>
                        Set your par levels here, then when you load a daily prep list, enter the current stock and the prep amount will calculate automatically!</small>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 2px solid #e9ecef;">
                        <button onclick="saveParConfig()" class="btn btn-success" style="font-size: 16px; padding: 12px 30px;">
                            <i class="fas fa-save"></i> Save Par Levels
                        </button>
                    </div>
                </div>
            </div>

            <!-- Schedule Section -->
            <div id="scheduleSection" class="tab-content hidden schedule-section">
                <!-- Schedule Management -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-calendar-alt"></i>
                                Weekly Schedule Management
                            </div>
                            
                            <!-- View-only notice -->
                            <div id="scheduleViewOnlyNotice" style="display: none; margin: 15px 0; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; color: #856404;">
                                <i class="fas fa-info-circle"></i> <strong>View Only Mode:</strong> You have read-only access to the schedule. Only General Managers and above can edit schedules.
                            </div>
                            
                            <!-- Week Navigation -->
                            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" id="prevWeekBtn">
                                    <i class="fas fa-chevron-left"></i> Previous Week
                                </button>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; font-size: 1.1em;" id="currentWeekDisplay">
                                        Week of January 1, 2025
                                    </div>
                                    <div style="font-size: 0.9em; color: #666;" id="weekDateRange">
                                        Jan 1 - Jan 7, 2025
                                    </div>
                                </div>
                                <button class="btn btn-secondary" id="nextWeekBtn">
                                    Next Week <i class="fas fa-chevron-right"></i>
                                </button>
                                <button class="btn btn-primary" id="currentWeekBtn">
                                    <i class="fas fa-calendar-day"></i> Current Week
                                </button>
                            </div>

                            <!-- Advanced Week Features -->
                            <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 8px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label for="weekDropdown" style="font-weight: 600; margin: 0;">Jump to Week:</label>
                                    <select id="weekDropdown" class="form-control" style="min-width: 200px;">
                                        <option value="">Select a previous week...</option>
                                    </select>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-info" id="copyScheduleBtn">
                                        <i class="fas fa-copy"></i> Copy Week
                                    </button>
                                    <button class="btn btn-success" id="pasteScheduleBtn" disabled>
                                        <i class="fas fa-paste"></i> Paste Week
                                    </button>
                                </div>
                                <button class="btn btn-warning" id="scheduleNotesBtn">
                                    <i class="fas fa-sticky-note"></i> Notes
                                </button>
                            </div>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-success" id="addEmployeeBtn">
                                    <i class="fas fa-user-plus"></i> Manage Employees
                                </button>
                                <button class="btn btn-info" id="emailScheduleBtn">
                                    <i class="fas fa-cloud-upload-alt"></i> Submit to Basecamp
                                </button>
                                <button class="btn btn-primary" id="printScheduleBtn">
                                    <i class="fas fa-print"></i> Print Schedule
                                </button>
                                <button class="btn btn-success" id="mobileScheduleBtn">
                                    <i class="fas fa-mobile-alt"></i> Mobile Input
                                </button>
                            </div>
                        </div>
                        <div class="schedule-container" style="overflow-x: auto; padding: 20px;">
                            <table class="schedule-table" id="scheduleTable">
                                <thead>
                                    <tr>
                                        <th style="min-width: 120px;">Employee</th>
                                        <th style="min-width: 100px;">Role</th>
                                        <th style="min-width: 150px;">Monday</th>
                                        <th style="min-width: 150px;">Tuesday</th>
                                        <th style="min-width: 150px;">Wednesday</th>
                                        <th style="min-width: 150px;">Thursday</th>
                                        <th style="min-width: 150px;">Friday</th>
                                        <th style="min-width: 150px;">Saturday</th>
                                        <th style="min-width: 150px;">Sunday</th>
                                        <th style="min-width: 80px;">Week Total</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleTableBody">
                                    <!-- Schedule rows will be populated here -->
                                </tbody>
                                <tfoot>
                                    <tr style="background: #f8f9fa; font-weight: bold;">
                                        <td>Daily Totals</td>
                                        <td class="print-role-cell"></td>
                                        <td id="totalMon">0h</td>
                                        <td id="totalTue">0h</td>
                                        <td id="totalWed">0h</td>
                                        <td id="totalThu">0h</td>
                                        <td id="totalFri">0h</td>
                                        <td id="totalSat">0h</td>
                                        <td id="totalSun">0h</td>
                                        <td id="totalWeek">0h</td>
                                    </tr>
                                    <tr style="background: #e8f4f8; font-weight: bold; color: #2c3e50;">
                                        <td>Daily Payroll</td>
                                        <td class="print-role-cell"></td>
                                        <td id="payrollMon">$0</td>
                                        <td id="payrollTue">$0</td>
                                        <td id="payrollWed">$0</td>
                                        <td id="payrollThu">$0</td>
                                        <td id="payrollFri">$0</td>
                                        <td id="payrollSat">$0</td>
                                        <td id="payrollSun">$0</td>
                                        <td id="payrollWeek">$0</td>
                                    </tr>
                                    <tr style="background: #f0f8e8; font-weight: bold; color: #27ae60;">
                                        <td>Daily Sales</td>
                                        <td class="print-role-cell"></td>
                                        <td><input type="number" id="salesMon" class="daily-sales" placeholder="Sales" style="width: 80px; border: none; background: transparent; font-weight: bold; color: #27ae60; text-align: center;"></td>
                                        <td><input type="number" id="salesTue" class="daily-sales" placeholder="Sales" style="width: 80px; border: none; background: transparent; font-weight: bold; color: #27ae60; text-align: center;"></td>
                                        <td><input type="number" id="salesWed" class="daily-sales" placeholder="Sales" style="width: 80px; border: none; background: transparent; font-weight: bold; color: #27ae60; text-align: center;"></td>
                                        <td><input type="number" id="salesThu" class="daily-sales" placeholder="Sales" style="width: 80px; border: none; background: transparent; font-weight: bold; color: #27ae60; text-align: center;"></td>
                                        <td><input type="number" id="salesFri" class="daily-sales" placeholder="Sales" style="width: 80px; border: none; background: transparent; font-weight: bold; color: #27ae60; text-align: center;"></td>
                                        <td><input type="number" id="salesSat" class="daily-sales" placeholder="Sales" style="width: 80px; border: none; background: transparent; font-weight: bold; color: #27ae60; text-align: center;"></td>
                                        <td><input type="number" id="salesSun" class="daily-sales" placeholder="Sales" style="width: 80px; border: none; background: transparent; font-weight: bold; color: #27ae60; text-align: center;"></td>
                                        <td id="salesWeek" style="font-weight: bold;">$0</td>
                                    </tr>
                                    <tr style="background: #fdf2e9; font-weight: bold; color: #e67e22;">
                                        <td>Labor %</td>
                                        <td class="print-role-cell"></td>
                                        <td class="office-location-column" style="display: none;"></td>
                                        <td id="laborMon">0%</td>
                                        <td id="laborTue">0%</td>
                                        <td id="laborWed">0%</td>
                                        <td id="laborThu">0%</td>
                                        <td id="laborFri">0%</td>
                                        <td id="laborSat">0%</td>
                                        <td id="laborSun">0%</td>
                                        <td id="laborWeek">0%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Schedule vs Budget Comparison -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-balance-scale"></i>
                                Schedule vs Payroll Budget
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px;">
                            <div>
                                <label><strong>Total Projected Sales</strong></label>
                                <div id="totalProjectedSales" style="font-size: 1.5rem; font-weight: bold; color: #3498db;">$0</div>
                            </div>
                            <div>
                                <label><strong>Total Projected Payroll Budget</strong></label>
                                <div id="totalProjectedPayrollBudget" style="font-size: 1.5rem; font-weight: bold; color: #9b59b6;">$0</div>
                                <small style="color: #7f8c8d;">25% of projected sales</small>
                            </div>
                            <div>
                                <label><strong>Total Scheduled Pay</strong></label>
                                <div id="totalScheduledPay" style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">$0</div>
                            </div>
                            <div>
                                <label><strong>Weekly Payroll Budget</strong></label>
                                <div id="weeklyPayrollBudget" style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">$0</div>
                            </div>
                            <div>
                                <label><strong>Over/Under Budget</strong></label>
                                <div id="budgetVariance" style="font-size: 1.5rem; font-weight: bold;">$0</div>
                            </div>
                            <div>
                                <label><strong>Budget %</strong></label>
                                <div id="budgetPercentage" style="font-size: 1.5rem; font-weight: bold;">0%</div>
                            </div>
                            <div>
                                <label><strong>GM Pay Included</strong></label>
                                <div id="gmPayTotal" style="font-size: 1.2rem; font-weight: bold; color: #e74c3c;">$0</div>
                                <small style="color: #7f8c8d;">Weekly GM salaries</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Section -->
            <div id="usersSection" class="tab-content hidden">
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-users"></i>
                            User Management
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" id="addUserBtn">
                                <i class="fas fa-user-plus"></i> Add New User
                            </button>
                            <button class="btn btn-info" id="shareUrlBtn">
                                <i class="fas fa-share"></i> Share Team URL
                            </button>
                        </div>
                    </div>
                    
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Temp Password</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-cog"></i>
                            System Settings
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" id="companyName" value="Couchman Companies QSR Navigator">
                    </div>
                    
                    <div class="form-group">
                        <label>Default Budget Percentage</label>
                        <input type="number" id="budgetPercent" value="29" min="1" max="50">
                    </div>
                    
                    <button class="btn btn-success">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>

            <!-- Checklists Section -->
            <div id="checklistsSection" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-clipboard-check"></i>
                            Manager Checklists
                        </div>
                    </div>
                    
                    <!-- Checklist Navigation -->
                    <div class="tabs" style="margin-bottom: 20px;" id="checklistTabs">
                        <button class="tab active" data-checklist="opening">
                            <i class="fas fa-sun"></i> Opening
                        </button>
                        <button class="tab" data-checklist="closing">
                            <i class="fas fa-moon"></i> Closing
                        </button>
                        <button class="tab" data-checklist="weekly">
                            <i class="fas fa-calendar-week"></i> Weekly
                        </button>
                        <button class="tab" data-checklist="monthly">
                            <i class="fas fa-calendar-month"></i> Monthly
                        </button>
                    </div>

                    <!-- Store Information -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="checklistStore">Store Location</label>
                            <input type="text" id="checklistStore" placeholder="Store name/location">
                        </div>
                        <div class="form-group">
                            <label for="checklistManager">Manager Name</label>
                            <input type="text" id="checklistManager" placeholder="Manager name">
                        </div>
                        <div class="form-group">
                            <label for="checklistDate">Date & Time</label>
                            <input type="datetime-local" id="checklistDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>

                    <!-- Checklist Content -->
                    <div id="checklistContent">
                        <!-- Dynamic checklist content will be inserted here -->
                    </div>

                    <!-- Action Buttons -->
                    <div class="checklist-actions" style="text-align: center; padding: 30px 0;">
                        <button type="button" class="btn btn-primary" id="submitChecklistBtn" style="font-size: 1.2rem; padding: 15px 40px;">
                            <i class="fas fa-check-circle"></i> Submit to Basecamp
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New User</h3>
                <span class="close">&times;</span>
            </div>
            
            <form id="addUserForm">
                <div class="form-group">
                    <label for="newUserName">Full Name</label>
                    <input type="text" id="newUserName" required>
                </div>
                
                <div class="form-group">
                    <label for="newUserEmail">Email Address</label>
                    <input type="email" id="newUserEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="newUserRole">Role</label>
                    <select id="newUserRole" required>
                        <option value="staff">Staff (View Only - Schedule Access)</option>
                        <option value="manager">Manager (Can Add Staff)</option>
                        <option value="general_manager">General Manager (All Tools, Manage Staff)</option>
                        <option value="admin">Administrator (Manage Brands)</option>
                        <option value="super_admin">Super Administrator (Full System Access)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="brandAccessType">Brand Access Type</label>
                    <select id="brandAccessType" onchange="toggleBrandSelection()">
                        <option value="all">All Brands</option>
                        <option value="specific">Specific Brands</option>
                    </select>
                </div>
                
                <div class="form-group" id="brandSelectionGroup" style="display: none;">
                    <label>Select Brands</label>
                    <div style="position: relative;">
                        <input type="text" id="brandSearch" placeholder="Search brands..." 
                               style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"
                               onkeyup="filterBrands()">
                        <button type="button" onclick="selectAllBrands()" 
                                style="position: absolute; right: 5px; top: 5px; padding: 5px 10px; font-size: 12px;"
                                class="btn btn-sm">Select All</button>
                    </div>
                    <div id="brandCheckboxContainer" style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto;">
                        <label style="display: block; margin: 5px 0;" class="brand-option">
                            <input type="checkbox" value="Pizza" class="brand-checkbox" onchange="updateLocationCheckboxes()"> Pizza
                        </label>
                        <label style="display: block; margin: 5px 0;" class="brand-option">
                            <input type="checkbox" value="Smoothie" class="brand-checkbox" onchange="updateLocationCheckboxes()"> Smoothie
                        </label>
                        <label style="display: block; margin: 5px 0;" class="brand-option">
                            <input type="checkbox" value="Doughnut" class="brand-checkbox" onchange="updateLocationCheckboxes()"> Doughnut
                        </label>
                        <label style="display: block; margin: 5px 0;" class="brand-option">
                            <input type="checkbox" value="Taco" class="brand-checkbox" onchange="updateLocationCheckboxes()"> Taco
                        </label>
                        <label style="display: block; margin: 5px 0;" class="brand-option">
                            <input type="checkbox" value="Golf" class="brand-checkbox" onchange="updateLocationCheckboxes()"> Golf
                        </label>
                        <label style="display: block; margin: 5px 0;" class="brand-option">
                            <input type="checkbox" value="Office Administration" class="brand-checkbox" onchange="updateLocationCheckboxes()"> Office Administration
                        </label>
                    </div>
                    <small id="brandSelectionCount" style="color: #28a745; font-weight: 500;"></small>
                </div>
                
                <div class="form-group">
                    <label for="locationAccessType">Location Access Type</label>
                    <select id="locationAccessType" onchange="toggleLocationSelection()">
                        <option value="all">All Locations (for selected brands)</option>
                        <option value="specific">Specific Locations</option>
                    </select>
                </div>
                
                <div class="form-group" id="locationSelectionGroup" style="display: none;">
                    <label>Select Locations</label>
                    <div style="position: relative;">
                        <input type="text" id="locationSearch" placeholder="Search locations..." 
                               style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"
                               onkeyup="filterLocations()">
                        <button type="button" onclick="selectAllLocations()" 
                                style="position: absolute; right: 5px; top: 5px; padding: 5px 10px; font-size: 12px;"
                                class="btn btn-sm">Select All</button>
                    </div>
                    <div id="locationCheckboxContainer" style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                        <!-- Location checkboxes will be populated dynamically -->
                    </div>
                    <small style="color: #6c757d; font-size: 0.9rem;">Locations are filtered based on selected brands</small>
                </div>
                
                <div class="form-group">
                    <label for="newUserPassword">Temporary Password</label>
                    <input type="password" id="newUserPassword" required placeholder="Enter temporary password">
                    <small style="color: #6c757d; font-size: 0.9rem;">User will be prompted to change on first login</small>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" id="cancelAddUser">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-user-plus"></i> Create User
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
                <span class="close">&times;</span>
            </div>
            
            <form id="editUserForm">
                <input type="hidden" id="editUserEmail">
                
                <div class="form-group">
                    <label for="editUserName">Full Name</label>
                    <input type="text" id="editUserName" required>
                </div>
                
                <div class="form-group">
                    <label for="editUserRole">Role</label>
                    <select id="editUserRole" required>
                        <option value="staff">Staff (View Only - Schedule Access)</option>
                        <option value="manager">Manager (Can Add Staff)</option>
                        <option value="general_manager">General Manager (All Tools, Manage Staff)</option>
                        <option value="admin">Administrator (Manage Brands)</option>
                        <option value="super_admin">Super Administrator (Full System Access)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editBrandAccessType">Brand Access Type</label>
                    <select id="editBrandAccessType" onchange="toggleEditBrandSelection()">
                        <option value="all">All Brands</option>
                        <option value="specific">Specific Brands</option>
                    </select>
                </div>
                
                <div class="form-group" id="editBrandSelectionGroup" style="display: none;">
                    <label>Select Brands</label>
                    <div style="position: relative;">
                        <input type="text" id="editBrandSearch" placeholder="Search brands..." 
                               style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"
                               onkeyup="filterEditBrands()">
                        <button type="button" onclick="selectAllEditBrands()" 
                                style="position: absolute; right: 5px; top: 5px; padding: 5px 10px; font-size: 12px;"
                                class="btn btn-sm">Select All</button>
                    </div>
                    <div id="editBrandCheckboxContainer" style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto;">
                        <label style="display: block; margin: 5px 0;" class="edit-brand-option">
                            <input type="checkbox" value="Pizza" class="edit-brand-checkbox" onchange="updateEditLocationCheckboxes()"> Pizza
                        </label>
                        <label style="display: block; margin: 5px 0;" class="edit-brand-option">
                            <input type="checkbox" value="Smoothie" class="edit-brand-checkbox" onchange="updateEditLocationCheckboxes()"> Smoothie
                        </label>
                        <label style="display: block; margin: 5px 0;" class="edit-brand-option">
                            <input type="checkbox" value="Doughnut" class="edit-brand-checkbox" onchange="updateEditLocationCheckboxes()"> Doughnut
                        </label>
                        <label style="display: block; margin: 5px 0;" class="edit-brand-option">
                            <input type="checkbox" value="Taco" class="edit-brand-checkbox" onchange="updateEditLocationCheckboxes()"> Taco
                        </label>
                        <label style="display: block; margin: 5px 0;" class="edit-brand-option">
                            <input type="checkbox" value="Golf" class="edit-brand-checkbox" onchange="updateEditLocationCheckboxes()"> Golf
                        </label>
                        <label style="display: block; margin: 5px 0;" class="edit-brand-option">
                            <input type="checkbox" value="Office Administration" class="edit-brand-checkbox" onchange="updateEditLocationCheckboxes()"> Office Administration
                        </label>
                    </div>
                    <small id="editBrandSelectionCount" style="color: #28a745; font-weight: 500;"></small>
                </div>
                
                <div class="form-group">
                    <label for="editLocationAccessType">Location Access Type</label>
                    <select id="editLocationAccessType" onchange="toggleEditLocationSelection()">
                        <option value="all">All Locations (for selected brands)</option>
                        <option value="specific">Specific Locations</option>
                    </select>
                </div>
                
                <div class="form-group" id="editLocationSelectionGroup" style="display: none;">
                    <label>Select Locations</label>
                    <div style="position: relative;">
                        <input type="text" id="editLocationSearch" placeholder="Search locations..." 
                               style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"
                               onkeyup="filterEditLocations()">
                        <button type="button" onclick="selectAllEditLocations()" 
                                style="position: absolute; right: 5px; top: 5px; padding: 5px 10px; font-size: 12px;"
                                class="btn btn-sm">Select All</button>
                    </div>
                    <div id="editLocationCheckboxContainer" style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                        <!-- Locations will be populated dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editUserPassword">New Password (leave blank to keep current)</label>
                    <input type="password" id="editUserPassword" placeholder="Enter new password or leave blank">
                    <small style="color: #6c757d; font-size: 0.9rem;">Only fill this if you want to change the password</small>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" id="cancelEditUser">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for employee management -->
    <div id="employeeModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Employee Management</h3>
                <span class="close" id="closeEmployeeModal">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" id="addNewEmployeeBtn">
                    <i class="fas fa-plus"></i> Add New Employee
                </button>
            </div>
            
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Pay Rate</th>
                        <th>Email</th>
                        <th>Availability</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody">
                    <!-- Employee rows will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for adding/editing employees -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="employeeModalTitle">Add New Employee</h3>
                <span class="close" id="closeAddEmployeeModal">&times;</span>
            </div>
            
            <form id="addEmployeeForm">
                <div class="form-group">
                    <label for="empName">Employee Name</label>
                    <input type="text" id="empName" required>
                </div>
                
                <div class="form-group">
                    <label for="empBrand">Brand</label>
                    <select id="empBrand" required>
                        <option value="">Select Brand</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="empLocation">Location</label>
                    <select id="empLocation" required>
                        <option value="">Select Location</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="empRole">Role</label>
                    <select id="empRole" required>
                        <option value="GM">General Manager</option>
                        <option value="Manager 1">Manager 1</option>
                        <option value="Manager 2">Manager 2</option>
                        <option value="Manager 3">Manager 3</option>
                        <option value="Crew">Crew</option>
                        <option value="Driver">Driver</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="empPayType">Pay Type</label>
                    <select id="empPayType" required>
                        <option value="hourly">Hourly</option>
                        <option value="weekly">Weekly Salary (GM)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="empPayRate">Pay Rate/Salary</label>
                    <input type="number" id="empPayRate" step="0.01" required placeholder="15.00, 50000, or 1100">
                    <small style="color: #6c757d;" id="payRateHelp">Hourly rate, annual salary, or weekly salary (for GMs)</small>
                </div>
                
                <div class="form-group">
                    <label for="empEmail">Email Address</label>
                    <input type="email" id="empEmail" placeholder="employee@company.com">
                </div>
                
                <div class="form-group">
                    <label for="empAvailability">Availability</label>
                    <textarea id="empAvailability" rows="3" placeholder="Mon-Fri: 9am-5pm, Weekend: Available"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="empNotes">Training Notes</label>
                    <textarea id="empNotes" rows="3" placeholder="Training status, certifications, special notes..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="cancelAddEmployee">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Employee
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Schedule Notes Modal -->
    <div id="scheduleNotesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Schedule Notes</h3>
                <span class="close" id="closeNotesModal">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    Track unusual sales activity, special events, or other factors that may affect scheduling decisions for this week.
                </p>
                
                <div style="margin-bottom: 15px;">
                    <label for="scheduleNotesText" style="display: block; font-weight: 600; margin-bottom: 5px;">
                        Notes for <span id="notesWeekDisplay">Current Week</span>:
                    </label>
                    <textarea 
                        id="scheduleNotesText" 
                        rows="8" 
                        class="form-control" 
                        placeholder="Enter notes about unusual sales activity, special events, promotions, weather impacts, or other factors affecting this week's schedule..."
                        style="resize: vertical; min-height: 150px;">
                    </textarea>
                </div>
                
                <div style="font-size: 0.9em; color: #666;">
                    <strong>Examples:</strong> Holiday rush, weather impact, special promotion, event catering, staff training, equipment issues, etc.
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
                <button type="button" class="btn btn-secondary" id="clearNotesBtn">
                    <i class="fas fa-trash"></i> Clear Notes
                </button>
                <div>
                    <button type="button" class="btn btn-secondary" id="cancelNotesBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNotesBtn">
                        <i class="fas fa-save"></i> Save Notes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Schedule Input Modal -->
    <div id="mobileScheduleModal" class="modal">
        <div class="modal-content" style="max-width: 95%; height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3><i class="fas fa-mobile-alt"></i> Mobile Schedule Input</h3>
                <span class="close" onclick="closeMobileScheduleModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 10px;">
                <div id="mobileScheduleContent">
                    <!-- Mobile schedule interface will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Inventory Modal -->
    <div id="mobileInventoryModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Mobile Inventory Count</h3>
                <span class="close" id="closeMobileInventoryModal">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    Quick inventory counting optimized for mobile devices. Tap items to count and update inventory levels.
                </p>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Select Category:</label>
                    <select id="mobileInventoryCategory" class="form-control">
                        <option value="freezer">Freezer</option>
                        <option value="walkin">Walk-In</option>
                        <option value="foh">FOH</option>
                        <option value="boh">BOH</option>
                        <option value="produce">Produce</option>
                        <option value="soda">Soda</option>
                    </select>
                </div>
                
                <div id="mobileInventoryList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Mobile inventory items will be populated here -->
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
                <button type="button" class="btn btn-secondary" id="cancelMobileInventoryBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMobileInventoryBtn">
                    <i class="fas fa-save"></i> Save Counts
                </button>
            </div>
        </div>
    </div>

    <!-- Update Pricing Modal -->
    <div id="updatePricingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Pricing</h3>
                <span class="close" id="closePricingModal">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    Paste the pricing data from column A of your spreadsheet. Format: one price per line (copy entire column A).
                </p>
                
                <div style="margin-bottom: 15px;">
                    <label for="pricingData" style="display: block; font-weight: 600; margin-bottom: 5px;">
                        Pricing Data (Column A):
                    </label>
                    <textarea 
                        id="pricingData" 
                        rows="12" 
                        class="form-control" 
                        placeholder="Paste column A pricing data here:&#10;$25.00&#10;$162.80&#10;$98.02&#10;$27.60&#10;..."
                        style="resize: vertical; min-height: 200px; font-family: monospace;">
                    </textarea>
                </div>
                
                <div style="font-size: 0.9em; color: #666;">
                    <strong>Instructions:</strong> Copy column A (PRICE column) from your spreadsheet and paste it here. The system will automatically parse the price values (e.g., $25.00 → 25.00).
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
                <button type="button" class="btn btn-secondary" id="cancelPricingBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="updatePricingBtn">
                    <i class="fas fa-dollar-sign"></i> Update Prices
                </button>
            </div>
        </div>
    </div>

    <!-- Monthly Mobile Inventory Modal -->
    <div id="monthlyMobileInventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Monthly Mobile Inventory Count</h3>
                <span class="close" id="closeMonthlyMobileInventoryModal">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    Mobile-optimized inventory counting for monthly inventory. Tap to update counts quickly.
                </p>
                
                <div style="margin-bottom: 15px;">
                    <label for="monthlyMobileInventoryCategory">Select Category:</label>
                    <select id="monthlyMobileInventoryCategory" class="form-control">
                        <option value="cheese-mozzarella">Cheese Mozzarella</option>
                        <option value="cheese-other">Cheese Other</option>
                        <option value="meat">Meat</option>
                        <option value="groceries">Groceries</option>
                        <option value="produce">Produce</option>
                        <option value="paper-plastic">Paper & Plastic</option>
                        <option value="beverages">Beverages</option>
                    </select>
                </div>
            </div>

            <div id="monthlyMobileInventoryList" style="max-height: 400px; overflow-y: auto;">
                <!-- Monthly mobile inventory items will be populated here -->
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" id="cancelMonthlyMobileInventoryBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMonthlyMobileInventoryBtn">
                    <i class="fas fa-save"></i> Save Monthly Counts
                </button>
            </div>
        </div>
    </div>


    <!-- CSV Upload Modal -->
    <div id="csvUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload CSV File</h3>
                <span class="close" id="closeCsvUploadModal">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    Upload your monthly inventory CSV file to automatically update items and pricing. The system will parse the file and update all inventory categories.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <label for="csvFileInput" style="display: block; font-weight: 600; margin-bottom: 10px;">
                        Select CSV File:
                    </label>
                    <input type="file" id="csvFileInput" accept=".csv" class="form-control" style="padding: 10px;">
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px; color: #495057;">Your CSV Format (from /Users/jasonadams/Desktop/2.csv):</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                        <li><strong>Column A:</strong> PRICE (e.g., $25.00, $162.80)</li>
                        <li><strong>Column B:</strong> Product Name (e.g., Block Mozzarella, Pepperoni)</li>
                        <li><strong>Categories:</strong> "1) CHEESE - MOZZARELLA", "2) CHEESE - OTHER", "3) MEATS", "4) GROCERIES", "5) PRODUCE", "6) PAPER & PLASTIC", "BEVERAGES"</li>
                        <li>System will automatically parse and categorize all items with their exact prices</li>
                    </ul>
                </div>
                
                <div id="csvPreview" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.9em; display: none;">
                    <!-- CSV preview will appear here -->
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
                <button type="button" class="btn btn-secondary" id="cancelCsvUploadBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="processCsvBtn" disabled>
                    <i class="fas fa-cogs"></i> Process CSV & Update Inventory
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // SIMPLIFIED USER MANAGEMENT SYSTEM
        // ==========================================
        
        // Core test users - keeping brand/location structure
        const GLOBAL_USERS = {
            // Super Admin - access everything
            'superadmin@couchmancompanies.com': {
                name: 'Super Administrator',
                role: 'super_admin',
                password: 'super123',
                brands: 'all',
                locations: 'all'
            },
            // Pizza Manager - specific location
            'pizzamanager@theopt.net': {
                name: 'Pizza Manager',
                role: 'general_manager',
                password: 'pizza123',
                brands: ['Pizza'],
                locations: ['Oh-006', 'Oh-008']
            },
            // Staff member - single location
            'staff@theopt.net': {
                name: 'Staff Member',
                role: 'staff',
                password: 'staff123',
                brands: ['Pizza'],
                locations: ['Oh-006']
            }
        };
        
        
        // Initialize user stores
        let USERS = { ...GLOBAL_USERS };
        let usersData = { ...GLOBAL_USERS };
        
        // Function to sync users from database
        async function syncUsersFromDatabase() {
            try {
                console.log('Syncing users from database...');
                const response = await fetch('/.netlify/functions/users');
                if (response.ok) {
                    const dbUsers = await response.json();
                    console.log('Found', dbUsers.length, 'users in database');
                    
                    // Add database users to USERS object
                    dbUsers.forEach(user => {
                        USERS[user.email] = {
                            name: user.name,
                            role: user.role,
                            password: user.password,
                            brands: user.brands || [],
                            locations: user.locations || []
                        };
                        usersData[user.email] = USERS[user.email];
                    });
                    
                    console.log('Users synced successfully');
                } else {
                    console.error('Failed to fetch users from database:', response.status);
                }
            } catch (error) {
                console.error('Error syncing users from database:', error);
            }
        }
        
        // Sync users on page load
        syncUsersFromDatabase();
        let currentUser = null;
        
        // Role hierarchy will be loaded from rolepermissions.js
        
        // Check if user can manage another user based on role hierarchy
        function canManageUser(currentUserRole, targetUserRole) {
            const currentSecurityCode = getSecurityCodeForRole(currentUserRole);
            const targetSecurityCode = getSecurityCodeForRole(targetUserRole);
            return currentSecurityCode >= targetSecurityCode;
        }
        
        // Update role dropdown options based on current user's role
        function updateRoleDropdownOptions() {
            const roleSelect = document.getElementById('newUserRole');
            const editRoleSelect = document.getElementById('editUserRole');
            
            if (!currentUser) return;
            
            const currentSecurityCode = getSecurityCodeForRole(currentUser.role);
            const roleOptions = [
                { value: 'staff', text: 'Staff (View Only - Schedule Access)', securityCode: 1 },
                { value: 'manager', text: 'Manager (Can Add Staff)', securityCode: 2 },
                { value: 'general_manager', text: 'General Manager (All Tools, Manage Staff)', securityCode: 3 },
                { value: 'admin', text: 'Administrator (Manage Brands)', securityCode: 4 },
                { value: 'super_admin', text: 'Super Administrator (Full System Access)', securityCode: 5 }
            ];
            
            // Clear and repopulate dropdowns
            [roleSelect, editRoleSelect].forEach(select => {
                if (select) {
                    select.innerHTML = '';
                    roleOptions.forEach(option => {
                        // Only show roles with security codes at or below current user's security code
                        if (option.securityCode <= currentSecurityCode) {
                            const opt = document.createElement('option');
                            opt.value = option.value;
                            opt.textContent = `${option.text} (Security Code: ${option.securityCode})`;
                            select.appendChild(opt);
                        }
                    });
                }
            });
        }
        
        // Show test accounts
        console.log('=== SIMPLIFIED TEST ACCOUNTS ===');
        console.log('Super Admin: superadmin@couchmancompanies.com / super123');
        console.log('Manager: pizzamanager@theopt.net / pizza123');
        console.log('Staff: staff@theopt.net / staff123');
        console.log('==============================');
        console.log('GLOBAL_USERS:', GLOBAL_USERS);
        
        // Add debug script loader function
        window.loadDebugScript = function() {
            const debugScript = document.createElement('script');
            debugScript.src = './debug-admin.js';
            document.body.appendChild(debugScript);
        };
        
        // Add function to check saved users
        window.checkUsers = function() {
            const customUsers = JSON.parse(localStorage.getItem('couchman_users') || '{}');
            console.log('=== SAVED CUSTOM USERS ===');
            console.log('Count:', Object.keys(customUsers).length);
            Object.entries(customUsers).forEach(([email, user]) => {
                console.log(`${email}: ${user.name} (${user.role})`);
            });
            return customUsers;
        };
        
        // Load RBAC System Scripts after GLOBAL_USERS is defined
        console.log('Loading RBAC scripts...');
        console.log('Current protocol:', window.location.protocol);
        
        // Check if running locally or on server
        const isLocal = window.location.protocol === 'file:';
        if (isLocal) {
            console.warn('Running locally with file:// protocol. RBAC scripts may not load properly.');
        }
        
        (function() {
            const script1 = document.createElement('script');
            script1.src = './rolepermissions.js';
            script1.onerror = function() {
                console.error('Failed to load rolepermissions.js - RBAC features will be limited');
                // Continue without RBAC
                window.ROLES = { SUPER_ADMIN: 'super_admin', ADMIN: 'admin', MANAGER: 'manager', STAFF: 'staff' };
                window.PermissionChecker = function() { return { hasPermission: () => true }; };
            };
            document.head.appendChild(script1);
            
            script1.onload = function() {
                console.log('rolepermissions.js loaded successfully');
                const script2 = document.createElement('script');
                script2.src = './rbacintegration.js';
                script2.onerror = function() {
                    console.error('Failed to load rbacintegration.js - RBAC features will be limited');
                };
                script2.onload = function() {
                    console.log('rbacintegration.js loaded successfully');
                };
                document.head.appendChild(script2);
            };
        })();

        // Location and Brand mapping
        const LOCATION_BRAND_MAP = [
            // Pizza Locations - Ohio
            { location: 'Oh-006', brand: 'Pizza' },
            { location: 'Oh-008', brand: 'Pizza' },
            { location: 'Oh-010', brand: 'Pizza' },
            { location: 'Oh-011', brand: 'Pizza' },
            { location: 'Oh-012', brand: 'Pizza' },
            { location: 'Oh-014', brand: 'Pizza' },
            { location: 'Oh-018', brand: 'Pizza' },
            { location: 'Oh-019', brand: 'Pizza' },
            { location: 'Oh-021', brand: 'Pizza' },
            { location: 'Oh-022', brand: 'Pizza' },
            { location: 'Oh-025', brand: 'Pizza' },
            { location: 'Oh-026', brand: 'Pizza' },
            { location: 'Oh-030', brand: 'Pizza' },
            { location: 'Oh-031', brand: 'Pizza' },
            { location: 'Oh-037', brand: 'Pizza' },
            { location: 'Oh-039', brand: 'Pizza' },
            { location: 'Oh-041', brand: 'Pizza' },
            { location: 'Oh-043', brand: 'Pizza' },
            { location: 'Oh-045', brand: 'Pizza' },
            { location: 'Oh-046', brand: 'Pizza' },
            { location: 'Oh-047', brand: 'Pizza' },
            { location: 'Oh-048', brand: 'Pizza' },
            // Pizza Locations - Florida
            { location: 'fl-008', brand: 'Pizza' },
            { location: 'Fl-009', brand: 'Pizza' },
            { location: 'fl-010', brand: 'Pizza' },
            { location: 'fl-017', brand: 'Pizza' },
            { location: 'Fl-024', brand: 'Pizza' },
            { location: 'Fl-035', brand: 'Pizza' },
            { location: 'fl-041', brand: 'Pizza' },
            { location: 'fl-045', brand: 'Pizza' },
            { location: 'Fl-046', brand: 'Pizza' },
            { location: 'FL-051', brand: 'Pizza' },
            // Pizza Locations - Michigan
            { location: 'mi-030', brand: 'Pizza' },
            { location: 'mi-050', brand: 'Pizza' },
            { location: 'mi-078', brand: 'Pizza' },
            // Smoothie Locations
            { location: 'OST1', brand: 'Smoothie' },
            { location: 'OST2', brand: 'Smoothie' },
            { location: 'OST3', brand: 'Smoothie' },
            { location: 'OST4', brand: 'Smoothie' },
            { location: 'OST5', brand: 'Smoothie' },
            { location: 'OST6', brand: 'Smoothie' },
            // Doughnut Locations
            { location: 'ODT1', brand: 'Doughnut' },
            { location: 'ODT2', brand: 'Doughnut' },
            { location: 'ODT3', brand: 'Doughnut' },
            { location: 'ODT4', brand: 'Doughnut' },
            { location: 'ODT5', brand: 'Doughnut' },
            { location: 'ODT6', brand: 'Doughnut' },
            // Taco Locations
            { location: 'TACO 1', brand: 'Taco' },
            { location: 'TACO 2', brand: 'Taco' },
            { location: 'TACO 3', brand: 'Taco' },
            // Golf Locations
            { location: 'X-Golf 1', brand: 'Golf' },
            { location: 'X-Golf 2', brand: 'Golf' },
            { location: 'X-Golf 3', brand: 'Golf' },
            // Office
            { location: 'Office', brand: 'Office Administration' }
        ];
        
        // Helper function to get locations by brand
        function getLocationsByBrand(brands) {
            if (!brands || brands === 'all') {
                return LOCATION_BRAND_MAP.map(item => item.location);
            }
            if (Array.isArray(brands) && brands.length === 0) {
                return LOCATION_BRAND_MAP.map(item => item.location);
            }
            return LOCATION_BRAND_MAP
                .filter(item => {
                    return Array.isArray(brands) && brands.some(brand => brand === item.brand);
                })
                .map(item => item.location);
        }
        
        // Function to update location dropdown based on selected brand
        function updateLocationDropdownForBrand(selectedBrand) {
            const userRole = currentUser.rbac ? currentUser.rbac.role : currentUser.role;
            const userBrands = currentUser.rbac ? currentUser.rbac.brands : (currentUser.brands || []);
            const userLocations = currentUser.rbac ? currentUser.rbac.locations : (currentUser.locations || []);
            
            // Filter locations for the selected brand
            let filteredLocations = [];
            
            if (userRole === 'super_admin' || (Array.isArray(userLocations) && userLocations.includes('ALL'))) {
                // Super admin or users with ALL locations - show all locations for selected brand
                filteredLocations = LOCATION_BRAND_MAP.filter(item => 
                    !selectedBrand || selectedBrand === '' || item.brand === selectedBrand
                );
            } else {
                // Regular users - show only their assigned locations for selected brand
                filteredLocations = LOCATION_BRAND_MAP.filter(item => {
                    const brandMatch = !selectedBrand || selectedBrand === '' || item.brand === selectedBrand;
                    const locationMatch = Array.isArray(userLocations) && userLocations.includes(item.location);
                    return brandMatch && locationMatch;
                });
            }
            
            // Update location dropdown
            const locationDropdown = document.getElementById('currentLocation');
            const locationSelector = document.getElementById('locationSelector');
            
            if (filteredLocations.length > 0) {
                locationSelector.classList.remove('hidden');
                locationDropdown.innerHTML = '<option value="">Select Location</option>';
                
                // Group by brand if no specific brand selected
                if (!selectedBrand || selectedBrand === '') {
                    const brandGroups = {};
                    filteredLocations.forEach(item => {
                        if (!brandGroups[item.brand]) {
                            brandGroups[item.brand] = [];
                        }
                        brandGroups[item.brand].push(item.location);
                    });
                    
                    Object.entries(brandGroups).forEach(([brand, locations]) => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = brand;
                        locations.forEach(location => {
                            const option = document.createElement('option');
                            option.value = location;
                            option.textContent = location;
                            optgroup.appendChild(option);
                        });
                        locationDropdown.appendChild(optgroup);
                    });
                } else {
                    // Single brand - just list locations
                    filteredLocations.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.location;
                        option.textContent = item.location;
                        locationDropdown.appendChild(option);
                    });
                }
            } else {
                locationSelector.classList.add('hidden');
            }
        }

        // Setup location selector for users
        function setupLocationSelector() {
            const locationSelector = document.getElementById('locationSelector');
            const locationDropdown = document.getElementById('currentLocation');
            
            console.log('Setting up selectors for user:', currentUser);
            console.log('Location selector element:', locationSelector);
            console.log('Is mobile:', window.innerWidth <= 768);
            
            // Get role, brands, and locations from RBAC or currentUser
            const userRole = currentUser.rbac ? currentUser.rbac.role : currentUser.role;
            const userBrands = currentUser.rbac ? currentUser.rbac.brands : (currentUser.brands || []);
            const userLocations = currentUser.rbac ? currentUser.rbac.locations : (currentUser.locations || []);
            
            console.log('User role:', userRole);
            console.log('User brands:', userBrands);
            console.log('User locations:', userLocations);
            
            // Check if user is admin or super admin
            if (userRole === 'admin' || userRole === 'super_admin' || userRole === 'general_manager') {
                // Get available locations based on user's brands/locations
                let availableLocations = [];
                if (userRole === 'super_admin' || userLocations === 'all' || (Array.isArray(userLocations) && userLocations.includes('ALL'))) {
                    // Super admin or users with 'all' locations access
                    if (userBrands === 'all' || (Array.isArray(userBrands) && userBrands.includes('Jets Pizza'))) {
                        // Access to all brands and all locations
                        availableLocations = LOCATION_BRAND_MAP.map(item => item);
                    } else if (Array.isArray(userBrands)) {
                        // Access to specific brands but all locations within those brands
                        availableLocations = LOCATION_BRAND_MAP.filter(item => 
                            userBrands.includes(item.brand)
                        );
                    } else {
                        // Fallback to all locations
                        availableLocations = LOCATION_BRAND_MAP.map(item => item);
                    }
                } else {
                    // Filter locations based on user's specific access
                    availableLocations = LOCATION_BRAND_MAP.filter(item => {
                        const brandMatch = userBrands === 'all' || (Array.isArray(userBrands) && userBrands.includes(item.brand));
                        const locationMatch = Array.isArray(userLocations) && userLocations.includes(item.location);
                        return brandMatch && locationMatch;
                    });
                }
                
                // Always show location selector if user has any locations OR is admin/super_admin
                const adminRoles = ['super_admin', 'admin', 'general_manager'];
                if (availableLocations.length > 0 || adminRoles.includes(userRole)) {
                    // Show location selector
                    locationSelector.classList.remove('hidden');
                    locationSelector.style.display = 'flex'; // Force display
                    locationSelector.style.visibility = 'visible'; // Force visibility
                    
                    // Clear and populate dropdown
                    locationDropdown.innerHTML = '<option value="">Select Location</option>';
                    
                    // Group by brand
                    const brandGroups = {};
                    availableLocations.forEach(item => {
                        if (!brandGroups[item.brand]) {
                            brandGroups[item.brand] = [];
                        }
                        brandGroups[item.brand].push(item.location);
                    });
                    
                    // Add options grouped by brand
                    Object.entries(brandGroups).forEach(([brand, locations]) => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = brand;
                        locations.forEach(location => {
                            const option = document.createElement('option');
                            option.value = location;
                            option.textContent = location;
                            optgroup.appendChild(option);
                        });
                        locationDropdown.appendChild(optgroup);
                    });
                    
                    // Set current location from localStorage or default to first location
                    const savedLocation = localStorage.getItem('currentSelectedLocation');
                    if (savedLocation && Array.from(locationDropdown.options).some(opt => opt.value === savedLocation)) {
                        locationDropdown.value = savedLocation;
                    } else if (availableLocations.length > 0) {
                        // Default to first available location instead of "All Locations"
                        const firstLocation = availableLocations[0].location;
                        locationDropdown.value = firstLocation;
                        localStorage.setItem('currentSelectedLocation', firstLocation);
                    }
                    
                    // Remove any existing listeners to prevent duplicates
                    locationDropdown.replaceWith(locationDropdown.cloneNode(true));
                    const newLocationDropdown = document.getElementById('currentLocation');
                    
                    // Add change event listener
                    newLocationDropdown.addEventListener('change', function(e) {
                        e.stopPropagation();
                        const selectedLocation = this.value;
                        localStorage.setItem('currentSelectedLocation', selectedLocation);
                        
                        // Update brand selector if visible
                        const brandDropdown = document.getElementById('currentBrand');
                        if (brandDropdown && selectedLocation) {
                            const locationItem = LOCATION_BRAND_MAP.find(item => item.location === selectedLocation);
                            if (locationItem) {
                                brandDropdown.value = locationItem.brand;
                            }
                        }
                        
                        // Reload all data for the new location
                        reloadDataForLocation(selectedLocation);
                        
                        // Update checklist tabs based on new brand/location
                        updateChecklistTabs();
                    });
                } else if (availableLocations.length === 1) {
                    // Single location - set it automatically
                    localStorage.setItem('currentSelectedLocation', availableLocations[0].location);
                }
            } else {
                // Non-admin users - use their assigned location
                const userLocations = currentUser.locations || [];
                if (Array.isArray(userLocations) && userLocations.length > 0 && userLocations[0] !== 'all') {
                    localStorage.setItem('currentSelectedLocation', userLocations[0]);
                } else if (userLocations === 'all') {
                    // User has access to all locations but isn't admin - shouldn't happen but handle it
                    localStorage.setItem('currentSelectedLocation', '');
                }
            }
        }
        
        // Update location dropdown based on selected brand
        function updateLocationDropdownForBrand(selectedBrand) {
            const locationDropdown = document.getElementById('currentLocation');
            const userRole = currentUser.rbac ? currentUser.rbac.role : currentUser.role;
            const userLocations = currentUser.rbac ? currentUser.rbac.locations : (currentUser.locations || []);
            
            // Clear current options
            locationDropdown.innerHTML = '<option value="">Select Location</option>';
            
            // Get locations for the selected brand
            let availableLocations = [];
            if (selectedBrand) {
                // Filter by selected brand
                availableLocations = LOCATION_BRAND_MAP.filter(item => item.brand === selectedBrand);
                
                // Further filter by user's location access if not super admin
                if (userRole !== 'super_admin' && userLocations[0] !== 'all') {
                    availableLocations = availableLocations.filter(item => 
                        userLocations.includes(item.location)
                    );
                }
            } else {
                // No brand selected - show all accessible locations
                if (userRole === 'super_admin' || userLocations[0] === 'all') {
                    availableLocations = LOCATION_BRAND_MAP;
                } else {
                    availableLocations = LOCATION_BRAND_MAP.filter(item => 
                        userLocations.includes(item.location)
                    );
                }
            }
            
            // Add location options
            availableLocations.forEach(item => {
                const option = document.createElement('option');
                option.value = item.location;
                option.textContent = item.location;
                locationDropdown.appendChild(option);
            });
            
            // Reset location selection
            localStorage.removeItem('currentSelectedLocation');
            reloadDataForLocation('');
        }
        
        // Get current location context
        function getCurrentLocation() {
            return localStorage.getItem('currentSelectedLocation') || '';
        }
        
        function getCurrentBrand() {
            // Get brand from current location
            const currentLocation = getCurrentLocation();
            if (currentLocation) {
                const locationItem = LOCATION_BRAND_MAP.find(item => item.location === currentLocation);
                if (locationItem) {
                    return locationItem.brand;
                }
            }
            return '';
        }
        
        // Helper function to check user roles
        function hasRole(allowedRoles) {
            const userRole = currentUser.rbac ? currentUser.rbac.role : currentUser.role;
            return allowedRoles.includes(userRole);
        }
        
        function isAdmin() {
            return hasRole(['super_admin', 'admin']);
        }
        
        function isManager() {
            return hasRole(['super_admin', 'admin', 'general_manager', 'manager']);
        }
        
        // Debug function to show all location-specific data
        function debugLocationData() {
            const userEmail = currentUser.email;
            console.log('=== LOCATION DATA DEBUG ===');
            console.log('Current user:', userEmail);
            console.log('Current location:', getCurrentLocation());
            
            // Check all localStorage keys for this user
            const allKeys = Object.keys(localStorage);
            const userKeys = allKeys.filter(key => key.includes(userEmail));
            
            console.log('All keys for user:');
            userKeys.forEach(key => {
                console.log(`  ${key}: ${localStorage.getItem(key).substring(0, 100)}...`);
            });
            
            console.log('=== END DEBUG ===');
        }
        
        // Generate storage key with location context
        function getLocationStorageKey(baseKey, userEmail) {
            const location = getCurrentLocation();
            console.log('getLocationStorageKey called with:', { baseKey, userEmail, currentLocation: location });
            
            // Check if user has multiple locations
            const userRole = currentUser.rbac ? currentUser.rbac.role : currentUser.role;
            const userLocations = currentUser.rbac ? currentUser.rbac.locations : (currentUser.locations || []);
            const hasMultipleLocations = (userLocations === 'all') || (Array.isArray(userLocations) && userLocations.length > 1);
            console.log('User has multiple locations:', hasMultipleLocations, 'Locations:', userLocations);
            
            // For users with multiple locations, always require a specific location
            if (hasMultipleLocations && !location) {
                console.warn('Warning: Multi-location user attempting to save without selecting a location');
                // Try to get first available location
                if (Array.isArray(userLocations) && userLocations.length > 0) {
                    const firstLocation = userLocations[0];
                    localStorage.setItem('currentSelectedLocation', firstLocation);
                    return `${baseKey}_${userEmail}_${firstLocation.replace(/\s+/g, '_')}`;
                } else if (userLocations === 'all') {
                    // For users with 'all' locations, get the first location from LOCATION_BRAND_MAP
                    const firstLocation = LOCATION_BRAND_MAP[0].location;
                    localStorage.setItem('currentSelectedLocation', firstLocation);
                    return `${baseKey}_${userEmail}_${firstLocation.replace(/\s+/g, '_')}`;
                }
            }
            
            if (location) {
                const key = `${baseKey}_${userEmail}_${location.replace(/\s+/g, '_')}`;
                console.log('Returning location-specific key:', key);
                return key;
            }
            
            // For single location users, use their assigned location
            if (!hasMultipleLocations && Array.isArray(userLocations) && userLocations.length === 1) {
                const singleLocation = userLocations[0];
                const key = `${baseKey}_${userEmail}_${singleLocation.replace(/\s+/g, '_')}`;
                console.log('Single location user, using key:', key);
                localStorage.setItem('currentSelectedLocation', singleLocation);
                return key;
            }
            
            console.warn('Returning key without location:', `${baseKey}_${userEmail}`);
            return `${baseKey}_${userEmail}`;
        }
        
        // Check and migrate data from old keys to location-specific keys
        function migrateDataToLocationKeys(userEmail) {
            const location = getCurrentLocation();
            if (!location) return;
            
            const dataTypes = [
                'couchman_inventory',
                'couchman_employees', 
                'couchman_schedule',
                'itemPricing',
                'monthly_pricing',
                'checklist'
            ];
            
            dataTypes.forEach(dataType => {
                const oldKey = `${dataType}_${userEmail}`;
                const newKey = `${dataType}_${userEmail}_${location.replace(/\s+/g, '_')}`;
                
                // Check if old key exists but new key doesn't
                if (localStorage.getItem(oldKey) && !localStorage.getItem(newKey)) {
                    console.log(`Migrating ${dataType} from ${oldKey} to ${newKey}`);
                    localStorage.setItem(newKey, localStorage.getItem(oldKey));
                    // Don't remove old key yet - keep for backup
                }
            });
        }
        
        // Reload all data for a specific location
        async function reloadDataForLocation(location) {
            // Show loading indicator
            showSuccess(`Loading data for ${location || 'All Locations'}...`);
            
            // First migrate any old data
            migrateDataToLocationKeys(currentUser.email);
            
            // Reload all data with location context
            loadInventoryData(currentUser.email);
            loadEmployeeData(currentUser.email);
            
            // Check if we're on the schedule tab
            if (currentTab === 'schedule') {
                if (!location) {
                    // No location selected - show message
                    const scheduleSection = document.getElementById('scheduleSection');
                    if (scheduleSection) {
                        const scheduleContent = scheduleSection.querySelector('.schedule-content') || scheduleSection;
                        scheduleContent.innerHTML = `
                            <div style="text-align: center; padding: 50px; background: #f8f9fa; border-radius: 10px; margin: 20px;">
                                <i class="fas fa-map-marker-alt" style="font-size: 48px; color: #e74c3c; margin-bottom: 20px;"></i>
                                <h2 style="color: #2c3e50; margin-bottom: 10px;">No Location Selected</h2>
                                <p style="color: #7f8c8d; font-size: 18px;">Please select a location from the dropdown above to view and manage the schedule.</p>
                            </div>
                        `;
                    }
                    stopScheduleAutoRefresh();
                } else {
                    // Location selected - load and render schedule
                    await loadScheduleData();
                    if (typeof renderScheduleTable === 'function') {
                        renderScheduleTable();
                        if (typeof updateScheduleTotals === 'function') {
                            updateScheduleTotals();
                        }
                    }
                    // Restart auto-refresh for the new location
                    startScheduleAutoRefresh();
                }
            } else {
                // Not on schedule tab, just load the data
                await loadScheduleData();
            }
            
            loadPricingData(currentUser.email);
            
            // Check if monthly functions exist before calling
            if (typeof loadMonthlyPricingData === 'function') {
                loadMonthlyPricingData(currentUser.email);
            }
            if (typeof loadMonthlyInventoryData === 'function') {
                loadMonthlyInventoryData(currentUser.email);
            }
            
            // Refresh all tables to show the new location's data
            renderInventoryTable();
            renderScheduleTable();
            updateScheduleTotals();
            renderEmployeeTable();
            
            // Render monthly inventory if the function exists
            if (typeof renderMonthlyInventoryTable === 'function') {
                renderMonthlyInventoryTable();
            }
            
            // Update daily sales display
            const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayKeys.forEach((key, index) => {
                const input = document.getElementById(`sales${dayNames[index]}`);
                if (input) input.value = currentWeekSales[key] || '';
            });
            updateDailySalesDisplay();
            
            // Calculate estimated order total
            calculateEstimatedOrderTotal();
            
            // Refresh current view
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                switchTab(activeTab.dataset.tab);
            }
        }
        
        // Function to update location dropdown based on selected brands
        function updateLocationDropdown(dropdownId, selectedBrands) {
            const locationSelect = document.getElementById(dropdownId);
            if (!locationSelect) return;
            
            // Save currently selected locations
            const currentlySelected = Array.from(locationSelect.selectedOptions).map(opt => opt.value);
            
            // Clear current options
            locationSelect.innerHTML = '';
            
            // Get locations for selected brands
            const availableLocations = getLocationsByBrand(selectedBrands);
            
            // Add options
            availableLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                // Restore selection if it was previously selected
                option.selected = currentlySelected.includes(location);
                locationSelect.appendChild(option);
            });
            
            // If no locations are available, show a message
            if (availableLocations.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No locations available for selected brands';
                option.disabled = true;
                locationSelect.appendChild(option);
            }
        }

        // Prep List Items from Updated CSV
        const PREP_LIST_ITEMS = [
            // Walk-In Area
            { area: 'Walk-In', name: 'SAUCE POURED BINS', notes: '2 Full Bins = 1 WHITE BUCKET' },
            { area: 'Walk-In', name: 'SAUCE MADE WHITE BUCKETS', notes: '1 WHITE BUCKET = 2 BINS' },
            { area: 'Walk-IN', name: 'CHEESE BUCKETS', notes: '2 1/2 BLOCKS/BIN=Full Bin' },
            
            // Make Line Area
            { area: 'Make Line', name: 'PIZZA DICED TOMATOES', notes: '1/6 container (8 Tomatoes)' },
            { area: 'Make Line', name: 'PIZZA WHITE ONIONS', notes: '1/6 container (3-4 onions)' },
            { area: 'Make Line', name: 'PIZZA RED ONIONS', notes: '1/6 container (3-4 onions)' },
            { area: 'Make Line', name: 'PIZZA GREEN PEPPER', notes: '1/6 container, (8-12 GPs, depends on GP size)' },
            { area: 'Make Line', name: 'PIZZA MUSHROOMS', notes: '2 Cans= 1/3 Bin, Fully Drain' },
            { area: 'Make Line', name: 'PIZZA Ham', notes: 'Quarter ham' },
            { area: 'Make Line', name: 'PIZZA BLACK OLIVES', notes: '1/6= 1 bag, drain fully' },
            { area: 'Make Line', name: 'PIZZA PINEAPPLE', notes: '1/6= 1 bag, drain fully' },
            { area: 'Make Line', name: 'PIZZA Milder Pepper', notes: '1 jug =2 1/6 containers' },
            
            // Salad Area
            { area: 'SALAD', name: 'SALAD DICED TOMATOES', notes: '1/6 container (8 tomatoes)' },
            { area: 'SALAD', name: 'SALAD RED ONIONS SALADS', notes: '1/6 container (3-4 onions)' },
            { area: 'SALAD', name: 'SALAD GREEN PEPPER SALADS', notes: '1/6 container, (8-12 GPs, depends on GP size)' },
            { area: 'SALAD', name: 'HAM SALADS', notes: '1/6 Shallow' },
            { area: 'SALAD', name: 'SALAMI SALADS', notes: '1/6 shallow' },
            { area: 'SALAD', name: 'SALAD FETA', notes: '1/6 Shallow, roughly 1-2 blocks' },
            { area: 'SALAD', name: 'SALAD BLACK OLIVES', notes: '1/6= 1 bag, drain fully' },
            
            // Dressing Area
            { area: 'Dressing', name: 'SAUCE CUPS 4 OZ.', notes: '1 Bin=20 Cups' },
            { area: 'Dressing', name: 'RANCH POURED 4 OZ.', notes: '1 bin=20 Cups' },
            { area: 'Dressing', name: 'ITALIAN POURED 4 OZ.', notes: '1 bin=20 Cups' },
            { area: 'Dressing', name: 'GREEK POURED 4 OZ.', notes: '1 bin=20 Cups' },
            { area: 'Dressing', name: 'RANCH MADE 12 QT', notes: 'Let sit overnight before pouring!!' },
            { area: 'Dressing', name: 'ITALIAN MADE 6 QT', notes: 'Let sit overnight before pouring!!' }
        ];

        // Load custom users from localStorage only (no URL sharing)
        function loadSharedUsers() {
            try {
                const stored = localStorage.getItem('couchman_users');
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.log('No custom users found in localStorage');
                return {};
            }
        }

        function saveSharedUsers(users) {
            try {
                // Filter out global users, only save custom ones
                const customUsers = {};
                Object.entries(users).forEach(([email, user]) => {
                    if (!GLOBAL_USERS[email]) {
                        customUsers[email] = user;
                    }
                });
                
                // Save custom users to localStorage only
                localStorage.setItem('couchman_users', JSON.stringify(customUsers));
            } catch (e) {
                console.error('Failed to save shared users:', e);
            }
        }

        // Load users - simple function to get custom users from localStorage
        function loadUsers() {
            try {
                const customUsers = JSON.parse(localStorage.getItem('couchman_users') || '{}');
                return customUsers;
            } catch (e) {
                return {};
            }
        }

        // Save users - only save custom users to localStorage
        function saveUsers(users) {
            const customUsers = {};
            Object.entries(users).forEach(([email, user]) => {
                if (!GLOBAL_USERS[email]) {
                    customUsers[email] = user;
                }
            });
            localStorage.setItem('couchman_users', JSON.stringify(customUsers));
        }

        // Load and merge custom users with global users on startup
        const customUsers = loadUsers();
        Object.assign(USERS, customUsers);

        // Application state
        let currentTab = 'inventory';
        let currentArea = 'freezer';
        let inventoryData = {};
        let currentWeekStart = null; // Track current week being viewed
        let copiedWeekData = null; // Store copied schedule data
        let itemPricing = {}; // Store item pricing data
        
        // Monthly inventory management state
        let monthlyInventoryData = {}; // Store monthly inventory data
        let monthlyPricing = {}; // Store monthly pricing data
        let currentInventoryMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format

        // Schedule management state
        let employees = [];
        let scheduleData = {}; // Store schedule data by week
        let currentWeekSales = {
            mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0
        };

        // Complete inventory items - all categories
        const inventoryItems = {
            'freezer': [
                'BEEF TPNG (2x5 LB)',
                'SAUSAGE ITAL CHNK CKD (3x5 LB)',
                'SALAMI HARD SLC (2x5 LB)',
                'COOKIE 8" FAMILY STYLE HERSHEY CHOC CHIP (12x8")',
                'DESSERT PIZZA BROWNIE CHOC.CHIP 8" FMLY (12x8")',
                'CRUST PIZZA 10" DIE CUT X-CRSPY (2x40 CT)',
                'CRUST PIZZA 14" DIECUT X-CRSPY (30x14 IN)',
                'CRUST PIZZA 9" SEAS CAULIFLOWER GLTN FRE (60x9")',
                'CRUST PIZZA VEGAN GF 7X9 (20x7X9")',
                'WING CHIC RST FC (3x5 LB)',
                'CHICKEN FAJITA STRIP FC (2x5 LB)',
                'CHICKEN BNLS CHNK HMSTYL FC (2x5 LB)'
            ],
            'walkin': [
                'CHEESE MOZZ PS PC 104 (8x6.81 LB)',
                'CHEESE CHED SHRD (2x5 LB)',
                'CHEESE ROMANO GRTD EA (1x5 LB)',
                'CHEESE FETA DOMEST TUB (2x9 LB)',
                'BUTTERMILK 1/2 GAL (6x.5 GAL)',
                'BACON 3/8" PCS FC (4x5 LB)',
                'BACON CANADIAN STYLE SLC (5x2 LB)',
                'PEPPERONI ROSA GRANDE XTR SLC 16CT (1x10 LB)',
                'PEPPERONI SLC (2x12.5 LB)',
                'OLIVES KALAMATA SLC PAIL (1x10 LB)',
                'MAYO HVY DUTY (4x1 GAL)',
                'DRESSING BLUE CHS CUP (100x1.5 OZ)',
                'DRESSING RSPBRY VINAI FF PKT (60x1.5 OZ)',
                'SAUCE GARLIC CUP (128x1.25 OZ)',
                'DRESSING CATALINA PKT (60x1.5 OZ)'
            ],
            'foh': [
                'DESSERT ICING VANILLA REDI-PAK (12x2 LB)',
                'BUTTER FLAV WHIRL (3x1 GAL)',
                'MAYO SQUEEZE (12x22 OZ)',
                'CHEESE PARM PKT 3.5GM (200x3.5 GM)',
                'PEPPER RED CRSHD PKT 1GM (500x1 GM)',
                'ANCHOVIES IN OIL 13OZ (1x13 OZ)',
                'SPICE GARLIC GRANUL 6.5LB (1x6.5 LB)',
                'SPICE SESAME SEED HULLED WHOLE (1x21 OZ)',
                'SPICE CINNAMON SUGAR (1x22 OZ)',
                'SPICE CAJUN (1x24 OZ)',
                'LINER BASKET 8.5X11 PP COATD (1x2000 CT)',
                'CUTLERY KIT F/K BLK JETS (1x500 CT)',
                'BAG FOOD 6X3X12 (1x1000 CT)',
                'BAG PLAS TSHIRT JETS (1000 CT)',
                'BAG PRINT 6# JETS NK (1x500 CT)',
                'BAG PRINT 12# JETS (1x1000 CT)'
            ],
            'boh': [
                'SAUCE PIZZA JETS (6x#10)',
                'MUSHROOMS P&S (6x#10)',
                'OLIVES BLK RIPE SLC (1 CASE)',
                'OIL CORN JETS (1x35 LB)',
                'SAUCE BBQ ORIG (4x1 GAL)',
                'SAUCE BBQ HNY (4x1 GAL)',
                'VINEGAR 50 GR WHT (6x1 GAL)',
                'SALT GRANUL (1x25 LB)',
                'SUGAR 50# (1x50 LB)',
                'SAUCE WING BUFFALO REDHOT (4x1 GAL)',
                'SAUCE WNG REDHOT X-HOT BUFF (4x1 GAL)',
                'PEPPERS JALAPENO THIN SLC (4x1 GAL)',
                'DRESSING RANCH ORIG MIX (18x3.2 OZ)',
                'DRESSING ITALIAN MIX (12x7.6 OZ)',
                'DRESSING GREEK (4x1 GAL)',
                'SAUCE WNG SWT RED CHILI (4x1 GAL)',
                'FLOUR SQUARE PIZZA (1x50 LB)',
                'FLOUR RND PIZZA (1x50 LB)',
                'YEAST BAG ACTIVE DRY (1x2 LB)',
                'SEASONING SAUCE (12x26.7 OZ)',
                'PEPPERONCINI (4x1 GAL)',
                'PEPPERS RING MILD BANANA (4x1 GAL)',
                'PINEAPPLE TIDBITS L/S POUCH (6x81 OZ)',
                'BEETS SLC CAN (24x15 OZ)',
                'BOX PIZZA 18X13 JETS (50 BX)',
                'BOX WING 10" JETS (200 BX)',
                'BOX PIZZA 9X9 1C JETS (100 BX)',
                'BOX PIZZA 10X10 1C JETS (100 BX)',
                'BOX PIZZA 12X12 1C JETS (100 BX)',
                'BOX PIZZA 14X14 1C JETS (75 BX)',
                'BOX PIZZA 15X10.5 1C JETS (75 BX)',
                'BOX PIZZA SLC 1C JETS (200 BX)',
                'INSERTS PIZZA 9X9 (250 CT)',
                'INSERTS PIZZA 4.75X6.25 (500 CT)',
                'INSERTS PIZZA 11.75X11.75 (250 CT)',
                'INSERTS PIZZA 9.75X9.75 (250 CT)',
                'INSERTS PIZZA 10.25X14.75 (250 CT)',
                'INSERTS PIZZA 13.75X13.75 (250 CT)',
                'INSERTS PIZZA 12.75X17.75 (250 CT)',
                'CUP FOAM TALL 12OZ (1x1000 CT)',
                'NAPKIN XPRESSNAP WHT (12x500 CT)',
                'TOWEL PAPER CNTR PULL (1x6 CT)',
                'PLATE PAPER 8.5" JETS (2x250 CT)',
                'PAPER BATH TISSUE HI CAPACITY (1x36 CT)',
                'REGISTER RL THERM 3.13X230 (50 RL)',
                'LID PLAS 160OZ SQ JETS (1x50 CT)',
                'CUP SOUFFLE 4OZ (20x125 CT)',
                'LID PLAS SOUFFLE 3.25/4OZ (20x125 CT)',
                'FILM 24X2000 SLIDE CUTTER (1 RL)',
                'LINER 38X58 CLR 55GAL .75 MIL (1x100 CT)',
                'LINER 38X58 BLK 55GAL .9 MIL (1x100 CT)',
                'BOWL PLAS 160OZ SQ JETS (1x50 CT)',
                'BOWL PLAS 48OZ SQ JETS (1x200 CT)',
                'BOWL PLAS 24OZ SQ JETS (1x200 CT)',
                'SUPPORT PIZ BX LID 1.75 JETS (1x1000 CT)',
                'TONGS PLAS 9" BLK (48 CT)',
                'GLOVE VINYL XLG PWDR FREE (10x100 CT)',
                'GLOVE VINYL MED PWDR FREE (10x100 CT)',
                'GLOVE VINYL LG PWDR FREE (10x100 CT)',
                'LID PLAS 24/48OZ SQ JETS (1x200 CT)',
                'CLEANER MANUAL POT/PAN DETERG (4x1 GAL)',
                'CLEANER LIQ HAND SOAP (2x1 GAL)',
                'SANITIZER BROAD RANGE QUAT (3x1 GAL)',
                'CLEANER FINISHED FLOOR (3x1 GAL)',
                'CLEANER 3-N-1 ALL PURP (3x1 GAL)',
                'TEST STRIPS SANITIZER (2x15FT RL)',
                'PAD SCRUB YELL/GRN MED (1x20 CT)',
                'PAD SCRUB STNLS STEEL (1x12 CT)',
                'CLEANER STNLS STEEL (6x16 OZ)',
                'GLOVE OVEN NEOPRENE COATD PAIR (1 PR)',
                'STICKER REMOVABLE SUNDAY 1" (1 RL)',
                'STICKER REMOVABLE MONDAY 1" (1 RL)',
                'STICKER REMOVABLE TUESDAY 1" (1 RL)',
                'STICKER REMOVABLE WEDNESDAY 1" (1 RL)',
                'STICKER REMOVABLE THURSDAY 1" (1 RL)',
                'STICKER REMOVABLE FRIDAY 1" (1 RL)',
                'STICKER REMOVABLE SATURDAY 1" (1 RL)',
                'BOTTLE SQZ 12OZ JETS (1x24 CT)'
            ],
            'produce': [
                'Pre Cut Lettuce Romaine/Iceberg Blend',
                'Iceberg Lettuce Whole',
                'Romaine Lettuce',
                'Whole Tomatoes',
                'Grape Tomatoes',
                '10 lb Green Pepper Box',
                'White Onion',
                'Red Onion'
            ],
            'soda': [
                '20 oz. Coke',
                '20 oz. Diet Coke',
                '20 oz. Cherry Coke',
                '20 oz. Sprite',
                '20 oz. Mellow Yellow',
                '20 oz. Minute Made Lemonade',
                '20 oz. Barq\'s Root Beer',
                '20 oz. Dr Pepper (varies)',
                '20 oz. Diet Dr Pepper (varies)',
                '20 oz. Coke Zero',
                '20 oz. Cherry Coke Zero',
                '20 oz. Sprite Zero',
                '20 oz. Dasani Water',
                '2 Liter Coke',
                '2 Liter Diet Coke',
                '2 Liter Cherry Coke',
                '2 Liter Sprite',
                '2 Liter Mellow Yellow',
                '2 Liter Minute Made Lemonade',
                '2 Liter Barq\'s Root Beer',
                '2 Liter Dr Pepper (varies)',
                '2 Liter Diet Dr Pepper (varies)',
                '2 Liter Coke Zero',
                'Specialty Blue Powerade',
                'Specialty Red Powerade',
                'Specialty Tea',
                'Specialty Sweet Tea',
                'Specialty Smart Water'
            ]
        };

        // DOM elements
        const authContainer = document.getElementById('authContainer');
        const mainApp = document.getElementById('mainApp');
        const authForm = document.getElementById('authForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const currentUserSpan = document.getElementById('currentUser');
        const logoutBtn = document.getElementById('logoutBtn');
        const projectedSalesInput = document.getElementById('projectedSales');
        const projectedBudgetDiv = document.getElementById('projectedBudget');
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserModal = document.getElementById('addUserModal');
        const usersTab = document.getElementById('usersTab');

        // Prep List Functions
        async function loadPrepList() {
            const date = document.getElementById('prepListDate').value;
            const day = document.getElementById('prepListDay').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const location = getCurrentLocation();
            if (!location) {
                alert('Please select a location first');
                return;
            }
            
            try {
                // Load prep list from database
                const prepListResult = await DB_API.prepLists.get({ 
                    location: location, 
                    prep_date: date 
                });
                
                const prepData = prepListResult.length > 0 ? prepListResult[0].items : {};
                
                // Load par levels from database
                const parListResult = await DB_API.parLists.get({ 
                    location: location, 
                    day_of_week: day 
                });
                
                const parLevels = parListResult.length > 0 ? parListResult[0].par_levels : {};
                
                renderPrepList(prepData, parLevels);
                
                // Calculate all prep amounts after rendering
                setTimeout(() => {
                    calculateAllPrepAmounts();
                }, 100);
            } catch (error) {
                console.error('Error loading prep list:', error);
                alert('Failed to load prep list. Please try again.');
            }
        }
        
        async function savePrepList() {
            const date = document.getElementById('prepListDate').value;
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const location = getCurrentLocation();
            if (!location) {
                alert('Please select a location first');
                return;
            }
            
            const prepData = {};
            document.querySelectorAll('#prepListContainer input').forEach(input => {
                const item = input.dataset.item;
                const field = input.dataset.field;
                if (!prepData[item]) prepData[item] = {};
                prepData[item][field] = input.value;
            });
            
            // Get any notes from the textarea if it exists
            const notesTextarea = document.querySelector('#prepListNotes');
            const notes = notesTextarea ? notesTextarea.value : '';
            
            try {
                await DB_API.prepLists.save({
                    location: location,
                    prep_date: date,
                    items: prepData,
                    notes: notes
                });
                alert('Prep list saved successfully!');
            } catch (error) {
                console.error('Error saving prep list:', error);
                alert('Failed to save prep list. Please try again.');
            }
        }
        
        async function printPrepList() {
            const date = document.getElementById('prepListDate').value;
            const day = document.getElementById('prepListDay').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            // Generate fresh print content with current values
            const printHTML = await generatePrintablePrepList(date, day);
            
            const printWindow = window.open('', '', 'height=800,width=1200');
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Auto-print after content loads
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }
        
        async function generatePrintablePrepList(date, day) {
            // Get current data from inputs
            const currentPrepData = {};
            document.querySelectorAll('#prepListContainer input').forEach(input => {
                const item = input.dataset.item;
                const field = input.dataset.field;
                if (!currentPrepData[item]) currentPrepData[item] = {};
                currentPrepData[item][field] = input.value;
            });
            
            // Get par levels from database for the selected day and location
            const location = getCurrentLocation();
            let parLevels = {};
            
            try {
                const parListResult = await DB_API.parLists.get({ 
                    location: location, 
                    day_of_week: day 
                });
                parLevels = parListResult.length > 0 ? parListResult[0].par_levels : {};
            } catch (error) {
                console.error('Error loading par levels for print:', error);
                // Fallback to localStorage if database fails
                const parKey = `parLevels_${currentUser.email}_${day}`;
                parLevels = JSON.parse(localStorage.getItem(parKey) || '{}');
            }
            
            // Group items by area
            const itemsByArea = {};
            PREP_LIST_ITEMS.forEach(item => {
                if (!itemsByArea[item.area]) {
                    itemsByArea[item.area] = [];
                }
                itemsByArea[item.area].push(item);
            });
            
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daily Prep List - ${date}</title>
                    <style>
                        @page {
                            size: portrait;
                            margin: 0.5in;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                            font-size: 12px;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 3px solid #2c3e50;
                            padding-bottom: 15px;
                        }
                        
                        .header h1 {
                            margin: 0;
                            color: #2c3e50;
                            font-size: 24px;
                        }
                        
                        .header h2 {
                            margin: 5px 0;
                            color: #666;
                            font-size: 16px;
                            font-weight: normal;
                        }
                        
                        .area-section {
                            margin-bottom: 25px;
                            page-break-inside: avoid;
                        }
                        
                        .area-header {
                            background-color: #2c3e50;
                            color: white;
                            padding: 10px;
                            margin: 0;
                            border-radius: 5px 5px 0 0;
                            font-size: 16px;
                            font-weight: bold;
                        }
                        
                        .prep-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 15px;
                        }
                        
                        .prep-table th {
                            background-color: #f8f9fa;
                            padding: 10px 8px;
                            text-align: left;
                            font-weight: bold;
                            border: 1px solid #ddd;
                        }
                        
                        .prep-table td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            vertical-align: top;
                        }
                        
                        .item-name {
                            font-weight: bold;
                            color: #2c3e50;
                        }
                        
                        .notes {
                            font-size: 11px;
                            color: #666;
                            font-style: italic;
                        }
                        
                        .number-field {
                            text-align: center;
                            font-weight: bold;
                            min-width: 60px;
                        }
                        
                        .prep-amount {
                            background-color: #fff3cd;
                            font-weight: bold;
                            color: #856404;
                        }
                        
                        .container-size {
                            background-color: #e3f2fd;
                            font-weight: 500;
                            text-align: center;
                        }
                        
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            color: #666;
                            font-size: 10px;
                            border-top: 1px solid #ddd;
                            padding-top: 10px;
                        }
                        
                        @media print {
                            body { margin: 0; padding: 15px; }
                            .area-section { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Couchman Companies QSR Navigator - Daily Prep List</h1>
                        <h2>${date} (${day.charAt(0).toUpperCase() + day.slice(1)})</h2>
                    </div>`;
            
            // Render each area
            Object.keys(itemsByArea).forEach(area => {
                html += `<div class="area-section">
                    <h3 class="area-header">${area}</h3>
                    <table class="prep-table">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Item</th>
                                <th style="width: 28%;">Notes</th>
                                <th style="width: 10%;">Par Level</th>
                                <th style="width: 12%;">Current Stock</th>
                                <th style="width: 12%;">Prep Amount</th>
                                <th style="width: 18%;">Container Size</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                // Separate items by prep status for better organization
                const itemsNeedingPrep = [];
                const itemsAdequatelyStocked = [];
                const itemsNoData = [];
                
                itemsByArea[area].forEach(item => {
                    const itemData = currentPrepData[item.name] || {};
                    const parLevelData = parLevels[item.name] || {};
                    const parLevel = typeof parLevelData === 'object' ? (parseFloat(parLevelData.level) || 0) : (parseFloat(parLevelData) || 0);
                    const currentStock = parseFloat(itemData.currentStock) || 0;
                    
                    if (currentStock === 0) {
                        itemsNoData.push(item);
                    } else if (parLevel > 0 && currentStock < (parLevel * 0.65)) {
                        itemsNeedingPrep.push(item);
                    } else if (parLevel > 0 && currentStock >= (parLevel * 0.65)) {
                        itemsAdequatelyStocked.push(item);
                    } else {
                        itemsNoData.push(item);
                    }
                });
                
                // Render items needing prep first (priority)
                const allItems = [...itemsNeedingPrep, ...itemsNoData, ...itemsAdequatelyStocked];
                
                if (allItems.length === 0) {
                    html += `<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666; font-style: italic;">No items configured for this area</td></tr>`;
                } else {
                    allItems.forEach(item => {
                        const itemData = currentPrepData[item.name] || {};
                        const parLevelData = parLevels[item.name] || {};
                        
                        // Debug logging for container size issue
                        if (item.name === 'SAUCE POURED BINS') {
                            console.log('SAUCE POURED BINS parLevelData:', parLevelData);
                        }
                        
                        const parLevel = typeof parLevelData === 'object' ? (parseFloat(parLevelData.level) || 0) : (parseFloat(parLevelData) || 0);
                        const containerSize = typeof parLevelData === 'object' && parLevelData.containerSize ? parLevelData.containerSize : '';
                        const currentStock = parseFloat(itemData.currentStock) || 0;
                        const prepAmount = itemData.prepAmount || '';
                        const stockPercentage = parLevel > 0 && currentStock > 0 ? ((currentStock / parLevel) * 100).toFixed(1) : '';
                        
                        const needsPrep = parLevel > 0 && currentStock > 0 && (currentStock < (parLevel * 0.65));
                        const isAdequatelyStocked = parLevel > 0 && currentStock > 0 && (currentStock >= (parLevel * 0.65));
                        
                        let rowClass = '';
                        let statusText = '';
                        let statusColor = '';
                        
                        if (needsPrep) {
                            rowClass = 'style="background-color: #fff3cd;"';
                            statusText = '⚠️ PREP NEEDED';
                            statusColor = '#856404';
                        } else if (isAdequatelyStocked) {
                            rowClass = 'style="background-color: #d4edda;"';
                            statusText = '✅ ADEQUATELY STOCKED';
                            statusColor = '#155724';
                        }
                        
                        html += `<tr ${rowClass}>
                            <td class="item-name">
                                ${item.name}
                                ${statusText ? `<br><small style="color: ${statusColor};">${statusText}</small>` : ''}
                            </td>
                            <td class="notes">${item.notes}</td>
                            <td class="number-field">${parLevel}</td>
                            <td class="number-field">
                                ${currentStock || ''}
                                ${stockPercentage ? `<br><small style="color: #666;">${stockPercentage}% of par</small>` : ''}
                            </td>
                            <td class="number-field prep-amount">${prepAmount}</td>
                            <td class="container-size">${containerSize || 'Not Set'}</td>
                        </tr>`;
                    });
                }
                
                html += '</tbody></table></div>';
            });
            
            html += `<div class="footer">
                        Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()} | Couchman Companies QSR Navigator Restaurant Management System
                    </div>
                </body>
                </html>`;
            
            return html;
        }
        
        function renderPrepList(prepData, parLevels) {
            const container = document.getElementById('prepListContainer');
            
            // Group items by area
            const itemsByArea = {};
            PREP_LIST_ITEMS.forEach(item => {
                if (!itemsByArea[item.area]) {
                    itemsByArea[item.area] = [];
                }
                itemsByArea[item.area].push(item);
            });
            
            let html = '';
            
            // Render each area as a separate section
            Object.keys(itemsByArea).forEach(area => {
                html += `<div style="margin-bottom: 30px;">
                    <h3 style="background-color: #2c3e50; color: white; padding: 10px; margin: 0; border-radius: 5px 5px 0 0;">
                        ${area}
                    </h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="border: 1px solid #ddd; padding: 8px; width: 20%;">Item</th>
                                <th style="border: 1px solid #ddd; padding: 8px; width: 25%;">Notes</th>
                                <th style="border: 1px solid #ddd; padding: 8px; width: 12%;">Par Level</th>
                                <th style="border: 1px solid #ddd; padding: 8px; width: 13%;">Current Stock</th>
                                <th style="border: 1px solid #ddd; padding: 8px; width: 13%;">Prep Amount</th>
                                <th style="border: 1px solid #ddd; padding: 8px; width: 17%;">Container Size</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                itemsByArea[area].forEach(item => {
                    const itemData = prepData[item.name] || {};
                    const parLevelData = parLevels[item.name] || {};
                    const parLevel = typeof parLevelData === 'object' ? (parseFloat(parLevelData.level) || 0) : (parseFloat(parLevelData) || 0);
                    const containerSize = typeof parLevelData === 'object' && parLevelData.containerSize ? parLevelData.containerSize : '';
                    const currentStock = parseFloat(itemData.currentStock) || 0;
                    const prepAmount = itemData.prepAmount || '';
                    
                    // Determine if item needs prep (current stock < 65% of par level)
                    const needsPrep = parLevel > 0 && currentStock > 0 && (currentStock < (parLevel * 0.65));
                    const isAdequatelyStocked = parLevel > 0 && currentStock > 0 && (currentStock >= (parLevel * 0.65));
                    const stockPercentage = parLevel > 0 && currentStock > 0 ? ((currentStock / parLevel) * 100).toFixed(1) : 0;
                    
                    // Determine row styling and status
                    let rowStyle = '';
                    let statusIcon = '';
                    let statusColor = '';
                    
                    if (needsPrep) {
                        rowStyle = 'background-color: #fff3cd;'; // Yellow for prep needed
                        statusIcon = '⚠️ PREP NEEDED';
                        statusColor = '#856404';
                    } else if (isAdequatelyStocked) {
                        rowStyle = 'background-color: #d4edda;'; // Light green for adequately stocked
                        statusIcon = '✅ ADEQUATELY STOCKED';
                        statusColor = '#155724';
                    }
                    
                    html += `<tr style="${rowStyle}">
                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">
                            ${item.name}
                            ${statusIcon ? `<br><small style="color: ${statusColor}; font-weight: normal;">${statusIcon}</small>` : ''}
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px; font-size: 12px; color: #666;">${item.notes}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${parLevel}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <input type="number" value="${currentStock || ''}" data-item="${item.name}" data-field="currentStock" 
                                   style="width: 80px; border: 1px solid #ddd; padding: 4px;" 
                                   onchange="calculatePrepAmount('${item.name}'); refreshPrepList();" step="0.01" min="0">
                            ${currentStock > 0 && parLevel > 0 ? `<br><small style="color: #666;">${stockPercentage}% of par</small>` : ''}
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <input type="number" value="${prepAmount}" data-item="${item.name}" data-field="prepAmount" 
                                   style="width: 80px; border: 1px solid #ddd; padding: 4px; background-color: #f0f8ff;" 
                                   readonly step="0.01" title="Auto-calculated: Par Level - Current Stock">
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <span style="background-color: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-weight: 500;">
                                ${containerSize || 'Not Set'}
                            </span>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
            });
            
            container.innerHTML = html;
        }
        
        async function loadParConfig() {
            const day = document.getElementById('parConfigDay').value;
            const location = getCurrentLocation();
            
            if (!location) {
                alert('Please select a location first');
                return;
            }
            
            try {
                // Load par levels from database
                const parListResult = await DB_API.parLists.get({ 
                    location: location, 
                    day_of_week: day 
                });
                
                const parLevels = parListResult.length > 0 ? parListResult[0].par_levels : {};
                
                renderParConfig(parLevels);
            } catch (error) {
                console.error('Error loading par levels:', error);
                alert('Failed to load par levels. Please try again.');
            }
        }
        
        async function saveParConfig() {
            const day = document.getElementById('parConfigDay').value;
            const location = getCurrentLocation();
            
            if (!location) {
                alert('Please select a location first');
                return;
            }
            
            // Debug logging
            console.log('Current user:', currentUser);
            console.log('User role:', currentUser?.role);
            console.log('Role as int:', parseInt(currentUser?.role));
            
            // Check permissions - only security code 3+ can save par levels
            const userSecurityCode = currentUser && typeof getSecurityCodeForRole !== 'undefined' 
                ? getSecurityCodeForRole(currentUser.role) 
                : parseInt(currentUser.role || 0);
            
            if (!currentUser || userSecurityCode < 3) {
                const roleDisplay = currentUser ? currentUser.role : 'unknown';
                const securityCodeDisplay = currentUser ? userSecurityCode : 'unknown';
                alert(`Only General Managers (3), Admins (4), and Super Admins (5) can modify par levels. Your role: ${roleDisplay} (Security Code: ${securityCodeDisplay})`);
                return;
            }
            
            const parData = {};
            
            // Collect both par levels and container sizes
            document.querySelectorAll('#parConfigContainer input[data-field="level"]').forEach(input => {
                const item = input.dataset.item;
                const containerSelect = document.querySelector(`#parConfigContainer select[data-item="${item}"][data-field="containerSize"]`);
                const level = parseFloat(input.value) || 0;
                const containerSize = containerSelect ? containerSelect.value : '';
                
                if (level > 0 || containerSize) {
                    parData[item] = {
                        level: level,
                        containerSize: containerSize
                    };
                }
            });
            
            try {
                await DB_API.parLists.save({
                    location: location,
                    day_of_week: day,
                    par_levels: parData
                });
                alert('Par levels saved successfully!');
            } catch (error) {
                console.error('Error saving par levels:', error);
                alert('Failed to save par levels. Please try again.');
            }
        }
        
        function renderParConfig(parLevels) {
            const container = document.getElementById('parConfigContainer');
            
            // Group items by area
            const itemsByArea = {};
            PREP_LIST_ITEMS.forEach(item => {
                if (!itemsByArea[item.area]) {
                    itemsByArea[item.area] = [];
                }
                itemsByArea[item.area].push(item);
            });
            
            let html = '';
            
            // Render each area as a separate section
            Object.keys(itemsByArea).forEach(area => {
                html += `<div style="margin-bottom: 30px;">
                    <h3 style="background-color: #2c3e50; color: white; padding: 10px; margin: 0; border-radius: 5px 5px 0 0;">
                        ${area}
                    </h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="border: 1px solid #ddd; padding: 8px; width: 25%;">Item</th>
                                <th style="border: 1px solid #ddd; padding: 8px; width: 35%;">Notes</th>
                                <th style="border: 1px solid #ddd; padding: 8px; width: 15%;">Par Level</th>
                                <th style="border: 1px solid #ddd; padding: 8px; width: 25%;">Container Size</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                itemsByArea[area].forEach(item => {
                    const parLevelData = parLevels[item.name] || {};
                    const parLevel = typeof parLevelData === 'object' ? (parLevelData.level || '') : parLevelData;
                    const containerSize = typeof parLevelData === 'object' ? (parLevelData.containerSize || '') : '';
                    const userSecurityCode = currentUser && typeof getSecurityCodeForRole !== 'undefined' 
                        ? getSecurityCodeForRole(currentUser.role) 
                        : parseInt(currentUser?.role || 0);
                    const isReadOnly = !currentUser || userSecurityCode < 3;
                    
                    html += `<tr>
                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${item.name}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; font-size: 12px; color: #666;">${item.notes}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <input type="number" value="${parLevel}" data-item="${item.name}" data-field="level"
                                   style="width: 100px; border: 1px solid #ddd; padding: 4px; ${isReadOnly ? 'background-color: #f8f9fa; cursor: not-allowed;' : ''}" 
                                   step="0.01" min="0"
                                   ${isReadOnly ? 'readonly disabled' : ''}>
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <select data-item="${item.name}" data-field="containerSize"
                                    style="width: 100%; border: 1px solid #ddd; padding: 4px; ${isReadOnly ? 'background-color: #f8f9fa; cursor: not-allowed;' : ''}"
                                    ${isReadOnly ? 'disabled' : ''}>
                                <option value="">Select Size</option>
                                <option value="Full Bin" ${containerSize === 'Full Bin' ? 'selected' : ''}>Full Bin</option>
                                <option value="1/2 Bin" ${containerSize === '1/2 Bin' ? 'selected' : ''}>1/2 Bin</option>
                                <option value="1/3 Bin" ${containerSize === '1/3 Bin' ? 'selected' : ''}>1/3 Bin</option>
                                <option value="1/6 Bin" ${containerSize === '1/6 Bin' ? 'selected' : ''}>1/6 Bin</option>
                                <option value="1/6 Bin Shallow" ${containerSize === '1/6 Bin Shallow' ? 'selected' : ''}>1/6 Bin Shallow</option>
                                <option value="12 qt bin" ${containerSize === '12 qt bin' ? 'selected' : ''}>12 qt bin</option>
                                <option value="6 qt bin" ${containerSize === '6 qt bin' ? 'selected' : ''}>6 qt bin</option>
                            </select>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
            });
            
            container.innerHTML = html;
            
            // Show/hide save button based on permissions
            const saveButton = document.querySelector('button[onclick="saveParConfig()"]');
            if (saveButton) {
                const userSecurityCode = currentUser && typeof getSecurityCodeForRole !== 'undefined' 
                    ? getSecurityCodeForRole(currentUser.role) 
                    : parseInt(currentUser?.role || 0);
                const canEdit = currentUser && userSecurityCode >= 3;
                saveButton.style.display = canEdit ? 'inline-block' : 'none';
                
                // Add a notice for read-only users
                if (!canEdit) {
                    const existingNotice = document.querySelector('.par-readonly-notice');
                    if (!existingNotice) {
                        const notice = document.createElement('div');
                        notice.className = 'par-readonly-notice';
                        notice.style.cssText = 'text-align: center; margin-top: 20px; padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; color: #721c24;';
                        notice.innerHTML = '<i class="fas fa-lock"></i> Par levels are read-only. Only General Managers (3), Admins (4), and Super Admins (5) can modify these settings.';
                        const saveButtonParent = saveButton.parentElement.parentElement;
                        saveButtonParent.appendChild(notice);
                    }
                }
            }
        }
        
        // Calculate prep amount when current stock changes
        async function calculatePrepAmount(itemName) {
            const day = document.getElementById('prepListDay').value;
            const location = getCurrentLocation();
            
            if (!location) return;
            
            try {
                // Get par levels from current view or database
                const parListResult = await DB_API.parLists.get({ 
                    location: location, 
                    day_of_week: day 
                });
                
                const parLevels = parListResult.length > 0 ? parListResult[0].par_levels : {};
                const parLevelData = parLevels[itemName] || {};
                const parLevel = typeof parLevelData === 'object' ? (parseFloat(parLevelData.level) || 0) : (parseFloat(parLevelData) || 0);
                
                const currentStockInput = document.querySelector(`input[data-item="${itemName}"][data-field="currentStock"]`);
                const prepAmountInput = document.querySelector(`input[data-item="${itemName}"][data-field="prepAmount"]`);
                
                if (currentStockInput && prepAmountInput) {
                    const currentStock = parseFloat(currentStockInput.value) || 0;
                    const prepAmount = Math.max(0, parLevel - currentStock); // Don't allow negative prep amounts
                    
                    prepAmountInput.value = prepAmount.toFixed(2);
                    
                    // Auto-save the calculated prep amount to database
                    const date = document.getElementById('prepListDate').value;
                    if (date) {
                        // Get current prep data
                        const prepListResult = await DB_API.prepLists.get({ 
                            location: location, 
                            prep_date: date 
                        });
                        
                        const prepData = prepListResult.length > 0 ? prepListResult[0].items : {};
                        
                        if (!prepData[itemName]) prepData[itemName] = {};
                        prepData[itemName].currentStock = currentStock.toFixed(2);
                        prepData[itemName].prepAmount = prepAmount.toFixed(2);
                        
                        // Save to database
                        await DB_API.prepLists.save({
                            location: location,
                            prep_date: date,
                            items: prepData,
                            notes: prepListResult.length > 0 ? prepListResult[0].notes : ''
                        });
                    }
                }
            } catch (error) {
                console.error('Error calculating prep amount:', error);
            }
        }
        
        // Calculate all prep amounts when prep list is loaded
        async function calculateAllPrepAmounts() {
            const day = document.getElementById('prepListDay').value;
            const location = getCurrentLocation();
            
            if (!location) return;
            
            try {
                // Get par levels from database
                const parListResult = await DB_API.parLists.get({ 
                    location: location, 
                    day_of_week: day 
                });
                
                const parLevels = parListResult.length > 0 ? parListResult[0].par_levels : {};
                
                PREP_LIST_ITEMS.forEach(item => {
                    const parLevelData = parLevels[item.name] || {};
                    const parLevel = typeof parLevelData === 'object' ? (parseFloat(parLevelData.level) || 0) : (parseFloat(parLevelData) || 0);
                    const currentStockInput = document.querySelector(`input[data-item="${item.name}"][data-field="currentStock"]`);
                    const prepAmountInput = document.querySelector(`input[data-item="${item.name}"][data-field="prepAmount"]`);
                    
                    if (currentStockInput && prepAmountInput && parLevel > 0) {
                        const currentStock = parseFloat(currentStockInput.value) || 0;
                        const prepAmount = Math.max(0, parLevel - currentStock);
                        prepAmountInput.value = prepAmount.toFixed(2);
                    }
                });
            } catch (error) {
                console.error('Error calculating all prep amounts:', error);
            }
        }
        
        // Refresh prep list to show/hide items based on current stock levels
        async function refreshPrepList() {
            const date = document.getElementById('prepListDate').value;
            const day = document.getElementById('prepListDay').value;
            const location = getCurrentLocation();
            
            if (!date || !location) return;
            
            // Collect current data before refresh
            const currentPrepData = {};
            document.querySelectorAll('#prepListContainer input').forEach(input => {
                const item = input.dataset.item;
                const field = input.dataset.field;
                if (!currentPrepData[item]) currentPrepData[item] = {};
                currentPrepData[item][field] = input.value;
            });
            
            try {
                // Get par levels from database
                const parListResult = await DB_API.parLists.get({ 
                    location: location, 
                    day_of_week: day 
                });
                
                const parLevels = parListResult.length > 0 ? parListResult[0].par_levels : {};
                
                // Re-render with current data
                renderPrepList(currentPrepData, parLevels);
                
                // Recalculate amounts
                setTimeout(() => {
                    calculateAllPrepAmounts();
                }, 50);
            } catch (error) {
                console.error('Error refreshing prep list:', error);
            }
        }

        // Load saved users from localStorage
        
        // Initialize app
        function initApp() {
            // Initialize usersData with all users
            usersData = { ...USERS };
            
            updateBudgetDisplay();
            
            
            renderUsersTable();
            addEventListeners();
            
            // Ensure URL is updated with any existing inventory data
            updateSharedDataUrl();
            
            // Note: loadInventoryData() is called after login in showMainApp()
        }
        
        // No URL syncing needed - users are local only

        // Load user-specific inventory data
        function loadInventoryData(userEmail = null) {
            if (!userEmail && currentUser) {
                userEmail = currentUser.email;
            }
            
            if (!userEmail) {
                // No user logged in, initialize empty
                inventoryData = {};
                return;
            }
            
            // Load from localStorage for this specific user and location
            const storageKey = getLocationStorageKey('couchman_inventory', userEmail);
            // console.log('Loading inventory from key:', storageKey);
            const savedInventory = localStorage.getItem(storageKey);
            
            // Debug: Show all inventory keys in localStorage
            const allKeys = Object.keys(localStorage).filter(key => key.includes('couchman_inventory'));
            // console.log('All inventory keys in localStorage:', allKeys);
            
            if (savedInventory) {
                inventoryData = JSON.parse(savedInventory);
            } else {
                // First time for this user - initialize with sample data
                inventoryData = {};
                Object.keys(inventoryItems).forEach(area => {
                    inventoryItems[area].forEach(item => {
                        inventoryData[item] = {
                            par: Math.floor(Math.random() * 10) + 1,
                            have: Math.floor(Math.random() * 8),
                            area: area,
                            lastModified: new Date().toISOString(),
                            modifiedBy: userEmail
                        };
                    });
                });
                // Save the initial data
                saveInventoryData(userEmail);
            }
        }

        // Save user-specific inventory data
        function saveInventoryData(userEmail = null) {
            if (!userEmail && currentUser) {
                userEmail = currentUser.email;
            }
            
            if (!userEmail) {
                console.error('Cannot save inventory: no user specified');
                return;
            }
            
            const storageKey = getLocationStorageKey('couchman_inventory', userEmail);
            // console.log('Saving inventory to key:', storageKey);
            localStorage.setItem(storageKey, JSON.stringify(inventoryData));
            
            // Inventory saved locally only (no URL updates needed)
        }

        function loadPricingData(userEmail) {
            const storageKey = getLocationStorageKey('itemPricing', userEmail);
            const savedPricing = localStorage.getItem(storageKey);
            if (savedPricing) {
                itemPricing = JSON.parse(savedPricing);
            }
        }
        
        // No URL sharing - keep all data local to avoid long URLs
        function updateSharedDataUrl() {
            // Remove any URL fragments to keep URLs clean
            if (window.location.hash) {
                window.location.hash = '';
            }
        }

        // Utility functions
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
            setTimeout(() => successMessage.classList.add('hidden'), 3000);
        }

        // Clear localStorage and reset to defaults
        function resetToDefaults() {
            localStorage.removeItem('couchman_users');
            localStorage.removeItem('couchman_users');
            // Clear all inventory data
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('couchman_inventory_')) {
                    localStorage.removeItem(key);
                }
            });
            window.location.hash = '';
            window.location.reload();
        }

        // Simple authentication - check email and password
        async function handleAuth(email, password) {
            const userEmail = email.toLowerCase();
            
            try {
                // First check local USERS cache (includes GLOBAL_USERS and loaded database users)
                if (USERS[userEmail] && USERS[userEmail].password === password) {
                    const user = USERS[userEmail];
                    setCurrentUser(userEmail, user);
                    return;
                }
                
                // If not in cache, check database for custom users
                console.log('User not in cache, checking database...');
                const dbUsers = await DB_API.users.get(userEmail);
                console.log('Database response:', dbUsers);
                if (dbUsers && dbUsers.length > 0) {
                    const dbUser = dbUsers[0];
                    console.log('Found user in database:', dbUser.email);
                    console.log('Full user object:', JSON.stringify(dbUser, null, 2));
                    
                    // Check password
                    console.log('Checking password - DB:', dbUser.password, 'Input:', password, 'Match:', dbUser.password === password);
                    if (dbUser.password === password) {
                        // Parse brands and locations from JSON strings
                        const user = {
                            id: dbUser.id,
                            name: dbUser.name,
                            role: dbUser.role,
                            password: dbUser.password,
                            brands: typeof dbUser.brands === 'string' ? JSON.parse(dbUser.brands) : dbUser.brands,
                            locations: typeof dbUser.locations === 'string' ? JSON.parse(dbUser.locations) : dbUser.locations
                        };
                        
                        // Update local cache
                        USERS[userEmail] = user;
                        setCurrentUser(userEmail, user);
                        return;
                    } else {
                        console.log('Password mismatch for user:', userEmail);
                    }
                } else {
                    console.log('User not found in database:', userEmail);
                }
                
                showError('Invalid email or password');
            } catch (error) {
                console.error('Authentication error:', error);
                showError('Authentication failed. Please check your connection and try again.');
            }
        }
        
        function setCurrentUser(userEmail, user) {
            // Set current user
            currentUser = {
                email: userEmail,
                name: user.name,
                role: user.role,
                brands: user.brands || [],
                locations: user.locations || [],
                password: user.password
            };
            
            // Check for RBAC integration
            if (typeof UserWithPermissions !== 'undefined') {
                try {
                    const enhancedUser = new UserWithPermissions(userEmail, currentUser);
                    currentUser.rbac = enhancedUser;
                    currentUser.role = enhancedUser.role;
                    currentUser.brands = enhancedUser.brands;
                    currentUser.locations = enhancedUser.locations;
                } catch (e) {
                    console.log('RBAC integration error:', e.message);
                }
            }
            
            // Save to localStorage - map role names to security codes
            const roleToSecurityCode = {
                'super_admin': 5,
                'admin': 4,
                'general_manager': 3,
                'manager': 2,
                'staff': 1
            };
            
            // Get the correct security code for the role
            let securityCode = roleToSecurityCode[currentUser.role];
            if (securityCode === undefined) {
                // If role is already a number, use it directly
                securityCode = parseInt(currentUser.role) || 1;
            }
            
            localStorage.setItem('currentUser', JSON.stringify({
                email: currentUser.email,
                name: currentUser.name,
                role: currentUser.role,  // Store the original role name (e.g., 'super_admin')
                securityCode: securityCode,  // Also store the numeric security code
                brands: currentUser.brands,
                locations: currentUser.locations
            }));
            
            // Setup brand/location selectors
            setupLocationSelector();
            
            // Force location selector to show on mobile for super_admin and admin
            setTimeout(() => {
                const adminRoles = ['super_admin', 'admin', 'general_manager'];
                if (window.innerWidth <= 768 && adminRoles.includes(currentUser.role)) {
                    const locationSelector = document.getElementById('locationSelector');
                    if (locationSelector) {
                        locationSelector.classList.remove('hidden');
                        locationSelector.style.display = 'flex';
                        locationSelector.style.visibility = 'visible';
                        console.log('Forced location selector visible on mobile for admin user');
                    }
                }
            }, 100);
            
            // Load user interface
            authContainer.classList.add('hidden');
            mainApp.classList.remove('hidden');
            currentUserSpan.textContent = currentUser.name;
            
            // Apply RBAC permissions if available
            if (typeof updateUIBasedOnPermissions !== 'undefined') {
                updateUIBasedOnPermissions(currentUser);
            }
            if (currentUser.rbac && typeof updateRoleBadge !== 'undefined') {
                updateRoleBadge(currentUser.rbac);
            }
            if (typeof setupToolVisibility !== 'undefined') {
                setupToolVisibility();
            }
            
            // Initialize navigation tabs after RBAC setup to ensure proper visibility
            initializeNavigationTabs();
            
            // Load user data
            setTimeout(() => {
                migrateDataToLocationKeys(currentUser.email);
                loadInventoryData(currentUser.email);
                loadEmployeeData(currentUser.email);
                // Only load schedule data if a location is selected
                if (getCurrentLocation()) {
                    loadScheduleData();
                }
                loadPricingData(currentUser.email);
                
                if (typeof loadMonthlyPricingData === 'function') {
                    loadMonthlyPricingData(currentUser.email);
                }
                if (typeof loadMonthlyInventoryData === 'function') {
                    loadMonthlyInventoryData(currentUser.email);
                }
                
                renderInventoryTable();
            }, 100);
        }

        // New function to ensure tabs are properly rendered and visible
        function initializeNavigationTabs() {
            console.log('[UI Init] Starting tab initialization');
            
            // Get the tabs container
            const tabsContainer = document.querySelector('.tabs');
            if (!tabsContainer) {
                console.error('[UI Init] ERROR: Tabs container not found!');
                return;
            }
            
            // Remove any inline styles that might be hiding it
            tabsContainer.removeAttribute('style');
            
            // Ensure the tabs container is visible
            tabsContainer.style.display = 'flex';
            tabsContainer.style.visibility = 'visible';
            tabsContainer.style.opacity = '1';
            
            // Get all tab buttons
            const allTabs = tabsContainer.querySelectorAll('.tab');
            console.log(`[UI Init] Found ${allTabs.length} tab buttons`);
            
            // Ensure all tabs are visible based on role
            const userRole = currentUser.rbac ? currentUser.rbac.role : currentUser.role;
            const userSecurityCode = typeof getSecurityCodeForRole !== 'undefined' ? 
                getSecurityCodeForRole(userRole) : 5; // Default to highest if function not available
            
            allTabs.forEach(tab => {
                const tabName = tab.getAttribute('data-tab');
                
                // Managers and above (security code 2+) see ALL tabs
                if (userSecurityCode >= 2) {
                    tab.style.display = '';
                    tab.style.visibility = 'visible';
                    tab.style.opacity = '1';
                } else {
                    // Staff users (security code 1) only see Schedule and Settings tabs
                    const staffAllowedTabs = ['schedule', 'settings'];
                    if (staffAllowedTabs.includes(tabName)) {
                        tab.style.display = '';
                        tab.style.visibility = 'visible';
                        tab.style.opacity = '1';
                    } else {
                        tab.style.display = 'none';
                    }
                }
            });
            
            // Ensure main-content is visible
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.removeAttribute('style');
                mainContent.style.display = 'block';
                mainContent.style.visibility = 'visible';
                mainContent.style.opacity = '1';
            }
            
            // Set up click event listeners for tabs
            document.querySelectorAll('[data-tab]').forEach(tab => {
                // Remove any existing listeners first
                tab.replaceWith(tab.cloneNode(true));
            });
            
            // Re-query and add fresh listeners
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    switchTab(tab.dataset.tab);
                });
            });
            
            console.log('[UI Init] Tab initialization complete with event listeners');
        }

        function showMainApp() {
            // Show/hide main containers
            authContainer.classList.add('hidden');
            mainApp.classList.remove('hidden');
            currentUserSpan.textContent = currentUser.name;
            
            // Setup location selector FIRST before loading any data
            setupLocationSelector();
            
            // Small delay to ensure DOM is ready
            setTimeout(() => {
                // Initialize the navigation tabs
                initializeNavigationTabs();
                
                // Apply RBAC permissions if available
                if (typeof updateUIBasedOnPermissions !== 'undefined') {
                    updateUIBasedOnPermissions(currentUser);
                }
                if (currentUser.rbac && typeof updateRoleBadge !== 'undefined') {
                    updateRoleBadge(currentUser.rbac);
                }
                if (typeof setupToolVisibility !== 'undefined') {
                    setupToolVisibility();
                }
                
                // Note: Tab visibility is now handled in initializeNavigationTabs based on security codes
                // This ensures consistent role-based permissions
                
                // Update role dropdown options based on current user's role
                updateRoleDropdownOptions();
                
                // Initialize the first tab AFTER ensuring tabs are visible
                switchTab('inventory');
            }, 50); // Small delay to ensure DOM updates
            
            // IMPORTANT: Wait a moment to ensure location is set before loading data
            setTimeout(() => {
                // First migrate any old data to location-specific keys
                migrateDataToLocationKeys(currentUser.email);
                
                // Load this user's specific data
                loadInventoryData(currentUser.email);
                loadEmployeeData(currentUser.email);
                
                // Load and render schedule data only if location is selected
                if (getCurrentLocation()) {
                    loadScheduleData().then(() => {
                        console.log('Schedule loaded after login for user:', currentUser.email);
                        renderScheduleTable();
                        if (typeof updateScheduleTotals === 'function') {
                            updateScheduleTotals();
                        }
                    });
                }
                
                loadPricingData(currentUser.email);
                
                // Render all tables
                renderInventoryTable();
                
                // Calculate estimated order total after all data is loaded
                calculateEstimatedOrderTotal();
            }, 100);
            
            // Initialize monthly inventory in the setTimeout
            setTimeout(() => {
                document.getElementById('inventoryMonth').value = currentInventoryMonth;
                updateMonthlyCategorySummary();
                
                // Update daily sales inputs with saved values
                const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                dayKeys.forEach((key, index) => {
                    const input = document.getElementById(`sales${dayNames[index]}`);
                    if (input) input.value = currentWeekSales[key] || '';
                });
                
                updateDailySalesDisplay();
            }, 100);
        }

        function logout() {
            // Clear current user
            currentUser = null;
            localStorage.removeItem('currentUser');
            
            // Show a brief message before refresh
            showSuccess('Logging out...');
            
            // Refresh the page after a short delay to ensure clean state
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }

        // Budget calculator
        function updateBudgetDisplay() {
            const sales = parseFloat(projectedSalesInput.value) || 0;
            const foodBudget = sales * 0.29;
            
            // Update food budget only
            projectedBudgetDiv.textContent = `$${foodBudget.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }
        
        // Calculate estimated order total using monthly pricing
        // Item name mapping between regular inventory and monthly pricing CSV
        function getMonthlyPricingName(regularInventoryName) {
            const mappings = {
                // Cheese mappings
                'CHEESE MOZZ PS PC 104 (8x6.81 LB)': 'Block Mozzarella',
                'CHEESE CHED SHRD (2x5 LB)': 'Cheddar',
                'CHEESE ROMANO GRTD EA (1x5 LB)': 'Romano',
                'CHEESE FETA DOMEST TUB (2x9 LB)': 'Feta',
                
                // Meat mappings
                'BEEF TPNG (2x5 LB)': 'Hamburger',
                'SAUSAGE ITAL CHNK CKD (3x5 LB)': 'Italian Sausage',
                'SALAMI HARD SLC (2x5 LB)': 'Salami',
                'BACON 3/8" PCS FC (4x5 LB)': 'Bacon',
                'BACON CANADIAN STYLE SLC (5x2 LB)': 'Canadian Bacon',
                'PEPPERONI ROSA GRANDE XTR SLC 16CT (1x10 LB)': 'Bold Pepperoni',
                'PEPPERONI SLC (2x12.5 LB)': 'Pepperoni',
                'WING CHIC RST FC (3x5 LB)': 'Wings',
                'CHICKEN FAJITA STRIP FC (2x5 LB)': 'Fajita Chicken-pizzas',
                'CHICKEN BNLS CHNK HMSTYL FC (2x5 LB)': 'Boneless Chicken Chunks',
                
                // Produce mappings
                'LETTUCE ICBRG SLD 24CT (24x24 CT)': 'Lettuce',
                'TOMATO SLCR 25LB (1x25 LB)': 'Tomatoes',
                'PEPPER BELL GRN 25LB (1x25 LB)': 'Green Peppers',
                'ONION YLW 25LB (1x25 LB)': 'Onions',
                'ONION RED 10LB (1x10 LB)': 'Red Onions',
                'TOMATO GRAPE PINT (12x1 PT)': 'Grape Tomatoes',
                
                // Beverages
                'POP 2-LTR VAR (8x2 LTR)': '2 Liters Pop',
                'POP 20OZ VAR DASH BTL (24x20 OZ)': '20oz Pop',
                'WATER DASANI 16.9OZ (24x16.9 OZ)': 'Dasani Water',
                'WATER SMART 1 LTR (12x1 LTR)': 'Smart Water',
                'DRINK POWERADE VAR 20OZ (24x20 OZ)': 'Powerade',
                'ENERGY MNSTR VAR 16OZ (24x16 OZ)': 'Monster Energy',
                'TEA GOLD PEAK VAR 18.5OZ (12x18.5 OZ)': 'Gold Peak Tea',
                
                // Paper & Plastic
                'INSRT GRSE PROOF 10" 500CT (500x10")': 'Inserts',
                'BOX PIZZA 10" WHT E-FLUTE (50x10")': 'Pizza Box',
                'BOX PIZZA 14" WHT E-FLUTE (50x14")': 'Pizza Box',
                'BAG CARRY OUT T-SHIRT 1/6 WHT (1000x1/6)': 'Bags',
                'CUP COLD DRINK 20OZ CLOR (50x20 OZ)': 'Cups',
                'LID COLD DRINK 20OZ CLOR (50x20 OZ)': 'Lids',
                'NAPKIN DINNER WHT 2-PLY (3000x2-PLY)': 'Napkins'
            };
            
            return mappings[regularInventoryName] || null;
        }

        function calculateEstimatedOrderTotal() {
            let totalOrderValue = 0;
            let debugInfo = [];
            
            // Loop through all inventory areas and items
            Object.keys(inventoryItems).forEach(area => {
                const items = inventoryItems[area];
                items.forEach(item => {
                    const itemData = inventoryData[item];
                    if (itemData) {
                        const orderQty = calculateOrder(itemData.par, itemData.have);
                        if (orderQty > 0) {
                            // First try direct match, then try mapped name
                            let itemPrice = monthlyPricing[item] || 0;
                            let pricingKey = item;
                            
                            if (itemPrice === 0) {
                                const mappedName = getMonthlyPricingName(item);
                                if (mappedName && monthlyPricing[mappedName]) {
                                    itemPrice = monthlyPricing[mappedName];
                                    pricingKey = mappedName;
                                }
                            }
                            
                            const orderValue = orderQty * itemPrice;
                            totalOrderValue += orderValue;
                            
                            // Store debug info for items with orders
                            debugInfo.push({
                                item: item,
                                mappedTo: pricingKey,
                                orderQty: orderQty,
                                price: itemPrice,
                                value: orderValue
                            });
                        }
                    }
                });
            });
            
            // Debug logging (commented out for production)
            // console.log('=== Estimated Order Total Calculation ===');
            // console.log('Total order value:', totalOrderValue);
            // console.log('Items with orders:', debugInfo.length);
            // debugInfo.forEach(info => {
            //     if (info.price > 0) {
            //         console.log(`✓ ${info.item} → ${info.mappedTo}: ${info.orderQty} × $${info.price} = $${info.value.toFixed(2)}`);
            //     } else {
            //         console.log(`✗ ${info.item}: ${info.orderQty} × $0 (no price found)`);
            //     }
            // });
            
            // Update the estimated order total display
            const estimatedOrderDiv = document.getElementById('estimatedOrderTotal');
            if (estimatedOrderDiv) {
                estimatedOrderDiv.textContent = `$${totalOrderValue.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
            }
            
            return totalOrderValue;
        }

        // Debug function to check pricing data availability
        function debugPricingData() {
            console.log('=== PRICING DATA DEBUG ===');
            console.log('Available monthly pricing items:', Object.keys(monthlyPricing).length);
            console.log('Sample monthly pricing data:');
            Object.keys(monthlyPricing).slice(0, 10).forEach(item => {
                console.log(`  ${item}: $${monthlyPricing[item]}`);
            });
            
            console.log('\n=== INVENTORY ITEM MAPPING TEST ===');
            let totalMapped = 0;
            let totalUnmapped = 0;
            
            Object.keys(inventoryItems).forEach(area => {
                console.log(`\n--- ${area.toUpperCase()} ---`);
                inventoryItems[area].forEach(item => {
                    const directPrice = monthlyPricing[item];
                    const mappedName = getMonthlyPricingName(item);
                    const mappedPrice = mappedName ? monthlyPricing[mappedName] : null;
                    
                    if (directPrice > 0) {
                        console.log(`✓ DIRECT: ${item} → $${directPrice}`);
                        totalMapped++;
                    } else if (mappedPrice > 0) {
                        console.log(`✓ MAPPED: ${item} → ${mappedName} → $${mappedPrice}`);
                        totalMapped++;
                    } else {
                        console.log(`✗ NO PRICE: ${item}`);
                        totalUnmapped++;
                    }
                });
            });
            
            console.log(`\n=== SUMMARY ===`);
            console.log(`Items with pricing: ${totalMapped}`);
            console.log(`Items without pricing: ${totalUnmapped}`);
            console.log(`Total regular inventory items: ${totalMapped + totalUnmapped}`);
            
            return {
                monthlyPricingCount: Object.keys(monthlyPricing).length,
                mappedItems: totalMapped,
                unmappedItems: totalUnmapped
            };
        }

        // Inventory functions
        function calculateOrder(par, have) {
            const order = par - have;
            return order <= 0 ? 0 : Math.round(order);
        }

        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            
            const currentItems = inventoryItems[currentArea] || [];
            
            currentItems.forEach(item => {
                const itemData = inventoryData[item] || { par: 0, have: 0, area: currentArea };
                const orderQty = calculateOrder(itemData.par, itemData.have);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item}</strong></td>
                    <td>
                        <input type="number" class="inventory-input" 
                               data-item="${item}" data-field="par" 
                               value="${itemData.par}" min="0" step="1" max="999">
                    </td>
                    <td>
                        <input type="number" class="inventory-input" 
                               data-item="${item}" data-field="have" 
                               value="${itemData.have}" min="0" step="0.25" max="999">
                    </td>
                    <td class="order-qty">${orderQty}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners
            const inputs = tbody.querySelectorAll('.inventory-input');
            inputs.forEach(input => {
                input.addEventListener('input', handleInventoryInput);
            });
            
            // Update estimated order total
            calculateEstimatedOrderTotal();
        }

        function handleInventoryInput(event) {
            const item = event.target.dataset.item;
            const field = event.target.dataset.field;
            const value = Math.max(0, Math.min(999, parseFloat(event.target.value) || 0));

            if (!inventoryData[item]) {
                inventoryData[item] = { par: 0, have: 0, area: currentArea };
            }

            inventoryData[item][field] = value;
            inventoryData[item].lastModified = new Date().toISOString();
            inventoryData[item].modifiedBy = currentUser.email;

            // Update order quantity
            const row = event.target.closest('tr');
            const orderCell = row.querySelector('.order-qty');
            const par = inventoryData[item].par;
            const have = inventoryData[item].have;
            orderCell.textContent = calculateOrder(par, have);

            // Save changes immediately for this user
            saveInventoryData(currentUser.email);
            // Update estimated order total
            calculateEstimatedOrderTotal();
        }

        // Projected Order Cost Functions
        function calculateProjectedOrderCost() {
            if (!monthlyPricing || Object.keys(monthlyPricing).length === 0) {
                showError('No monthly inventory pricing data available. Please upload CSV pricing data first.');
                return;
            }
            
            let totalOrderValue = 0;
            let orderDetails = [];
            
            // Get all areas and calculate total order cost
            Object.keys(inventoryItems).forEach(area => {
                const items = inventoryItems[area];
                items.forEach(item => {
                    const itemData = inventoryData[item];
                    if (itemData) {
                        const orderQty = calculateOrder(itemData.par, itemData.have);
                        if (orderQty > 0) {
                            // First try direct match, then try mapped name
                            let itemPrice = monthlyPricing[item] || 0;
                            if (itemPrice === 0) {
                                const mappedName = getMonthlyPricingName(item);
                                if (mappedName && monthlyPricing[mappedName]) {
                                    itemPrice = monthlyPricing[mappedName];
                                }
                            }
                            
                            const orderValue = orderQty * itemPrice;
                            totalOrderValue += orderValue;
                            
                            if (itemPrice > 0) {
                                orderDetails.push({
                                    item: item,
                                    area: area,
                                    orderQty: orderQty,
                                    price: itemPrice,
                                    total: orderValue
                                });
                            }
                        }
                    }
                });
            });
            
            // Calculate food cost percentage based on projected sales
            const projectedSales = parseFloat(document.getElementById('projectedSales').value) || 25000;
            const foodCostPercentage = projectedSales > 0 ? (totalOrderValue / projectedSales * 100) : 0;
            
            showProjectedOrderResults(totalOrderValue, foodCostPercentage, orderDetails, projectedSales);
        }
        
        function showProjectedOrderResults(totalOrderValue, foodCostPercentage, orderDetails, projectedSales) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            const orderItemsHtml = orderDetails
                .sort((a, b) => b.total - a.total)
                .map(item => `
                    <tr>
                        <td>${item.item}</td>
                        <td>${item.area.toUpperCase()}</td>
                        <td style="text-align: center;">${item.orderQty}</td>
                        <td style="text-align: right;">$${item.price.toFixed(2)}</td>
                        <td style="text-align: right; font-weight: bold;">$${item.total.toFixed(2)}</td>
                    </tr>
                `).join('');
            
            const statusColor = foodCostPercentage <= 29 ? '#27ae60' : foodCostPercentage <= 35 ? '#f39c12' : '#e74c3c';
            const statusText = foodCostPercentage <= 29 ? 'Excellent' : foodCostPercentage <= 35 ? 'Acceptable' : 'Over Budget';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3><i class="fas fa-calculator"></i> Projected Order Cost Analysis</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Total Order Cost</div>
                                <div style="font-size: 24px; font-weight: bold; color: #27ae60;">$${totalOrderValue.toFixed(2)}</div>
                            </div>
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Projected Sales</div>
                                <div style="font-size: 24px; font-weight: bold; color: #2196f3;">$${projectedSales.toLocaleString()}</div>
                            </div>
                            <div style="background: ${statusColor}20; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Food Cost %</div>
                                <div style="font-size: 24px; font-weight: bold; color: ${statusColor};">${foodCostPercentage.toFixed(1)}%</div>
                                <div style="font-size: 12px; color: ${statusColor}; margin-top: 5px;">${statusText}</div>
                            </div>
                            <div style="background: #f3e5f5; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Items to Order</div>
                                <div style="font-size: 24px; font-weight: bold; color: #9c27b0;">${orderDetails.length}</div>
                            </div>
                        </div>
                        
                        <!-- Target vs Actual -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">Budget Analysis</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <div style="font-size: 14px; color: #666;">Target Food Cost (29%)</div>
                                    <div style="font-size: 18px; font-weight: bold; color: #27ae60;">$${(projectedSales * 0.29).toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #666;">Projected vs Target</div>
                                    <div style="font-size: 18px; font-weight: bold; color: ${statusColor};">
                                        ${totalOrderValue > (projectedSales * 0.29) ? '+' : ''}$${(totalOrderValue - (projectedSales * 0.29)).toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Details Table -->
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">Order Details</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Item</th>
                                        <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Area</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Order Qty</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Unit Price</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Total Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${orderItemsHtml}
                                </tbody>
                                <tfoot>
                                    <tr style="background: #e8f5e8; font-weight: bold;">
                                        <td colspan="4" style="padding: 12px; text-align: right; border: 1px solid #ddd;">TOTAL ORDER COST:</td>
                                        <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${totalOrderValue.toFixed(2)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Schedule Management Functions
        async function loadEmployeeData(userEmail = null) {
            if (!userEmail && currentUser) {
                userEmail = currentUser.email;
            }
            
            if (!userEmail) {
                employees = [];
                return;
            }
            
            try {
                const location = getCurrentLocation();
                console.log('Loading employees for location:', location);
                
                if (!location) {
                    console.warn('No location set, cannot load employees');
                    employees = [];
                    return;
                }
                
                // Load employees from database for current location
                console.log('Calling DB_API.employees.get with location:', location);
                const dbEmployees = await DB_API.employees.get(location);
                console.log('Database returned employees:', dbEmployees);
                
                // Also log if we get an empty array
                if (!dbEmployees || dbEmployees.length === 0) {
                    console.warn('No employees found in database for location:', location);
                    console.log('Try checking if employees exist with: SELECT * FROM employees WHERE location_id =', location);
                }
                
                // Convert database format to local format
                employees = dbEmployees.map(emp => ({
                    id: emp.id,
                    name: emp.name,
                    brand: emp.brand,
                    location: emp.location_id,
                    role: emp.role,
                    payType: emp.pay_type,
                    payRate: parseFloat(emp.pay_rate),
                    email: emp.email,
                    availability: emp.availability,
                    notes: emp.notes
                }));
                
                console.log('Loaded employees from database:', employees.length, 'employees for location', location);
                
                // Render employee table if on schedule tab
                if (document.getElementById('employeeTableBody')) {
                    renderEmployeeTable();
                }
                
            } catch (error) {
                console.error('Error loading employees from database:', error);
                employees = [];
                showError('Failed to load employees. Please refresh the page.');
            }
        }
        
        // No longer need saveEmployeeData as we save directly to database
        
        // Helper function to get the start of the week (Monday)
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        
        async function loadScheduleData(userEmail = null, weekStart = null) {
            // Get current location
            const location = getCurrentLocation();
            
            console.log('=== Loading Schedule Data ===');
            console.log('Current User:', currentUser?.email);
            console.log('Current Location:', location);
            console.log('Week Start:', weekStart);
            
            if (!location) {
                console.error('No location selected - cannot load schedule');
                scheduleData = {};
                currentWeekSales = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };
                return;
            }
            
            try {
                // If no week specified, use current week
                if (!weekStart) {
                    // Initialize currentWeekStart if not set
                    if (!currentWeekStart) {
                        currentWeekStart = typeof getWeekStart !== 'undefined' ? getWeekStart(new Date()) : new Date();
                    }
                    weekStart = currentWeekStart;
                }
                
                const weekStartStr = weekStart.toISOString().split('T')[0];
                
                // Load from database - backend expects 'location' not 'location_id' or 'brand'
                if (typeof DB_API !== 'undefined') {
                    const params = {
                        location: location,  // Backend expects 'location'
                        week_start_date: weekStartStr
                    };
                    
                    console.log('Loading schedule for location:', location, 'week:', weekStartStr);
                    console.log('API Request params:', params);
                    
                    const dbSchedules = await DB_API.schedules.get(params);
                    console.log('Database response:', dbSchedules);
                    
                    if (dbSchedules && dbSchedules.length > 0) {
                        const dbSchedule = dbSchedules[0];
                        console.log('Found schedule record:', {
                            id: dbSchedule.id,
                            location: dbSchedule.location,
                            week_start_date: dbSchedule.week_start_date,
                            updated_by: dbSchedule.user_id
                        });
                        
                        const data = typeof dbSchedule.schedule_data === 'string' ? 
                            JSON.parse(dbSchedule.schedule_data) : dbSchedule.schedule_data;
                        
                        scheduleData = data.schedule || {};
                        currentWeekSales = data.sales || { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };
                        console.log('Loaded schedule from database:', Object.keys(scheduleData).length, 'employees');
                        console.log('Schedule data:', scheduleData);
                        return;
                    }
                }
                
                // If no database data found, initialize empty
                console.log('No schedule data found for this location/week, initializing empty');
                scheduleData = {};
                currentWeekSales = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };
            } catch (error) {
                console.error('Error loading schedule data:', error);
                
                // Check if it's a network error
                if (error.message && (error.message.includes('Network connection lost') || 
                    error.message.includes('Failed to fetch') || 
                    error.message.includes('ERR_INTERNET_DISCONNECTED'))) {
                    
                    // Network error - show user-friendly message
                    console.log('Network error detected while loading schedule');
                    
                    if (typeof showError === 'function') {
                        showError('Cannot connect to server. Please check your internet connection and try again.');
                    }
                } else {
                    // Non-network error
                    if (typeof showError === 'function') {
                        showError('Error loading schedule data. Please try refreshing the page.');
                    }
                }
                
                // Initialize empty on error
                scheduleData = {};
                currentWeekSales = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };
            }
        }
        
        async function saveScheduleData(userEmail = null, weekStart = null) {
            // Check permissions first - only security code 3+ can save
            const currentUserRole = currentUser?.role || 'staff';
            const currentSecurityCode = getSecurityCodeForRole(currentUserRole);
            
            console.log('=== saveScheduleData called ===');
            console.log('Current user:', currentUser?.email);
            console.log('Current role:', currentUserRole);
            console.log('Security code:', currentSecurityCode);
            
            if (currentSecurityCode < 3) {
                console.warn('User does not have permission to save schedule (security code:', currentSecurityCode, ')');
                console.warn('Schedule changes will not be persisted');
                return;
            }
            
            // Get current location
            const location = getCurrentLocation();
            
            if (!location) {
                console.error('Cannot save schedule: no location selected');
                alert('Please select a location before saving the schedule');
                return;
            }
            
            // Ensure we have a valid week start date
            if (!weekStart) {
                // If currentWeekStart is not set, initialize it
                if (!currentWeekStart) {
                    currentWeekStart = typeof getWeekStart !== 'undefined' ? getWeekStart(new Date()) : new Date();
                }
                weekStart = currentWeekStart;
            }
            
            // Ensure scheduleData is initialized
            if (!scheduleData || typeof scheduleData !== 'object') {
                console.warn('Schedule data is empty, initializing...');
                scheduleData = {};
            }
            
            // Ensure currentWeekSales is initialized
            if (!currentWeekSales || typeof currentWeekSales !== 'object') {
                currentWeekSales = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };
            }
            
            const data = {
                schedule: scheduleData,
                sales: currentWeekSales
            };
            
            try {
                // Save to database - backend expects 'location' not 'location_id'
                if (typeof DB_API !== 'undefined') {
                    const weekStartStr = weekStart.toISOString().split('T')[0];
                    
                    const schedulePayload = {
                        location: location,  // Backend expects 'location'
                        week_start_date: weekStartStr,
                        schedule_data: JSON.stringify(data),
                        updated_by: currentUser ? currentUser.email : 'unknown'
                    };
                    
                    console.log('=== Saving Schedule Data ===');
                    console.log('Current User:', currentUser?.email);
                    console.log('Saving schedule payload:', {
                        location: schedulePayload.location,
                        week_start_date: schedulePayload.week_start_date,
                        data_size: schedulePayload.schedule_data.length,
                        updated_by: schedulePayload.updated_by,
                        employee_count: Object.keys(scheduleData).length
                    });
                    
                    await DB_API.schedules.save(schedulePayload);
                    console.log('Schedule saved to database successfully for location:', location, 'week:', weekStartStr);
                    
                    // Show success message
                    if (typeof showSuccess === 'function') {
                        showSuccess('Schedule saved successfully');
                    }
                }
            } catch (error) {
                console.error('Error saving schedule to database:', error);
                if (error.message && error.message.includes('400')) {
                    alert('Error: Missing required schedule information. Please ensure a location is selected and try again.');
                } else {
                    alert('Error saving schedule. Please try again.');
                }
            }
        }
        
        // Auto-refresh schedule data every 30 seconds for real-time sync
        let scheduleRefreshInterval = null;
        
        function startScheduleAutoRefresh() {
            // Clear any existing interval
            if (scheduleRefreshInterval) {
                clearInterval(scheduleRefreshInterval);
            }
            
            // Set up auto-refresh every 30 seconds
            scheduleRefreshInterval = setInterval(async () => {
                // Only refresh if on schedule tab
                if (currentTab === 'schedule') {
                    console.log('Auto-refreshing schedule data...');
                    await loadScheduleData();
                    renderScheduleTable();
                    updateScheduleTotals();
                }
            }, 30000); // 30 seconds
        }
        
        function stopScheduleAutoRefresh() {
            if (scheduleRefreshInterval) {
                clearInterval(scheduleRefreshInterval);
                scheduleRefreshInterval = null;
            }
        }
        
        // Helper function to get role options based on brand/location
        function getScheduleRoleOptions(currentBrand, currentLocation, currentRole) {
            let roleOptions = '<option value="">Role</option>';
            
            // Check for specific brands
            if (currentBrand === 'Taco' || (currentLocation && currentLocation.toLowerCase().includes('taco'))) {
                // Taco brand roles
                const tacoRoles = [
                    { value: 'GM', text: 'General Manager' },
                    { value: '!Bartender', text: '!Bartender' },
                    { value: '!Cook', text: '!Cook' },
                    { value: 'Bartender', text: 'Bartender' },
                    { value: 'Cook', text: 'Cook' }
                ];
                tacoRoles.forEach(role => {
                    roleOptions += `<option value="${role.value}" ${currentRole === role.value ? 'selected' : ''}>${role.text}</option>`;
                });
            } else if (currentBrand === 'Doughnut' || (currentLocation && currentLocation.toUpperCase().startsWith('ODT'))) {
                // Doughnut brand roles
                const doughnutRoles = [
                    { value: 'GM', text: 'GM' },
                    { value: 'Barista', text: 'Barista' },
                    { value: 'FOH', text: 'Front of House (FOH)' },
                    { value: 'Den', text: 'Den' },
                    { value: 'Kitchen', text: 'Kitchen' }
                ];
                doughnutRoles.forEach(role => {
                    roleOptions += `<option value="${role.value}" ${currentRole === role.value ? 'selected' : ''}>${role.text}</option>`;
                });
            } else if (currentBrand === 'Office Administration' && currentLocation === 'Office') {
                // Office Administration roles
                const officeRoles = [
                    { value: 'EOO', text: 'EOO' },
                    { value: 'EFO', text: 'EFO' },
                    { value: 'EUO', text: 'EUO' },
                    { value: 'EAO', text: 'EAO' },
                    { value: 'EMD', text: 'EMD' },
                    { value: 'EHRD', text: 'EHRD' },
                    { value: 'EHRDA', text: 'EHRDA' },
                    { value: 'EFM', text: 'EFM' }
                ];
                officeRoles.forEach(role => {
                    roleOptions += `<option value="${role.value}" ${currentRole === role.value ? 'selected' : ''}>${role.text}</option>`;
                });
            } else {
                // Default roles
                const defaultRoles = [
                    { value: 'GM', text: 'GM' },
                    { value: 'Manager 1', text: 'Manager 1' },
                    { value: 'Manager 2', text: 'Manager 2' },
                    { value: 'Manager 3', text: 'Manager 3' },
                    { value: 'Crew', text: 'Crew' },
                    { value: 'Driver', text: 'Driver' }
                ];
                defaultRoles.forEach(role => {
                    roleOptions += `<option value="${role.value}" ${currentRole === role.value ? 'selected' : ''}>${role.text}</option>`;
                });
            }
            
            return roleOptions;
        }
        
        // Function to get role options based on brand/location
        function getScheduleRoleOptions(currentBrand, currentLocation, currentRole) {
            let roleOptions = '<option value="">Role</option>';
            
            // Check brand properly
            if (!currentBrand && currentLocation) {
                const locationItem = LOCATION_BRAND_MAP.find(item => item.location === currentLocation);
                if (locationItem) {
                    currentBrand = locationItem.brand;
                }
            }
            
            if (currentBrand === 'Taco' || (currentLocation && currentLocation.toLowerCase().includes('taco'))) {
                const tacoRoles = [
                    { value: 'GM', text: 'General Manager' },
                    { value: '!Bartender', text: '!Bartender' },
                    { value: '!Cook', text: '!Cook' },
                    { value: 'Bartender', text: 'Bartender' },
                    { value: 'Cook', text: 'Cook' }
                ];
                tacoRoles.forEach(role => {
                    roleOptions += `<option value="${role.value}" ${currentRole === role.value ? 'selected' : ''}>${role.text}</option>`;
                });
            } else if (currentBrand === 'Doughnut' || (currentLocation && currentLocation.toUpperCase().startsWith('ODT'))) {
                const doughnutRoles = [
                    { value: 'GM', text: 'GM' },
                    { value: 'Barista', text: 'Barista' },
                    { value: 'FOH', text: 'Front of House (FOH)' },
                    { value: 'Den', text: 'Den' },
                    { value: 'Kitchen', text: 'Kitchen' }
                ];
                doughnutRoles.forEach(role => {
                    roleOptions += `<option value="${role.value}" ${currentRole === role.value ? 'selected' : ''}>${role.text}</option>`;
                });
            } else if (currentBrand === 'Office Administration' || currentLocation === 'Office') {
                // Office Administration roles
                const officeRoles = [
                    { value: 'EOO', text: 'EOO' },
                    { value: 'EFO', text: 'EFO' },
                    { value: 'EUO', text: 'EUO' },
                    { value: 'EAO', text: 'EAO' },
                    { value: 'EMD', text: 'EMD' },
                    { value: 'EHRD', text: 'EHRD' },
                    { value: 'EHRDA', text: 'EHRDA' },
                    { value: 'EFM', text: 'EFM' }
                ];
                officeRoles.forEach(role => {
                    roleOptions += `<option value="${role.value}" ${currentRole === role.value ? 'selected' : ''}>${role.text}</option>`;
                });
            } else {
                // Default roles for Jets Pizza etc
                const defaultRoles = [
                    { value: 'GM', text: 'General Manager' },
                    { value: 'Manager 1', text: 'Manager 1' },
                    { value: 'Manager 2', text: 'Manager 2' },
                    { value: 'Manager 3', text: 'Manager 3' },
                    { value: 'Crew', text: 'Crew' },
                    { value: 'Driver', text: 'Driver' }
                ];
                defaultRoles.forEach(role => {
                    roleOptions += `<option value="${role.value}" ${currentRole === role.value ? 'selected' : ''}>${role.text}</option>`;
                });
            }
            
            return roleOptions;
        }
        
        function renderScheduleTable() {
            const tbody = document.getElementById('scheduleTableBody');
            if (!tbody) {
                console.error('Schedule table body not found - scheduleTableBody element missing');
                return;
            }
            tbody.innerHTML = '';
            
            const currentBrand = getCurrentBrand();
            const currentLocation = getCurrentLocation();
            
            // Check user permissions - security code >= 3 can edit
            const currentUserRole = currentUser?.role || 'staff';
            const currentSecurityCode = getSecurityCodeForRole(currentUserRole);
            const canEditSchedule = currentSecurityCode >= 3;
            
            // Update schedule buttons based on permissions
            const scheduleButtons = ['addEmployeeBtn', 'emailScheduleBtn', 'copyScheduleBtn', 'pasteScheduleBtn', 'scheduleNotesBtn'];
            scheduleButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.display = canEditSchedule ? '' : 'none';
                }
            });
            
            // Update sales input fields based on permissions
            const salesInputs = document.querySelectorAll('.daily-sales');
            salesInputs.forEach(input => {
                input.disabled = !canEditSchedule;
                input.style.backgroundColor = canEditSchedule ? '' : '#f0f0f0';
            });
            
            // Show/hide view-only notice
            const viewOnlyNotice = document.getElementById('scheduleViewOnlyNotice');
            if (viewOnlyNotice) {
                viewOnlyNotice.style.display = canEditSchedule ? 'none' : 'block';
            }
            
            // START OFFICE ADMINISTRATION SPECIFIC MODIFICATION
            if (currentBrand === 'Office Administration' || currentLocation === 'Office') {
                renderOfficeAdministrationSchedule();
                return;
            } else {
                // Remove office admin class if switching away
                const scheduleSection = document.getElementById('scheduleSection');
                if (scheduleSection) {
                    scheduleSection.classList.remove('office-admin-schedule');
                }
            }
            // END OFFICE ADMINISTRATION SPECIFIC MODIFICATION
            
            const showLocationColumn = currentBrand === 'Office Administration' && currentLocation === 'Office';
            
            // Show/hide location column headers
            document.querySelectorAll('.office-location-column').forEach(element => {
                element.style.display = showLocationColumn ? '' : 'none';
            });
            
            // Filter employees by current location
            const locationEmployees = employees.filter(emp => {
                // If employee has no location set, include them for backward compatibility
                if (!emp.location) return true;
                // Otherwise, only include if they match current location
                return emp.location === currentLocation;
            });
            
            console.log(`Showing ${locationEmployees.length} employees for location: ${currentLocation}`);
            
            // Create 30 rows for schedule entries
            for (let i = 0; i < 30; i++) {
                const row = document.createElement('tr');
                const empId = `emp_${i}`;
                const empData = scheduleData[empId] || { name: '', role: '', location: '', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '', sun: '' };
                
                // Check if employee has a predefined role
                const selectedEmployee = empData.name ? employees.find(emp => emp.name === empData.name) : null;
                const employeeRole = selectedEmployee ? selectedEmployee.role : empData.role;
                const isRoleDisabled = selectedEmployee && selectedEmployee.role ? true : false;
                
                row.innerHTML = `
                    <td>
                        <select class="schedule-input" data-field="name" data-emp="${empId}" ${!canEditSchedule ? 'disabled' : ''}>
                            <option value="">Select Employee</option>
                            ${locationEmployees.map(emp => `<option value="${emp.name}" ${empData.name === emp.name ? 'selected' : ''}>${emp.name}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select class="schedule-input" data-field="role" data-emp="${empId}" ${!canEditSchedule || isRoleDisabled ? 'disabled' : ''}>
                            ${getScheduleRoleOptions(currentBrand, currentLocation, employeeRole)}
                        </select>
                    </td>
                    ${showLocationColumn ? `
                    <td class="office-location-column">
                        <select class="schedule-input" data-field="location" data-emp="${empId}" ${!canEditSchedule ? 'disabled' : ''}>
                            <option value="">Select Location</option>
                            ${LOCATION_BRAND_MAP.map(item => `<option value="${item.location}" ${empData.location === item.location ? 'selected' : ''}>${item.location}</option>`).join('')}
                        </select>
                    </td>` : '<td class="office-location-column" style="display: none;"></td>'}
                    <td>
                        <select class="schedule-input shift-select" data-field="mon" data-emp="${empId}" ${!canEditSchedule ? 'disabled' : ''}>
                            <option value="">Select Shift</option>
                            <option value="7am-4pm" ${empData.mon === '7am-4pm' ? 'selected' : ''}>7am-4pm</option>
                            <option value="8am-4pm" ${empData.mon === '8am-4pm' ? 'selected' : ''}>8am-4pm</option>
                            <option value="8am-8pm" ${empData.mon === '8am-8pm' ? 'selected' : ''}>8am-8pm</option>
                            <option value="7am-8pm" ${empData.mon === '7am-8pm' ? 'selected' : ''}>7am-8pm</option>
                            <option value="10am-4pm" ${empData.mon === '10am-4pm' ? 'selected' : ''}>10am-4pm</option>
                            <option value="4pm-8pm" ${empData.mon === '4pm-8pm' ? 'selected' : ''}>4pm-8pm</option>
                            <option value="4pm-9pm" ${empData.mon === '4pm-9pm' ? 'selected' : ''}>4pm-9pm</option>
                            <option value="4pm-10pm" ${empData.mon === '4pm-10pm' ? 'selected' : ''}>4pm-10pm</option>
                            <option value="5pm-8pm" ${empData.mon === '5pm-8pm' ? 'selected' : ''}>5pm-8pm</option>
                            <option value="5pm-9pm" ${empData.mon === '5pm-9pm' ? 'selected' : ''}>5pm-9pm</option>
                            <option value="5pm-10pm" ${empData.mon === '5pm-10pm' ? 'selected' : ''}>5pm-10pm</option>
                            <option value="6pm-9pm" ${empData.mon === '6pm-9pm' ? 'selected' : ''}>6pm-9pm</option>
                            <option value="6pm-10pm" ${empData.mon === '6pm-10pm' ? 'selected' : ''}>6pm-10pm</option>
                            <option value="custom" ${empData.mon && !['7am-4pm', '8am-4pm', '8am-8pm', '7am-8pm', '10am-4pm', '4pm-8pm', '4pm-9pm', '4pm-10pm', '5pm-8pm', '5pm-9pm', '5pm-10pm', '6pm-9pm', '6pm-10pm'].includes(empData.mon) ? 'selected' : ''}>Custom...</option>
                        </select>
                        <input type="text" class="schedule-input custom-shift" data-field="mon" data-emp="${empId}" value="${empData.mon}" placeholder="Custom shift" style="display: none; margin-top: 2px;" ${!canEditSchedule ? 'disabled' : ''}>
                    </td>
                    <td>
                        <select class="schedule-input shift-select" data-field="tue" data-emp="${empId}" ${!canEditSchedule ? 'disabled' : ''}>
                            <option value="">Select Shift</option>
                            <option value="7am-4pm" ${empData.tue === '7am-4pm' ? 'selected' : ''}>7am-4pm</option>
                            <option value="8am-4pm" ${empData.tue === '8am-4pm' ? 'selected' : ''}>8am-4pm</option>
                            <option value="8am-8pm" ${empData.tue === '8am-8pm' ? 'selected' : ''}>8am-8pm</option>
                            <option value="7am-8pm" ${empData.tue === '7am-8pm' ? 'selected' : ''}>7am-8pm</option>
                            <option value="10am-4pm" ${empData.tue === '10am-4pm' ? 'selected' : ''}>10am-4pm</option>
                            <option value="4pm-8pm" ${empData.tue === '4pm-8pm' ? 'selected' : ''}>4pm-8pm</option>
                            <option value="4pm-9pm" ${empData.tue === '4pm-9pm' ? 'selected' : ''}>4pm-9pm</option>
                            <option value="4pm-10pm" ${empData.tue === '4pm-10pm' ? 'selected' : ''}>4pm-10pm</option>
                            <option value="5pm-8pm" ${empData.tue === '5pm-8pm' ? 'selected' : ''}>5pm-8pm</option>
                            <option value="5pm-9pm" ${empData.tue === '5pm-9pm' ? 'selected' : ''}>5pm-9pm</option>
                            <option value="5pm-10pm" ${empData.tue === '5pm-10pm' ? 'selected' : ''}>5pm-10pm</option>
                            <option value="6pm-9pm" ${empData.tue === '6pm-9pm' ? 'selected' : ''}>6pm-9pm</option>
                            <option value="6pm-10pm" ${empData.tue === '6pm-10pm' ? 'selected' : ''}>6pm-10pm</option>
                            <option value="custom" ${empData.tue && !['7am-4pm', '8am-4pm', '8am-8pm', '7am-8pm', '10am-4pm', '4pm-8pm', '4pm-9pm', '4pm-10pm', '5pm-8pm', '5pm-9pm', '5pm-10pm', '6pm-9pm', '6pm-10pm'].includes(empData.tue) ? 'selected' : ''}>Custom...</option>
                        </select>
                        <input type="text" class="schedule-input custom-shift" data-field="tue" data-emp="${empId}" value="${empData.tue}" placeholder="Custom shift" style="display: none; margin-top: 2px;" ${!canEditSchedule ? 'disabled' : ''}>
                    </td>
                    <td>
                        <select class="schedule-input shift-select" data-field="wed" data-emp="${empId}" ${!canEditSchedule ? 'disabled' : ''}>
                            <option value="">Select Shift</option>
                            <option value="7am-4pm" ${empData.wed === '7am-4pm' ? 'selected' : ''}>7am-4pm</option>
                            <option value="8am-4pm" ${empData.wed === '8am-4pm' ? 'selected' : ''}>8am-4pm</option>
                            <option value="8am-8pm" ${empData.wed === '8am-8pm' ? 'selected' : ''}>8am-8pm</option>
                            <option value="7am-8pm" ${empData.wed === '7am-8pm' ? 'selected' : ''}>7am-8pm</option>
                            <option value="10am-4pm" ${empData.wed === '10am-4pm' ? 'selected' : ''}>10am-4pm</option>
                            <option value="4pm-8pm" ${empData.wed === '4pm-8pm' ? 'selected' : ''}>4pm-8pm</option>
                            <option value="4pm-9pm" ${empData.wed === '4pm-9pm' ? 'selected' : ''}>4pm-9pm</option>
                            <option value="4pm-10pm" ${empData.wed === '4pm-10pm' ? 'selected' : ''}>4pm-10pm</option>
                            <option value="5pm-8pm" ${empData.wed === '5pm-8pm' ? 'selected' : ''}>5pm-8pm</option>
                            <option value="5pm-9pm" ${empData.wed === '5pm-9pm' ? 'selected' : ''}>5pm-9pm</option>
                            <option value="5pm-10pm" ${empData.wed === '5pm-10pm' ? 'selected' : ''}>5pm-10pm</option>
                            <option value="6pm-9pm" ${empData.wed === '6pm-9pm' ? 'selected' : ''}>6pm-9pm</option>
                            <option value="6pm-10pm" ${empData.wed === '6pm-10pm' ? 'selected' : ''}>6pm-10pm</option>
                            <option value="custom" ${empData.wed && !['7am-4pm', '8am-4pm', '8am-8pm', '7am-8pm', '10am-4pm', '4pm-8pm', '4pm-9pm', '4pm-10pm', '5pm-8pm', '5pm-9pm', '5pm-10pm', '6pm-9pm', '6pm-10pm'].includes(empData.wed) ? 'selected' : ''}>Custom...</option>
                        </select>
                        <input type="text" class="schedule-input custom-shift" data-field="wed" data-emp="${empId}" value="${empData.wed}" placeholder="Custom shift" style="display: none; margin-top: 2px;" ${!canEditSchedule ? 'disabled' : ''}>
                    </td>
                    <td>
                        <select class="schedule-input shift-select" data-field="thu" data-emp="${empId}" ${!canEditSchedule ? 'disabled' : ''}>
                            <option value="">Select Shift</option>
                            <option value="7am-4pm" ${empData.thu === '7am-4pm' ? 'selected' : ''}>7am-4pm</option>
                            <option value="8am-4pm" ${empData.thu === '8am-4pm' ? 'selected' : ''}>8am-4pm</option>
                            <option value="8am-8pm" ${empData.thu === '8am-8pm' ? 'selected' : ''}>8am-8pm</option>
                            <option value="7am-8pm" ${empData.thu === '7am-8pm' ? 'selected' : ''}>7am-8pm</option>
                            <option value="10am-4pm" ${empData.thu === '10am-4pm' ? 'selected' : ''}>10am-4pm</option>
                            <option value="4pm-8pm" ${empData.thu === '4pm-8pm' ? 'selected' : ''}>4pm-8pm</option>
                            <option value="4pm-9pm" ${empData.thu === '4pm-9pm' ? 'selected' : ''}>4pm-9pm</option>
                            <option value="4pm-10pm" ${empData.thu === '4pm-10pm' ? 'selected' : ''}>4pm-10pm</option>
                            <option value="5pm-8pm" ${empData.thu === '5pm-8pm' ? 'selected' : ''}>5pm-8pm</option>
                            <option value="5pm-9pm" ${empData.thu === '5pm-9pm' ? 'selected' : ''}>5pm-9pm</option>
                            <option value="5pm-10pm" ${empData.thu === '5pm-10pm' ? 'selected' : ''}>5pm-10pm</option>
                            <option value="6pm-9pm" ${empData.thu === '6pm-9pm' ? 'selected' : ''}>6pm-9pm</option>
                            <option value="6pm-10pm" ${empData.thu === '6pm-10pm' ? 'selected' : ''}>6pm-10pm</option>
                            <option value="custom" ${empData.thu && !['7am-4pm', '8am-4pm', '8am-8pm', '7am-8pm', '10am-4pm', '4pm-8pm', '4pm-9pm', '4pm-10pm', '5pm-8pm', '5pm-9pm', '5pm-10pm', '6pm-9pm', '6pm-10pm'].includes(empData.thu) ? 'selected' : ''}>Custom...</option>
                        </select>
                        <input type="text" class="schedule-input custom-shift" data-field="thu" data-emp="${empId}" value="${empData.thu}" placeholder="Custom shift" style="display: none; margin-top: 2px;" ${!canEditSchedule ? 'disabled' : ''}>
                    </td>
                    <td>
                        <select class="schedule-input shift-select" data-field="fri" data-emp="${empId}" ${!canEditSchedule ? 'disabled' : ''}>
                            <option value="">Select Shift</option>
                            <option value="7am-4pm" ${empData.fri === '7am-4pm' ? 'selected' : ''}>7am-4pm</option>
                            <option value="8am-4pm" ${empData.fri === '8am-4pm' ? 'selected' : ''}>8am-4pm</option>
                            <option value="8am-8pm" ${empData.fri === '8am-8pm' ? 'selected' : ''}>8am-8pm</option>
                            <option value="7am-8pm" ${empData.fri === '7am-8pm' ? 'selected' : ''}>7am-8pm</option>
                            <option value="10am-4pm" ${empData.fri === '10am-4pm' ? 'selected' : ''}>10am-4pm</option>
                            <option value="4pm-8pm" ${empData.fri === '4pm-8pm' ? 'selected' : ''}>4pm-8pm</option>
                            <option value="4pm-9pm" ${empData.fri === '4pm-9pm' ? 'selected' : ''}>4pm-9pm</option>
                            <option value="4pm-10pm" ${empData.fri === '4pm-10pm' ? 'selected' : ''}>4pm-10pm</option>
                            <option value="5pm-8pm" ${empData.fri === '5pm-8pm' ? 'selected' : ''}>5pm-8pm</option>
                            <option value="5pm-9pm" ${empData.fri === '5pm-9pm' ? 'selected' : ''}>5pm-9pm</option>
                            <option value="5pm-10pm" ${empData.fri === '5pm-10pm' ? 'selected' : ''}>5pm-10pm</option>
                            <option value="6pm-9pm" ${empData.fri === '6pm-9pm' ? 'selected' : ''}>6pm-9pm</option>
                            <option value="6pm-10pm" ${empData.fri === '6pm-10pm' ? 'selected' : ''}>6pm-10pm</option>
                            <option value="custom" ${empData.fri && !['7am-4pm', '8am-4pm', '8am-8pm', '7am-8pm', '10am-4pm', '4pm-8pm', '4pm-9pm', '4pm-10pm', '5pm-8pm', '5pm-9pm', '5pm-10pm', '6pm-9pm', '6pm-10pm'].includes(empData.fri) ? 'selected' : ''}>Custom...</option>
                        </select>
                        <input type="text" class="schedule-input custom-shift" data-field="fri" data-emp="${empId}" value="${empData.fri}" placeholder="Custom shift" style="display: none; margin-top: 2px;" ${!canEditSchedule ? 'disabled' : ''}>
                    </td>
                    <td>
                        <select class="schedule-input shift-select" data-field="sat" data-emp="${empId}" ${!canEditSchedule ? 'disabled' : ''}>
                            <option value="">Select Shift</option>
                            <option value="7am-4pm" ${empData.sat === '7am-4pm' ? 'selected' : ''}>7am-4pm</option>
                            <option value="8am-4pm" ${empData.sat === '8am-4pm' ? 'selected' : ''}>8am-4pm</option>
                            <option value="8am-8pm" ${empData.sat === '8am-8pm' ? 'selected' : ''}>8am-8pm</option>
                            <option value="7am-8pm" ${empData.sat === '7am-8pm' ? 'selected' : ''}>7am-8pm</option>
                            <option value="10am-4pm" ${empData.sat === '10am-4pm' ? 'selected' : ''}>10am-4pm</option>
                            <option value="4pm-8pm" ${empData.sat === '4pm-8pm' ? 'selected' : ''}>4pm-8pm</option>
                            <option value="4pm-9pm" ${empData.sat === '4pm-9pm' ? 'selected' : ''}>4pm-9pm</option>
                            <option value="4pm-10pm" ${empData.sat === '4pm-10pm' ? 'selected' : ''}>4pm-10pm</option>
                            <option value="5pm-8pm" ${empData.sat === '5pm-8pm' ? 'selected' : ''}>5pm-8pm</option>
                            <option value="5pm-9pm" ${empData.sat === '5pm-9pm' ? 'selected' : ''}>5pm-9pm</option>
                            <option value="5pm-10pm" ${empData.sat === '5pm-10pm' ? 'selected' : ''}>5pm-10pm</option>
                            <option value="6pm-9pm" ${empData.sat === '6pm-9pm' ? 'selected' : ''}>6pm-9pm</option>
                            <option value="6pm-10pm" ${empData.sat === '6pm-10pm' ? 'selected' : ''}>6pm-10pm</option>
                            <option value="custom" ${empData.sat && !['7am-4pm', '8am-4pm', '8am-8pm', '7am-8pm', '10am-4pm', '4pm-8pm', '4pm-9pm', '4pm-10pm', '5pm-8pm', '5pm-9pm', '5pm-10pm', '6pm-9pm', '6pm-10pm'].includes(empData.sat) ? 'selected' : ''}>Custom...</option>
                        </select>
                        <input type="text" class="schedule-input custom-shift" data-field="sat" data-emp="${empId}" value="${empData.sat}" placeholder="Custom shift" style="display: none; margin-top: 2px;" ${!canEditSchedule ? 'disabled' : ''}>
                    </td>
                    <td>
                        <select class="schedule-input shift-select" data-field="sun" data-emp="${empId}" ${!canEditSchedule ? 'disabled' : ''}>
                            <option value="">Select Shift</option>
                            <option value="7am-4pm" ${empData.sun === '7am-4pm' ? 'selected' : ''}>7am-4pm</option>
                            <option value="8am-4pm" ${empData.sun === '8am-4pm' ? 'selected' : ''}>8am-4pm</option>
                            <option value="8am-8pm" ${empData.sun === '8am-8pm' ? 'selected' : ''}>8am-8pm</option>
                            <option value="7am-8pm" ${empData.sun === '7am-8pm' ? 'selected' : ''}>7am-8pm</option>
                            <option value="10am-4pm" ${empData.sun === '10am-4pm' ? 'selected' : ''}>10am-4pm</option>
                            <option value="4pm-8pm" ${empData.sun === '4pm-8pm' ? 'selected' : ''}>4pm-8pm</option>
                            <option value="4pm-9pm" ${empData.sun === '4pm-9pm' ? 'selected' : ''}>4pm-9pm</option>
                            <option value="4pm-10pm" ${empData.sun === '4pm-10pm' ? 'selected' : ''}>4pm-10pm</option>
                            <option value="5pm-8pm" ${empData.sun === '5pm-8pm' ? 'selected' : ''}>5pm-8pm</option>
                            <option value="5pm-9pm" ${empData.sun === '5pm-9pm' ? 'selected' : ''}>5pm-9pm</option>
                            <option value="5pm-10pm" ${empData.sun === '5pm-10pm' ? 'selected' : ''}>5pm-10pm</option>
                            <option value="6pm-9pm" ${empData.sun === '6pm-9pm' ? 'selected' : ''}>6pm-9pm</option>
                            <option value="6pm-10pm" ${empData.sun === '6pm-10pm' ? 'selected' : ''}>6pm-10pm</option>
                            <option value="custom" ${empData.sun && !['7am-4pm', '8am-4pm', '8am-8pm', '7am-8pm', '10am-4pm', '4pm-8pm', '4pm-9pm', '4pm-10pm', '5pm-8pm', '5pm-9pm', '5pm-10pm', '6pm-9pm', '6pm-10pm'].includes(empData.sun) ? 'selected' : ''}>Custom...</option>
                        </select>
                        <input type="text" class="schedule-input custom-shift" data-field="sun" data-emp="${empId}" value="${empData.sun}" placeholder="Custom shift" style="display: none; margin-top: 2px;" ${!canEditSchedule ? 'disabled' : ''}>
                    </td>
                    <td class="weekly-total" data-emp="${empId}">0h</td>
                `;
                
                tbody.appendChild(row);
            }
            
            // Add event listeners for schedule inputs
            addScheduleEventListeners();
            updateScheduleTotals();
        }
        
        // START OFFICE ADMINISTRATION SPECIFIC FUNCTIONS
        function renderOfficeAdministrationSchedule() {
            const tbody = document.getElementById('scheduleTableBody');
            tbody.innerHTML = '';
            
            // Check user permissions - security code >= 3 can edit
            const currentUserRole = currentUser?.role || 'staff';
            const currentSecurityCode = getSecurityCodeForRole(currentUserRole);
            const canEditSchedule = currentSecurityCode >= 3;
            
            // Add class to schedule section for print styling
            const scheduleSection = document.getElementById('scheduleSection');
            if (scheduleSection) {
                scheduleSection.classList.add('office-admin-schedule');
            }
            
            // Get all locations from the system
            const allLocations = LOCATION_BRAND_MAP.map(item => item.location);
            
            // Filter employees for Office Administration/Office
            const officeEmployees = employees.filter(emp => {
                return emp.location === 'Office' || emp.brand === 'Office Administration';
            });
            
            // Create 15 rows for Office Administration
            for (let i = 0; i < 15; i++) {
                const row = document.createElement('tr');
                const empId = `emp_${i}`;
                const empData = scheduleData[empId] || { name: '', role: '', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '', sun: '' };
                
                // Check if employee has a predefined role
                const selectedEmployee = empData.name ? employees.find(emp => emp.name === empData.name) : null;
                const employeeRole = selectedEmployee ? selectedEmployee.role : empData.role;
                const isRoleDisabled = selectedEmployee && selectedEmployee.role ? true : false;
                
                // Build the row HTML
                let rowHTML = `
                    <td>
                        <select class="schedule-input" data-field="name" data-emp="${empId}" ${!canEditSchedule ? 'disabled' : ''}>
                            <option value="">Select Employee</option>
                            ${officeEmployees.map(emp => `<option value="${emp.name}" ${empData.name === emp.name ? 'selected' : ''}>${emp.name}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select class="schedule-input" data-field="role" data-emp="${empId}" ${!canEditSchedule || isRoleDisabled ? 'disabled' : ''}>
                            ${getScheduleRoleOptions('Office Administration', 'Office', employeeRole)}
                        </select>
                    </td>
                `;
                
                // Add cells for each day with multiple entry support
                const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                days.forEach(day => {
                    const dayEntries = parseOfficeEntries(empData[day]);
                    
                    rowHTML += `
                        <td class="office-admin-schedule-cell">
                            <div class="office-entries" data-day="${day}" data-emp="${empId}">
                                ${dayEntries.map((entry, index) => createOfficeEntryHTML(empId, day, index, entry, canEditSchedule)).join('')}
                                ${canEditSchedule ? `<button class="add-office-entry" data-emp="${empId}" data-day="${day}">+ Add Entry</button>` : ''}
                            </div>
                        </td>
                    `;
                });
                
                // Add weekly total
                rowHTML += `<td class="weekly-total" data-emp="${empId}">0h</td>`;
                
                row.innerHTML = rowHTML;
                tbody.appendChild(row);
            }
            
            // Add event listeners
            addOfficeAdministrationEventListeners();
            updateOfficeAdminTotals();
        }
        
        function updateOfficeAdminTotals() {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            
            // Update weekly totals for each employee
            for (let i = 0; i < 15; i++) {
                const empId = `emp_${i}`;
                const empData = scheduleData[empId];
                let weeklyTotal = 0;
                
                if (empData && empData.name) {
                    days.forEach(day => {
                        if (empData[day]) {
                            const entries = parseOfficeEntries(empData[day]);
                            entries.forEach(entry => {
                                if (entry.hours) {
                                    const hours = parseTimeRange(entry.hours);
                                    weeklyTotal += hours;
                                }
                            });
                        }
                    });
                }
                
                // Update the weekly total cell
                const totalCell = document.querySelector(`.weekly-total[data-emp="${empId}"]`);
                if (totalCell) {
                    totalCell.textContent = weeklyTotal > 0 ? `${weeklyTotal.toFixed(1)}h` : '0h';
                }
            }
            
            // Call the main updateScheduleTotals to update footer
            updateScheduleTotals();
        }
        
        function parseOfficeEntries(dayData) {
            // Parse format: "Location1:8h|Location2:4h" or "Location1:4p-8:30p"
            if (!dayData || dayData.trim() === '') return [];
            
            const entries = [];
            const parts = dayData.split('|');
            
            parts.forEach(part => {
                // Find the first colon that separates location from hours
                // But we need to handle time formats like "4p-8:30p" which also contain colons
                const colonIndex = part.indexOf(':');
                if (colonIndex > 0) {
                    const location = part.substring(0, colonIndex).trim();
                    const hours = part.substring(colonIndex + 1).trim();
                    
                    if (location && hours) {
                        entries.push({ location, hours });
                        console.log(`Parsed entry: location="${location}", hours="${hours}"`);
                    }
                }
            });
            
            return entries;
        }
        
        function createOfficeEntryHTML(empId, day, index, entry = { location: '', hours: '' }, canEdit = true) {
            const printValue = entry.location && entry.hours ? `${entry.location}: ${entry.hours}` : '';
            return `
                <div class="office-entry" data-index="${index}" data-print-value="${printValue}">
                    <select class="office-location-select" data-emp="${empId}" data-day="${day}" data-index="${index}" ${!canEdit ? 'disabled' : ''}>
                        <option value="">Location</option>
                        ${LOCATION_BRAND_MAP.map(item => 
                            `<option value="${item.location}" ${entry.location === item.location ? 'selected' : ''}>${item.location}</option>`
                        ).join('')}
                    </select>
                    <input type="text" class="office-hours-input" placeholder="8h or 9a-5p" 
                           data-emp="${empId}" data-day="${day}" data-index="${index}"
                           value="${entry.hours}" ${!canEdit ? 'disabled' : ''}>
                    ${canEdit ? `<button class="remove-office-entry" data-emp="${empId}" data-day="${day}" data-index="${index}">×</button>` : ''}
                    <span class="office-print-value" style="display: none;">${printValue}</span>
                </div>
            `;
        }
        
        function handleOfficeScheduleChange(event) {
            const empId = event.target.dataset.emp;
            const field = event.target.dataset.field;
            const value = event.target.value;
            
            if (!scheduleData[empId]) {
                scheduleData[empId] = { name: '', role: '', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '', sun: '' };
            }
            
            scheduleData[empId][field] = value;
            
            // If employee name changed, auto-fill role and pay info for Office Admin employees
            if (field === 'name' && value) {
                const employee = employees.find(emp => emp.name === value);
                if (employee && employee.role) {
                    scheduleData[empId].role = employee.role;
                    scheduleData[empId].payRate = employee.payRate;
                    scheduleData[empId].payType = employee.payType;
                    const roleSelect = document.querySelector(`select[data-field="role"][data-emp="${empId}"]`);
                    if (roleSelect) {
                        roleSelect.value = employee.role;
                    }
                }
            }
            
            updateOfficeAdminTotals();
            saveScheduleData();
        }
        
        function addOfficeAdministrationEventListeners() {
            // Regular schedule inputs
            const inputs = document.querySelectorAll('.schedule-input');
            inputs.forEach(input => {
                input.addEventListener('change', handleOfficeScheduleChange);
            });
            
            // Add entry buttons
            document.querySelectorAll('.add-office-entry').forEach(btn => {
                btn.addEventListener('click', handleAddOfficeEntry);
            });
            
            // Location and hours inputs (use event delegation)
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('office-location-select') || 
                    e.target.classList.contains('office-hours-input')) {
                    saveOfficeScheduleEntry(e.target.dataset.emp, e.target.dataset.day);
                }
            });
            
            // Remove entry buttons (use event delegation)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-office-entry')) {
                    handleRemoveOfficeEntry(e);
                }
            });
            
            // Daily sales inputs
            const dailySalesInputs = document.querySelectorAll('.daily-sales');
            dailySalesInputs.forEach(input => {
                input.addEventListener('input', handleDailySalesChange);
            });
        }
        
        function handleAddOfficeEntry(event) {
            const empId = event.target.dataset.emp;
            const day = event.target.dataset.day;
            const container = document.querySelector(`.office-entries[data-day="${day}"][data-emp="${empId}"]`);
            
            const currentEntries = container.querySelectorAll('.office-entry').length;
            const newEntryHTML = createOfficeEntryHTML(empId, day, currentEntries);
            
            // Insert before add button
            event.target.insertAdjacentHTML('beforebegin', newEntryHTML);
            
            // Save the updated data
            saveOfficeScheduleEntry(empId, day);
        }
        
        function handleRemoveOfficeEntry(event) {
            const empId = event.target.dataset.emp;
            const day = event.target.dataset.day;
            
            // Remove the entry
            event.target.closest('.office-entry').remove();
            
            // Save updated data
            saveOfficeScheduleEntry(empId, day);
        }
        
        function saveOfficeScheduleEntry(empId, day) {
            const container = document.querySelector(`.office-entries[data-day="${day}"][data-emp="${empId}"]`);
            const entries = [];
            
            container.querySelectorAll('.office-entry').forEach(entryDiv => {
                const location = entryDiv.querySelector('.office-location-select').value;
                const hours = entryDiv.querySelector('.office-hours-input').value;
                
                // Update print value
                const printSpan = entryDiv.querySelector('.office-print-value');
                if (printSpan) {
                    printSpan.textContent = location && hours ? `${location}: ${hours}` : '';
                }
                
                if (location && hours) {
                    entries.push(`${location}:${hours}`);
                }
            });
            
            // Update schedule data
            if (!scheduleData[empId]) {
                scheduleData[empId] = { name: '', role: '', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '', sun: '' };
            }
            
            scheduleData[empId][day] = entries.join('|');
            saveScheduleData();
            updateOfficeAdminTotals();
        }
        // END OFFICE ADMINISTRATION SPECIFIC FUNCTIONS
        
        function addScheduleEventListeners() {
            const inputs = document.querySelectorAll('.schedule-input');
            inputs.forEach(input => {
                input.addEventListener('change', handleScheduleChange);
            });
            
            // Add event listeners for daily sales inputs in the footer
            const dailySalesInputs = document.querySelectorAll('.daily-sales');
            dailySalesInputs.forEach(input => {
                input.addEventListener('input', handleDailySalesChange);
            });
            
            // Handle shift select changes
            const shiftSelects = document.querySelectorAll('.shift-select');
            shiftSelects.forEach(select => {
                select.addEventListener('change', handleShiftSelectChange);
            });
            
            // Handle custom shift inputs
            const customInputs = document.querySelectorAll('.custom-shift');
            customInputs.forEach(input => {
                input.addEventListener('change', handleCustomShiftChange);
            });
            
        }
        
        function handleScheduleChange(event) {
            const empId = event.target.dataset.emp;
            const field = event.target.dataset.field;
            const value = event.target.value;
            
            if (!scheduleData[empId]) {
                scheduleData[empId] = { name: '', role: '', location: '', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '', sun: '' };
            }
            
            scheduleData[empId][field] = value;
            
            // If employee name changed, auto-fill role and pay info
            if (field === 'name' && value) {
                const employee = employees.find(emp => emp.name === value);
                if (employee) {
                    // Auto-fill the role from employee data
                    scheduleData[empId].role = employee.role || '';
                    scheduleData[empId].payRate = employee.payRate;
                    scheduleData[empId].payType = employee.payType;
                    
                    // Update the role dropdown to show employee's assigned role
                    const roleSelect = document.querySelector(`select[data-field="role"][data-emp="${empId}"]`);
                    if (roleSelect) {
                        // First, regenerate options to ensure the employee's role is available
                        const currentBrand = getCurrentBrand();
                        const currentLocation = getCurrentLocation();
                        roleSelect.innerHTML = getScheduleRoleOptions(currentBrand, currentLocation, employee.role);
                        // Set the value to the employee's role
                        roleSelect.value = employee.role || '';
                        // Disable the role selector since it should be auto-filled
                        roleSelect.disabled = true;
                    }
                }
            } else if (field === 'name' && !value) {
                // If name is cleared, enable the role selector again
                const roleSelect = document.querySelector(`select[data-field="role"][data-emp="${empId}"]`);
                if (roleSelect) {
                    roleSelect.disabled = false;
                    roleSelect.value = '';
                    scheduleData[empId].role = '';
                }
            }
            
            updateScheduleTotals();
            saveScheduleData();
        }
        
        function handleShiftSelectChange(event) {
            const empId = event.target.dataset.emp;
            const field = event.target.dataset.field;
            const value = event.target.value;
            
            if (!scheduleData[empId]) {
                scheduleData[empId] = { name: '', role: '', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '', sun: '' };
            }
            
            if (value === 'custom') {
                // Show custom input
                const customInput = document.querySelector(`.custom-shift[data-field="${field}"][data-emp="${empId}"]`);
                if (customInput) {
                    customInput.style.display = 'block';
                    customInput.focus();
                }
            } else {
                // Hide custom input and use preset value
                const customInput = document.querySelector(`.custom-shift[data-field="${field}"][data-emp="${empId}"]`);
                if (customInput) {
                    customInput.style.display = 'none';
                }
                scheduleData[empId][field] = value;
                updateScheduleTotals();
                saveScheduleData();
            }
        }
        
        function handleCustomShiftChange(event) {
            const empId = event.target.dataset.emp;
            const field = event.target.dataset.field;
            const value = event.target.value;
            
            if (!scheduleData[empId]) {
                scheduleData[empId] = { name: '', role: '', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '', sun: '' };
            }
            
            scheduleData[empId][field] = value;
            updateScheduleTotals();
            saveScheduleData();
        }
        
        
        function parseTimeRange(timeStr) {
            if (!timeStr || timeStr.trim() === '') return 0;
            
            // Handle formats like "9am-5pm", "9:00-17:00", "8-16", etc.
            const cleanStr = timeStr.toLowerCase().replace(/\s/g, '');
            
            // Match patterns like 9am-5pm, 9a-5p, 10a-1p, 4p-8:30p, 9:00am-5:00pm, 9-17, 9:00-17:00
            const patterns = [
                // Pattern 1: Both times must have am/pm/a/p (e.g., "9a-5p", "4p-8:30p")
                /(\d{1,2}(?::\d{2})?)(am|pm|a|p)-(\d{1,2}(?::\d{2})?)(am|pm|a|p)/,
                // Pattern 2: Optional am/pm/a/p (e.g., "9-5", "9am-5")
                /(\d{1,2}(?::\d{2})?)(am|pm|a|p)?-(\d{1,2}(?::\d{2})?)(am|pm|a|p)?/,
                // Pattern 3: Just numbers (e.g., "9-17", "9:30-17:30")
                /(\d{1,2}(?::\d{2})?)-(\d{1,2}(?::\d{2})?)/
            ];
            
            for (const pattern of patterns) {
                const match = cleanStr.match(pattern);
                if (match) {
                    console.log(`Matched pattern: ${pattern.source}`);
                    console.log(`Match groups:`, match);
                    
                    // Handle different pattern match groups
                    let startTime, endTime, startAmPm, endAmPm;
                    
                    // Check if both times have am/pm markers
                    if (match[2] && match[4]) {
                        // Both have am/pm markers
                        startTime = parseTime(match[1], match[2]);
                        endTime = parseTime(match[3], match[4]);
                    } else {
                        // One or both missing am/pm markers
                        startTime = parseTime(match[1], match[2]);
                        endAmPm = match[4];
                        if (!endAmPm && match[2]) {
                            endAmPm = (match[2] === 'am' || match[2] === 'a') ? 'p' : match[2];
                        }
                        endTime = parseTime(match[3], endAmPm);
                    }
                    
                    if (endTime <= startTime) endTime += 12; // Handle overnight shifts
                    const hours = Math.max(0, endTime - startTime);
                    
                    // Debug logging for Office Administration
                    console.log(`Parsing time range: "${timeStr}" -> ${hours} hours (${startTime} to ${endTime})`);
                    
                    return hours;
                }
            }
            
            console.log(`Failed to parse time range: "${timeStr}"`);
            return 0;
        }
        
        function parseTime(timeStr, ampm) {
            // Handle time with minutes (e.g., "8:30" or "8.5")
            let hours = 0, minutes = 0;
            
            if (timeStr.includes(':')) {
                const parts = timeStr.split(':');
                hours = parseInt(parts[0]) || 0;
                minutes = (parseInt(parts[1]) || 0) / 60; // Convert minutes to decimal
            } else {
                hours = parseFloat(timeStr) || 0;
                minutes = 0;
            }
            
            // Handle both 'am/pm' and 'a/p' formats
            if ((ampm === 'pm' || ampm === 'p') && hours < 12) {
                hours += 12;
            }
            if ((ampm === 'am' || ampm === 'a') && hours === 12) {
                hours = 0;
            }
            
            const time = hours + minutes;
            console.log(`parseTime: "${timeStr}" ${ampm || ''} -> ${hours} hours + ${minutes.toFixed(2)} minutes = ${time.toFixed(2)}`);
            
            return time;
        }
        
        function calculateWeeklyPay(empId, weeklyHours) {
            const empData = scheduleData[empId];
            if (!empData || !empData.name) return 0;
            
            const employee = employees.find(emp => emp.name === empData.name);
            if (!employee) return 0;
            
            if (employee.payType === 'weekly') {
                // GM weekly salary - fixed amount regardless of hours
                return employee.payRate;
            } else {
                // Hourly - calculate with overtime
                const regularHours = Math.min(weeklyHours, 40);
                const overtimeHours = Math.max(0, weeklyHours - 40);
                return (regularHours * employee.payRate) + (overtimeHours * employee.payRate * 1.5);
            }
        }
        
        function updateScheduleTotals() {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const dayTotals = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };
            let totalScheduledPay = 0;
            const employeeHours = {}; // Track total hours per unique employee
            
            
            // First pass: calculate total hours for each employee across all their scheduled rows
            Object.keys(scheduleData).forEach(empId => {
                const empData = scheduleData[empId];
                if (!empData.name) return;
                
                if (!employeeHours[empData.name]) {
                    employeeHours[empData.name] = 0;
                }
                
                let weeklyHours = 0;
                days.forEach(day => {
                    let dayHours = 0;
                    
                    // START OFFICE ADMINISTRATION SPECIFIC MODIFICATION
                    const currentBrand = getCurrentBrand();
                    const currentLocation = getCurrentLocation();
                    
                    if (currentBrand === 'Office Administration' && currentLocation === 'Office') {
                        // Parse Office Administration format: "Location1:8h|Location2:4h" or "Location1:9a-5p|Location2:4h"
                        const entries = parseOfficeEntries(empData[day]);
                        console.log(`Office Admin - Employee: ${empData.name}, Day: ${day}, Raw data: ${empData[day]}, Parsed entries:`, entries);
                        
                        entries.forEach(entry => {
                            // Check if hours is in "8h" format or time range format
                            if (entry.hours && entry.hours.includes('h') && !entry.hours.includes('-')) {
                                // Direct hours format: "8h"
                                const hours = parseFloat(entry.hours.replace('h', '')) || 0;
                                dayHours += hours;
                                console.log(`  Direct hours: ${entry.hours} = ${hours}h`);
                            } else if (entry.hours) {
                                // Time range format: "9a-5p", "9am-5pm", etc.
                                const hours = parseTimeRange(entry.hours);
                                dayHours += hours;
                                console.log(`  Time range: ${entry.hours} = ${hours}h`);
                            }
                        });
                        console.log(`  Total hours for ${day}: ${dayHours}`);
                    } else {
                        // Regular format
                        dayHours = parseTimeRange(empData[day]);
                    }
                    // END OFFICE ADMINISTRATION SPECIFIC MODIFICATION
                    
                    dayTotals[day] += dayHours;
                    weeklyHours += dayHours;
                });
                
                employeeHours[empData.name] += weeklyHours;
                
                // Update row totals (no pay information shown to employees)
                const weeklyTotalCell = document.querySelector(`.weekly-total[data-emp="${empId}"]`);
                if (weeklyTotalCell) weeklyTotalCell.textContent = `${weeklyHours.toFixed(1)}h`;
            });
            
            // Second pass: calculate pay for each unique employee once
            console.log('Calculating pay for employees:', Object.keys(employeeHours));
            
            Object.keys(employeeHours).forEach(employeeName => {
                const employee = employees.find(emp => emp.name === employeeName);
                if (!employee) {
                    console.warn(`Employee ${employeeName} not found in employees array`);
                    return;
                }
                
                console.log(`Employee: ${employeeName}, PayType: ${employee.payType}, PayRate: ${employee.payRate}, Hours: ${employeeHours[employeeName]}`);
                
                let weeklyPay = 0;
                if (employee.payType === 'weekly') {
                    // GM weekly salary - fixed amount regardless of hours
                    weeklyPay = employee.payRate || 0;
                } else {
                    // Hourly - calculate with overtime based on total hours
                    const totalHours = employeeHours[employeeName];
                    const regularHours = Math.min(totalHours, 40);
                    const overtimeHours = Math.max(0, totalHours - 40);
                    const payRate = employee.payRate || 0;
                    weeklyPay = (regularHours * payRate) + (overtimeHours * payRate * 1.5);
                }
                
                console.log(`  Weekly Pay: $${weeklyPay}`);
                totalScheduledPay += weeklyPay;
            });
            
            // Update daily totals in footer
            days.forEach(day => {
                const totalCell = document.getElementById(`total${day.charAt(0).toUpperCase() + day.slice(1)}`);
                if (totalCell) totalCell.textContent = `${dayTotals[day].toFixed(1)}h`;
            });
            
            // Update weekly totals
            const totalWeekHours = Object.values(dayTotals).reduce((sum, hours) => sum + hours, 0);
            const totalWeekCell = document.getElementById('totalWeek');
            if (totalWeekCell) totalWeekCell.textContent = `${totalWeekHours.toFixed(1)}h`;
            
            // Calculate and update daily budget information
            updateDailyBudgetTotals(dayTotals, totalScheduledPay);
            
            // Update budget comparison
            updateBudgetComparison(totalScheduledPay);
        }
        
        function updateDailyBudgetTotals(dayTotals, totalScheduledPay) {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            // Calculate daily GM pay portion (GM weekly salary / 7 days)
            let dailyGMPay = 0;
            const scheduledGMs = new Set();
            
            Object.keys(scheduleData).forEach(empId => {
                const empData = scheduleData[empId];
                if (empData.name) {
                    const employee = employees.find(emp => emp.name === empData.name);
                    if (employee && employee.payType === 'weekly') {
                        const hasShifts = days.some(day => empData[day] && empData[day].trim() !== '');
                        if (hasShifts && !scheduledGMs.has(employee.name)) {
                            dailyGMPay += employee.payRate / 7; // Spread weekly salary across 7 days
                            scheduledGMs.add(employee.name);
                        }
                    }
                }
            });
            
            // Calculate daily payroll for each day
            let weeklyPayrollTotal = 0;
            let weeklySalesTotal = 0;
            
            days.forEach((day, index) => {
                // Calculate hourly employee pay for this specific day
                let dailyHourlyPay = 0;
                const employeeDayHours = {};
                
                Object.keys(scheduleData).forEach(empId => {
                    const empData = scheduleData[empId];
                    if (!empData.name) return;
                    
                    const employee = employees.find(emp => emp.name === empData.name);
                    if (!employee || employee.payType === 'weekly') return; // Skip GMs
                    
                    const dayHours = parseTimeRange(empData[day]);
                    if (dayHours > 0) {
                        if (!employeeDayHours[empData.name]) {
                            employeeDayHours[empData.name] = 0;
                        }
                        employeeDayHours[empData.name] += dayHours;
                    }
                });
                
                // Calculate pay for hourly employees for this day
                Object.keys(employeeDayHours).forEach(employeeName => {
                    const employee = employees.find(emp => emp.name === employeeName);
                    if (employee) {
                        dailyHourlyPay += employeeDayHours[employeeName] * employee.payRate;
                    }
                });
                
                // Total daily payroll = hourly pay + daily GM portion
                const dailyPayroll = dailyHourlyPay + dailyGMPay;
                weeklyPayrollTotal += dailyPayroll;
                
                // Get daily sales
                const dailySales = currentWeekSales[day] || 0;
                weeklySalesTotal += dailySales;
                
                // Calculate labor percentage
                const laborPercentage = dailySales > 0 ? (dailyPayroll / dailySales * 100) : 0;
                
                // Update the display
                const payrollCell = document.getElementById(`payroll${dayNames[index]}`);
                const salesInput = document.getElementById(`sales${dayNames[index]}`);
                const laborCell = document.getElementById(`labor${dayNames[index]}`);
                
                if (payrollCell) payrollCell.textContent = `$${dailyPayroll.toFixed(0)}`;
                if (salesInput && salesInput.value !== dailySales.toString()) {
                    salesInput.value = dailySales > 0 ? dailySales : '';
                }
                if (laborCell) laborCell.textContent = `${laborPercentage.toFixed(1)}%`;
            });
            
            // Update weekly totals
            const weeklyLaborPercentage = weeklySalesTotal > 0 ? (weeklyPayrollTotal / weeklySalesTotal * 100) : 0;
            
            const weeklyPayrollCell = document.getElementById('payrollWeek');
            const weeklySalesCell = document.getElementById('salesWeek');
            const weeklyLaborCell = document.getElementById('laborWeek');
            
            if (weeklyPayrollCell) weeklyPayrollCell.textContent = `$${weeklyPayrollTotal.toFixed(0)}`;
            if (weeklySalesCell) weeklySalesCell.textContent = `$${weeklySalesTotal.toFixed(0)}`;
            if (weeklyLaborCell) weeklyLaborCell.textContent = `${weeklyLaborPercentage.toFixed(1)}%`;
        }
        
        function updateBudgetComparison(totalScheduledPay) {
            console.log('=== Updating Budget Comparison ===');
            console.log('Total Scheduled Pay:', totalScheduledPay);
            console.log('Current Week Sales:', currentWeekSales);
            
            const totalWeeklySales = Object.values(currentWeekSales).reduce((sum, sales) => sum + sales, 0);
            const weeklyPayrollBudget = totalWeeklySales * 0.25; // 25% for payroll
            
            console.log('Total Weekly Sales:', totalWeeklySales);
            console.log('Weekly Payroll Budget (25%):', weeklyPayrollBudget);
            
            // Update the new total projected sales and payroll budget fields
            const totalProjectedSalesElement = document.getElementById('totalProjectedSales');
            if (totalProjectedSalesElement) {
                totalProjectedSalesElement.textContent = `$${totalWeeklySales.toFixed(2)}`;
            }
            
            const totalProjectedPayrollBudgetElement = document.getElementById('totalProjectedPayrollBudget');
            if (totalProjectedPayrollBudgetElement) {
                totalProjectedPayrollBudgetElement.textContent = `$${weeklyPayrollBudget.toFixed(2)}`;
            }
            
            // Extract GM pay from totalScheduledPay for display purposes
            let gmPayTotal = 0;
            const scheduledGMs = new Set();
            
            // Calculate GM pay for display (this is already included in totalScheduledPay)
            Object.keys(scheduleData).forEach(empId => {
                const empData = scheduleData[empId];
                if (empData.name) {
                    const employee = employees.find(emp => emp.name === empData.name);
                    if (employee && employee.payType === 'weekly') {
                        // Check if this GM has any shifts scheduled this week
                        const hasShifts = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].some(day => {
                            return empData[day] && empData[day].trim() !== '';
                        });
                        
                        if (hasShifts && !scheduledGMs.has(employee.name)) {
                            gmPayTotal += employee.payRate;
                            scheduledGMs.add(employee.name);
                        }
                    }
                }
            });
            
            // Ensure totalScheduledPay is a valid number
            let validScheduledPay = 0;
            if (typeof totalScheduledPay === 'number' && !isNaN(totalScheduledPay)) {
                validScheduledPay = totalScheduledPay;
            } else {
                console.warn('Invalid totalScheduledPay value:', totalScheduledPay, 'Type:', typeof totalScheduledPay);
                validScheduledPay = 0;
            }
            
            // totalScheduledPay already includes GM pay, so no need to add it again
            const totalScheduledPayElement = document.getElementById('totalScheduledPay');
            if (totalScheduledPayElement) {
                totalScheduledPayElement.textContent = `$${validScheduledPay.toFixed(2)}`;
            } else {
                console.error('Could not find totalScheduledPay element');
            }
            document.getElementById('weeklyPayrollBudget').textContent = `$${weeklyPayrollBudget.toFixed(2)}`;
            document.getElementById('gmPayTotal').textContent = `$${gmPayTotal.toFixed(2)}`;
            
            const variance = validScheduledPay - weeklyPayrollBudget;
            const varianceElement = document.getElementById('budgetVariance');
            varianceElement.textContent = `$${Math.abs(variance).toFixed(2)} ${variance >= 0 ? 'Over' : 'Under'}`;
            varianceElement.className = variance >= 0 ? 'over-budget' : 'under-budget';
            
            const percentage = weeklyPayrollBudget > 0 ? (validScheduledPay / weeklyPayrollBudget * 100) : 0;
            const percentageElement = document.getElementById('budgetPercentage');
            percentageElement.textContent = `${percentage.toFixed(1)}%`;
            percentageElement.className = percentage > 100 ? 'over-budget' : 'under-budget';
        }
        
        function updateDailySalesDisplay() {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            
            // Update the sales inputs in the schedule footer
            dayKeys.forEach((key, index) => {
                const salesInput = document.getElementById(`sales${days[index]}`);
                if (salesInput) {
                    const sales = currentWeekSales[key] || 0;
                    salesInput.value = sales > 0 ? sales : '';
                }
            });
            
            updateScheduleTotals(); // Recalculate budget comparison
        }
        
        function generateScheduleHTML() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            
            let html = 'WEEKLY SCHEDULE - OPTIMUS PRIME COST\n';
            html += '='.repeat(50) + '\n\n';
            
            // Header row
            html += 'Employee'.padEnd(20) + 'Role'.padEnd(12);
            days.forEach(day => {
                html += day.substring(0, 3).padEnd(12);
            });
            html += 'Total\n';
            html += '-'.repeat(20 + 12 + (12 * 7) + 8) + '\n';
            
            // Employee rows
            Object.keys(scheduleData).forEach(empId => {
                const empData = scheduleData[empId];
                if (empData.name) {
                    html += empData.name.padEnd(20) + empData.role.padEnd(12);
                    let totalHours = 0;
                    dayKeys.forEach(day => {
                        const shift = empData[day] || '';
                        const hours = parseTimeRange(shift);
                        totalHours += hours;
                        html += (shift || 'OFF').padEnd(12);
                    });
                    html += `${totalHours.toFixed(1)}h\n`;
                }
            });
            
            return html;
        }
        
        // Employee Management Functions
        function renderEmployeeTable() {
            const tbody = document.getElementById('employeeTableBody');
            tbody.innerHTML = '';
            
            employees.forEach(employee => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.name}</td>
                    <td>${employee.role}</td>
                    <td>${employee.payType === 'weekly' ? `$${parseFloat(employee.payRate).toLocaleString()}/week` : `$${parseFloat(employee.payRate).toFixed(2)}/hr`}</td>
                    <td>${employee.email || 'N/A'}</td>
                    <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${employee.availability || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editEmployee(${employee.id})" style="margin-right: 5px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${employee.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function addEmployee(name, brand, location, role, payType, payRate, email, availability, notes) {
            try {
                const employeeData = {
                    name: name,
                    brand: brand,
                    location_id: location, // Enforce location_id
                    role: role,
                    pay_type: payType,
                    pay_rate: parseFloat(payRate),
                    email: email || null,
                    availability: availability || null,
                    notes: notes || null
                };
                
                const result = await DB_API.employees.create(employeeData);
                
                // Add to local array with database ID
                const newEmployee = {
                    id: result.id,
                    name: result.name,
                    brand: result.brand,
                    location: result.location_id,
                    role: result.role,
                    payType: result.pay_type,
                    payRate: result.pay_rate,
                    email: result.email,
                    availability: result.availability,
                    notes: result.notes
                };
                
                employees.push(newEmployee);
                renderEmployeeTable();
                renderScheduleTable(); // Update schedule dropdown
                showSuccess(`Employee ${name} added successfully!`);
                return true;
            } catch (error) {
                console.error('Error adding employee:', error);
                showError('Failed to add employee. ' + (error.message || 'Please try again.'));
                return false;
            }
        }
        
        // Populate employee brand dropdown
        function populateEmployeeBrandDropdown() {
            const brandDropdown = document.getElementById('empBrand');
            brandDropdown.innerHTML = '<option value="">Select Brand</option>';
            
            // Get unique brands from LOCATION_BRAND_MAP
            const uniqueBrands = [...new Set(LOCATION_BRAND_MAP.map(item => item.brand))];
            
            // If user has brand restrictions, filter accordingly
            const userBrands = currentUser.brands || [];
            const availableBrands = userBrands === 'all' 
                ? uniqueBrands 
                : (Array.isArray(userBrands) && userBrands.length > 0 
                    ? uniqueBrands.filter(brand => userBrands.includes(brand))
                    : uniqueBrands);
            
            availableBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandDropdown.appendChild(option);
            });
        }
        
        // Populate employee role dropdown
        function populateEmployeeRoleDropdown(brand, location) {
            const roleDropdown = document.getElementById('empRole');
            roleDropdown.innerHTML = '';
            
            // START TACO BRAND SPECIFIC MODIFICATION
            if (brand === 'Taco' || (location && location.toLowerCase().includes('taco'))) {
                // Taco brand specific roles
                const tacoRoles = [
                    { value: 'GM', text: 'General Manager' },
                    { value: '!Bartender', text: '!Bartender' },
                    { value: '!Cook', text: '!Cook' },
                    { value: 'Bartender', text: 'Bartender' },
                    { value: 'Cook', text: 'Cook' }
                ];
                
                tacoRoles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.value;
                    option.textContent = role.text;
                    roleDropdown.appendChild(option);
                });
            // END TACO BRAND SPECIFIC MODIFICATION
            // START DOUGHNUT BRAND SPECIFIC MODIFICATION
            } else if (brand === 'Doughnut' || (location && location.toUpperCase().startsWith('ODT'))) {
                // Doughnut brand specific roles
                const doughnutRoles = [
                    { value: 'GM', text: 'GM' },
                    { value: 'Barista', text: 'Barista' },
                    { value: 'FOH', text: 'Front of House (FOH)' },
                    { value: 'Den', text: 'Den' },
                    { value: 'Kitchen', text: 'Kitchen' }
                ];
                
                doughnutRoles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.value;
                    option.textContent = role.text;
                    roleDropdown.appendChild(option);
                });
            // END DOUGHNUT BRAND SPECIFIC MODIFICATION
            // START OFFICE ADMINISTRATION SPECIFIC MODIFICATION
            } else if (brand === 'Office Administration' && location === 'Office') {
                // Office Administration specific roles
                const officeRoles = [
                    { value: 'EOO', text: 'EOO' },
                    { value: 'EFO', text: 'EFO' },
                    { value: 'EUO', text: 'EUO' },
                    { value: 'EAO', text: 'EAO' },
                    { value: 'EMD', text: 'EMD' },
                    { value: 'EHRD', text: 'EHRD' },
                    { value: 'EHRDA', text: 'EHRDA' },
                    { value: 'EFM', text: 'EFM' }
                ];
                
                officeRoles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.value;
                    option.textContent = role.text;
                    roleDropdown.appendChild(option);
                });
            } else {
                // END OFFICE ADMINISTRATION SPECIFIC MODIFICATION
                
                // Regular roles for all other brands/locations
                const regularRoles = [
                    { value: 'GM', text: 'General Manager' },
                    { value: 'Manager 1', text: 'Manager 1' },
                    { value: 'Manager 2', text: 'Manager 2' },
                    { value: 'Manager 3', text: 'Manager 3' },
                    { value: 'Crew', text: 'Crew' },
                    { value: 'Driver', text: 'Driver' }
                ];
                
                regularRoles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.value;
                    option.textContent = role.text;
                    roleDropdown.appendChild(option);
                });
            }
        }
        
        // Update employee location dropdown based on selected brand
        function updateEmployeeLocationDropdown(selectedBrand) {
            const locationDropdown = document.getElementById('empLocation');
            locationDropdown.innerHTML = '<option value="">Select Location</option>';
            
            if (!selectedBrand) return;
            
            // Get locations for the selected brand
            const brandLocations = LOCATION_BRAND_MAP
                .filter(item => item.brand === selectedBrand)
                .map(item => item.location);
            
            // If user has location restrictions, filter accordingly
            const userLocations = currentUser.locations || [];
            const availableLocations = userLocations === 'all'
                ? brandLocations
                : (Array.isArray(userLocations) && userLocations.length > 0
                    ? brandLocations.filter(loc => userLocations.includes(loc))
                    : brandLocations);
            
            availableLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationDropdown.appendChild(option);
            });
        }
        
        function editEmployee(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            // Populate brand dropdown first
            populateEmployeeBrandDropdown();
            
            // Populate form with existing data
            document.getElementById('empName').value = employee.name;
            document.getElementById('empBrand').value = employee.brand || '';
            
            // Update location dropdown based on brand
            if (employee.brand) {
                updateEmployeeLocationDropdown(employee.brand);
                setTimeout(() => {
                    document.getElementById('empLocation').value = employee.location || '';
                    // Populate role dropdown based on brand/location
                    populateEmployeeRoleDropdown(employee.brand, employee.location || '');
                    // Set the current role
                    document.getElementById('empRole').value = employee.role;
                }, 100);
            } else {
                // No brand, populate with default roles
                populateEmployeeRoleDropdown('', '');
                document.getElementById('empRole').value = employee.role;
            }
            document.getElementById('empPayType').value = employee.payType;
            document.getElementById('empPayRate').value = employee.payRate;
            document.getElementById('empEmail').value = employee.email || '';
            document.getElementById('empAvailability').value = employee.availability || '';
            document.getElementById('empNotes').value = employee.notes || '';
            
            // Change modal title and store employee ID for update
            document.getElementById('employeeModalTitle').textContent = 'Edit Employee';
            document.getElementById('addEmployeeForm').dataset.editId = employeeId;
            
            // Show modal
            document.getElementById('addEmployeeModal').style.display = 'block';
        }
        
        async function updateEmployee(employeeId, name, brand, location, role, payType, payRate, email, availability, notes) {
            try {
                const employeeData = {
                    name: name,
                    brand: brand,
                    location_id: location, // Enforce location_id
                    role: role,
                    pay_type: payType,
                    pay_rate: parseFloat(payRate),
                    email: email || null,
                    availability: availability || null,
                    notes: notes || null
                };
                
                const result = await DB_API.employees.update(employeeId, employeeData);
                
                // Update local array
                const employeeIndex = employees.findIndex(emp => emp.id === employeeId);
                if (employeeIndex !== -1) {
                    employees[employeeIndex] = {
                        id: employeeId,
                        name: result.name,
                        brand: result.brand,
                        location: result.location_id,
                        role: result.role,
                        payType: result.pay_type,
                        payRate: result.pay_rate,
                        email: result.email,
                        availability: result.availability,
                        notes: result.notes
                    };
                }
                
                renderEmployeeTable();
                renderScheduleTable(); // Update schedule dropdown
                showSuccess(`Employee ${name} updated successfully!`);
                return true;
            } catch (error) {
                console.error('Error updating employee:', error);
                showError('Failed to update employee. ' + (error.message || 'Please try again.'));
                return false;
            }
        }
        
        async function deleteEmployee(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            if (confirm(`Delete employee ${employee.name}? This will also remove them from the schedule.`)) {
                try {
                    await DB_API.employees.delete(employeeId);
                    
                    // Remove from local array
                    employees = employees.filter(emp => emp.id !== employeeId);
                    
                    // Remove from schedule data
                    Object.keys(scheduleData).forEach(empId => {
                        if (scheduleData[empId].name === employee.name) {
                            scheduleData[empId] = { name: '', role: '', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '', sun: '' };
                        }
                    });
                    
                    await saveScheduleData();
                    renderEmployeeTable();
                    renderScheduleTable();
                    updateScheduleTotals();
                    showSuccess(`Employee ${employee.name} deleted successfully!`);
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    showError('Failed to delete employee. ' + (error.message || 'Please try again.'));
                }
            }
        }
        
        function handleDailySalesChange(event) {
            const day = event.target.id.replace('sales', '').toLowerCase();
            const value = parseFloat(event.target.value) || 0;
            currentWeekSales[day] = value;
            
            saveScheduleData();
            updateDailySalesDisplay();
            
            // Update the schedule footer with new sales data
            updateScheduleTotals();
        }

        // User management
        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            // Get current user's role and security code
            const currentUserRole = currentUser?.role || 'staff';
            const currentSecurityCode = getSecurityCodeForRole(currentUserRole);
            
            // Get current user's brands and locations for GM filtering
            const currentUserBrands = currentUser?.brands || [];
            const currentUserLocations = currentUser?.locations || [];
            
            // Filter users based on security code hierarchy
            Object.entries(USERS).forEach(([email, user]) => {
                // Get target user's security code
                const targetSecurityCode = getSecurityCodeForRole(user.role);
                
                // Skip users with higher security codes than current user
                if (targetSecurityCode > currentSecurityCode) {
                    return;
                }
                
                // Special filtering for General Managers (security code 3)
                if (currentSecurityCode === 3) {
                    // GM can only see users who share at least one brand or location
                    const userBrands = Array.isArray(user.brands) ? user.brands : 
                                     (user.brands === 'all' ? [] : []);
                    const userLocations = Array.isArray(user.locations) ? user.locations : 
                                        (user.locations === 'all' ? [] : []);
                    
                    // Check for shared brands
                    const hasSharedBrand = userBrands.length === 0 || // User has access to all brands
                                         currentUserBrands.some(brand => userBrands.includes(brand));
                    
                    // Check for shared locations
                    const hasSharedLocation = userLocations.length === 0 || // User has access to all locations
                                            currentUserLocations.some(location => userLocations.includes(location));
                    
                    // Skip if no shared brand or location
                    if (!hasSharedBrand && !hasSharedLocation) {
                        return;
                    }
                }
                const row = document.createElement('tr');
                const tempPassword = user.password || 'Not set';
                
                // Enhanced role display
                const roleDisplayNames = {
                    'super_admin': 'SUPER ADMIN',
                    'admin': 'ADMINISTRATOR',
                    'general_manager': 'GENERAL MANAGER',
                    'manager': 'MANAGER',
                    'staff': 'STAFF'
                };
                const roleDisplay = roleDisplayNames[user.role] || user.role.toUpperCase();
                
                // Brand display
                const brandsDisplay = user.brands === 'all' 
                    ? 'All Brands'
                    : (Array.isArray(user.brands) && user.brands.length > 0 
                        ? user.brands.join(', ') 
                        : 'All Brands');
                    
                // Location display
                const locationsDisplay = user.locations === 'all'
                    ? 'All Locations'
                    : (Array.isArray(user.locations) && user.locations.length > 0
                        ? user.locations.join(', ')
                        : 'All Locations');
                
                // Determine if current user can edit/delete this user
                const canEdit = currentSecurityCode >= targetSecurityCode;
                const actionButtons = canEdit ? `
                    <button class="btn btn-primary" onclick="editUser('${email}')" style="margin-right: 5px;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-danger" onclick="deleteUser('${email}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                ` : '<span style="color: #6c757d;">No permissions</span>';
                
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${email}</td>
                    <td>
                        <span class="role-badge role-badge-${user.role}">${roleDisplay}</span>
                        <small style="color: #6c757d; display: block;">Security Code: ${targetSecurityCode}</small>
                        <small style="color: #6c757d;">Brands: ${brandsDisplay}</small>
                        <br><small style="color: #6c757d;">Locations: ${locationsDisplay}</small>
                    </td>
                    <td><code style="background: #f8f9fa; padding: 4px 8px; border-radius: 4px;">${tempPassword}</code></td>
                    <td><span class="status-badge status-active">ACTIVE</span></td>
                    <td>${actionButtons}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function addUser(name, email, role, password, brands, locations) {
            const normalizedEmail = email.toLowerCase();
            
            // Check if user already exists
            if (USERS[normalizedEmail]) {
                showError('User with this email already exists');
                return false;
            }
            
            // Check if current user can create a user with this security code
            const currentSecurityCode = getSecurityCodeForRole(currentUser.role);
            const targetSecurityCode = getSecurityCodeForRole(role);
            
            if (targetSecurityCode > currentSecurityCode) {
                showError('You cannot create users with higher security codes than your own');
                return false;
            }
            
            try {
                // Save to database
                const userData = {
                    email: normalizedEmail,
                    name: name,
                    role: role,
                    password: password,
                    brands: JSON.stringify(brands),
                    locations: JSON.stringify(locations)
                };
                
                await DB_API.users.create(userData);
                
                // Add to local store
                const newUser = {
                    name: name,
                    role: role,
                    password: password,
                    brands: brands,
                    locations: locations
                };
                
                usersData[normalizedEmail] = newUser;
                USERS[normalizedEmail] = newUser;
                
                // Save custom users to localStorage as backup
                saveUsers(USERS);
                
                renderUsersTable();
                showSuccess('User added successfully');
                return true;
                
            } catch (error) {
                console.error('Error adding user to database:', error);
                showError('Failed to add user. Please try again.');
                return false;
            }
        }

        async function deleteUser(email) {
            const normalizedEmail = email.toLowerCase();
            const targetUser = USERS[normalizedEmail];
            
            if (!targetUser) {
                showError('User not found');
                return;
            }
            
            // Check role hierarchy
            if (!canManageUser(currentUser.role, targetUser.role)) {
                showError('You do not have permission to delete this user');
                return;
            }
            
            // Don't allow deleting default users
            if (GLOBAL_USERS[normalizedEmail]) {
                showError('Cannot delete default system users');
                return;
            }
            
            const userName = targetUser.name || email;
            
            if (confirm(`Delete user ${userName}?`)) {
                try {
                    // First get the user from database to get their ID
                    const dbUsers = await DB_API.users.get(normalizedEmail);
                    if (dbUsers && dbUsers.length > 0) {
                        // Delete from database
                        await DB_API.users.delete(dbUsers[0].id);
                    }
                    
                    // Remove from all stores
                    delete usersData[normalizedEmail];
                    delete USERS[normalizedEmail];
                    
                    // Update localStorage
                    const customUsers = JSON.parse(localStorage.getItem('couchman_users') || '{}');
                    delete customUsers[normalizedEmail];
                    localStorage.setItem('couchman_users', JSON.stringify(customUsers));
                    
                    renderUsersTable();
                    showSuccess('User deleted successfully');
                    
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showError('Failed to delete user. Please try again.');
                }
            }
        }
        
        function editUser(email) {
            const user = usersData[email];
            if (!user) return;
            
            // Check role hierarchy
            if (!canManageUser(currentUser.role, user.role)) {
                showError('You do not have permission to edit this user');
                return;
            }
            
            // Populate edit form
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserRole').value = user.role;
            
            // Set brand access type and selections
            if (user.brands === 'all' || (Array.isArray(user.brands) && user.brands.includes('all'))) {
                document.getElementById('editBrandAccessType').value = 'all';
                document.getElementById('editBrandSelectionGroup').style.display = 'none';
            } else {
                document.getElementById('editBrandAccessType').value = 'specific';
                document.getElementById('editBrandSelectionGroup').style.display = 'block';
                
                // Check the appropriate brand checkboxes
                document.querySelectorAll('.edit-brand-checkbox').forEach(cb => {
                    cb.checked = user.brands && user.brands.includes(cb.value);
                });
            }
            
            // Set location access type and selections
            if (user.locations === 'all' || (Array.isArray(user.locations) && user.locations.includes('all'))) {
                document.getElementById('editLocationAccessType').value = 'all';
                document.getElementById('editLocationSelectionGroup').style.display = 'none';
            } else {
                document.getElementById('editLocationAccessType').value = 'specific';
                document.getElementById('editLocationSelectionGroup').style.display = 'block';
                
                // Update location checkboxes based on selected brands
                updateEditLocationCheckboxes();
                
                // Set selected locations after checkboxes are created
                setTimeout(() => {
                    document.querySelectorAll('.edit-location-checkbox').forEach(cb => {
                        cb.checked = user.locations && user.locations.includes(cb.value);
                    });
                }, 100);
            }
            
            // Clear password field
            document.getElementById('editUserPassword').value = '';
            
            // Show modal
            document.getElementById('editUserModal').style.display = 'block';
        }
        
        async function updateUser(email, name, role, password, brands, locations) {
            const user = usersData[email];
            if (!user) return false;
            
            try {
                // Prepare update data
                const updateData = {
                    id: user.id || email, // Use ID if available, otherwise email
                    email: email,
                    name: name,
                    role: role,
                    brands: JSON.stringify(brands),
                    locations: JSON.stringify(locations)
                };
                
                // Only include password if it's being changed
                if (password) {
                    updateData.password = password;
                }
                
                // Update in database
                await DB_API.users.update(updateData);
                
                // Update local data
                user.name = name;
                user.role = role;
                user.brands = brands;
                user.locations = locations;
                
                // Update password if provided
                if (password) {
                    user.password = password;
                }
                
                // Update both display data and login data
                USERS[email] = user;
                usersData[email] = user;
                
                // Save to localStorage as backup
                saveUsers(USERS);
                
                showSuccess(`User ${name} updated successfully!`);
                renderUsersTable();
                return true;
                
            } catch (error) {
                console.error('Error updating user:', error);
                showError('Failed to update user. Please try again.');
                return false;
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Section').classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            currentTab = tabName;
            
            // Handle schedule tab auto-refresh
            if (tabName === 'schedule') {
                // Check if a location is selected first
                const currentLocation = getCurrentLocation();
                
                if (!currentLocation) {
                    // No location selected - show message instead of loading schedule
                    const scheduleSection = document.getElementById('scheduleSection');
                    if (scheduleSection) {
                        const scheduleContent = scheduleSection.querySelector('.schedule-content') || scheduleSection;
                        scheduleContent.innerHTML = `
                            <div style="text-align: center; padding: 50px; background: #f8f9fa; border-radius: 10px; margin: 20px;">
                                <i class="fas fa-map-marker-alt" style="font-size: 48px; color: #e74c3c; margin-bottom: 20px;"></i>
                                <h2 style="color: #2c3e50; margin-bottom: 10px;">No Location Selected</h2>
                                <p style="color: #7f8c8d; font-size: 18px;">Please select a location from the dropdown above to view and manage the schedule.</p>
                            </div>
                        `;
                    }
                    // Stop auto-refresh since no location
                    stopScheduleAutoRefresh();
                    return;
                }
                
                // Start auto-refresh when entering schedule tab with location
                startScheduleAutoRefresh();
                // Load employees from database first
                loadEmployeeData().then(() => {
                    console.log('Employees loaded for schedule tab:', employees.length);
                    // Then load schedule data
                    return loadScheduleData();
                }).then(() => {
                    renderScheduleTable();
                    updateScheduleTotals();
                });
            } else {
                // Stop auto-refresh when leaving schedule tab
                stopScheduleAutoRefresh();
            }
            
            // Initialize checklist content when switching to checklists tab
            if (tabName === 'checklists') {
                setTimeout(() => {
                    updateChecklistTabs(); // Update tabs based on current brand/location
                    renderChecklistContent();
                }, 100);
            }
            
            // Reload users from database when switching to users tab
            if (tabName === 'users' && typeof DB_API !== 'undefined') {
                loadAllUsersFromDatabase().then(() => {
                    renderUsersTable();
                });
            }
        }

        function switchInventoryArea(area) {
            document.querySelectorAll('[data-area]').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`[data-area="${area}"]`).classList.add('active');
            currentArea = area;
            renderInventoryTable();
            calculateEstimatedOrderTotal(); // Update estimated order total when switching areas
        }

        // Track if event listeners have been added
        let eventListenersAdded = false;
        
        // Event listeners
        function addEventListeners() {
            // Prevent adding listeners multiple times
            if (eventListenersAdded) return;
            eventListenersAdded = true;
            
            // Authentication
            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleAuth(emailInput.value.trim(), passwordInput.value);
            });

            logoutBtn.addEventListener('click', logout);

            // Budget calculator
            projectedSalesInput.addEventListener('input', updateBudgetDisplay);

            // Tab switching
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    switchTab(tab.dataset.tab);
                });
            });
            

            // Inventory area switching
            document.querySelectorAll('[data-area]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    switchInventoryArea(tab.dataset.area);
                });
            });

            // Save inventory

            // User management
            addUserBtn.addEventListener('click', () => {
                console.log('Add User Button clicked');
                console.log('Current user:', currentUser);
                console.log('getSecurityCodeForRole defined?', typeof getSecurityCodeForRole !== 'undefined');
                
                // Check if user has permission to add users using security codes
                let currentSecurityCode = 1; // Default to lowest permission
                if (typeof getSecurityCodeForRole !== 'undefined') {
                    currentSecurityCode = getSecurityCodeForRole(currentUser.role);
                } else {
                    console.warn('getSecurityCodeForRole not defined, using role-based check');
                    // Fallback to role-based check
                    const adminRoles = ['super_admin', 'admin', 'general_manager', 'manager'];
                    if (!adminRoles.includes(currentUser.role)) {
                        showError('You do not have permission to add users');
                        return;
                    }
                }
                
                if (currentSecurityCode < 1) {
                    showError('You do not have permission to add users');
                    return;
                }
                
                // Reset form
                document.getElementById('addUserForm').reset();
                
                // Reset brand and location selections
                document.getElementById('brandAccessType').value = 'all';
                document.getElementById('locationAccessType').value = 'all';
                document.getElementById('brandSelectionGroup').style.display = 'none';
                document.getElementById('locationSelectionGroup').style.display = 'none';
                
                // Uncheck all checkboxes
                document.querySelectorAll('.brand-checkbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.location-checkbox').forEach(cb => cb.checked = false);
                
                // Clear search fields
                const brandSearch = document.getElementById('brandSearch');
                if (brandSearch) brandSearch.value = '';
                const locationSearch = document.getElementById('locationSearch');
                if (locationSearch) locationSearch.value = '';
                
                // Update role options based on current user's permissions
                if (typeof updateRoleSelectOptions !== 'undefined') {
                    updateRoleSelectOptions();
                }
                
                // Initialize location checkboxes
                if (typeof updateLocationCheckboxes !== 'undefined') {
                    updateLocationCheckboxes();
                }
                
                console.log('About to show modal...');
                console.log('Modal element:', addUserModal);
                addUserModal.style.display = 'block';
                console.log('Modal display set to:', addUserModal.style.display);
            });

            // Share Team URL button
            document.getElementById('shareUrlBtn').addEventListener('click', () => {
                if (currentUser.role !== 'admin') {
                    showError('Only administrators can share team URLs');
                    return;
                }
                
                // Copy base URL without any fragments
                const baseUrl = window.location.origin + window.location.pathname;
                const customUserCount = Object.keys(JSON.parse(localStorage.getItem('couchman_users') || '{}')).length;
                
                navigator.clipboard.writeText(baseUrl).then(() => {
                    showSuccess(`URL copied! 
                        
⚠️ IMPORTANT: Only the 3 global accounts work on all devices:
• superadmin@couchmancompanies.com
• pizzamanager@theopt.net  
• staff@theopt.net

Custom users (${customUserCount} on this device) must be created separately on each device.`);
                }).catch(() => {
                    // Fallback for older browsers
                    prompt('Copy this URL to share with your team:', baseUrl);
                });
            });

            // Modal handling
            document.querySelector('.close').addEventListener('click', () => {
                addUserModal.style.display = 'none';
            });

            document.getElementById('cancelAddUser').addEventListener('click', () => {
                addUserModal.style.display = 'none';
            });

            // Add user form
            document.getElementById('addUserForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('newUserName').value;
                const email = document.getElementById('newUserEmail').value.toLowerCase();
                const role = document.getElementById('newUserRole').value;
                const password = document.getElementById('newUserPassword').value;
                
                // Simple brand/location handling
                const brandAccessType = document.getElementById('brandAccessType').value;
                let brands = brandAccessType === 'all' ? 'all' : 
                    Array.from(document.querySelectorAll('.brand-checkbox:checked')).map(cb => cb.value);
                
                const locationAccessType = document.getElementById('locationAccessType').value;
                let locations = locationAccessType === 'all' ? 'all' : 
                    Array.from(document.querySelectorAll('.location-checkbox:checked')).map(cb => cb.value);
                
                // Validate
                if (!name || !email || !role || !password) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                if (brands.length === 0) brands = 'all';
                if (locations.length === 0) locations = 'all';
                
                if (addUser(name, email, role, password, brands, locations)) {
                    document.getElementById('addUserModal').style.display = 'none';
                    e.target.reset();
                    document.getElementById('brandAccessType').value = 'all';
                    document.getElementById('locationAccessType').value = 'all';
                    toggleBrandSelection();
                    toggleLocationSelection();
                }
            });

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === addUserModal) {
                    addUserModal.style.display = 'none';
                }
                if (e.target === document.getElementById('editUserModal')) {
                    document.getElementById('editUserModal').style.display = 'none';
                }
            });
            
            // Edit user modal handlers
            const editUserModal = document.getElementById('editUserModal');
            const editUserForm = document.getElementById('editUserForm');
            
            // Close edit modal
            editUserModal.querySelector('.close').addEventListener('click', () => {
                editUserModal.style.display = 'none';
            });
            
            document.getElementById('cancelEditUser').addEventListener('click', () => {
                editUserModal.style.display = 'none';
            });
            
            // Edit user form submission
            editUserForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('editUserEmail').value;
                const name = document.getElementById('editUserName').value;
                const role = document.getElementById('editUserRole').value;
                const password = document.getElementById('editUserPassword').value;
                
                // Get selected brands
                const editBrandAccessType = document.getElementById('editBrandAccessType').value;
                let brands = editBrandAccessType === 'all' ? 'all' : 
                    Array.from(document.querySelectorAll('.edit-brand-checkbox:checked')).map(cb => cb.value);
                
                // Get selected locations
                const editLocationAccessType = document.getElementById('editLocationAccessType').value;
                let locations = editLocationAccessType === 'all' ? 'all' : 
                    Array.from(document.querySelectorAll('.edit-location-checkbox:checked')).map(cb => cb.value);
                
                if (brands.length === 0) brands = 'all';
                if (locations.length === 0) locations = 'all';
                
                if (updateUser(email, name, role, password, brands, locations)) {
                    editUserModal.style.display = 'none';
                }
            });
            
            // Brand checkbox change handlers
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('brand-checkbox')) {
                    updateLocationCheckboxes();
                }
            });
            
            // Remove old edit user brands event listener since we're using checkboxes now
            
            // Mobile Inventory Functions
            function openMobileInventory() {
                if (!isManager()) {
                    showError('Only administrators and managers can access mobile inventory');
                    return;
                }
                
                document.getElementById('mobileInventoryModal').style.display = 'block';
                renderMobileInventoryList('freezer');
            }

            function renderMobileInventoryList(area) {
                const container = document.getElementById('mobileInventoryList');
                const items = inventoryItems[area] || [];
                
                container.innerHTML = '';
                
                items.forEach(item => {
                    const itemData = inventoryData[item] || { par: 0, have: 0, area: area };
                    const orderQty = calculateOrder(itemData.par, itemData.have);
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'mobile-inventory-item';
                    itemDiv.style.cssText = `
                        display: flex;
                        align-items: center;
                        padding: 12px;
                        margin: 8px 0;
                        background: white;
                        border: 2px solid #e0e0e0;
                        border-radius: 8px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    `;
                    
                    itemDiv.innerHTML = `
                        <div style="flex: 1; font-weight: 600; font-size: 0.9rem;">${item}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="mobile-count-btn" data-item="${item}" data-action="minus" style="
                                width: 40px; height: 40px; border: none; border-radius: 50%;
                                background: #e74c3c; color: white; font-size: 1.2rem; font-weight: bold;
                                display: flex; align-items: center; justify-content: center; cursor: pointer;
                            ">-</button>
                            <div style="
                                min-width: 60px; text-align: center; font-weight: bold; font-size: 1.1rem;
                                padding: 8px; background: #f8f9fa; border-radius: 4px;
                            " id="mobile-count-${item.replace(/[^a-zA-Z0-9]/g, '_')}">${itemData.have}</div>
                            <button class="mobile-count-btn" data-item="${item}" data-action="plus" style="
                                width: 40px; height: 40px; border: none; border-radius: 50%;
                                background: #27ae60; color: white; font-size: 1.2rem; font-weight: bold;
                                display: flex; align-items: center; justify-content: center; cursor: pointer;
                            ">+</button>
                        </div>
                    `;
                    
                    container.appendChild(itemDiv);
                });
                
                // Add event listeners to count buttons
                container.querySelectorAll('.mobile-count-btn').forEach(btn => {
                    btn.addEventListener('click', handleMobileCount);
                });
            }

            function handleMobileCount(event) {
                const item = event.target.dataset.item;
                const action = event.target.dataset.action;
                const itemId = item.replace(/[^a-zA-Z0-9]/g, '_');
                const countDisplay = document.getElementById(`mobile-count-${itemId}`);
                
                if (!inventoryData[item]) {
                    inventoryData[item] = { par: 0, have: 0, area: currentArea };
                }
                
                let currentCount = inventoryData[item].have;
                
                if (action === 'plus') {
                    currentCount += 0.25;
                } else if (action === 'minus' && currentCount > 0) {
                    currentCount = Math.max(0, currentCount - 0.25);
                }
                
                inventoryData[item].have = Math.round(currentCount * 4) / 4; // Round to nearest 0.25
                inventoryData[item].lastModified = new Date().toISOString();
                inventoryData[item].modifiedBy = currentUser.email;
                
                countDisplay.textContent = inventoryData[item].have;
                
                // Auto-save changes
                saveInventoryData(currentUser.email);
            }

            function saveMobileInventory() {
                saveInventoryData(currentUser.email);
                document.getElementById('mobileInventoryModal').style.display = 'none';
                renderInventoryTable(); // Refresh main inventory table
                calculateEstimatedOrderTotal(); // Update estimated order total
                showSuccess('Mobile inventory counts saved successfully!');
            }

            // Pricing Functions
            function openPricingModal() {
                if (currentUser.role !== 'admin') {
                    showError('Only administrators can update pricing');
                    return;
                }
                
                document.getElementById('updatePricingModal').style.display = 'block';
            }

            function updatePricing() {
                const pricingText = document.getElementById('pricingData').value.trim();
                if (!pricingText) {
                    showError('Please paste pricing data from column A');
                    return;
                }
                
                // Parse prices from column A format - extract numeric values from prices like "$25.00", "PRICE", etc.
                const lines = pricingText.split('\n').map(line => line.trim());
                const prices = [];
                
                lines.forEach(line => {
                    // Skip headers and empty lines
                    if (!line || line.toLowerCase().includes('price') || line.toLowerCase().includes('example')) {
                        return;
                    }
                    
                    // Extract price from formats like "$25.00", "25.00", etc.
                    const priceMatch = line.match(/\$?(\d+\.?\d*)/);
                    if (priceMatch) {
                        const price = parseFloat(priceMatch[1]);
                        if (!isNaN(price) && price > 0) {
                            prices.push(price);
                        }
                    }
                });
                
                if (prices.length === 0) {
                    showError('No valid prices found. Please check the format of your data.');
                    return;
                }
                
                // Get all inventory items
                const allItems = [];
                Object.keys(inventoryItems).forEach(area => {
                    inventoryItems[area].forEach(item => {
                        allItems.push(item);
                    });
                });
                
                // Map prices to items (if counts don't match, map what we can)
                let updatedCount = 0;
                const maxItems = Math.min(prices.length, allItems.length);
                
                for (let i = 0; i < maxItems; i++) {
                    itemPricing[allItems[i]] = prices[i];
                    updatedCount++;
                }
                
                // Save pricing data
                const storageKey = getLocationStorageKey('itemPricing', currentUser.email);
                localStorage.setItem(storageKey, JSON.stringify(itemPricing));
                
                document.getElementById('updatePricingModal').style.display = 'none';
                document.getElementById('pricingData').value = '';
                
                showSuccess(`Updated pricing for ${updatedCount} items (${prices.length} prices found)`);
            }

            // Monthly Inventory Functions - Complete data from CSV
            const monthlyInventoryItems = {
                'cheese-mozzarella': [
                    'Block Mozzarella',
                    'Shredded Mozzarella'
                ],
                'cheese-other': [
                    'Romano',
                    'Feta',
                    'Cheddar'
                ],
                'meat': [
                    'Pepperoni',
                    'Bold Pepperoni',
                    'Bacon',
                    'Italian Sausage',
                    'Salami',
                    'Canadian Bacon',
                    'Hamburger',
                    'Fajita Chicken-pizzas',
                    'Wings',
                    'Boneless Chicken Chunks'
                ],
                'groceries': [
                    'Mushrooms',
                    'Pineapple Bits',
                    'Black Olives',
                    'Sliced Kalamata Olives',
                    'Mild Peppers',
                    'Jalapeno Peppers',
                    'Pepperoncini',
                    'Greek Dressing',
                    'Vinegar',
                    'Buttermilk',
                    'Mayo(extra heavy)',
                    'Mayo Squeeze Bottles',
                    'Fat Free Rasp Vinaigrette',
                    'Catalina',
                    'Blue Cheese',
                    'Regular BBQ Sauce',
                    'Honey BBQ Sauce',
                    'Medium Buffalo Sauce',
                    'Hot Buffalo Sauce',
                    'SBR Buffalo Sauce',
                    'Sweet Red Chili Sauce',
                    'Anchovies',
                    'Dry Yeast',
                    'Salt',
                    'Sugar',
                    'Cajun',
                    'Sesame Seed (5 lb)',
                    'Sesame Seed (21oz cont.)',
                    'Cinnamon',
                    'Icing',
                    'Corn Oil',
                    'Italian Mix (Papa Joe\'s)',
                    'Hidden Valley Ranch',
                    'Beets',
                    'Garlic Dip Grandioso',
                    'Garlic',
                    'Whirl Butter',
                    'Crushed Red Peppers',
                    'Single Serve Parmesan Packet',
                    'Chip Bags (One size only)',
                    '10" Thin Crust',
                    '14" Thin Crust',
                    'Gluten Free Crusts',
                    'Cauliflower Crusts',
                    'Round(white)',
                    'Square(brown)',
                    'Jet\'s Sauce',
                    'Jet\'s Seasoning',
                    '8" Brownie',
                    '8" Chocolate Chip Cookie'
                ],
                'produce': [
                    'Lettuce Precut (romaine/iceberg)',
                    'Lettuce Plain Shredded (subs)',
                    'Lettuce Plain (heads)',
                    'Lettuce Romaine',
                    'Grape Tomatoes',
                    'Tomatoes Whole (20 lb box)',
                    'Tomatoes Precut',
                    'Green Peppers Whole (10 lb box)',
                    'Green Peppers Whole (25 lb box)',
                    'Green Peppers Precut',
                    'Onions Whole (50 lb bag)',
                    'Onions Precut',
                    'Red Onions Whole (25 lb bag)'
                ],
                'paper-plastic': [
                    '9" Inserts',
                    '10" Inserts',
                    '12" Inserts',
                    '14" Inserts',
                    '14.75" X 10.25" Inserts',
                    '17.75" X 12.75" Inserts',
                    '4.75 x 6.25 Inserts (Individual)',
                    'Jet\'s Bags (#6)',
                    'Jet\'s Bags (#12)',
                    '8.5" Jet\'s Paper Plate',
                    'Napkins (Xpressnap)',
                    'Jet\'s Coated Paper Liners',
                    'Solo 4 oz. Cups',
                    'Solo 4 oz. Lids',
                    'Small Salad Cont. 24 oz.',
                    'Small(24oz)/Med(48oz) Salad Lids',
                    'Med Salad Cont. 48 oz.',
                    'Party Salad Lids (160oz)',
                    'Party Salad Cont. (160oz)',
                    'Squeeze Bottles (12 oz)',
                    'Jet\'s Grocery Thank You Bags',
                    'Lid Supports',
                    '12 oz Plastic Cups',
                    'Salad Tongs',
                    'Jet\'s Fork and Knife Set',
                    '10" Pizza Box',
                    '12" Pizza Box',
                    '14" Pizza Box',
                    '15"x10" Pizza Box',
                    '18"x13" Pizza Box',
                    '9"x9" Slice Box',
                    'Wing Box',
                    '6.5 x 5 Individual Slice Box'
                ],
                'beverages': [
                    '2 Liters Pop (all varieties)',
                    '20oz Pop (all varieties)',
                    'Dasani Water',
                    'Smart Water',
                    'Powerade',
                    'Monster Energy',
                    'Gold Peak Tea',
                    '2.5 Gal Box (Sparkling Brands)',
                    '2.5 Gal Bbox (unsweetened tea)',
                    '5 Gal Bbox (Sparkling Brands)',
                    '5 Gal Bbox (unsweetened tea)'
                ]
            };

            // Default pricing from CSV (will be updated via pricing update feature)
            const defaultMonthlyPricing = {
                // Cheese Mozzarella
                'Block Mozzarella': 162.80,
                'Shredded Mozzarella': 98.02,
                
                // Cheese Other
                'Romano': 27.60,
                'Feta': 44.82,
                'Cheddar': 28.40,
                
                // Meats
                'Pepperoni': 76.25,
                'Bold Pepperoni': 40.70,
                'Bacon': 102.80,
                'Italian Sausage': 48.15,
                'Salami': 41.10,
                'Canadian Bacon': 38.00,
                'Hamburger': 39.10,
                'Fajita Chicken-pizzas': 40.59,
                'Wings': 60.99,
                'Boneless Chicken Chunks': 33.29,
                
                // Groceries
                'Mushrooms': 46.89,
                'Pineapple Bits': 39.89,
                'Black Olives': 52.99,
                'Sliced Kalamata Olives': 42.54,
                'Mild Peppers': 30.42,
                'Jalapeno Peppers': 36.23,
                'Pepperoncini': 26.04,
                'Greek Dressing': 57.18,
                'Vinegar': 19.91,
                'Buttermilk': 23.27,
                'Mayo(extra heavy)': 65.61,
                'Mayo Squeeze Bottles': 50.22,
                'Fat Free Rasp Vinaigrette': 36.13,
                'Catalina': 25.59,
                'Blue Cheese': 33.00,
                'Regular BBQ Sauce': 51.08,
                'Honey BBQ Sauce': 57.68,
                'Medium Buffalo Sauce': 65.53,
                'Hot Buffalo Sauce': 65.28,
                'SBR Buffalo Sauce': 60.89,
                'Sweet Red Chili Sauce': 64.63,
                'Anchovies': 14.73,
                'Dry Yeast': 10.55,
                'Salt': 8.47,
                'Sugar': 27.44,
                'Cajun': 7.70,
                'Sesame Seed (5 lb)': 25.69,
                'Sesame Seed (21oz cont.)': 7.44,
                'Cinnamon': 6.21,
                'Icing': 62.98,
                'Corn Oil': 28.59,
                'Italian Mix (Papa Joe\'s)': 33.45,
                'Hidden Valley Ranch': 36.28,
                'Beets': 32.32,
                'Garlic Dip Grandioso': 26.48,
                'Garlic': 30.76,
                'Whirl Butter': 30.28,
                'Crushed Red Peppers': 13.46,
                'Single Serve Parmesan Packet': 14.33,
                'Chip Bags (One size only)': 0.00, // No price listed in CSV
                '10" Thin Crust': 39.42,
                '14" Thin Crust': 31.12,
                'Gluten Free Crusts': 56.55,
                'Cauliflower Crusts': 126.55,
                'Round(white)': 18.59,
                'Square(brown)': 18.77,
                'Jet\'s Sauce': 32.19,
                'Jet\'s Seasoning': 46.89,
                '8" Brownie': 42.09,
                '8" Chocolate Chip Cookie': 31.29,
                
                // Produce (no prices listed in CSV)
                'Lettuce Precut (romaine/iceberg)': 0.00,
                'Lettuce Plain Shredded (subs)': 0.00,
                'Lettuce Plain (heads)': 0.00,
                'Lettuce Romaine': 0.00,
                'Grape Tomatoes': 0.00,
                'Tomatoes Whole (20 lb box)': 0.00,
                'Tomatoes Precut': 0.00,
                'Green Peppers Whole (10 lb box)': 0.00,
                'Green Peppers Whole (25 lb box)': 0.00,
                'Green Peppers Precut': 0.00,
                'Onions Whole (50 lb bag)': 0.00,
                'Onions Precut': 0.00,
                'Red Onions Whole (25 lb bag)': 0.00,
                
                // Paper & Plastic
                '9" Inserts': 12.13,
                '10" Inserts': 12.13,
                '12" Inserts': 15.54,
                '14" Inserts': 20.14,
                '14.75" X 10.25" Inserts': 17.27,
                '17.75" X 12.75" Inserts': 23.35,
                '4.75 x 6.25 Inserts (Individual)': 12.75,
                'Jet\'s Bags (#6)': 17.13,
                'Jet\'s Bags (#12)': 43.84,
                '8.5" Jet\'s Paper Plate': 21.49,
                'Napkins (Xpressnap)': 60.19,
                'Jet\'s Coated Paper Liners': 42.91,
                'Solo 4 oz. Cups': 83.61,
                'Solo 4 oz. Lids': 50.32,
                'Small Salad Cont. 24 oz.': 26.72,
                'Small(24oz)/Med(48oz) Salad Lids': 22.51,
                'Med Salad Cont. 48 oz.': 35.12,
                'Party Salad Lids (160oz)': 14.47,
                'Party Salad Cont. (160oz)': 22.45,
                'Squeeze Bottles (12 oz)': 18.21,
                'Jet\'s Grocery Thank You Bags': 25.48,
                'Lid Supports': 12.70,
                '12 oz Plastic Cups': 52.88,
                'Salad Tongs': 28.32,
                'Jet\'s Fork and Knife Set': 51.38,
                '10" Pizza Box': 24.57,
                '12" Pizza Box': 30.58,
                '14" Pizza Box': 29.86,
                '15"x10" Pizza Box': 26.25,
                '18"x13" Pizza Box': 23.44,
                '9"x9" Slice Box': 21.71,
                'Wing Box': 26.26,
                '6.5 x 5 Individual Slice Box': 21.13,
                
                // Beverages
                '2 Liters Pop (all varieties)': 16.00,
                '20oz Pop (all varieties)': 26.16,
                'Dasani Water': 16.75,
                'Smart Water': 34.84,
                'Powerade': 29.00,
                'Monster Energy': 44.96,
                'Gold Peak Tea': 38.00,
                '2.5 Gal Box (Sparkling Brands)': 22.98,
                '2.5 Gal Bbox (unsweetened tea)': 22.30,
                '5 Gal Bbox (Sparkling Brands)': 22.03,
                '5 Gal Bbox (unsweetened tea)': 21.29
            };

            function loadMonthlyPricingData(userEmail = null) {
                if (!userEmail) {
                    userEmail = currentUser?.email;
                }
                
                const key = getLocationStorageKey('monthly_pricing', userEmail);
                const saved = localStorage.getItem(key);
                if (saved) {
                    monthlyPricing = { ...defaultMonthlyPricing, ...JSON.parse(saved) };
                } else {
                    monthlyPricing = { ...defaultMonthlyPricing };
                    // Save default pricing
                    localStorage.setItem(key, JSON.stringify(monthlyPricing));
                }
            }

            function loadMonthlyInventoryData(userEmail = null, month = null) {
                if (!userEmail) {
                    userEmail = currentUser?.email;
                }
                if (!month) {
                    month = currentInventoryMonth;
                }
                
                const baseKey = `monthly_inventory_${month}`;
                const key = getLocationStorageKey(baseKey, userEmail);
                const saved = localStorage.getItem(key);
                
                if (saved) {
                    monthlyInventoryData = JSON.parse(saved);
                } else {
                    // Initialize with default data
                    monthlyInventoryData = {};
                    Object.keys(monthlyInventoryItems).forEach(category => {
                        monthlyInventoryItems[category].forEach(item => {
                            monthlyInventoryData[item] = {
                                category: category,
                                count: 0,
                                price: monthlyPricing[item] || 0,
                                lastUpdated: new Date().toISOString(),
                                updatedBy: userEmail
                            };
                        });
                    });
                    saveMonthlyInventoryData(userEmail, month);
                }
            }

            function saveMonthlyInventoryData(userEmail = null, month = null) {
                if (!userEmail) {
                    userEmail = currentUser?.email;
                }
                if (!month) {
                    month = currentInventoryMonth;
                }
                
                const baseKey = `monthly_inventory_${month}`;
                const key = getLocationStorageKey(baseKey, userEmail);
                localStorage.setItem(key, JSON.stringify(monthlyInventoryData));
            }

            function openMonthlyMobileInventory() {
                if (!isManager()) {
                    showError('Only administrators and managers can access monthly mobile inventory');
                    return;
                }
                
                document.getElementById('monthlyMobileInventoryModal').style.display = 'block';
                renderMonthlyMobileInventoryList('cheese-mozzarella');
            }

            function renderMonthlyMobileInventoryList(category) {
                const container = document.getElementById('monthlyMobileInventoryList');
                const items = monthlyInventoryItems[category] || [];
                
                container.innerHTML = '';
                
                items.forEach(item => {
                    const itemData = monthlyInventoryData[item] || { count: 0, price: 0 };
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'mobile-inventory-item';
                    itemDiv.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px;
                        margin: 10px 0;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        background: white;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    `;
                    
                    itemDiv.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 1.1em;">${item}</div>
                            <div style="color: #666; font-size: 0.9em;">$${itemData.price.toFixed(2)} each</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <button onclick="updateMonthlyCount('${item}', -0.25)" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2em; cursor: pointer;">-</button>
                            <span style="font-size: 1.3em; font-weight: bold; min-width: 50px; text-align: center;" id="count-${item.replace(/[^a-zA-Z0-9]/g, '')}">${itemData.count}</span>
                            <button onclick="updateMonthlyCount('${item}', 0.25)" style="background: #27ae60; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2em; cursor: pointer;">+</button>
                        </div>
                    `;
                    
                    container.appendChild(itemDiv);
                });
            }

            function updateMonthlyCount(item, change) {
                const currentPrice = monthlyPricing[item] || 0;
                
                if (!monthlyInventoryData[item]) {
                    // Find the category for this item
                    let itemCategory = 'unknown';
                    Object.keys(monthlyInventoryItems).forEach(category => {
                        if (monthlyInventoryItems[category].includes(item)) {
                            itemCategory = category;
                        }
                    });
                    
                    monthlyInventoryData[item] = { 
                        count: 0, 
                        price: currentPrice,
                        category: itemCategory,
                        lastUpdated: new Date().toISOString(),
                        updatedBy: currentUser.email
                    };
                }
                
                let currentCount = monthlyInventoryData[item].count;
                const increment = change > 0 ? 0.25 : -0.25;
                currentCount = Math.max(0, currentCount + increment);
                currentCount = Math.round(currentCount * 4) / 4; // Round to nearest 0.25
                
                monthlyInventoryData[item].count = currentCount;
                monthlyInventoryData[item].price = currentPrice; // Ensure price is always current
                monthlyInventoryData[item].lastUpdated = new Date().toISOString();
                monthlyInventoryData[item].updatedBy = currentUser.email;
                
                // Update display
                const countElement = document.getElementById(`count-${item.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (countElement) {
                    countElement.textContent = currentCount;
                }
                
                // Calculate total for this item
                const totalValue = currentCount * currentPrice;
                
                saveMonthlyInventoryData();
                updateMonthlyCategorySummary();
                
                // Also update the main table if it exists
                const table = document.getElementById('monthlyInventoryTableBody');
                if (table) {
                    const rows = table.getElementsByTagName('tr');
                    for (let row of rows) {
                        const itemCell = row.cells[0];
                        if (itemCell && itemCell.textContent === item) {
                            const countInput = row.cells[3].querySelector('input');
                            const totalValueCell = row.cells[4];
                            if (countInput) countInput.value = currentCount;
                            if (totalValueCell) {
                                totalValueCell.innerHTML = `<strong>$${totalValue.toFixed(2)}</strong>`;
                            }
                            break;
                        }
                    }
                }
                
                // Debug log
                console.log(`Mobile update ${item}: count=${currentCount}, price=$${currentPrice}, total=$${totalValue.toFixed(2)}`);
            }

            function saveMonthlyMobileInventory() {
                saveMonthlyInventoryData();
                document.getElementById('monthlyMobileInventoryModal').style.display = 'none';
                renderMonthlyInventoryTable();
                updateMonthlyCategorySummary();
                showSuccess('Monthly mobile inventory counts saved successfully!');
            }


            // Test function for debugging calculations
            function testMonthlyCalculations() {
                console.log('=== Monthly Inventory Calculation Test ===');
                console.log('Block Mozzarella price:', monthlyPricing['Block Mozzarella']);
                console.log('Romano price:', monthlyPricing['Romano']);
                console.log('Test calculation: 162.80 * 10 =', 162.80 * 10);
                console.log('Test calculation: 27.60 * 2 =', 27.60 * 2);
                console.log('Pricing data available:', Object.keys(monthlyPricing).length, 'items');
                console.log('Inventory data available:', Object.keys(monthlyInventoryData).length, 'items');
            }
            
            function renderMonthlyInventoryTable() {
                const tbody = document.getElementById('monthlyInventoryTableBody');
                tbody.innerHTML = '';
                
                // Ensure pricing data is initialized
                if (!monthlyPricing || Object.keys(monthlyPricing).length === 0) {
                    console.log('Initializing monthly pricing with defaults');
                    monthlyPricing = { ...defaultMonthlyPricing };
                }
                
                // Debug: Log pricing data availability
                console.log('renderMonthlyInventoryTable - monthlyPricing keys:', Object.keys(monthlyPricing).length);
                console.log('Sample pricing:', {
                    'Block Mozzarella': monthlyPricing['Block Mozzarella'],
                    'Romano': monthlyPricing['Romano']
                });
                
                Object.keys(monthlyInventoryItems).forEach(category => {
                    monthlyInventoryItems[category].forEach(item => {
                        // Get current item data, but always use latest pricing
                        const itemData = monthlyInventoryData[item] || { count: 0, price: 0, lastUpdated: '', updatedBy: '' };
                        const currentPrice = monthlyPricing[item] || itemData.price || 0;
                        
                        // Debug missing prices
                        if (currentPrice === 0) {
                            console.log(`Warning: No price found for item "${item}"`);
                        }
                        const currentCount = itemData.count || 0;
                        const totalValue = currentCount * currentPrice;
                        
                        // Update item data with current price if it's different
                        if (monthlyInventoryData[item] && monthlyInventoryData[item].price !== currentPrice) {
                            monthlyInventoryData[item].price = currentPrice;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item}</td>
                            <td>${category.replace('-', ' ').toUpperCase()}</td>
                            <td>$${currentPrice.toFixed(2)}</td>
                            <td><input type="number" class="monthly-count-input" data-item="${item}" value="${currentCount}" style="width: 80px; text-align: center;" min="0" step="0.25"></td>
                            <td class="total-value-cell"><strong>$${totalValue.toFixed(2)}</strong></td>
                            <td>${itemData.lastUpdated ? new Date(itemData.lastUpdated).toLocaleDateString() : ''}</td>
                        `;
                        tbody.appendChild(row);
                        
                        // Add event listener to the input
                        const input = row.querySelector('.monthly-count-input');
                        input.addEventListener('input', function() {
                            const itemName = this.dataset.item;
                            const newCount = parseFloat(this.value) || 0;
                            const price = monthlyPricing[itemName] || 0;
                            const total = newCount * price;
                            
                            // Enhanced debugging
                            console.log('=== INPUT EVENT TRIGGERED ===');
                            console.log(`Item: "${itemName}"`);
                            console.log(`Count: ${newCount}`);
                            console.log(`Price: $${price}`);
                            console.log(`Total: $${total.toFixed(2)}`);
                            
                            if (price === 0) {
                                console.log(`ERROR: No price found for ${itemName}`);
                                console.log('Available pricing keys:', Object.keys(monthlyPricing).slice(0, 10));
                            }
                            
                            // Update the data
                            if (!monthlyInventoryData[itemName]) {
                                monthlyInventoryData[itemName] = { 
                                    count: 0, 
                                    price: price,
                                    category: category,
                                    lastUpdated: new Date().toISOString(),
                                    updatedBy: currentUser.email
                                };
                            }
                            
                            monthlyInventoryData[itemName].count = newCount;
                            monthlyInventoryData[itemName].price = price;
                            monthlyInventoryData[itemName].lastUpdated = new Date().toISOString();
                            monthlyInventoryData[itemName].updatedBy = currentUser.email;
                            
                            // Update the total value cell immediately
                            const totalCell = row.querySelector('.total-value-cell');
                            totalCell.innerHTML = `<strong>$${total.toFixed(2)}</strong>`;
                            
                            // Save and update summary
                            saveMonthlyInventoryData();
                            updateMonthlyCategorySummary();
                            
                            console.log(`Input changed - ${itemName}: count=${newCount}, price=$${price}, total=$${total.toFixed(2)}`);
                        });
                    });
                });
            }

            function updateMonthlyItemCount(item, newCount) {
                const count = parseFloat(newCount) || 0;
                const currentPrice = monthlyPricing[item] || 0;
                
                if (!monthlyInventoryData[item]) {
                    // Find the category for this item
                    let itemCategory = 'unknown';
                    Object.keys(monthlyInventoryItems).forEach(category => {
                        if (monthlyInventoryItems[category].includes(item)) {
                            itemCategory = category;
                        }
                    });
                    
                    monthlyInventoryData[item] = { 
                        count: 0, 
                        price: currentPrice,
                        category: itemCategory,
                        lastUpdated: new Date().toISOString(),
                        updatedBy: currentUser.email
                    };
                }
                
                // Update count and ensure price is current
                monthlyInventoryData[item].count = count;
                monthlyInventoryData[item].price = currentPrice;
                monthlyInventoryData[item].lastUpdated = new Date().toISOString();
                monthlyInventoryData[item].updatedBy = currentUser.email;
                
                // Calculate and display new total value immediately
                const totalValue = count * currentPrice;
                
                // Debug log
                console.log(`updateMonthlyItemCount - Item: ${item}, Count: ${count}, Price: $${currentPrice}, Total: $${totalValue.toFixed(2)}`);
                
                // Find the row in the table and update the total value cell
                const table = document.getElementById('monthlyInventoryTableBody');
                const rows = table.getElementsByTagName('tr');
                let rowFound = false;
                for (let row of rows) {
                    const itemCell = row.cells[0];
                    if (itemCell && itemCell.textContent === item) {
                        const totalValueCell = row.cells[4]; // Total Value column is index 4
                        if (totalValueCell) {
                            totalValueCell.innerHTML = `<strong>$${totalValue.toFixed(2)}</strong>`;
                            console.log(`Updated total value cell for ${item}: $${totalValue.toFixed(2)}`);
                        }
                        rowFound = true;
                        break;
                    }
                }
                if (!rowFound) {
                    console.log(`Row not found for item: ${item}`);
                }
                
                // Save data and update summary
                saveMonthlyInventoryData();
                updateMonthlyCategorySummary();
                
                // Debug log
                console.log(`Updated ${item}: count=${count}, price=$${currentPrice}, total=$${totalValue.toFixed(2)}`);
            }

            function updateMonthlyCategorySummary() {
                const categoryTotals = {
                    'cheese-mozzarella': 0,
                    'cheese-other': 0,
                    'meat': 0,
                    'groceries': 0,
                    'produce': 0,
                    'paper-plastic': 0,
                    'beverages': 0
                };
                
                let totalItemsProcessed = 0;
                
                Object.keys(monthlyInventoryItems).forEach(category => {
                    let categoryItemCount = 0;
                    monthlyInventoryItems[category].forEach(item => {
                        const itemData = monthlyInventoryData[item] || { count: 0, price: 0 };
                        const currentPrice = monthlyPricing[item] || itemData.price || 0;
                        const currentCount = itemData.count || 0;
                        const itemTotal = currentCount * currentPrice;
                        
                        categoryTotals[category] += itemTotal;
                        
                        if (currentCount > 0 || currentPrice > 0) {
                            categoryItemCount++;
                            totalItemsProcessed++;
                        }
                        
                        // Debug log for non-zero items
                        if (itemTotal > 0) {
                            console.log(`${category}: ${item} = ${currentCount} × $${currentPrice} = $${itemTotal.toFixed(2)}`);
                        }
                    });
                    
                    if (categoryItemCount > 0) {
                        console.log(`${category} total: $${categoryTotals[category].toFixed(2)} (${categoryItemCount} items)`);
                    }
                });
                
                // Update display with error checking
                const updateElement = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = `$${value.toFixed(2)}`;
                    } else {
                        console.error(`Element with id '${id}' not found`);
                    }
                };
                
                updateElement('cheeseTotal', categoryTotals['cheese-mozzarella']);
                updateElement('cheeseOtherTotal', categoryTotals['cheese-other']);
                updateElement('meatTotal', categoryTotals['meat']);
                updateElement('groceriesTotal', categoryTotals['groceries']);
                updateElement('produceTotal', categoryTotals['produce']);
                updateElement('paperpTotal', categoryTotals['paper-plastic']);
                updateElement('beveragesTotal', categoryTotals['beverages']);
                
                // Calculate grand total
                const grandTotal = Object.values(categoryTotals).reduce((sum, total) => sum + total, 0);
                console.log(`Grand Total: $${grandTotal.toFixed(2)} (${totalItemsProcessed} items processed)`);
            }

            function printMonthlyCategories() {
                const categoryTotals = {
                    'CHEESE MOZZARELLA TOTAL': 0,
                    'CHEESE OTHER TOTAL': 0,
                    'MEAT TOTAL': 0,
                    'GROCERIES TOTAL': 0,
                    'PRODUCE TOTAL': 0,
                    'BOXES P&P TOTAL': 0,
                    'BEVERAGES TOTAL': 0
                };
                
                const categoryMapping = {
                    'cheese-mozzarella': 'CHEESE MOZZARELLA TOTAL',
                    'cheese-other': 'CHEESE OTHER TOTAL',
                    'meat': 'MEAT TOTAL',
                    'groceries': 'GROCERIES TOTAL',
                    'produce': 'PRODUCE TOTAL',
                    'paper-plastic': 'BOXES P&P TOTAL',
                    'beverages': 'BEVERAGES TOTAL'
                };
                
                Object.keys(monthlyInventoryItems).forEach(category => {
                    monthlyInventoryItems[category].forEach(item => {
                        const itemData = monthlyInventoryData[item] || { count: 0, price: 0 };
                        const categoryName = categoryMapping[category];
                        categoryTotals[categoryName] += itemData.count * itemData.price;
                    });
                });
                
                let printContent = `<h2>Monthly Inventory Category Breakdown - ${new Date().toLocaleDateString()}</h2>`;
                let monthlyGrandTotal = 0;
                
                Object.keys(categoryTotals).forEach(category => {
                    const total = categoryTotals[category];
                    monthlyGrandTotal += total;
                    printContent += `<h3>${category}: $${total.toFixed(2)}</h3>`;
                });
                
                printContent += `<h2 style="margin-top: 30px; border-top: 2px solid #333; padding-top: 15px;">GRAND TOTAL: $${monthlyGrandTotal.toFixed(2)}</h2>`;
                
                // Open print window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Monthly Inventory Categories - ${new Date().toLocaleDateString()}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
                                h3 { color: #e74c3c; margin: 20px 0 10px 0; font-size: 1.2em; }
                                @media print {
                                    body { margin: 0; }
                                    h2, h3 { page-break-inside: avoid; }
                                }
                            </style>
                        </head>
                        <body>${printContent}</body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            function exportMonthlyInventory() {
                // Create CSV data
                let csvContent = "Item,Category,Price,Count,Total Value,Last Updated,Updated By\n";
                
                Object.keys(monthlyInventoryItems).forEach(category => {
                    monthlyInventoryItems[category].forEach(item => {
                        const itemData = monthlyInventoryData[item] || { count: 0, price: 0, lastUpdated: '', updatedBy: '' };
                        const totalValue = itemData.count * itemData.price;
                        const lastUpdated = itemData.lastUpdated ? new Date(itemData.lastUpdated).toLocaleDateString() : '';
                        
                        csvContent += `"${item}","${category.replace('-', ' ').toUpperCase()}","${itemData.price.toFixed(2)}","${itemData.count}","${totalValue.toFixed(2)}","${lastUpdated}","${itemData.updatedBy || ''}"\n`;
                    });
                });
                
                // Add category totals
                csvContent += "\n--- Category Totals ---\n";
                const categoryTotals = {
                    'CHEESE MOZZARELLA TOTAL': 0,
                    'CHEESE OTHER TOTAL': 0,
                    'MEAT TOTAL': 0,
                    'GROCERIES TOTAL': 0,
                    'PRODUCE TOTAL': 0,
                    'BOXES P&P TOTAL': 0,
                    'BEVERAGES TOTAL': 0
                };
                
                const categoryMapping = {
                    'cheese-mozzarella': 'CHEESE MOZZARELLA TOTAL',
                    'cheese-other': 'CHEESE OTHER TOTAL',
                    'meat': 'MEAT TOTAL',
                    'groceries': 'GROCERIES TOTAL',
                    'produce': 'PRODUCE TOTAL',
                    'paper-plastic': 'BOXES P&P TOTAL',
                    'beverages': 'BEVERAGES TOTAL'
                };
                
                Object.keys(monthlyInventoryItems).forEach(category => {
                    monthlyInventoryItems[category].forEach(item => {
                        const itemData = monthlyInventoryData[item] || { count: 0, price: 0 };
                        const categoryName = categoryMapping[category];
                        categoryTotals[categoryName] += itemData.count * itemData.price;
                    });
                });
                
                let exportGrandTotal = 0;
                Object.keys(categoryTotals).forEach(category => {
                    const total = categoryTotals[category];
                    exportGrandTotal += total;
                    csvContent += `"${category}","","","","${total.toFixed(2)}","",""\n`;
                });
                
                csvContent += `"GRAND TOTAL","","","","${exportGrandTotal.toFixed(2)}","",""\n`;
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `monthly_inventory_${currentInventoryMonth}_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess('Monthly inventory data exported successfully!');
            }

            // CSV Upload and Processing Functions
            let csvData = null;
            let parsedInventoryData = null;

            function openCsvUploadModal() {
                if (currentUser.role !== 'admin') {
                    showError('Only administrators can upload CSV files');
                    return;
                }
                
                document.getElementById('csvUploadModal').style.display = 'block';
                // Reset the form
                document.getElementById('csvFileInput').value = '';
                document.getElementById('csvPreview').style.display = 'none';
                document.getElementById('processCsvBtn').disabled = true;
            }

            function handleCsvFileSelect(event) {
                const file = event.target.files[0];
                if (!file) {
                    document.getElementById('csvPreview').style.display = 'none';
                    document.getElementById('processCsvBtn').disabled = true;
                    return;
                }

                if (!file.name.toLowerCase().endsWith('.csv')) {
                    showError('Please select a CSV file');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvContent = e.target.result;
                    csvData = csvContent;
                    previewCsvData(csvContent);
                    parseCsvInventoryData(csvContent);
                };
                reader.readAsText(file);
            }

            function previewCsvData(csvContent) {
                const lines = csvContent.split('\n').slice(0, 10); // Show first 10 lines
                const preview = document.getElementById('csvPreview');
                preview.innerHTML = '<strong>CSV Preview (first 10 lines):</strong><br>' + 
                    lines.map(line => line.substring(0, 100) + (line.length > 100 ? '...' : '')).join('<br>');
                preview.style.display = 'block';
            }

            function parseCsvInventoryData(csvContent) {
                const lines = csvContent.split('\n').map(line => line.trim()).filter(line => line);
                const newInventoryItems = {
                    'cheese-mozzarella': [],
                    'cheese-other': [],
                    'meat': [],
                    'groceries': [],
                    'produce': [],
                    'paper-plastic': [],
                    'beverages': []
                };
                const newPricing = {};
                
                let currentCategory = null;
                let itemCount = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const columns = line.split(',').map(col => col.replace(/"/g, '').trim());
                    
                    // Skip empty lines or lines with insufficient data
                    if (columns.length < 2) continue;
                    
                    const priceCol = columns[0];
                    const productCol = columns[1];
                    
                    // Enhanced category detection for new CSV format
                    if (productCol.includes('1) CHEESE - MOZZARELLA') || 
                        (productCol.includes('CHEESE') && productCol.includes('MOZZARELLA') && !productCol.includes('TOTAL'))) {
                        currentCategory = 'cheese-mozzarella';
                        continue;
                    } else if (productCol.includes('2) CHEESE - OTHER') ||
                               (productCol.includes('CHEESE') && productCol.includes('OTHER') && !productCol.includes('TOTAL'))) {
                        currentCategory = 'cheese-other';
                        continue;
                    } else if (productCol.includes('3) MEATS') ||
                               (productCol.toUpperCase().includes('MEATS') && !productCol.includes('TOTAL'))) {
                        currentCategory = 'meat';
                        continue;
                    } else if (productCol.includes('4) GROCERIES') ||
                               (productCol.toUpperCase().includes('GROCERIES') && !productCol.includes('TOTAL'))) {
                        currentCategory = 'groceries';
                        continue;
                    } else if (productCol.includes('5) PRODUCE') ||
                               (productCol.toUpperCase().includes('PRODUCE') && !productCol.includes('TOTAL'))) {
                        currentCategory = 'produce';
                        continue;
                    } else if (productCol.includes('6) PAPER & PLASTIC') ||
                               (productCol.toUpperCase().includes('PAPER') && productCol.toUpperCase().includes('PLASTIC') && !productCol.includes('TOTAL'))) {
                        currentCategory = 'paper-plastic';
                        continue;
                    } else if (productCol.toUpperCase().includes('BEVERAGES') && !productCol.includes('TOTAL')) {
                        currentCategory = 'beverages';
                        continue;
                    }
                    
                    // Enhanced skip conditions for new CSV format
                    if (!productCol || 
                        productCol.toUpperCase().includes('PRICE') || 
                        productCol.toUpperCase().includes('TOTAL') ||
                        productCol.toUpperCase().includes('EXAMPLE') ||
                        productCol.toUpperCase().includes('SUMMARY') ||
                        productCol.toUpperCase().includes('PRODUCT') ||
                        productCol.toUpperCase().includes('CASE DESCRIPTION') ||
                        productCol.toUpperCase().includes('UNIT DESCRIPTION') ||
                        productCol.toUpperCase().includes('AMOUNT CASES') ||
                        productCol.toUpperCase().includes('GRAND TOTAL') ||
                        priceCol.toUpperCase().includes('PRICE') ||
                        !currentCategory) {
                        continue;
                    }
                    
                    // Extract price from column A - handle both $xx.xx and empty price cells
                    let price = 0;
                    if (priceCol && priceCol.includes('$')) {
                        const priceMatch = priceCol.match(/\$(\d+\.?\d*)/);
                        if (priceMatch) {
                            price = parseFloat(priceMatch[1]);
                        }
                    }
                    
                    // Clean up product name and add to category (allow items with no price for produce)
                    const cleanProductName = productCol.trim();
                    if (cleanProductName && 
                        !cleanProductName.includes('TOTAL') && 
                        cleanProductName.length > 1 &&
                        !newInventoryItems[currentCategory].includes(cleanProductName)) {
                        
                        newInventoryItems[currentCategory].push(cleanProductName);
                        newPricing[cleanProductName] = price;
                        itemCount++;
                        
                        // Log new items for debugging
                        console.log(`Added: ${cleanProductName} to ${currentCategory} with price $${price}`);
                    }
                }
                
                // Store parsed data
                parsedInventoryData = {
                    items: newInventoryItems,
                    pricing: newPricing,
                    totalItems: itemCount
                };
                
                // Enable process button if we found items
                document.getElementById('processCsvBtn').disabled = itemCount === 0;
                
                if (itemCount > 0) {
                    const categoriesWithItems = Object.keys(newInventoryItems).filter(cat => newInventoryItems[cat].length > 0).length;
                    showSuccess(`CSV parsed successfully! Found ${itemCount} inventory items across ${categoriesWithItems} categories.`);
                    
                    // Show category breakdown in console for debugging
                    console.log('Parsed categories:', Object.keys(newInventoryItems).map(cat => 
                        `${cat}: ${newInventoryItems[cat].length} items`
                    ).join(', '));
                } else {
                    showError('No valid inventory items found in CSV. Please check the file format.');
                }
            }

            function processCsvAndUpdateInventory() {
                if (!parsedInventoryData) {
                    showError('No CSV data to process');
                    return;
                }
                
                try {
                    let newItemsAdded = 0;
                    let existingItemsUpdated = 0;
                    const updatedCategories = [];
                    
                    // Merge new items with existing inventory items (preserving existing ones not in CSV)
                    Object.keys(parsedInventoryData.items).forEach(category => {
                        // Initialize category if it doesn't exist
                        if (!monthlyInventoryItems[category]) {
                            monthlyInventoryItems[category] = [];
                        }
                        
                        // Add new items from CSV that aren't already in the category
                        parsedInventoryData.items[category].forEach(item => {
                            if (!monthlyInventoryItems[category].includes(item)) {
                                monthlyInventoryItems[category].push(item);
                                newItemsAdded++;
                            }
                        });
                        
                        if (parsedInventoryData.items[category].length > 0) {
                            updatedCategories.push(category);
                        }
                    });
                    
                    // Update pricing - merge with existing pricing, don't replace completely
                    Object.keys(parsedInventoryData.pricing).forEach(item => {
                        const newPrice = parsedInventoryData.pricing[item];
                        const oldPrice = monthlyPricing[item];
                        
                        monthlyPricing[item] = newPrice;
                        
                        if (oldPrice !== undefined && oldPrice !== newPrice) {
                            existingItemsUpdated++;
                        }
                    });
                    
                    // Save updated pricing
                    const pricingKey = getLocationStorageKey('monthly_pricing', currentUser.email);
                    localStorage.setItem(pricingKey, JSON.stringify(monthlyPricing));
                    
                    // Update existing inventory data with new pricing
                    Object.keys(monthlyInventoryData).forEach(item => {
                        if (monthlyPricing[item] !== undefined) {
                            monthlyInventoryData[item].price = monthlyPricing[item];
                        }
                    });
                    
                    // Add any new items that weren't in the inventory yet
                    Object.keys(monthlyInventoryItems).forEach(category => {
                        monthlyInventoryItems[category].forEach(item => {
                            if (!monthlyInventoryData[item]) {
                                monthlyInventoryData[item] = {
                                    category: category,
                                    count: 0,
                                    price: monthlyPricing[item] || 0,
                                    lastUpdated: new Date().toISOString(),
                                    updatedBy: currentUser.email
                                };
                            } else {
                                // Update existing item's price
                                monthlyInventoryData[item].price = monthlyPricing[item] || 0;
                            }
                        });
                    });
                    
                    // Save updated inventory data
                    saveMonthlyInventoryData();
                    
                    // Update displays
                    renderMonthlyInventoryTable();
                    updateMonthlyCategorySummary();
                    
                    // Close modal
                    document.getElementById('csvUploadModal').style.display = 'none';
                    
                    // Show detailed success message
                    let successMessage = `CSV processing complete! `;
                    if (newItemsAdded > 0) {
                        successMessage += `Added ${newItemsAdded} new items. `;
                    }
                    if (existingItemsUpdated > 0) {
                        successMessage += `Updated ${existingItemsUpdated} existing prices. `;
                    }
                    successMessage += `Total inventory items: ${parsedInventoryData.totalItems}. Categories: ${updatedCategories.join(', ').replace(/-/g, ' ').toUpperCase()}.`;
                    
                    showSuccess(successMessage);
                    
                    // Update estimated order total after pricing data is updated
                    calculateEstimatedOrderTotal();
                    
                    // Debug log
                    console.log('Updated pricing:', Object.keys(monthlyPricing).length + ' items');
                    console.log('New items added:', newItemsAdded);
                    console.log('Existing items updated:', existingItemsUpdated);
                    console.log('Categories processed:', updatedCategories);
                    
                } catch (error) {
                    console.error('Error processing CSV:', error);
                    showError('Error processing CSV file. Please check the file format and try again.');
                }
            }

            // Category Print Functions
            function printCategories() {
                const categories = {
                    'CHEESE MOZZARELLA TOTAL': [],
                    'CHEESE OTHER TOTAL': [],
                    'MEAT TOTAL': [],
                    'PRODUCE TOTAL': [],
                    'BEVERAGES TOTAL': [],
                    'BOXES P&P TOTAL': [],
                    'DOUGH/CRUST TOTAL': [],
                    'SAUCES & CONDIMENTS TOTAL': [],
                    'SPICES & SEASONINGS TOTAL': [],
                    'CLEANING SUPPLIES TOTAL': [],
                    'GROCERIES TOTAL': []
                };
                
                // Enhanced categorization function based on item names and inventory areas
                function categorizeItem(item, area) {
                    const itemLower = item.toLowerCase();
                    
                    // Cheese categorization
                    if (itemLower.includes('mozz') || itemLower.includes('mozzarella')) {
                        return 'CHEESE MOZZARELLA TOTAL';
                    }
                    if (itemLower.includes('cheese') || itemLower.includes('romano') || 
                        itemLower.includes('feta') || itemLower.includes('ched') || 
                        itemLower.includes('parm')) {
                        return 'CHEESE OTHER TOTAL';
                    }
                    
                    // Meat categorization
                    if (itemLower.includes('beef') || itemLower.includes('sausage') || 
                        itemLower.includes('salami') || itemLower.includes('bacon') || 
                        itemLower.includes('pepperoni') || itemLower.includes('wing') || 
                        itemLower.includes('chicken')) {
                        return 'MEAT TOTAL';
                    }
                    
                    // Produce categorization (area-based + keywords)
                    if (area === 'produce' || itemLower.includes('lettuce') || 
                        itemLower.includes('tomato') || itemLower.includes('pepper') || 
                        itemLower.includes('onion') || itemLower.includes('grape')) {
                        return 'PRODUCE TOTAL';
                    }
                    
                    // Beverages categorization (area-based + keywords)
                    if (area === 'soda' || itemLower.includes('coke') || 
                        itemLower.includes('sprite') || itemLower.includes('water') || 
                        itemLower.includes('lemonade') || itemLower.includes('powerade') || 
                        itemLower.includes('tea') || itemLower.includes('liter') || 
                        itemLower.includes('dr pepper')) {
                        return 'BEVERAGES TOTAL';
                    }
                    
                    // Boxes & Paper/Plastic
                    if (itemLower.includes('box') || itemLower.includes('insert') || 
                        itemLower.includes('bag') || itemLower.includes('cup') || 
                        itemLower.includes('lid') || itemLower.includes('napkin') || 
                        itemLower.includes('towel') || itemLower.includes('paper') || 
                        itemLower.includes('liner') || itemLower.includes('bowl') || 
                        itemLower.includes('plate') || itemLower.includes('foam') || 
                        itemLower.includes('cutlery') || itemLower.includes('tongs') || 
                        itemLower.includes('glove') || itemLower.includes('film')) {
                        return 'BOXES P&P TOTAL';
                    }
                    
                    // Dough & Crust
                    if (itemLower.includes('crust') || itemLower.includes('flour') || 
                        itemLower.includes('yeast') || itemLower.includes('dough')) {
                        return 'DOUGH/CRUST TOTAL';
                    }
                    
                    // Sauces & Condiments
                    if (itemLower.includes('sauce') || itemLower.includes('dressing') || 
                        itemLower.includes('mayo') || itemLower.includes('oil') || 
                        itemLower.includes('vinegar') || itemLower.includes('butter')) {
                        return 'SAUCES & CONDIMENTS TOTAL';
                    }
                    
                    // Spices & Seasonings
                    if (itemLower.includes('spice') || itemLower.includes('seasoning') || 
                        itemLower.includes('salt') || itemLower.includes('sugar') || 
                        itemLower.includes('pepper red') || itemLower.includes('garlic') || 
                        itemLower.includes('sesame') || itemLower.includes('cinnamon') || 
                        itemLower.includes('cajun')) {
                        return 'SPICES & SEASONINGS TOTAL';
                    }
                    
                    // Cleaning Supplies
                    if (itemLower.includes('cleaner') || itemLower.includes('sanitizer') || 
                        itemLower.includes('soap') || itemLower.includes('pad scrub') || 
                        itemLower.includes('test strips')) {
                        return 'CLEANING SUPPLIES TOTAL';
                    }
                    
                    // Everything else goes to Groceries
                    return 'GROCERIES TOTAL';
                }
                
                // Categorize items based on order data (par - have = order qty) and monthly pricing
                Object.keys(inventoryItems).forEach(area => {
                    inventoryItems[area].forEach(item => {
                        const itemData = inventoryData[item] || { par: 0, have: 0, area: area };
                        const orderQty = calculateOrder(itemData.par, itemData.have);
                        
                        // First try direct match, then try mapped name
                        let monthlyPrice = monthlyPricing[item] || 0;
                        let pricingKey = item;
                        
                        if (monthlyPrice === 0) {
                            const mappedName = getMonthlyPricingName(item);
                            if (mappedName && monthlyPricing[mappedName]) {
                                monthlyPrice = monthlyPricing[mappedName];
                                pricingKey = mappedName;
                            }
                        }
                        
                        const orderValue = orderQty * monthlyPrice;
                        
                        // Only include items with order quantities > 0
                        if (orderQty > 0) {
                            // Use enhanced categorization function
                            const assignedCategory = categorizeItem(item, area);
                            
                            categories[assignedCategory].push({ 
                                item, 
                                orderQty, 
                                price: monthlyPrice, 
                                value: orderValue,
                                area: area
                            });
                        }
                    });
                });
                
                // Generate print content
                let printContent = '<h2>Order Sheet Category Breakdown</h2>';
                let categoryGrandTotal = 0;
                let totalItemsWithOrders = 0;
                
                // Sort categories by total value (highest first)
                const sortedCategories = Object.keys(categories).sort((a, b) => {
                    const totalA = categories[a].reduce((sum, item) => sum + item.value, 0);
                    const totalB = categories[b].reduce((sum, item) => sum + item.value, 0);
                    return totalB - totalA;
                });
                
                sortedCategories.forEach(category => {
                    const items = categories[category];
                    const categoryTotal = items.reduce((sum, item) => sum + item.value, 0);
                    categoryGrandTotal += categoryTotal;
                    totalItemsWithOrders += items.length;
                    
                    // Only show categories that have items
                    if (items.length > 0) {
                        printContent += `<h3>${category}: $${categoryTotal.toFixed(2)} (${items.length} items)</h3>`;
                        printContent += '<ul style="margin-bottom: 15px;">';
                        
                        // Sort items within category by value (highest first)
                        const sortedItems = items.sort((a, b) => b.value - a.value);
                        
                        sortedItems.forEach(item => {
                            printContent += `<li><strong>${item.item}</strong> [${item.area.toUpperCase()}]: ${item.orderQty} × $${item.price.toFixed(2)} = <strong>$${item.value.toFixed(2)}</strong></li>`;
                        });
                        printContent += '</ul>';
                    }
                });
                
                printContent += `<hr><h2>TOTAL ORDER VALUE: $${categoryGrandTotal.toFixed(2)}</h2>`;
                printContent += `<p><em>Total items with orders: ${totalItemsWithOrders} across ${sortedCategories.filter(cat => categories[cat].length > 0).length} categories</em></p>`;
                
                // Open print window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Inventory Categories - ${new Date().toLocaleDateString()}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
                                h3 { color: #e74c3c; margin-top: 20px; }
                                ul { margin: 10px 0; }
                                li { margin: 5px 0; }
                            </style>
                        </head>
                        <body>${printContent}</body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            // Week Navigation Functions
            window.getWeekStart = function(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is sunday
                return new Date(d.setDate(diff));
            }

            function formatWeekDisplay(weekStart) {
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
                const shortMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                const weekDisplay = `Week of ${monthNames[weekStart.getMonth()]} ${weekStart.getDate()}, ${weekStart.getFullYear()}`;
                const dateRange = `${shortMonths[weekStart.getMonth()]} ${weekStart.getDate()} - ${shortMonths[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekEnd.getFullYear()}`;
                
                return { weekDisplay, dateRange };
            }

            function getWeekKey(weekStart) {
                return `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}-${String(weekStart.getDate()).padStart(2, '0')}`;
            }

            function updateWeekDisplay() {
                if (!currentWeekStart) {
                    goToCurrentWeek();
                    return;
                }
                
                const { weekDisplay, dateRange } = formatWeekDisplay(currentWeekStart);
                document.getElementById('currentWeekDisplay').textContent = weekDisplay;
                document.getElementById('weekDateRange').textContent = dateRange;
            }

            async function saveCurrentWeekData() {
                if (!currentWeekStart) return;
                
                try {
                    // Save to database
                    await saveScheduleData(null, currentWeekStart);
                    
                    // Also save to localStorage for legacy/backup
                    const weekKey = getWeekKey(currentWeekStart);
                    const weekData = {
                        scheduleData: { ...scheduleData },
                        currentWeekSales: { ...currentWeekSales },
                        employees: [...employees]
                    };
                    
                    const allWeeksData = JSON.parse(localStorage.getItem(`scheduleWeeks_${currentUser.email}`) || '{}');
                    allWeeksData[weekKey] = weekData;
                    localStorage.setItem(`scheduleWeeks_${currentUser.email}`, JSON.stringify(allWeeksData));
                } catch (error) {
                    console.error('Error saving week data:', error);
                }
            }

            async function loadWeekData(weekStart) {
                try {
                    // Load schedule data from database
                    await loadScheduleData(null, weekStart);
                    
                    // Also check localStorage for legacy data
                    const weekKey = getWeekKey(weekStart);
                    const allWeeksData = JSON.parse(localStorage.getItem(`scheduleWeeks_${currentUser.email}`) || '{}');
                    
                    if (allWeeksData[weekKey] && allWeeksData[weekKey].employees) {
                        // Use employees from localStorage if available
                        employees = [...allWeeksData[weekKey].employees];
                    }
                    
                    renderScheduleTable();
                    updateScheduleTotals();
                    updateDailySalesDisplay();
                } catch (error) {
                    console.error('Error loading week data:', error);
                    // Initialize empty on error
                    scheduleData = {};
                    currentWeekSales = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };
                    renderScheduleTable();
                    updateScheduleTotals();
                    updateDailySalesDisplay();
                }
            }

            function navigateToWeek(direction) {
                if (!currentWeekStart) {
                    goToCurrentWeek();
                    return;
                }
                
                // Save current week data before navigating
                saveCurrentWeekData();
                
                // Navigate to new week
                const newWeekStart = new Date(currentWeekStart);
                newWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
                
                currentWeekStart = newWeekStart;
                updateWeekDisplay();
                loadWeekData(currentWeekStart);
                updateWeekDropdown();
                
                showSuccess(`Navigated to ${formatWeekDisplay(currentWeekStart).weekDisplay}`);
            }

            function goToCurrentWeek() {
                // Save current week data if we're switching weeks
                if (currentWeekStart) {
                    saveCurrentWeekData();
                }
                
                currentWeekStart = getWeekStart(new Date());
                updateWeekDisplay();
                loadWeekData(currentWeekStart);
                updateWeekDropdown();
                
                showSuccess('Switched to current week');
            }

            async function updateWeekDropdown() {
                const dropdown = document.getElementById('weekDropdown');
                if (!dropdown) return;
                
                dropdown.innerHTML = '<option value="">Select a previous week...</option>';
                
                try {
                    // Load from database first
                    if (typeof DB_API !== 'undefined') {
                        const location = getCurrentLocation();
                        const dbSchedules = await DB_API.schedules.get({
                            user_id: currentUser.email,
                            location: location
                        });
                        
                        // Create unique week entries from database
                        const dbWeeks = new Set();
                        if (dbSchedules && Array.isArray(dbSchedules)) {
                            dbSchedules.forEach(schedule => {
                                const weekDate = new Date(schedule.week_start_date);
                                const weekKey = getWeekKey(weekDate);
                                dbWeeks.add(weekKey);
                            });
                        }
                        
                        // Also get localStorage weeks
                        const allWeeksData = JSON.parse(localStorage.getItem(`scheduleWeeks_${currentUser.email}`) || '{}');
                        const localWeeks = Object.keys(allWeeksData);
                        
                        // Combine both sources
                        const allWeeks = new Set([...dbWeeks, ...localWeeks]);
                        const weekKeys = Array.from(allWeeks).sort().reverse(); // Most recent first
                        
                        weekKeys.forEach(weekKey => {
                            const [year, month, day] = weekKey.split('-');
                            const weekStart = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                            const { weekDisplay } = formatWeekDisplay(weekStart);
                            
                            const option = document.createElement('option');
                            option.value = weekKey;
                            option.textContent = weekDisplay;
                            dropdown.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error updating week dropdown:', error);
                    // Fallback to localStorage only
                    const allWeeksData = JSON.parse(localStorage.getItem(`scheduleWeeks_${currentUser.email}`) || '{}');
                    const weekKeys = Object.keys(allWeeksData).sort().reverse();
                    
                    weekKeys.forEach(weekKey => {
                        const [year, month, day] = weekKey.split('-');
                        const weekStart = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        const { weekDisplay } = formatWeekDisplay(weekStart);
                        
                        const option = document.createElement('option');
                        option.value = weekKey;
                        option.textContent = weekDisplay;
                        dropdown.appendChild(option);
                    });
                }
            }

            function jumpToWeek(weekKey) {
                if (!weekKey) return;
                
                // Save current week data before jumping
                if (currentWeekStart) {
                    saveCurrentWeekData();
                }
                
                const [year, month, day] = weekKey.split('-');
                currentWeekStart = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                
                updateWeekDisplay();
                loadWeekData(currentWeekStart);
                updateWeekDropdown();
                
                // Reset dropdown selection
                document.getElementById('weekDropdown').value = '';
                
                showSuccess(`Jumped to ${formatWeekDisplay(currentWeekStart).weekDisplay}`);
            }

            function copyCurrentWeek() {
                if (!currentWeekStart) {
                    showError('No week selected to copy');
                    return;
                }
                
                copiedWeekData = {
                    scheduleData: JSON.parse(JSON.stringify(scheduleData)),
                    currentWeekSales: JSON.parse(JSON.stringify(currentWeekSales)),
                    employees: JSON.parse(JSON.stringify(employees)),
                    sourceWeek: formatWeekDisplay(currentWeekStart).weekDisplay
                };
                
                // Enable paste button
                document.getElementById('pasteScheduleBtn').disabled = false;
                
                showSuccess(`Copied schedule from ${copiedWeekData.sourceWeek}`);
            }

            function pasteWeekData() {
                if (!copiedWeekData) {
                    showError('No schedule data copied to paste');
                    return;
                }
                
                if (!confirm(`Paste schedule from ${copiedWeekData.sourceWeek}? This will overwrite the current week's schedule.`)) {
                    return;
                }
                
                // Paste the copied data
                scheduleData = JSON.parse(JSON.stringify(copiedWeekData.scheduleData));
                currentWeekSales = JSON.parse(JSON.stringify(copiedWeekData.currentWeekSales));
                // Keep current employees list, don't overwrite it
                
                // Re-render everything
                renderScheduleTable();
                updateScheduleTotals();
                updateDailySalesDisplay();
                
                // Save the pasted data
                saveCurrentWeekData();
                
                showSuccess(`Pasted schedule from ${copiedWeekData.sourceWeek}`);
            }

            function openScheduleNotes() {
                if (!currentWeekStart) {
                    showError('No week selected');
                    return;
                }
                
                const { weekDisplay } = formatWeekDisplay(currentWeekStart);
                document.getElementById('notesWeekDisplay').textContent = weekDisplay;
                
                // Load existing notes
                const weekKey = getWeekKey(currentWeekStart);
                const allWeeksData = JSON.parse(localStorage.getItem(`scheduleWeeks_${currentUser.email}`) || '{}');
                const weekData = allWeeksData[weekKey] || {};
                
                document.getElementById('scheduleNotesText').value = weekData.notes || '';
                document.getElementById('scheduleNotesModal').style.display = 'block';
            }

            function saveScheduleNotes() {
                if (!currentWeekStart) return;
                
                const notes = document.getElementById('scheduleNotesText').value;
                const weekKey = getWeekKey(currentWeekStart);
                
                const allWeeksData = JSON.parse(localStorage.getItem(`scheduleWeeks_${currentUser.email}`) || '{}');
                if (!allWeeksData[weekKey]) {
                    allWeeksData[weekKey] = {
                        scheduleData: {},
                        currentWeekSales: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 },
                        employees: []
                    };
                }
                
                allWeeksData[weekKey].notes = notes;
                localStorage.setItem(`scheduleWeeks_${currentUser.email}`, JSON.stringify(allWeeksData));
                
                document.getElementById('scheduleNotesModal').style.display = 'none';
                showSuccess('Schedule notes saved successfully');
            }
            
            // Mobile Schedule Functions
            function calculateShiftHours(shiftValue) {
                if (!shiftValue || shiftValue === '' || shiftValue === 'OFF') {
                    return 0;
                }
                
                // Handle standard shifts used in the system
                const shiftHours = {
                    '7am-4pm': 9,
                    '8am-4pm': 8,
                    '8am-8pm': 12,
                    '7am-8pm': 13,
                    '10am-4pm': 6,
                    '4pm-8pm': 4,
                    '4pm-9pm': 5,
                    '4pm-10pm': 6,
                    '5pm-8pm': 3,
                    '5pm-9pm': 4,
                    '5pm-10pm': 5,
                    '6pm-9pm': 3,
                    '6pm-10pm': 4
                };
                
                if (shiftHours[shiftValue]) {
                    return shiftHours[shiftValue];
                }
                
                // Handle custom shifts with various formats
                const timeFormats = [
                    /^(\d{1,2})am-(\d{1,2})pm$/,  // 7am-4pm
                    /^(\d{1,2})pm-(\d{1,2})pm$/,  // 4pm-8pm
                    /^(\d{1,2})-(\d{1,2})$/,      // 9-3
                    /^(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})$/ // 9:30-3:45
                ];
                
                for (let format of timeFormats) {
                    const match = shiftValue.match(format);
                    if (match) {
                        // Handle different time formats and calculate hours
                        if (format.source.includes('am-') && format.source.includes('pm')) {
                            const startHour = parseInt(match[1]);
                            const endHour = parseInt(match[2]);
                            return (endHour + 12) - startHour;
                        } else if (format.source.includes('pm-') && format.source.includes('pm')) {
                            const startHour = parseInt(match[1]);
                            const endHour = parseInt(match[2]);
                            return endHour - startHour;
                        } else if (match.length === 3) {
                            const start = parseInt(match[1]);
                            const end = parseInt(match[2]);
                            return end > start ? end - start : (24 - start) + end;
                        } else if (match.length === 5) {
                            const startTime = parseInt(match[1]) + (parseInt(match[2]) / 60);
                            const endTime = parseInt(match[3]) + (parseInt(match[4]) / 60);
                            return endTime > startTime ? endTime - startTime : (24 - startTime) + endTime;
                        }
                    }
                }
                
                return 0;
            }
            
            function openMobileScheduleModal() {
                console.log('Opening mobile schedule modal...');
                console.log('Schedule data:', scheduleData);
                console.log('Current week start:', currentWeekStart);
                
                renderMobileScheduleInterface();
                document.getElementById('mobileScheduleModal').style.display = 'block';
            }
            
            function closeMobileScheduleModal() {
                document.getElementById('mobileScheduleModal').style.display = 'none';
                console.log('Mobile schedule modal closed');
            }
            
            // Make sure the functions are globally accessible
            window.closeMobileScheduleModal = closeMobileScheduleModal;
            window.changeMobileEmployee = changeMobileEmployee;
            window.previousMobileEmployee = previousMobileEmployee;
            window.nextMobileEmployee = nextMobileEmployee;
            window.setMobileShift = setMobileShift;
            
            let currentMobileEmployeeIndex = 0;
            let mobileEmployeesList = [];
            
            function renderMobileScheduleInterface() {
                const mobileContent = document.getElementById('mobileScheduleContent');
                
                // Ensure currentWeekStart is available
                if (!currentWeekStart) {
                    goToCurrentWeek();
                }
                
                const weekDate = currentWeekStart ? currentWeekStart.toLocaleDateString() : 'Current Week';
                
                // Get employees list
                mobileEmployeesList = [];
                console.log('Available schedule data keys:', Object.keys(scheduleData));
                
                Object.keys(scheduleData).forEach(empId => {
                    const empData = scheduleData[empId];
                    console.log(`Employee ${empId}:`, empData);
                    if (empData && empData.name) {
                        mobileEmployeesList.push({ id: empId, data: empData });
                    }
                });
                
                // If no employees in schedule data, try getting from employees array
                if (mobileEmployeesList.length === 0 && employees && employees.length > 0) {
                    console.log('No employees in schedule data, using employees array:', employees);
                    employees.forEach((emp, index) => {
                        if (emp && emp.name) {
                            const empId = `emp_${index}`;
                            const empData = scheduleData[empId] || { 
                                name: emp.name, 
                                role: emp.role || 'Employee', 
                                mon: '', tue: '', wed: '', thu: '', fri: '', sat: '', sun: '' 
                            };
                            mobileEmployeesList.push({ id: empId, data: empData });
                        }
                    });
                }
                
                console.log('Mobile employees list:', mobileEmployeesList);
                
                if (mobileEmployeesList.length === 0) {
                    mobileContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>No employees available. Please add employees using the "Manage Employees" button in the desktop interface first.</p>
                            <p style="font-size: 14px; margin-top: 15px;">Debug: scheduleData keys: ${Object.keys(scheduleData).length}, employees: ${employees ? employees.length : 'undefined'}</p>
                        </div>
                    `;
                    return;
                }
                
                // Initialize current employee index
                currentMobileEmployeeIndex = Math.max(0, Math.min(currentMobileEmployeeIndex, mobileEmployeesList.length - 1));
                
                const html = `
                    <div style="margin-bottom: 20px; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin: 0; color: #2c3e50;">Week of ${weekDate}</h4>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Touch-friendly schedule input • Auto-save enabled</p>
                    </div>
                    
                    <!-- Employee Selection -->
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px; font-size: 16px; color: #2c3e50;">Select Employee:</label>
                            <select id="mobileEmployeeSelect" onchange="changeMobileEmployee(this.value)" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; background: white;">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #2c3e50;" id="currentEmployeeName">Loading...</div>
                            <div style="font-size: 14px; color: #666;" id="currentEmployeeRole">Role</div>
                        </div>
                    </div>
                    
                    <!-- Current Employee Schedule -->
                    <div id="currentEmployeeSchedule">
                        <!-- Schedule will be populated here -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding: 20px;">
                        <button type="button" id="closeMobileScheduleBtn" class="btn btn-secondary" style="font-size: 16px; padding: 12px 24px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                `;
                
                mobileContent.innerHTML = html;
                
                // Add event listeners after HTML is rendered
                const employeeSelect = document.getElementById('mobileEmployeeSelect');
                if (employeeSelect) {
                    employeeSelect.addEventListener('change', function() {
                        changeMobileEmployee(this.value);
                    });
                }
                
                const closeMobileBtn = document.getElementById('closeMobileScheduleBtn');
                if (closeMobileBtn) {
                    closeMobileBtn.addEventListener('click', function() {
                        closeMobileScheduleModal();
                    });
                }
                
                renderCurrentMobileEmployee();
            }
            
            // Navigation functions for mobile schedule
            function previousMobileEmployee() {
                if (mobileEmployeesList.length === 0) return;
                
                currentMobileEmployeeIndex = (currentMobileEmployeeIndex - 1 + mobileEmployeesList.length) % mobileEmployeesList.length;
                renderCurrentMobileEmployee();
                
                // Haptic feedback
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }
            
            function nextMobileEmployee() {
                if (mobileEmployeesList.length === 0) return;
                
                currentMobileEmployeeIndex = (currentMobileEmployeeIndex + 1) % mobileEmployeesList.length;
                renderCurrentMobileEmployee();
                
                // Haptic feedback
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }
            
            function changeMobileEmployee(selectedIndex) {
                const index = parseInt(selectedIndex);
                if (index >= 0 && index < mobileEmployeesList.length) {
                    currentMobileEmployeeIndex = index;
                    renderCurrentMobileEmployee();
                    
                    // Haptic feedback
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }
            }
            
            function renderCurrentMobileEmployee() {
                if (mobileEmployeesList.length === 0) return;
                
                // Populate the dropdown if it exists
                const employeeSelect = document.getElementById('mobileEmployeeSelect');
                if (employeeSelect) {
                    employeeSelect.innerHTML = '';
                    mobileEmployeesList.forEach((emp, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `${emp.data.name} - ${emp.data.role}`;
                        if (index === currentMobileEmployeeIndex) {
                            option.selected = true;
                        }
                        employeeSelect.appendChild(option);
                    });
                }
                
                const currentEmp = mobileEmployeesList[currentMobileEmployeeIndex];
                const empData = currentEmp.data;
                
                // Update employee info
                document.getElementById('currentEmployeeName').textContent = empData.name;
                document.getElementById('currentEmployeeRole').textContent = empData.role;
                
                // Render schedule for current employee
                const scheduleContainer = document.getElementById('currentEmployeeSchedule');
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                
                // Define actual shift options from desktop interface (matches desktop exactly)
                const shiftOptions = [
                    { value: '', label: 'OFF', color: '#e74c3c' },
                    { value: '7am-4pm', label: '7am-4pm', color: '#2ecc71' },
                    { value: '8am-4pm', label: '8am-4pm', color: '#2ecc71' },
                    { value: '8am-8pm', label: '8am-8pm', color: '#e67e22' },
                    { value: '7am-8pm', label: '7am-8pm', color: '#e67e22' },
                    { value: '10am-4pm', label: '10am-4pm', color: '#3498db' },
                    { value: '4pm-8pm', label: '4pm-8pm', color: '#9b59b6' },
                    { value: '4pm-9pm', label: '4pm-9pm', color: '#9b59b6' },
                    { value: '4pm-10pm', label: '4pm-10pm', color: '#9b59b6' },
                    { value: '5pm-8pm', label: '5pm-8pm', color: '#8e44ad' },
                    { value: '5pm-9pm', label: '5pm-9pm', color: '#8e44ad' },
                    { value: '5pm-10pm', label: '5pm-10pm', color: '#8e44ad' },
                    { value: '6pm-9pm', label: '6pm-9pm', color: '#34495e' },
                    { value: '6pm-10pm', label: '6pm-10pm', color: '#34495e' }
                ];
                
                let html = `<div style="background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden;">`;
                
                dayKeys.forEach((dayKey, index) => {
                    const dayName = days[index];
                    const currentValue = empData[dayKey] || '';
                    const hours = calculateShiftHours(currentValue);
                    
                    html += `
                        <div style="padding: 20px; border-bottom: 1px solid #eee; ${index === dayKeys.length - 1 ? 'border-bottom: none;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: #2c3e50; font-size: 18px;">${dayName}</h4>
                                <div style="text-align: right;">
                                    <div style="font-size: 16px; font-weight: bold; color: #27ae60;">${hours}h</div>
                                    <div style="font-size: 12px; color: #666;">${currentValue || 'Not scheduled'}</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 10px;">`;
                    
                    // Add shift buttons
                    shiftOptions.slice(0, 8).forEach(option => {
                        const isActive = currentValue === option.value;
                        html += `
                            <button onclick="setMobileShift('${currentEmp.id}', '${dayKey}', '${option.value}')" 
                                    style="padding: 10px 6px; border: 2px solid ${option.color}; 
                                           background: ${isActive ? option.color : 'white'}; 
                                           color: ${isActive ? 'white' : option.color}; 
                                           border-radius: 8px; font-size: 11px; font-weight: bold; 
                                           cursor: pointer; transition: all 0.2s; text-align: center;">
                                ${option.label}
                            </button>`;
                    });
                    
                    html += `</div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 15px;">`;
                    
                    // Add remaining shift buttons
                    shiftOptions.slice(8).forEach(option => {
                        const isActive = currentValue === option.value;
                        html += `
                            <button onclick="setMobileShift('${currentEmp.id}', '${dayKey}', '${option.value}')" 
                                    style="padding: 10px 6px; border: 2px solid ${option.color}; 
                                           background: ${isActive ? option.color : 'white'}; 
                                           color: ${isActive ? 'white' : option.color}; 
                                           border-radius: 8px; font-size: 11px; font-weight: bold; 
                                           cursor: pointer; transition: all 0.2s; text-align: center;">
                                ${option.label}
                            </button>`;
                    });
                    
                    html += `</div>
                            
                            <input type="text" 
                                   placeholder="Custom shift (e.g., 9am-3pm)" 
                                   value="${currentValue && !shiftOptions.some(opt => opt.value === currentValue) ? currentValue : ''}" 
                                   onchange="setMobileShift('${currentEmp.id}', '${dayKey}', this.value)" 
                                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; 
                                          font-size: 14px; background: #f8f9fa;">
                        </div>
                    `;
                });
                
                html += `</div>`;
                scheduleContainer.innerHTML = html;
            }
            
            function setMobileShift(empId, dayKey, value) {
                console.log(`Setting mobile shift: ${empId}, ${dayKey}, ${value}`);
                
                // Update the schedule data
                if (!scheduleData[empId]) {
                    scheduleData[empId] = { name: '', role: '', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '', sun: '' };
                }
                
                scheduleData[empId][dayKey] = value;
                
                // Auto-save immediately
                saveScheduleData();
                updateScheduleTotals();
                
                // Update the current employee view
                renderCurrentMobileEmployee();
                
                // Provide haptic feedback on mobile
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
                
                // Show brief auto-save confirmation
                showAutoSaveConfirmation();
                
                console.log(`Auto-saved schedule data for ${empId}:`, scheduleData[empId]);
            }
            
            function showAutoSaveConfirmation() {
                // Create or update auto-save indicator
                let indicator = document.getElementById('autoSaveIndicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'autoSaveIndicator';
                    indicator.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #27ae60;
                        color: white;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: bold;
                        z-index: 10000;
                        transform: translateY(-50px);
                        opacity: 0;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    `;
                    document.body.appendChild(indicator);
                }
                
                indicator.innerHTML = '<i class="fas fa-check"></i> Auto-saved';
                indicator.style.transform = 'translateY(0)';
                indicator.style.opacity = '1';
                
                // Hide after 2 seconds
                setTimeout(() => {
                    indicator.style.transform = 'translateY(-50px)';
                    indicator.style.opacity = '0';
                }, 2000);
            }
            
            // Auto-save functionality means no manual save function needed
            // All changes are automatically saved when setMobileShift is called

            // Schedule Management Event Listeners
            
            // Check and ensure BasecampIntegration is loaded
            if (!window.BasecampIntegration) {
                console.warn('BasecampIntegration not loaded on initial check, attempting to reload...');
                // Try to load it from the global scope
                const script = document.createElement('script');
                script.src = 'basecamp-integration.js';
                script.onload = () => {
                    console.log('BasecampIntegration reloaded:', window.BasecampIntegration ? 'Success' : 'Failed');
                };
                document.head.appendChild(script);
            }
            
            // Employee management button
            document.getElementById('addEmployeeBtn').addEventListener('click', () => {
                const userRole = currentUser.rbac ? currentUser.rbac.role : currentUser.role;
                const allowedRoles = ['super_admin', 'admin', 'general_manager', 'manager'];
                
                if (!allowedRoles.includes(userRole)) {
                    showError('Only administrators and managers can manage employees');
                    return;
                }
                renderEmployeeTable();
                document.getElementById('employeeModal').style.display = 'block';
            });
            
            // Add new employee button
            document.getElementById('addNewEmployeeBtn').addEventListener('click', () => {
                // Reset form
                document.getElementById('addEmployeeForm').reset();
                delete document.getElementById('addEmployeeForm').dataset.editId;
                document.getElementById('employeeModalTitle').textContent = 'Add New Employee';
                
                // Populate brand dropdown
                populateEmployeeBrandDropdown();
                
                // Default to current brand/location if set
                const currentLocation = getCurrentLocation();
                if (currentLocation) {
                    const locationItem = LOCATION_BRAND_MAP.find(item => item.location === currentLocation);
                    if (locationItem) {
                        document.getElementById('empBrand').value = locationItem.brand;
                        updateEmployeeLocationDropdown(locationItem.brand);
                        setTimeout(() => {
                            document.getElementById('empLocation').value = currentLocation;
                            // Populate role dropdown based on brand/location
                            populateEmployeeRoleDropdown(locationItem.brand, currentLocation);
                        }, 100);
                    }
                } else {
                    // No location selected, populate with default roles
                    populateEmployeeRoleDropdown('', '');
                }
                
                document.getElementById('addEmployeeModal').style.display = 'block';
            });
            
            // Brand change handler for employee form
            document.getElementById('empBrand').addEventListener('change', (e) => {
                const selectedBrand = e.target.value;
                updateEmployeeLocationDropdown(selectedBrand);
                
                // Update role dropdown
                const selectedLocation = document.getElementById('empLocation').value;
                populateEmployeeRoleDropdown(selectedBrand, selectedLocation);
            });
            
            // Location change handler for employee form
            document.getElementById('empLocation').addEventListener('change', (e) => {
                const selectedLocation = e.target.value;
                const selectedBrand = document.getElementById('empBrand').value;
                
                // Update role dropdown
                populateEmployeeRoleDropdown(selectedBrand, selectedLocation);
            });
            
            // Pay type change handler to update help text
            document.getElementById('empPayType').addEventListener('change', (e) => {
                const payType = e.target.value;
                const helpText = document.getElementById('payRateHelp');
                const rateInput = document.getElementById('empPayRate');
                
                if (payType === 'hourly') {
                    helpText.textContent = 'Hourly rate (e.g., 15.00)';
                    rateInput.placeholder = '15.00';
                } else if (payType === 'weekly') {
                    helpText.textContent = 'Weekly salary for GM (e.g., 1100)';
                    rateInput.placeholder = '1100';
                }
            });
            
            // Employee form submission
            document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('empName').value;
                const brand = document.getElementById('empBrand').value;
                const location = document.getElementById('empLocation').value;
                const role = document.getElementById('empRole').value;
                const payType = document.getElementById('empPayType').value;
                const payRate = document.getElementById('empPayRate').value;
                const email = document.getElementById('empEmail').value;
                const availability = document.getElementById('empAvailability').value;
                const notes = document.getElementById('empNotes').value;
                
                const editId = e.target.dataset.editId;
                let success = false;
                
                if (editId) {
                    success = await updateEmployee(parseInt(editId), name, brand, location, role, payType, payRate, email, availability, notes);
                } else {
                    success = await addEmployee(name, brand, location, role, payType, payRate, email, availability, notes);
                }
                
                if (success) {
                    document.getElementById('addEmployeeModal').style.display = 'none';
                    e.target.reset();
                    delete e.target.dataset.editId;
                    document.getElementById('employeeModalTitle').textContent = 'Add New Employee';
                }
            });
            
            // Daily sales inputs
            const dailySalesInputs = document.querySelectorAll('.daily-sales');
            dailySalesInputs.forEach(input => {
                input.addEventListener('input', handleDailySalesChange);
            });
            
            // Submit schedule to Basecamp button
            document.getElementById('emailScheduleBtn').addEventListener('click', async () => {
                try {
                    // Get current brand and location
                    const currentBrand = getCurrentBrand() || 'Unknown Brand';
                    const currentLocation = getCurrentLocation() || 'Unknown Location';
                    
                    // Get week start date
                    const weekStartDate = currentWeekStart.toLocaleDateString();
                    
                    // Check if there's any schedule data
                    const hasScheduleData = Object.keys(scheduleData).some(key => 
                        scheduleData[key] && scheduleData[key].name
                    );
                    
                    if (!hasScheduleData) {
                        showError('No schedule data to submit. Please add employee schedules first.');
                        return;
                    }
                    
                    // Show loading indicator
                    const btn = document.getElementById('emailScheduleBtn');
                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading to Basecamp...';
                    
                    // Submit to Basecamp with sales data
                    console.log('Checking BasecampIntegration:', window.BasecampIntegration);
                    console.log('Has submitScheduleToBasecamp:', window.BasecampIntegration?.submitScheduleToBasecamp);
                    
                    if (window.BasecampIntegration && window.BasecampIntegration.submitScheduleToBasecamp) {
                        const result = await window.BasecampIntegration.submitScheduleToBasecamp(
                            scheduleData,
                            weekStartDate,
                            currentLocation,
                            currentBrand,
                            currentWeekSales // Pass the sales data
                        );
                        
                        if (result.success) {
                            showSuccess(`Schedule uploaded to Basecamp! <a href="${result.documentUrl}" target="_blank" style="color: #fff; text-decoration: underline;">View in Basecamp</a>`);
                        } else {
                            throw new Error(result.message || 'Upload failed');
                        }
                    } else {
                        throw new Error('Basecamp integration not available');
                    }
                    
                } catch (error) {
                    console.error('Schedule submission error:', error);
                    showError(`Failed to submit schedule: ${error.message}`);
                } finally {
                    // Restore button
                    const btn = document.getElementById('emailScheduleBtn');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Submit to Basecamp';
                }
            });
            
            // Copy schedule button
            document.getElementById('copyScheduleBtn').addEventListener('click', () => {
                // Simple implementation - copy current schedule data
                const scheduleText = JSON.stringify(scheduleData, null, 2);
                navigator.clipboard.writeText(scheduleText).then(() => {
                    showSuccess('Schedule data copied to clipboard');
                }).catch(() => {
                    showError('Could not copy schedule data');
                });
            });
            
            // Enhanced print schedule button - Uses the same enhanced PDF
            document.getElementById('printScheduleBtn').addEventListener('click', () => {
                // Check security level - must be 3 or higher
                const currentUserRole = currentUser?.role || 'staff';
                const currentSecurityCode = getSecurityCodeForRole(currentUserRole);
                
                if (currentSecurityCode < 3) {
                    showError('You do not have permission to print schedules. Security level 3 or higher required.');
                    return;
                }
                
                const currentDate = new Date();
                const weekDate = currentWeekStart.toLocaleDateString();
                
                const currentBrand = getCurrentBrand();
                const currentLocation = getCurrentLocation();
                
                // Update totals before printing
                if (currentBrand === 'Office Administration' && currentLocation === 'Office') {
                    updateOfficeAdminTotals();
                } else {
                    updateScheduleTotals();
                }
                
                // Check if we have the Basecamp integration for PDF generation
                console.log('Checking BasecampIntegration:', window.BasecampIntegration);
                console.log('Has generateSchedulePDF:', window.BasecampIntegration?.generateSchedulePDF);
                
                if (window.BasecampIntegration && window.BasecampIntegration.generateSchedulePDF) {
                    try {
                        showInfo('Generating schedule report...');
                        
                        console.log('Generating PDF with data:', {
                            scheduleData,
                            weekDate,
                            currentLocation,
                            currentBrand,
                            currentWeekSales
                        });
                        
                        // Generate the enhanced PDF
                        const pdfBase64 = window.BasecampIntegration.generateSchedulePDF(
                            scheduleData,
                            weekDate,
                            currentLocation,
                            currentBrand,
                            currentWeekSales
                        );
                        
                        if (!pdfBase64) {
                            throw new Error('PDF generation returned empty result');
                        }
                        
                        console.log('PDF generated, base64 length:', pdfBase64.length);
                        
                        // Convert base64 to binary
                        const byteCharacters = atob(pdfBase64);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        
                        // Create blob and object URL
                        const blob = new Blob([byteArray], { type: 'application/pdf' });
                        const blobUrl = URL.createObjectURL(blob);
                        
                        // Open in new window
                        const printWindow = window.open(blobUrl, '_blank');
                        
                        if (printWindow) {
                            // Clean up blob URL after window loads
                            printWindow.onload = () => {
                                setTimeout(() => {
                                    printWindow.print();
                                }, 500);
                            };
                            
                            // Clean up blob URL after a delay
                            setTimeout(() => {
                                URL.revokeObjectURL(blobUrl);
                            }, 60000); // Clean up after 1 minute
                            
                            showSuccess('Schedule report opened in new window');
                        } else {
                            showError('Could not open print window. Please check popup blocker settings.');
                            URL.revokeObjectURL(blobUrl);
                        }
                        
                        return; // Exit early, don't continue with old print logic
                    } catch (error) {
                        console.error('Error generating PDF:', error);
                        showError('Failed to generate schedule report: ' + error.message);
                        // Fall back to old print method
                    }
                }
                
                if (currentBrand === 'Office Administration' && currentLocation === 'Office') {
                    try {
                        // Create a dedicated print window with Office Admin schedule
                        const printWindow = window.open('', '', 'height=800,width=1200');
                        if (!printWindow) {
                            showError('Could not open print window. Please check popup blocker settings.');
                            return;
                        }
                        
                        // Get the current schedule data
                        const scheduleTable = document.getElementById('scheduleTable');
                        if (!scheduleTable) {
                            showError('Schedule table not found');
                            return;
                        }
                    
                    // Create a clone of the table and process it for printing
                    const printTable = scheduleTable.cloneNode(true);
                    
                    // Remove any existing IDs to avoid conflicts
                    printTable.removeAttribute('id');
                    
                    // Process each row to show actual values instead of inputs
                    const rows = printTable.querySelectorAll('tbody tr');
                    console.log(`Processing ${rows.length} rows for Office Admin print`);
                    
                    // Debug: Log schedule data
                    console.log('Current scheduleData:', scheduleData);
                    
                    rows.forEach((row, index) => {
                        const empId = `emp_${index}`;
                        const empData = scheduleData[empId] || {};
                        console.log(`Row ${index} - empId: ${empId}, empData:`, empData);
                        
                        // Get all cells in the row
                        const cells = row.querySelectorAll('td');
                        
                        // Process first cell (employee name)
                        if (cells[0]) {
                            // First try to get from schedule data
                            if (empData.name) {
                                cells[0].textContent = empData.name;
                            } else {
                                // Fallback to select element if exists
                                const nameSelect = cells[0].querySelector('select');
                                if (nameSelect && nameSelect.value) {
                                    const selectedOption = nameSelect.options[nameSelect.selectedIndex];
                                    if (selectedOption) {
                                        cells[0].textContent = selectedOption.text;
                                    }
                                } else {
                                    cells[0].textContent = '';
                                }
                            }
                        }
                        
                        // Process second cell (role)
                        if (cells[1]) {
                            // First try to get from schedule data
                            if (empData.role) {
                                cells[1].textContent = empData.role;
                                cells[1].style.textAlign = 'center';
                            } else {
                                // Fallback to select element if exists
                                const roleSelect = cells[1].querySelector('select');
                                if (roleSelect && roleSelect.value) {
                                    cells[1].textContent = roleSelect.value;
                                    cells[1].style.textAlign = 'center';
                                } else {
                                    cells[1].textContent = '';
                                }
                            }
                        }
                        
                        // Process day cells - look for office-print-value spans
                        const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                        days.forEach((day, dayIndex) => {
                            const dayCell = cells[dayIndex + 2]; // Skip name and role columns
                            if (dayCell && dayCell.classList.contains('office-admin-schedule-cell')) {
                                let cellContent = '';
                                
                                // First try to get from schedule data
                                if (empData[day]) {
                                    const entries = empData[day].split('|');
                                    entries.forEach(entry => {
                                        if (entry.trim()) {
                                            cellContent += `<div class="office-entry">${entry}</div>`;
                                        }
                                    });
                                } else {
                                    // Fallback to existing print values
                                    const printValues = dayCell.querySelectorAll('.office-print-value');
                                    if (printValues.length > 0) {
                                        printValues.forEach(span => {
                                            const value = span.textContent.trim();
                                            if (value && value !== ':') {
                                                cellContent += `<div class="office-entry">${value}</div>`;
                                            }
                                        });
                                    }
                                }
                                
                                // If no content, leave cell empty (don't show OFF)
                                dayCell.innerHTML = cellContent || '';
                                dayCell.style.textAlign = cellContent ? 'left' : 'center';
                            }
                        });
                        
                        // Ensure weekly total displays correctly
                        const totalCell = cells[cells.length - 1]; // Last cell is the total
                        if (totalCell) {
                            // First check if it already has a value from the original table
                            const existingValue = totalCell.textContent.trim();
                            console.log(`Row ${index} - Total cell existing value: "${existingValue}"`);
                            
                            // If it doesn't have a valid value or is "0h", recalculate
                            if (!existingValue || existingValue === '0h' || existingValue === '') {
                                // Calculate total from schedule data if available
                                if (empData.name) {
                                    let weeklyTotal = 0;
                                    days.forEach(day => {
                                        if (empData[day]) {
                                            const entries = empData[day].split('|');
                                            entries.forEach(entry => {
                                                // Extract hours from entry (format: "Location:hours")
                                                const parts = entry.split(':');
                                                if (parts.length >= 2) {
                                                    const hoursStr = parts[1];
                                                    const hours = parseTimeRange(hoursStr);
                                                    weeklyTotal += hours;
                                                }
                                            });
                                        }
                                    });
                                    totalCell.textContent = weeklyTotal > 0 ? `${weeklyTotal.toFixed(1)}h` : '0h';
                                    totalCell.classList.add('weekly-total');
                                    console.log(`Row ${index} - Calculated weekly total: ${weeklyTotal.toFixed(1)}h`);
                                }
                            } else if (!existingValue.includes('h')) {
                                // Add 'h' suffix if missing
                                totalCell.textContent = existingValue + 'h';
                            }
                        }
                    });
                    
                    // Process footer rows to show values instead of inputs
                    const footerRows = printTable.querySelectorAll('tfoot tr');
                    footerRows.forEach(row => {
                        // Process daily sales inputs
                        const salesInputs = row.querySelectorAll('input.daily-sales');
                        salesInputs.forEach(input => {
                            const value = input.value || '0';
                            const cell = input.parentElement;
                            if (cell) {
                                cell.innerHTML = `$${value}`;
                            }
                        });
                        
                        // Hide empty role cells in footer
                        const roleCells = row.querySelectorAll('.print-role-cell');
                        roleCells.forEach(cell => {
                            cell.style.display = 'none';
                        });
                    });
                    
                    // Generate Office Admin specific print HTML
                    const printHTML = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Office Administration Schedule - Week of ${weekDate}</title>
                            <style>
                                @page {
                                    size: landscape;
                                    margin: 0.3in;
                                }
                                
                                * {
                                    box-sizing: border-box;
                                }
                                
                                body {
                                    font-family: Arial, sans-serif;
                                    margin: 0;
                                    padding: 0;
                                    background: white;
                                    color: #000;
                                }
                                
                                .print-container {
                                    width: 100%;
                                    height: 100vh;
                                    padding: 0;
                                    display: flex;
                                    flex-direction: column;
                                }
                                
                                /* Header Section */
                                .print-header {
                                    text-align: center;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 3px solid #000;
                                }
                                
                                h1 {
                                    font-size: 24px;
                                    margin: 0 0 5px 0;
                                    color: #000;
                                    font-weight: bold;
                                }
                                
                                h2 {
                                    font-size: 16px;
                                    margin: 0;
                                    color: #333;
                                    font-weight: normal;
                                }
                                
                                /* Table Styling */
                                .schedule-table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    background: white;
                                    font-size: 11px;
                                    flex: 1;
                                }
                                
                                .schedule-table th,
                                .schedule-table td {
                                    padding: 8px 6px;
                                    text-align: left;
                                    border: 1px solid #000;
                                }
                                
                                /* Header Row */
                                .schedule-table thead th {
                                    background: #333;
                                    color: white;
                                    font-weight: bold;
                                    font-size: 12px;
                                    text-transform: uppercase;
                                    padding: 10px 8px;
                                }
                                
                                /* Column Widths */
                                .schedule-table th:first-child { width: 16%; }
                                .schedule-table th:nth-child(2) { width: 6%; text-align: center; }
                                .schedule-table th:nth-child(n+3):nth-child(-n+9) { width: 9.5%; }
                                .schedule-table th:last-child { 
                                    width: 7%; 
                                    text-align: center;
                                }
                                
                                /* Body Rows */
                                .schedule-table tbody td {
                                    vertical-align: middle;
                                    font-size: 11px;
                                    padding: 8px 6px;
                                    height: auto;
                                }
                                
                                .schedule-table tbody td:first-child {
                                    font-weight: bold;
                                    color: #000;
                                    font-size: 12px;
                                }
                                
                                .schedule-table tbody td:nth-child(2) {
                                    text-align: center;
                                    font-weight: bold;
                                    color: #000;
                                    font-size: 11px;
                                }
                                
                                /* Schedule Entries */
                                .office-entry {
                                    display: block;
                                    padding: 3px 4px;
                                    margin: 2px 0;
                                    background: #f0f0f0;
                                    font-size: 10px;
                                    line-height: 1.3;
                                    color: #000;
                                }
                                
                                /* Weekly Total Column */
                                .weekly-total {
                                    font-weight: bold;
                                    text-align: center;
                                    background: #e0e0e0;
                                    color: #000;
                                    font-size: 12px;
                                    padding: 6px !important;
                                }
                                
                                /* Footer Section */
                                tfoot tr {
                                    font-weight: bold;
                                }
                                
                                tfoot tr:first-child {
                                    background: #f0f0f0;
                                    border-top: 3px solid #000;
                                }
                                
                                tfoot tr:first-child td {
                                    padding-top: 10px;
                                    font-size: 12px;
                                }
                                
                                tfoot tr:nth-child(2) {
                                    background: #e8e8e8;
                                }
                                
                                tfoot tr:nth-child(3) {
                                    background: #f8f8f8;
                                }
                                
                                tfoot tr:nth-child(4) {
                                    background: #f0f0f0;
                                }
                                
                                tfoot td {
                                    font-size: 11px;
                                    padding: 8px 6px;
                                    text-align: center;
                                    font-weight: bold;
                                }
                                
                                tfoot td:first-child {
                                    text-align: left;
                                    font-weight: bold;
                                    color: #000;
                                    font-size: 12px;
                                }
                                
                                /* Hide role column in footer */
                                tfoot td:nth-child(2) {
                                    display: none;
                                }
                                
                                /* Empty cells */
                                .empty-cell {
                                    color: #999;
                                    text-align: center;
                                    font-style: normal;
                                    font-size: 8px;
                                }
                                
                                /* Print optimization */
                                @media print {
                                    html, body {
                                        height: 100%;
                                        margin: 0;
                                        padding: 0;
                                    }
                                    
                                    .print-container {
                                        height: 100vh;
                                        padding: 0;
                                        display: flex;
                                        flex-direction: column;
                                    }
                                    
                                    .schedule-table {
                                        page-break-inside: avoid;
                                        flex: 1;
                                        display: table;
                                    }
                                    
                                    .schedule-table thead th {
                                        background: #333 !important;
                                        -webkit-print-color-adjust: exact;
                                        print-color-adjust: exact;
                                    }
                                    
                                    .weekly-total {
                                        background: #e0e0e0 !important;
                                        -webkit-print-color-adjust: exact;
                                        print-color-adjust: exact;
                                    }
                                    
                                    .office-entry {
                                        background: #f0f0f0 !important;
                                        -webkit-print-color-adjust: exact;
                                        print-color-adjust: exact;
                                    }
                                    
                                    tr {
                                        page-break-inside: avoid;
                                    }
                                }
                                
                                select, input, button {
                                    display: none !important;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="print-container">
                                <div class="print-header">
                                    <h1>Couchman Companies QSR Navigator</h1>
                                    <h2>Office Administration Schedule - Week of ${weekDate}</h2>
                                </div>
                                ${printTable.outerHTML}
                            </div>
                        </body>
                        </html>
                    `;
                    
                    // Log the HTML for debugging
                    console.log('Print HTML length:', printHTML.length);
                    console.log('Print HTML preview:', printHTML.substring(0, 500));
                    
                    // Write to print window
                    printWindow.document.open();
                    printWindow.document.write(printHTML);
                    printWindow.document.close();
                    
                    // Check if document was written
                    if (!printWindow.document.body) {
                        throw new Error('Failed to write document to print window');
                    }
                    
                    // Auto-print after content loads
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                    
                    showSuccess('Office Administration schedule sent to printer');
                    } catch (error) {
                        console.error('Print error:', error);
                        showError('Failed to print: ' + error.message);
                    }
                } else {
                    // Generate clean grid HTML for regular printing
                    const printHTML = generatePrintableScheduleGrid(weekDate);
                    
                    // Open new window for printing
                    const printWindow = window.open('', '', 'height=800,width=1200');
                    printWindow.document.write(printHTML);
                    printWindow.document.close();
                    
                    // Auto-print after content loads
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                    
                    showSuccess('Schedule print view opened');
                }
            });
            
            // Function to generate printable schedule grid
            function generatePrintableScheduleGrid(weekDate) {
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                
                // Check if we should show location column
                const currentBrand = getCurrentBrand();
                const currentLocation = getCurrentLocation();
                const showLocationColumn = currentBrand === 'Office Administration' && currentLocation === 'Office';
                
                let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Weekly Schedule - Week of ${weekDate}</title>
                    <style>
                        @page {
                            size: landscape;
                            margin: 0.5in;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                            font-size: 12px;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 3px solid #2c3e50;
                            padding-bottom: 10px;
                        }
                        
                        .header h1 {
                            margin: 0;
                            color: #2c3e50;
                            font-size: 24px;
                        }
                        
                        .header h2 {
                            margin: 5px 0 0 0;
                            color: #666;
                            font-size: 16px;
                            font-weight: normal;
                        }
                        
                        .schedule-grid {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        
                        .schedule-grid th {
                            background-color: #2c3e50;
                            color: white;
                            padding: 12px 8px;
                            text-align: center;
                            font-weight: bold;
                            border: 2px solid #34495e;
                        }
                        
                        .schedule-grid td {
                            border: 1px solid #ddd;
                            padding: 10px 8px;
                            text-align: center;
                            vertical-align: middle;
                            min-height: 40px;
                        }
                        
                        .employee-name {
                            background-color: #f8f9fa;
                            font-weight: bold;
                            text-align: left;
                            padding-left: 12px;
                            border-right: 2px solid #2c3e50;
                        }
                        
                        .shift-cell {
                            font-weight: 600;
                            color: #2c3e50;
                        }
                        
                        .off-day {
                            background-color: #f8f9fa;
                            color: #999;
                            font-style: italic;
                        }
                        
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            color: #666;
                            font-size: 10px;
                            border-top: 1px solid #ddd;
                            padding-top: 10px;
                        }
                        
                        @media print {
                            body { margin: 0; padding: 15px; }
                            .schedule-grid { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Couchman Companies QSR Navigator - Weekly Schedule</h1>
                        <h2>Week of ${weekDate}</h2>
                    </div>
                    
                    <table class="schedule-grid">
                        <thead>
                            <tr>
                                <th style="width: 150px;">Employee</th>`;
                
                // Add location column if needed
                if (showLocationColumn) {
                    html += `<th style="width: 120px;">Location</th>`;
                }
                
                // Add day headers
                days.forEach(day => {
                    html += `<th style="width: 120px;">${day}</th>`;
                });
                
                html += `</tr></thead><tbody>`;
                
                // Add employee rows
                const employees = Object.keys(scheduleData).filter(empId => scheduleData[empId].name);
                
                if (employees.length === 0) {
                    const colspan = showLocationColumn ? 9 : 8;
                    html += `<tr><td colspan="${colspan}" style="text-align: center; padding: 40px; color: #999; font-style: italic;">No employees scheduled for this week</td></tr>`;
                } else {
                    employees.forEach(empId => {
                        const emp = scheduleData[empId];
                        html += `<tr>
                            <td class="employee-name">${emp.name}${emp.role ? ` (${emp.role})` : ''}</td>`;
                        
                        // Add location column if needed
                        if (showLocationColumn) {
                            html += `<td>${emp.location || ''}</td>`;
                        }
                        
                        dayKeys.forEach(dayKey => {
                            const schedule = emp[dayKey] || '';
                            const isOff = !schedule || schedule.toLowerCase() === 'off' || schedule.toLowerCase() === 'o';
                            
                            html += `<td class="${isOff ? 'off-day' : 'shift-cell'}">
                                ${isOff ? 'OFF' : schedule}
                            </td>`;
                        });
                        
                        html += `</tr>`;
                    });
                }
                
                html += `</tbody></table>
                    
                    <div class="footer">
                        Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()} | Couchman Companies QSR Navigator Restaurant Management System
                    </div>
                </body>
                </html>`;
                
                return html;
            }
            
            // Mobile schedule input button
            document.getElementById('mobileScheduleBtn').addEventListener('click', () => {
                openMobileScheduleModal();
            });

            // Week Navigation Event Listeners
            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                navigateToWeek(-1);
            });

            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                navigateToWeek(1);
            });

            document.getElementById('currentWeekBtn').addEventListener('click', () => {
                goToCurrentWeek();
            });

            // Week dropdown navigation
            document.getElementById('weekDropdown').addEventListener('change', (e) => {
                jumpToWeek(e.target.value);
            });

            // Copy/Paste schedule functionality
            document.getElementById('copyScheduleBtn').addEventListener('click', () => {
                copyCurrentWeek();
            });

            document.getElementById('pasteScheduleBtn').addEventListener('click', () => {
                pasteWeekData();
            });

            // Schedule notes functionality
            document.getElementById('scheduleNotesBtn').addEventListener('click', () => {
                openScheduleNotes();
            });

            document.getElementById('closeNotesModal').addEventListener('click', () => {
                document.getElementById('scheduleNotesModal').style.display = 'none';
            });

            document.getElementById('cancelNotesBtn').addEventListener('click', () => {
                document.getElementById('scheduleNotesModal').style.display = 'none';
            });

            document.getElementById('saveNotesBtn').addEventListener('click', () => {
                saveScheduleNotes();
            });

            document.getElementById('clearNotesBtn').addEventListener('click', () => {
                if (confirm('Clear all notes for this week?')) {
                    document.getElementById('scheduleNotesText').value = '';
                }
            });

            // Mobile Inventory Event Listeners
            document.getElementById('mobileInventoryBtn').addEventListener('click', () => {
                openMobileInventory();
            });

            document.getElementById('closeMobileInventoryModal').addEventListener('click', () => {
                document.getElementById('mobileInventoryModal').style.display = 'none';
            });

            document.getElementById('cancelMobileInventoryBtn').addEventListener('click', () => {
                document.getElementById('mobileInventoryModal').style.display = 'none';
            });

            document.getElementById('saveMobileInventoryBtn').addEventListener('click', () => {
                saveMobileInventory();
            });

            document.getElementById('mobileInventoryCategory').addEventListener('change', (e) => {
                renderMobileInventoryList(e.target.value);
            });

            // Pricing Event Listeners
            document.getElementById('updatePricingBtn').addEventListener('click', () => {
                openPricingModal();
            });

            document.getElementById('closePricingModal').addEventListener('click', () => {
                document.getElementById('updatePricingModal').style.display = 'none';
            });

            document.getElementById('cancelPricingBtn').addEventListener('click', () => {
                document.getElementById('updatePricingModal').style.display = 'none';
            });

            // The update pricing button inside the modal
            document.querySelector('#updatePricingModal .btn-primary').addEventListener('click', () => {
                updatePricing();
            });

            // Print Categories Event Listener
            document.getElementById('printCategoriesBtn').addEventListener('click', () => {
                printCategories();
            });
            
            // Projected Order Cost Event Listener
            document.getElementById('projectedOrderBtn').addEventListener('click', () => {
                calculateProjectedOrderCost();
            });

            // Monthly Inventory Event Listeners
            document.getElementById('monthlyMobileInventoryBtn').addEventListener('click', () => {
                openMonthlyMobileInventory();
            });

            document.getElementById('closeMonthlyMobileInventoryModal').addEventListener('click', () => {
                document.getElementById('monthlyMobileInventoryModal').style.display = 'none';
            });

            document.getElementById('cancelMonthlyMobileInventoryBtn').addEventListener('click', () => {
                document.getElementById('monthlyMobileInventoryModal').style.display = 'none';
            });

            document.getElementById('saveMonthlyMobileInventoryBtn').addEventListener('click', () => {
                saveMonthlyMobileInventory();
            });

            document.getElementById('monthlyMobileInventoryCategory').addEventListener('change', (e) => {
                renderMonthlyMobileInventoryList(e.target.value);
            });


            // Monthly Print Categories Event Listener
            document.getElementById('monthlyPrintCategoriesBtn').addEventListener('click', () => {
                printMonthlyCategories();
            });

            // Monthly Export Event Listener
            document.getElementById('exportInventoryBtn').addEventListener('click', () => {
                exportMonthlyInventory();
            });
            
            // Test Calculations Button
            document.getElementById('testCalculationsBtn').addEventListener('click', () => {
                testMonthlyCalculations();
                
                // Also perform a live test
                console.log('=== LIVE CALCULATION TEST ===');
                const testItems = ['Block Mozzarella', 'Romano'];
                testItems.forEach(item => {
                    const price = monthlyPricing[item] || 0;
                    const testCount = item === 'Block Mozzarella' ? 10 : 2;
                    const expectedTotal = price * testCount;
                    console.log(`${item}: $${price} × ${testCount} = $${expectedTotal.toFixed(2)}`);
                });
            });

            // CSV Upload Event Listeners
            document.getElementById('uploadCsvBtn').addEventListener('click', () => {
                openCsvUploadModal();
            });

            document.getElementById('closeCsvUploadModal').addEventListener('click', () => {
                document.getElementById('csvUploadModal').style.display = 'none';
            });

            document.getElementById('cancelCsvUploadBtn').addEventListener('click', () => {
                document.getElementById('csvUploadModal').style.display = 'none';
            });

            document.getElementById('csvFileInput').addEventListener('change', handleCsvFileSelect);

            document.getElementById('processCsvBtn').addEventListener('click', () => {
                processCsvAndUpdateInventory();
            });

            // Monthly Inventory Month Selection
            document.getElementById('inventoryMonth').addEventListener('change', (e) => {
                currentInventoryMonth = e.target.value;
                loadMonthlyInventoryData();
                renderMonthlyInventoryTable();
                updateMonthlyCategorySummary();
            });
            
            // Modal close buttons
            document.getElementById('closeEmployeeModal').addEventListener('click', () => {
                document.getElementById('employeeModal').style.display = 'none';
            });
            
            document.getElementById('closeAddEmployeeModal').addEventListener('click', () => {
                document.getElementById('addEmployeeModal').style.display = 'none';
            });
            
            document.getElementById('cancelAddEmployee').addEventListener('click', () => {
                document.getElementById('addEmployeeModal').style.display = 'none';
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                const employeeModal = document.getElementById('employeeModal');
                const addEmployeeModal = document.getElementById('addEmployeeModal');
                const mobileScheduleModal = document.getElementById('mobileScheduleModal');
                
                if (e.target === employeeModal) {
                    employeeModal.style.display = 'none';
                }
                if (e.target === addEmployeeModal) {
                    addEmployeeModal.style.display = 'none';
                }
                if (e.target === mobileScheduleModal) {
                    mobileScheduleModal.style.display = 'none';
                    console.log('Mobile schedule modal closed by clicking outside');
                }
            });
        }

        // Global functions for delete buttons
        window.deleteUser = deleteUser;
        window.editEmployee = editEmployee;
        window.deleteEmployee = deleteEmployee;

        // ========================
        // CHECKLIST FUNCTIONALITY  
        // ========================
        
        let currentChecklist = 'opening';
        let checklistData = {};
        let checklistPhotos = {};
        
        // Make these globally accessible for Basecamp integration
        window.currentChecklist = currentChecklist;
        window.checklistData = checklistData;
        window.checklistPhotos = checklistPhotos;
        
        // Get current date/time in HTML datetime-local format
        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // Complete comprehensive checklist data
        const checklists = {
            opening: {
                title: 'Opening Manager Checklist',
                sections: [
                    {
                        title: 'Store Setup',
                        items: [
                            { id: 'closing-rating', label: 'Rate the closing shift from last night', type: 'rating' },
                            { id: 'crew-uniform', label: 'Crew rocking the Jet\'s look? (Clean shirt, black pants/shorts, Jet\'s hat)', type: 'checkbox' },
                            { id: 'oven-temps', label: 'Snap a pic of oven temps & times', type: 'photo' },
                            { id: 'dough-scale', label: 'Snap a pic of calibrated dough scale', type: 'photo' },
                            { id: 'driver-sign', label: 'AM Driver\'s car with delivery sign ON & LIT', type: 'photo' },
                            { id: 'soda-cooler', label: 'Stocked soda cooler', type: 'photo' },
                            { id: 'day-dotted-bins', label: 'Day-dotted, flipped bins for rotation', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Food Preparation',
                        items: [
                            { id: 'makeline-portions', label: 'Portion cups in the makeline', type: 'photo' },
                            { id: 'salad-portions', label: 'Portion cups in salad station', type: 'photo' },
                            { id: 'cheese-scale', label: 'Calibrated cheese scale', type: 'photo' },
                            { id: 'chicken-scale', label: 'Calibrated chicken scale', type: 'photo' },
                            { id: 'dough-book', label: 'Completed Dough Book Wizard', type: 'photo' },
                            { id: 'prep-list', label: 'Completed Prep List', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Dough Preparation',
                        items: [
                            { id: 'small-square', label: 'Pressed small square dough', type: 'photo' },
                            { id: 'large-square', label: 'Pressed large square dough', type: 'photo' },
                            { id: 'xl-square', label: 'Pressed XL square dough', type: 'photo' },
                            { id: 'round-dough', label: 'Wrapped round dough trays', type: 'photo' },
                            { id: 'dough-mixer', label: 'Cleaned dough mixer (18+ required)', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Final Setup',
                        items: [
                            { id: 'slice-setup', label: 'Slice tray setup with tracking method', type: 'photo' },
                            { id: 'store-front', label: 'Store front with signage', type: 'photo' },
                            { id: 'whiteboard', label: 'Whiteboard with tasks outlined', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Shift Evaluation',
                        items: [
                            { id: 'product-quality', label: 'Rate the product quality', type: 'rating' },
                            { id: 'customer-service', label: 'Rate the customer service', type: 'rating' },
                            { id: 'teamwork', label: 'Rate the teamwork', type: 'rating' },
                            { id: 'operations', label: 'Rate store operations', type: 'rating' },
                            { id: 'improvements', label: 'What could we do better?', type: 'text' },
                            { id: 'went-well', label: 'What went well?', type: 'text' }
                        ]
                    }
                ]
            },
            closing: {
                title: 'Closing Manager Checklist',
                sections: [
                    {
                        title: 'Evening Setup',
                        items: [
                            { id: 'opening-rating', label: 'Rate the opening shift', type: 'rating' },
                            { id: 'store-front-pm', label: 'Store front photo', type: 'photo' },
                            { id: 'position-chart', label: 'Position chart filled out', type: 'photo' },
                            { id: 'driver-sign-pm', label: 'PM Driver\'s car with delivery sign ON & LIT', type: 'photo' },
                            { id: 'uniform-check', label: 'Crew uniform check', type: 'checkbox' }
                        ]
                    },
                    {
                        title: 'Burns Tracking',
                        items: [
                            { id: 'small-burns', label: 'Small square burns', type: 'text' },
                            { id: 'large-burns', label: 'Large square burns', type: 'text' },
                            { id: 'xl-burns', label: 'XL square burns', type: 'text' }
                        ]
                    },
                    {
                        title: 'Equipment & Service',
                        items: [
                            { id: 'slice-setup-pm', label: 'Slice tray setup', type: 'photo' },
                            { id: 'oven-temps-pm', label: 'Oven temps & times', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Cleaning & Maintenance',
                        items: [
                            { id: 'makeline-clean', label: 'Sparkling clean makeline', type: 'photo' },
                            { id: 'salad-station-clean', label: 'Cleaned salad station', type: 'photo' },
                            { id: 'cut-table-clean', label: 'Cleaned cut table', type: 'photo' },
                            { id: 'oven-trays-clean', label: 'Cleaned oven & drop trays', type: 'photo' },
                            { id: 'lobby-clean', label: 'Cleaned lobby', type: 'photo' },
                            { id: 'soda-cooler-pm', label: 'Stocked soda cooler', type: 'photo' }
                        ]
                    },
                    {
                        title: 'End of Day',
                        items: [
                            { id: 'labor-stats', label: 'POS Labor Stats', type: 'photo' },
                            { id: 'station-cleaning', label: 'Station cleaning checklists completed', type: 'checkbox' },
                            { id: 'drivers-cashed', label: 'All drivers returned and cashed out', type: 'checkbox' },
                            { id: 'safe-counted', label: 'Safe counted, drawers counted, POS day end ran', type: 'checkbox' },
                            { id: 'secured', label: 'Ovens off, lights off, alarm set, doors locked', type: 'checkbox' }
                        ]
                    },
                    {
                        title: 'Shift Evaluation',
                        items: [
                            { id: 'product-quality-pm', label: 'Rate the product quality', type: 'rating' },
                            { id: 'customer-service-pm', label: 'Rate the customer service', type: 'rating' },
                            { id: 'teamwork-pm', label: 'Rate the teamwork', type: 'rating' },
                            { id: 'operations-pm', label: 'Rate store operations', type: 'rating' },
                            { id: 'improvements-pm', label: 'What could we do better?', type: 'text' },
                            { id: 'went-well-pm', label: 'What went well?', type: 'text' }
                        ]
                    }
                ]
            },
            weekly: {
                title: 'Weekly Store Profile (RM)',
                sections: [
                    {
                        title: 'Store Information',
                        items: [
                            { id: 'management-team', label: 'Management Team Members', type: 'text' }
                        ]
                    },
                    {
                        title: 'Front Lobby Area',
                        items: [
                            { id: 'windows-clean', label: 'Windows clean', type: 'checkbox' },
                            { id: 'front-door', label: 'Front door clean/handle secure', type: 'checkbox' },
                            { id: 'proper-signage', label: 'Proper signage', type: 'checkbox' },
                            { id: 'floors-clean', label: 'Floors clean', type: 'checkbox' },
                            { id: 'wall-tile', label: 'Wall tile clean', type: 'checkbox' },
                            { id: 'pop-cooler', label: 'Pop cooler clean & stocked', type: 'checkbox' },
                            { id: 'rugs-clean', label: 'Rugs clean', type: 'checkbox' },
                            { id: 'sneeze-guard', label: 'Sneeze guard clean', type: 'checkbox' },
                            { id: 'hot-box', label: 'Hot box clean', type: 'checkbox' },
                            { id: 'menu-tvs', label: 'Menu TVs on', type: 'checkbox' },
                            { id: 'lobby-photo', label: 'Take pic of lobby', type: 'photo' },
                            { id: 'lobby-rating', label: 'Lobby rating', type: 'rating' },
                            { id: 'lobby-notes', label: 'Lobby improvement notes', type: 'text' }
                        ]
                    },
                    {
                        title: 'Kitchen Stations',
                        items: [
                            { id: 'stations-stocked', label: 'Stations fully stocked/round dough rotated', type: 'checkbox' },
                            { id: 'cabinets-clean', label: 'Make line/salad station cabinets cleaned', type: 'checkbox' },
                            { id: 'topping-cups', label: 'Cups for toppings in tables', type: 'checkbox' },
                            { id: 'slices-ready', label: 'Slices ready/slice timer used', type: 'checkbox' },
                            { id: 'freezers-organized', label: 'Freezers clean and organized', type: 'checkbox' },
                            { id: 'wing-bowls', label: 'Wing bowls', type: 'checkbox' },
                            { id: 'slice-boxes', label: 'Slice boxes (single for combos)', type: 'checkbox' },
                            { id: 'cutside-setup', label: 'Wing bowls/cutside set up', type: 'checkbox' },
                            { id: 'boxes-stocked', label: 'Boxes and inserts stocked', type: 'checkbox' },
                            { id: 'ovens-on', label: 'Ovens on at 9:30am', type: 'checkbox' },
                            { id: 'kitchen-photo', label: 'Take pic of kitchen', type: 'photo' },
                            { id: 'kitchen-rating', label: 'Kitchen rating', type: 'rating' },
                            { id: 'kitchen-notes', label: 'Kitchen improvement notes', type: 'text' }
                        ]
                    },
                    {
                        title: 'Back of House',
                        items: [
                            { id: 'delivery-station', label: 'Delivery station clean, mapping screen working', type: 'checkbox' },
                            { id: 'delivery-signs', label: 'Store has enough delivery signs', type: 'checkbox' },
                            { id: 'copilot-running', label: 'Co-Pilot up and running', type: 'checkbox' },
                            { id: 'delivery-bags', label: 'Enough delivery bags, clean and organized', type: 'checkbox' },
                            { id: 'walkin-cooler', label: 'Walk-in cooler clean and organized', type: 'checkbox' },
                            { id: 'driver-cooler', label: 'Driver cooler stocked (if applicable)', type: 'checkbox' },
                            { id: 'backroom-photo', label: 'Take pic of back room', type: 'photo' },
                            { id: 'boh-rating', label: 'Back of house rating', type: 'rating' },
                            { id: 'boh-notes', label: 'BOH improvement notes', type: 'text' }
                        ]
                    },
                    {
                        title: 'Prep',
                        items: [
                            { id: 'dough-pressed', label: 'Dough pressed and rotated properly (by 11am)', type: 'checkbox' },
                            { id: 'prep-day-dotted', label: 'Prep day dotted', type: 'checkbox' },
                            { id: 'prep-rotated', label: 'Prep rotated, not over prepping chopped veggies', type: 'checkbox' },
                            { id: 'prep-charts', label: 'Prep charts used', type: 'checkbox' },
                            { id: 'dough-wizard', label: 'Dough Book Wizard used', type: 'checkbox' },
                            { id: 'pressed-dough-photo', label: 'Pic of pressed dough', type: 'photo' },
                            { id: 'prep-rating', label: 'Prep rating', type: 'rating' },
                            { id: 'prep-notes', label: 'Prep improvement notes', type: 'text' }
                        ]
                    },
                    {
                        title: 'Management',
                        items: [
                            { id: 'proper-staffing', label: 'Proper staffing/scheduling', type: 'checkbox' },
                            { id: 'schedule-posted', label: 'Schedule posted', type: 'checkbox' },
                            { id: 'marketing-calendar', label: 'Marketing calendar posted', type: 'checkbox' },
                            { id: 'lights-working', label: 'Lights working and on by 10am', type: 'checkbox' },
                            { id: 'employees-uniform', label: 'Employees uniform', type: 'checkbox' },
                            { id: 'door-chime', label: 'Door chime working', type: 'checkbox' },
                            { id: 'phones-checked', label: 'Phones checked, staff feedback', type: 'checkbox' },
                            { id: 'online-ordering', label: 'Online ordering checked, delivery radius, 3rd party', type: 'checkbox' },
                            { id: 'google-reviews', label: 'Google reviews checked', type: 'checkbox' },
                            { id: 'quoted-times', label: 'Quoted times checked, POS report', type: 'checkbox' },
                            { id: 'wages-updated', label: 'Wages up to date in POS, roster in payroll', type: 'checkbox' },
                            { id: 'gift-cards', label: 'Gift cards in store', type: 'checkbox' },
                            { id: 'doordash-bags', label: 'Door Dash bags for 3rd party orders', type: 'checkbox' },
                            { id: 'schedule-photo', label: 'Take pic of posted schedule', type: 'photo' },
                            { id: 'staff-photo', label: 'Staff group pic', type: 'photo' },
                            { id: 'management-rating', label: 'Management rating', type: 'rating' },
                            { id: 'safe-total', label: 'Safe total', type: 'text' },
                            { id: 'otd', label: 'OTD', type: 'text' },
                            { id: 'quoted-times-notes', label: 'Quoted times notes', type: 'text' },
                            { id: 'net-sales', label: 'Net sales', type: 'text' },
                            { id: 'food-cost', label: 'Food cost %', type: 'text' },
                            { id: 'labor-cost', label: 'Labor cost %', type: 'text' }
                        ]
                    }
                ]
            },
            monthly: {
                title: 'Monthly Store Inspection',
                sections: [
                    {
                        title: 'Exterior',
                        items: [
                            { id: 'ext-windows-door', label: 'Windows/Front door (clean, updated signage, hours)', type: 'checkbox' },
                            { id: 'ext-windows-door-photo', label: 'Photo of storefront (optional)', type: 'photo' },
                            { id: 'ext-doors', label: 'Doors (proper color, fire retardant paint, maintained)', type: 'checkbox' },
                            { id: 'ext-parking', label: 'Parking lot (lighting, litter, etc.)', type: 'checkbox' },
                            { id: 'ext-parking-photo', label: 'Photo of parking lot issues (optional)', type: 'photo' },
                            { id: 'ext-signs', label: 'Signs (LED working, professional trademark)', type: 'checkbox' },
                            { id: 'ext-signs-photo', label: 'Photo of signage (optional)', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Lobby',
                        items: [
                            { id: 'lobby-sneeze', label: 'Sneeze guard (clean/75% open glass)', type: 'checkbox' },
                            { id: 'lobby-menu', label: 'Menu board/updated signage (on, updated)', type: 'checkbox' },
                            { id: 'lobby-unapproved', label: 'Any unapproved items/objects', type: 'checkbox' },
                            { id: 'lobby-unapproved-photo', label: 'Photo of unapproved items (optional)', type: 'photo' },
                            { id: 'lobby-seating', label: 'Seating/tables (approved/clean, proper colors)', type: 'checkbox' },
                            { id: 'lobby-restrooms', label: 'Restrooms (clean & organized)', type: 'checkbox' },
                            { id: 'lobby-counter', label: 'Front counter (clean & organized)', type: 'checkbox' },
                            { id: 'lobby-counter-photo', label: 'Photo of front counter (optional)', type: 'photo' },
                            { id: 'lobby-maintenance', label: 'Maintenance (doors, tiles, gates, baseboards)', type: 'checkbox' },
                            { id: 'lobby-maintenance-photo', label: 'Photo of maintenance issues (optional)', type: 'photo' },
                            { id: 'lobby-cleanliness', label: 'Cleanliness (walls, floors, corners, ceiling)', type: 'checkbox' },
                            { id: 'lobby-lighting', label: 'Lighting (broken covers, burnt bulbs)', type: 'checkbox' },
                            { id: 'lobby-pop-cooler', label: 'Pop cooler (clean, filled, proper temp)', type: 'checkbox' },
                            { id: 'lobby-overview-photo', label: 'Overall lobby photo (optional)', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Make Area',
                        items: [
                            { id: 'make-hotbox', label: 'Hot box(es) (maintained, clean, display working)', type: 'checkbox' },
                            { id: 'make-hotbox-photo', label: 'Photo of hot box issues (optional)', type: 'photo' },
                            { id: 'make-temperature', label: 'Temperature (proper holding temp, regulations)', type: 'checkbox' },
                            { id: 'make-freezer', label: 'Freezer (clean, organized, gaskets clean)', type: 'checkbox' },
                            { id: 'make-freezer-photo', label: 'Photo of freezer gaskets (optional)', type: 'photo' },
                            { id: 'make-tables', label: 'Make/salad tables (clean, gaskets clean)', type: 'checkbox' },
                            { id: 'make-tables-photo', label: 'Photo of table gaskets (optional)', type: 'photo' },
                            { id: 'make-handsink', label: 'Side hand sink (clean, soap, towels, caulked)', type: 'checkbox' },
                            { id: 'make-handsink-photo', label: 'Photo of hand sink area (optional)', type: 'photo' },
                            { id: 'make-worktables', label: 'Work tables (clean, organized, maintained)', type: 'checkbox' },
                            { id: 'make-cleanliness', label: 'Cleanliness (ceiling, vents, walls, floors)', type: 'checkbox' },
                            { id: 'make-cleanliness-photo', label: 'Photo of cleanliness issues (optional)', type: 'photo' },
                            { id: 'make-lights', label: 'Lights (broken covers, burnt bulbs)', type: 'checkbox' },
                            { id: 'make-sheeter', label: 'Dough sheeter (working, clean, proper settings)', type: 'checkbox' },
                            { id: 'make-cutside', label: 'Cut side (heat lamps, table clean, organized)', type: 'checkbox' },
                            { id: 'make-oven', label: 'Oven (clean, catch trays, utensils, filters)', type: 'checkbox' },
                            { id: 'make-oven-photo', label: 'Photo of oven condition (optional)', type: 'photo' },
                            { id: 'make-hood', label: 'Hood unit (clean, lights on, working)', type: 'checkbox' },
                            { id: 'make-oven-temp', label: 'Oven time & temperature (using enough ovens)', type: 'checkbox' },
                            { id: 'make-area-overview', label: 'Make area overview photo (optional)', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Back of Store',
                        items: [
                            { id: 'back-cleanliness', label: 'Cleanliness (ceiling, walls, floors, nothing on floor)', type: 'checkbox' },
                            { id: 'back-cleanliness-photo', label: 'Photo of back area cleanliness (optional)', type: 'photo' },
                            { id: 'back-phone', label: 'Phone area (organized, signs posted, coupons)', type: 'checkbox' },
                            { id: 'back-walkin', label: 'Walk-in cooler (clean, organized, proper temp)', type: 'checkbox' },
                            { id: 'back-walkin-photo', label: 'Photo of walk-in cooler (optional)', type: 'photo' },
                            { id: 'back-sink', label: '3 compartment sink/hand sink (clean, caulked)', type: 'checkbox' },
                            { id: 'back-sink-photo', label: 'Photo of sink area (optional)', type: 'photo' },
                            { id: 'back-canopener', label: 'Can opener/electric mixer (clean, working)', type: 'checkbox' },
                            { id: 'back-hobart', label: 'Hobart & dough bowl (clean, no buildup)', type: 'checkbox' },
                            { id: 'back-hobart-photo', label: 'Photo of Hobart mixer (optional)', type: 'photo' },
                            { id: 'back-grinder', label: 'Cheese grinder & veggie chopper (clean, proper blades)', type: 'checkbox' }
                        ]
                    }
                ]
            },
            fieldmanager: {
                title: 'Jet\'s Pizza Field Manager Shift Visit Report',
                sections: [
                    {
                        title: 'Shift Details',
                        items: [
                            { id: 'fm-shift-8-11', label: 'Shift: 8am-11am', type: 'checkbox' },
                            { id: 'fm-shift-5-8', label: 'Shift: 5pm-8pm', type: 'checkbox' },
                            { id: 'fm-shift-7-10', label: 'Shift: 7pm-10pm', type: 'checkbox' }
                        ]
                    },
                    {
                        title: 'Training & Product Execution',
                        items: [
                            { id: 'fm-trained-rounds', label: 'Trained staff on rounds', type: 'checkbox' },
                            { id: 'fm-saucing-technique', label: 'Saucing technique and cheese/topping distribution', type: 'checkbox' },
                            { id: 'fm-portion-control', label: 'Portion control & product rotation', type: 'checkbox' },
                            { id: 'fm-oven-loading', label: 'Oven loading & round screens practice', type: 'checkbox' },
                            { id: 'fm-proper-bake', label: 'Proper bake on pizzas', type: 'checkbox' },
                            { id: 'fm-oven-management', label: 'Oven management techniques', type: 'checkbox' },
                            { id: 'fm-cut-table', label: 'Cut table technique & pizza packaging', type: 'checkbox' },
                            { id: 'fm-ticket-management', label: 'Ticket management & slice packaging', type: 'checkbox' },
                            { id: 'fm-register-coaching', label: 'Register/customer service coaching', type: 'checkbox' },
                            { id: 'fm-salad-portion', label: 'Salad portioning & packaging', type: 'checkbox' },
                            { id: 'fm-phone-upsell', label: 'Phone upselling & order practice', type: 'checkbox' },
                            { id: 'fm-dough-procedures', label: 'Dough procedures: temp, consistency, pressing, wrapping', type: 'checkbox' },
                            { id: 'fm-slice-procedure', label: 'Train staff on slice procedure, fresh slices available every hour', type: 'checkbox' },
                            { id: 'fm-prep-rotation', label: 'Prep rotation & inventory management', type: 'checkbox' },
                            { id: 'fm-training-notes', label: 'Additional Notes', type: 'text' },
                            { id: 'fm-training-photo-1', label: 'Training Photo 1', type: 'photo' },
                            { id: 'fm-training-photo-2', label: 'Training Photo 2', type: 'photo' },
                            { id: 'fm-training-photo-3', label: 'Training Photo 3', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Time Management & Prep',
                        items: [
                            { id: 'fm-opening-procedures', label: 'Opening procedures & dough prep', type: 'checkbox' },
                            { id: 'fm-timed-batches', label: 'Timed dough batches (<12 min goal)', type: 'checkbox' },
                            { id: 'fm-square-dough', label: 'Square dough pressed by 10am', type: 'checkbox' },
                            { id: 'fm-prep-management', label: 'Prep management: one task at a time', type: 'checkbox' },
                            { id: 'fm-morning-rush', label: 'Morning rush prep (sauces, cheese, tables stocked)', type: 'checkbox' },
                            { id: 'fm-major-prep', label: 'Major prep stops by 11am', type: 'checkbox' },
                            { id: 'fm-delivery-management', label: 'Delivery management coaching', type: 'checkbox' },
                            { id: 'fm-evening-rush', label: 'Evening rush prep (sauces, cheese, boxes, etc.)', type: 'checkbox' },
                            { id: 'fm-closing-procedures', label: 'Closing procedures & checklist review', type: 'checkbox' },
                            { id: 'fm-make-table-timing', label: 'Make table/lobby closing timing', type: 'checkbox' },
                            { id: 'fm-time-notes', label: 'Notes', type: 'text' },
                            { id: 'fm-time-photo-1', label: 'Time Management Photo 1', type: 'photo' },
                            { id: 'fm-time-photo-2', label: 'Time Management Photo 2', type: 'photo' },
                            { id: 'fm-time-photo-3', label: 'Time Management Photo 3', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Management Coaching',
                        items: [
                            { id: 'fm-delivery-assignment', label: 'Delivery assignment coaching (no triples)', type: 'checkbox' },
                            { id: 'fm-driver-signage', label: 'Driver signage checks', type: 'checkbox' },
                            { id: 'fm-position-chart', label: 'Daily position chart completion', type: 'checkbox' },
                            { id: 'fm-dough-book', label: 'Dough book & prep par review', type: 'checkbox' },
                            { id: 'fm-portion-coaching', label: 'Portion control coaching', type: 'checkbox' },
                            { id: 'fm-inventory-control', label: 'Inventory control & budgeted ordering', type: 'checkbox' },
                            { id: 'fm-scheduling-review', label: 'Scheduling & budgeting review', type: 'checkbox' },
                            { id: 'fm-uniform-standards', label: 'Uniform standards enforced', type: 'checkbox' },
                            { id: 'fm-jetsu-forms', label: 'JetsU/JOT forms in use', type: 'checkbox' },
                            { id: 'fm-training-docs', label: 'Training documentation review', type: 'checkbox' },
                            { id: 'fm-labor-stats', label: 'Labor stats & staff cut timing', type: 'checkbox' },
                            { id: 'fm-marketing-calendar', label: 'Marketing calendar posted', type: 'checkbox' },
                            { id: 'fm-prep-charts', label: 'Prep charts updated', type: 'checkbox' },
                            { id: 'fm-store-systems', label: 'Store systems/tech checked (lights, chime, phones, online orders)', type: 'checkbox' },
                            { id: 'fm-google-reviews', label: 'Google reviews checked', type: 'checkbox' },
                            { id: 'fm-pos-roster', label: 'POS/roster/gift cards/DoorDash bags checked', type: 'checkbox' },
                            { id: 'fm-sign-return', label: 'Coach management team to ask for all signs and bags to be returned before checking out the POS and clocking out', type: 'checkbox' },
                            { id: 'fm-management-notes', label: 'Notes', type: 'text' },
                            { id: 'fm-management-photo-1', label: 'Management Photo 1', type: 'photo' },
                            { id: 'fm-management-photo-2', label: 'Management Photo 2', type: 'photo' },
                            { id: 'fm-management-photo-3', label: 'Management Photo 3', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Store Cleanliness & Organization',
                        items: [
                            { id: 'fm-deep-clean-stations', label: 'Deep cleaned stations & tables', type: 'checkbox' },
                            { id: 'fm-walkin-organized', label: 'Walk-in, soda cooler, cut table organized', type: 'checkbox' },
                            { id: 'fm-lobby-deep-clean', label: 'Lobby/walls deep cleaned', type: 'checkbox' },
                            { id: 'fm-sinks-bathroom', label: 'Sinks/mop/bathroom deep cleaned', type: 'checkbox' },
                            { id: 'fm-wing-pans', label: 'Wing/cinnamon pans cleaned', type: 'checkbox' },
                            { id: 'fm-dough-mixer-area', label: 'Dough mixer/sink area cleaned', type: 'checkbox' },
                            { id: 'fm-equipment-fixed', label: 'Broken equipment/bulbs fixed', type: 'checkbox' },
                            { id: 'fm-cleanliness-notes', label: 'Notes', type: 'text' },
                            { id: 'fm-cleanliness-photo-1', label: 'Cleanliness Photo 1', type: 'photo' },
                            { id: 'fm-cleanliness-photo-2', label: 'Cleanliness Photo 2', type: 'photo' },
                            { id: 'fm-cleanliness-photo-3', label: 'Cleanliness Photo 3', type: 'photo' }
                        ]
                    },
                    {
                        title: 'Additional Comments / Follow-ups',
                        items: [
                            { id: 'fm-additional-comments', label: 'Additional Comments / Follow-ups', type: 'text' }
                        ]
                    },
                    {
                        title: 'Manager Signature',
                        items: [
                            { id: 'fm-manager-signature', label: 'Manager Signature', type: 'text' },
                            { id: 'fm-signature-date', label: 'Date', type: 'date' }
                        ]
                    }
                ]
            }
        };
        
        // Switch checklist type
        function switchChecklist(checklistType) {
            currentChecklist = checklistType;
            window.currentChecklist = checklistType; // Update global reference
            document.querySelectorAll('[data-checklist]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-checklist="${checklistType}"]`).classList.add('active');
            renderChecklistContent();
        }
        
        // Render checklist content
        function renderChecklistContent() {
            // Use the new checklist system if available, fallback to old
            const checklist = (window.checklistsNew && window.checklistsNew[currentChecklist]) ? 
                             window.checklistsNew[currentChecklist] : 
                             checklists[currentChecklist];
            const content = document.getElementById('checklistContent');
            
            let html = `<h3 style="margin-bottom: 20px; color: #2c3e50;">${checklist.title}</h3>`;
            
            checklist.sections.forEach(section => {
                html += `<div class="card" style="margin-bottom: 20px;">
                    <div class="card-header"><h4>${section.title}</h4></div>
                    <div style="padding: 20px;">`;
                
                section.items.forEach(item => {
                    html += `<div class="form-group" style="border-bottom: 1px solid #eee; padding: 15px 0;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">${item.label}</label>`;
                    
                    if (item.type === 'checkbox') {
                        // For weekly and monthly checklists, use Pass/Needs Work/Fail options
                        if (currentChecklist === 'weekly' || currentChecklist === 'monthly') {
                            html += `<div style="display: flex; gap: 15px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="${item.id}" value="pass" onchange="handleChecklistChange('${item.id}', this.value)" style="transform: scale(1.2);">
                                    <span style="color: #27ae60; font-weight: 600;">Pass</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="${item.id}" value="needs-work" onchange="handleChecklistChange('${item.id}', this.value)" style="transform: scale(1.2);">
                                    <span style="color: #f39c12; font-weight: 600;">Needs Work</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="${item.id}" value="fail" onchange="handleChecklistChange('${item.id}', this.value)" style="transform: scale(1.2);">
                                    <span style="color: #e74c3c; font-weight: 600;">Fail</span>
                                </label>
                            </div>`;
                        } else {
                            // For opening and closing checklists, use regular checkboxes
                            html += `<label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="${item.id}" onchange="handleChecklistChange('${item.id}', this.checked)" style="transform: scale(1.2);">
                                <span>Complete</span></label>`;
                        }
                    } else if (item.type === 'rating') {
                        html += `<div class="star-rating" data-item-id="${item.id}">
                            <i class="fas fa-star" data-rating="1" onclick="setRating('${item.id}', 1)" style="color: #ddd; cursor: pointer; font-size: 1.5rem; margin-right: 5px;"></i>
                            <i class="fas fa-star" data-rating="2" onclick="setRating('${item.id}', 2)" style="color: #ddd; cursor: pointer; font-size: 1.5rem; margin-right: 5px;"></i>
                            <i class="fas fa-star" data-rating="3" onclick="setRating('${item.id}', 3)" style="color: #ddd; cursor: pointer; font-size: 1.5rem; margin-right: 5px;"></i>
                            <i class="fas fa-star" data-rating="4" onclick="setRating('${item.id}', 4)" style="color: #ddd; cursor: pointer; font-size: 1.5rem; margin-right: 5px;"></i>
                            <i class="fas fa-star" data-rating="5" onclick="setRating('${item.id}', 5)" style="color: #ddd; cursor: pointer; font-size: 1.5rem; margin-right: 5px;"></i>
                            </div>`;
                    } else if (item.type === 'text') {
                        html += `<textarea id="${item.id}" placeholder="Enter your response..." 
                            onchange="handleChecklistChange('${item.id}', this.value)"
                            style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>`;
                    } else if (item.type === 'photo') {
                        html += `<div style="display: flex; gap: 10px; align-items: center;">
                            <input type="file" id="${item.id}" accept="image/*" capture="environment" onchange="handlePhotoUpload('${item.id}', this)" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('${item.id}').click()">
                                <i class="fas fa-camera"></i> Take/Select Photo
                            </button>
                            <div id="${item.id}-preview" style="margin-left: 10px;"></div>
                            </div>`;
                    } else if (item.type === 'date') {
                        html += `<input type="date" id="${item.id}" 
                            onchange="handleChecklistChange('${item.id}', this.value)"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">`;
                    }
                    html += `</div>`;
                });
                html += `</div></div>`;
            });
            
            content.innerHTML = html;
            
            // Auto-populate date/time if not already set
            const dateInput = document.getElementById('checklistDate');
            if (dateInput && !dateInput.value) {
                dateInput.value = getCurrentDateTime();
            }
            
            loadChecklistData();
        }
        
        // Handle checklist data changes
        function handleChecklistChange(itemId, value) {
            if (!checklistData[currentChecklist]) {
                checklistData[currentChecklist] = {};
            }
            checklistData[currentChecklist][itemId] = value;
            
            // Update global reference
            window.checklistData = checklistData;
            
            saveChecklistData();
        }
        
        // Set star rating
        function setRating(itemId, rating) {
            const stars = document.querySelectorAll(`[data-item-id="${itemId}"] .fas`);
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#ffd700';
                } else {
                    star.style.color = '#ddd';
                }
            });
            handleChecklistChange(itemId, rating);
        }
        
        // Handle photo upload with compression
        function handlePhotoUpload(itemId, input) {
            console.log('Photo upload started for item:', itemId);
            const file = input.files[0];
            if (file) {
                console.log('File selected:', file.name, 'Type:', file.type, 'Size:', file.size);
                
                // Compress image before storing
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        console.log('Image loaded:', img.width, 'x', img.height);
                        
                        // Create canvas for compression
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set max dimensions
                        const maxWidth = 800;
                        const maxHeight = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (maxWidth / width) * height;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (maxHeight / height) * width;
                                height = maxHeight;
                            }
                        }
                        
                        // Set canvas dimensions and draw resized image
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to compressed JPEG
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        console.log('Compressed image size:', compressedDataUrl.length, 'characters');
                        
                        // Store compressed image
                        if (!checklistPhotos[currentChecklist]) {
                            checklistPhotos[currentChecklist] = {};
                        }
                        checklistPhotos[currentChecklist][itemId] = compressedDataUrl;
                        
                        // Also store in checklistData for compatibility
                        if (!checklistData[currentChecklist]) {
                            checklistData[currentChecklist] = {};
                        }
                        checklistData[currentChecklist][itemId] = compressedDataUrl;
                        
                        // Update global references
                        window.checklistPhotos = checklistPhotos;
                        window.checklistData = checklistData;
                        
                        console.log('Photo stored for checklist:', currentChecklist, 'item:', itemId);
                        console.log('Current photos in checklist:', Object.keys(checklistPhotos[currentChecklist]));
                        console.log('Global window.checklistPhotos updated:', window.checklistPhotos);
                        
                        // Show preview
                        const preview = document.getElementById(`${itemId}-preview`);
                        if (preview) {
                            preview.innerHTML = `<img src="${compressedDataUrl}" alt="Preview" 
                                style="max-width: 100px; max-height: 100px; border-radius: 5px; border: 1px solid #ddd;">`;
                        }
                        
                        saveChecklistData();
                    };
                    img.onerror = function() {
                        console.error('Failed to load image');
                        showError('Failed to load image. Please try again.');
                    };
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    console.error('Failed to read file');
                    showError('Failed to read file. Please try again.');
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Save and load checklist data
        function saveChecklistData() {
            try {
                // Save main checklist data without photos
                const data = {
                    store: document.getElementById('checklistStore').value,
                    manager: document.getElementById('checklistManager').value,
                    checklistDate: document.getElementById('checklistDate').value,
                    checklistData,
                    lastSaved: new Date().toISOString()
                };
                const checklistKey = getLocationStorageKey('checklist', currentUser.email);
                
                // Try to save main data first
                try {
                    localStorage.setItem(checklistKey, JSON.stringify(data));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        console.warn('Storage quota exceeded, clearing old checklist data...');
                        // Clear old checklist data
                        const keys = Object.keys(localStorage);
                        keys.forEach(key => {
                            if (key.includes('checklist_') && key.includes('photo_')) {
                                localStorage.removeItem(key);
                            }
                        });
                        // Try again
                        localStorage.setItem(checklistKey, JSON.stringify(data));
                    }
                }
                
                // Save photos separately with compression
                if (checklistPhotos[currentChecklist]) {
                    Object.keys(checklistPhotos[currentChecklist]).forEach(photoId => {
                        const photoKey = `${checklistKey}_photo_${currentChecklist}_${photoId}`;
                        try {
                            localStorage.setItem(photoKey, checklistPhotos[currentChecklist][photoId]);
                        } catch (e) {
                            if (e.name === 'QuotaExceededError') {
                                console.warn(`Cannot save photo ${photoId} - storage full`);
                                // Don't throw error, just skip this photo
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error saving checklist data:', error);
                showError('Unable to save checklist data. Storage may be full.');
            }
        }
        
        function loadChecklistData() {
            const checklistKey = getLocationStorageKey('checklist', currentUser.email);
            const stored = localStorage.getItem(checklistKey);
            if (stored) {
                const data = JSON.parse(stored);
                
                document.getElementById('checklistStore').value = data.store || '';
                document.getElementById('checklistManager').value = data.manager || '';
                document.getElementById('checklistDate').value = data.checklistDate || getCurrentDateTime();
                
                checklistData = data.checklistData || {};
                checklistPhotos = {}; // Initialize empty
                
                // Update global references
                window.checklistData = checklistData;
                window.checklistPhotos = checklistPhotos;
                
                // Load photos separately
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith(`${checklistKey}_photo_`)) {
                        const parts = key.split('_photo_');
                        if (parts.length === 2) {
                            const [, photoInfo] = parts;
                            const [checklistType, photoId] = photoInfo.split('_');
                            if (!checklistPhotos[checklistType]) {
                                checklistPhotos[checklistType] = {};
                            }
                            checklistPhotos[checklistType][photoId] = localStorage.getItem(key);
                        }
                    }
                });
                
                // Update global reference after loading all photos
                window.checklistPhotos = checklistPhotos;
                
                // Restore form values
                if (checklistData[currentChecklist]) {
                    Object.keys(checklistData[currentChecklist]).forEach(itemId => {
                        const value = checklistData[currentChecklist][itemId];
                        
                        // Handle regular checkboxes
                        const checkboxElement = document.getElementById(itemId);
                        if (checkboxElement && checkboxElement.type === 'checkbox') {
                            checkboxElement.checked = value;
                        }
                        
                        // Handle radio buttons (Pass/Needs Work/Fail)
                        const radioElements = document.querySelectorAll(`input[name="${itemId}"]`);
                        if (radioElements.length > 0) {
                            radioElements.forEach(radio => {
                                if (radio.value === value) {
                                    radio.checked = true;
                                }
                            });
                        }
                        
                        // Handle textareas
                        const textElement = document.getElementById(itemId);
                        if (textElement && textElement.tagName === 'TEXTAREA') {
                            textElement.value = value;
                        }
                    });
                }
                
                // Restore photo previews
                if (checklistPhotos[currentChecklist]) {
                    Object.keys(checklistPhotos[currentChecklist]).forEach(itemId => {
                        const preview = document.getElementById(`${itemId}-preview`);
                        if (preview) {
                            preview.innerHTML = `<img src="${checklistPhotos[currentChecklist][itemId]}" alt="Preview" 
                                style="max-width: 100px; max-height: 100px; border-radius: 5px; border: 1px solid #ddd;">`;
                        }
                    });
                }
            }
        }
        
        // Checklist action functions
        function saveChecklist() {
            saveChecklistData();
            showSuccess('Checklist progress saved successfully!');
        }
        
        function clearChecklist() {
            if (confirm('Are you sure you want to clear all checklist data? This cannot be undone.')) {
                checklistData = {};
                checklistPhotos = {};
                
                // Get the proper storage key
                const checklistKey = getLocationStorageKey('checklist', currentUser.email);
                
                // Remove main checklist data
                localStorage.removeItem(checklistKey);
                
                // Remove all photos for this checklist
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith(`${checklistKey}_photo_`)) {
                        localStorage.removeItem(key);
                    }
                });
                
                document.getElementById('checklistStore').value = '';
                document.getElementById('checklistManager').value = '';
                document.getElementById('checklistDate').value = getCurrentDateTime();
                
                renderChecklistContent();
                showSuccess('Checklist cleared successfully!');
            }
        }
        
        // Generate PDF of checklist
        function generatePDF() {
            const store = document.getElementById('checklistStore').value;
            const manager = document.getElementById('checklistManager').value;
            const checklistDateTime = document.getElementById('checklistDate').value;
            
            if (!store || !manager) {
                showError('Please fill in store location and manager name before generating PDF.');
                return;
            }
            
            // Format the date/time for display
            let formattedDateTime = 'Not specified';
            if (checklistDateTime) {
                const dateObj = new Date(checklistDateTime);
                formattedDateTime = dateObj.toLocaleString();
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set up PDF - use new checklist system if available
            const checklist = (window.checklistsNew && window.checklistsNew[currentChecklist]) ? 
                             window.checklistsNew[currentChecklist] : 
                             checklists[currentChecklist];
            let yPosition = 20;
            
            // Header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(checklist.title, 20, yPosition);
            yPosition += 10;
            
            // Store info
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Store: ${store}`, 20, yPosition);
            yPosition += 7;
            doc.text(`Manager: ${manager}`, 20, yPosition);
            yPosition += 7;
            doc.text(`Completed: ${formattedDateTime}`, 20, yPosition);
            yPosition += 7;
            doc.text(`From: reportautomation12@gmail.com`, 20, yPosition);
            yPosition += 15;
            
            // Sections
            checklist.sections.forEach(section => {
                // Section header
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(section.title, 20, yPosition);
                yPosition += 10;
                
                // Items
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                section.items.forEach(item => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    const value = checklistData[currentChecklist] ? checklistData[currentChecklist][item.id] : null;
                    let status = '';
                    
                    if (item.type === 'checkbox') {
                        if (currentChecklist === 'weekly' || currentChecklist === 'monthly') {
                            if (value === 'pass') status = '✓ PASS';
                            else if (value === 'needs-work') status = '⚠ NEEDS WORK';
                            else if (value === 'fail') status = '✗ FAIL';
                            else status = 'Not assessed';
                        } else {
                            status = value ? '✓' : '✗';
                        }
                    } else if (item.type === 'rating') {
                        status = `${value || 0}/5 stars`;
                    } else if (item.type === 'text') {
                        status = value || 'Not filled';
                    } else if (item.type === 'photo') {
                        const hasPhoto = checklistPhotos[currentChecklist] && checklistPhotos[currentChecklist][item.id];
                        status = hasPhoto ? 'Photo attached' : 'No photo';
                        
                        // Log photo status for debugging
                        console.log(`Photo item ${item.id}: hasPhoto=${hasPhoto}, currentChecklist=${currentChecklist}`);
                        if (checklistPhotos[currentChecklist]) {
                            console.log('Available photo IDs in checklistPhotos:', Object.keys(checklistPhotos[currentChecklist]));
                        }
                        // Also check in checklistData
                        const photoInData = checklistData[currentChecklist] && checklistData[currentChecklist][item.id];
                        if (photoInData && typeof photoInData === 'string' && photoInData.startsWith('data:image')) {
                            console.log('Found photo in checklistData for item:', item.id);
                            if (!hasPhoto) {
                                // Use photo from checklistData if not in checklistPhotos
                                hasPhoto = true;
                                if (!checklistPhotos[currentChecklist]) {
                                    checklistPhotos[currentChecklist] = {};
                                }
                                checklistPhotos[currentChecklist][item.id] = photoInData;
                            }
                        }
                        
                        // Add photo to PDF if available
                        if (hasPhoto) {
                            try {
                                const imgData = checklistPhotos[currentChecklist][item.id];
                                console.log('Adding photo for item:', item.id, 'Data length:', imgData?.length);
                                
                                // First, add the text label
                                const text = `${item.label}: ${status}`;
                                const splitText = doc.splitTextToSize(text, 170);
                                doc.text(splitText, 25, yPosition);
                                yPosition += (splitText.length * 5) + 5;
                                
                                // Check if we need a new page for the photo
                                if (yPosition > 200) {
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                
                                // Determine image format from base64 data
                                let format = 'JPEG';
                                if (imgData.includes('data:image/png')) {
                                    format = 'PNG';
                                } else if (imgData.includes('data:image/gif')) {
                                    format = 'GIF';
                                }
                                
                                // Add image directly to PDF with larger size
                                const maxWidth = 100;
                                const maxHeight = 75;
                                
                                try {
                                    // Try adding as JPEG first (since photos are compressed to JPEG)
                                    doc.addImage(imgData, 'JPEG', 30, yPosition, maxWidth, maxHeight);
                                    console.log('Photo added successfully as JPEG');
                                } catch (jpegError) {
                                    // If JPEG fails, try with detected format
                                    console.log('JPEG failed, trying format:', format);
                                    doc.addImage(imgData, format, 30, yPosition, maxWidth, maxHeight);
                                    console.log('Photo added successfully as', format);
                                }
                                
                                yPosition += maxHeight + 10; // Add space after photo
                                
                                // Continue to next item, don't add text again
                                return;
                            } catch (e) {
                                console.error('Error adding image to PDF:', e);
                                status += ' (Error: ' + e.message + ')';
                            }
                        }
                    }
                    
                    // Split long text
                    const text = `${item.label}: ${status}`;
                    const splitText = doc.splitTextToSize(text, 170);
                    doc.text(splitText, 25, yPosition);
                    yPosition += (splitText.length * 5) + 2;
                });
                
                yPosition += 5;
            });
            
            // Only save PDF if not being called from submitChecklist
            const fileName = `${checklist.title.replace(/[^a-z0-9]/gi, '_')}_${store.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            
            // Check if being called directly (not from submitChecklist)
            if (arguments[0] !== 'no-download') {
                doc.save(fileName);
                showSuccess('PDF generated and downloaded!');
            }
            
            return doc;
        }
        
        // Universal submit function that works on all devices
        async function submitChecklist() {
            console.log('Submit checklist called');
            const store = document.getElementById('checklistStore').value;
            const manager = document.getElementById('checklistManager').value;
            
            if (!store || !manager) {
                showError('Please fill in store location and manager name before submitting.');
                return;
            }
            
            try {
                // Show loading state
                showSuccess('Submitting to Basecamp...');
                
                // Save checklist data first
                saveChecklistData();
                
                // Generate report content
                const checklist = checklists[currentChecklist];
                const checklistDateTime = document.getElementById('checklistDate').value;
                let formattedDateTime = checklistDateTime ? new Date(checklistDateTime).toLocaleString() : new Date().toLocaleString();
                
                // Create PDF filename
                const pdfFilename = `${currentChecklist}_${store.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Generate detailed email body with checklist results
                let emailBody = `${checklist.title} - Checklist Submission\n`;
                emailBody += `${'='.repeat(50)}\n\n`;
                emailBody += `Store: ${store}\n`;
                emailBody += `Manager: ${manager}\n`;
                emailBody += `Date/Time: ${formattedDateTime}\n`;
                emailBody += `${'='.repeat(50)}\n\n`;
                
                // Calculate completion stats
                let totalItems = 0;
                let completedItems = 0;
                
                // Add checklist results
                emailBody += `CHECKLIST RESULTS:\n\n`;
                checklist.sections.forEach(section => {
                    emailBody += `[${section.title.toUpperCase()}]\n`;
                    
                    section.items.forEach(item => {
                        const value = checklistData[currentChecklist] ? checklistData[currentChecklist][item.id] : null;
                        totalItems++;
                        
                        if (item.type === 'checkbox') {
                            if (currentChecklist === 'weekly' || currentChecklist === 'monthly') {
                                if (value === 'pass') {
                                    emailBody += `✓ ${item.label}: PASS\n`;
                                    completedItems++;
                                } else if (value === 'needs-work') {
                                    emailBody += `⚠ ${item.label}: NEEDS WORK\n`;
                                    completedItems++;
                                } else if (value === 'fail') {
                                    emailBody += `✗ ${item.label}: FAIL\n`;
                                    completedItems++;
                                } else {
                                    emailBody += `○ ${item.label}: Not checked\n`;
                                }
                            } else {
                                if (value === true) {
                                    emailBody += `✓ ${item.label}: Complete\n`;
                                    completedItems++;
                                } else {
                                    emailBody += `○ ${item.label}: Not complete\n`;
                                }
                            }
                        } else if (item.type === 'rating') {
                            if (value) {
                                emailBody += `★ ${item.label}: ${value}/5 stars\n`;
                                completedItems++;
                            } else {
                                emailBody += `☆ ${item.label}: Not rated\n`;
                            }
                        } else if (item.type === 'text') {
                            if (value && value.trim()) {
                                emailBody += `📝 ${item.label}: ${value}\n`;
                                completedItems++;
                            } else {
                                emailBody += `📝 ${item.label}: No response\n`;
                            }
                        } else if (item.type === 'photo') {
                            const photos = checklistPhotos[currentChecklist] && checklistPhotos[currentChecklist][item.id];
                            if (photos && photos.length > 0) {
                                emailBody += `📷 ${item.label}: ${photos.length} photo(s) attached\n`;
                                completedItems++;
                            } else {
                                emailBody += `📷 ${item.label}: No photos\n`;
                            }
                        }
                    });
                    emailBody += `\n`;
                });
                
                const completionRate = Math.round((completedItems / totalItems) * 100);
                emailBody += `${'='.repeat(50)}\n`;
                emailBody += `SUMMARY:\n`;
                emailBody += `Total Items: ${totalItems}\n`;
                emailBody += `Completed Items: ${completedItems}\n`;
                emailBody += `Completion Rate: ${completionRate}%\n\n`;
                emailBody += `${'='.repeat(50)}\n`;
                emailBody += `[PDF_URL_PLACEHOLDER]\n`;
                emailBody += `${'='.repeat(50)}\n\n`;
                emailBody += `Generated by Couchman Companies QSR Navigator`;
                
                // Generate PDF first to get base64 (without downloading)
                const doc = generatePDF('no-download');
                const pdfBase64 = doc.output('datauristring').split(',')[1];
                
                // Upload PDF to get permanent URL
                let pdfUrl = '';
                try {
                    const uploadResponse = await fetch('/.netlify/functions/store-pdf', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: pdfFilename,
                            pdfData: pdfBase64
                        })
                    });
                    
                    if (uploadResponse.ok) {
                        const uploadResult = await uploadResponse.json();
                        pdfUrl = uploadResult.url;
                        console.log('PDF uploaded successfully:', pdfUrl);
                        
                        // Update email body with actual PDF URL - format it properly
                        // Add line breaks and make it more prominent
                        const pdfLinkText = `\n\nPDF REPORT DOWNLOAD LINK:\n${pdfUrl}\n\nClick the link above to download the full PDF report.\n\n`;
                        emailBody = emailBody.replace('[PDF_URL_PLACEHOLDER]\n', pdfLinkText);
                    }
                } catch (error) {
                    console.error('PDF upload error:', error);
                    // Continue without PDF URL if upload fails
                    emailBody = emailBody.replace('[PDF_URL_PLACEHOLDER]', 'PDF generation failed - please contact support');
                }
                
                // Create subject line
                const subject = `[COMPLETED] ${checklist.title} - ${store} - ${new Date().toLocaleDateString()}`;
                
                // Submit to Netlify Forms using URL-encoded format for better compatibility
                const formData = new URLSearchParams({
                    'form-name': 'checklist-email',
                    'to': 'save-jSnJTgoL5CnR@3.basecamp.com',
                    'subject': subject,
                    'message': emailBody,
                    'store': store,
                    'manager': manager,
                    'datetime': formattedDateTime,
                    'pdf-report': pdfUrl || 'Not available',
                    'completion-rate': completionRate.toString()
                });
                
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData.toString()
                });
                
                if (response.ok) {
                    // Clear photos from memory AFTER PDF generation
                    if (checklistPhotos[currentChecklist]) {
                        delete checklistPhotos[currentChecklist];
                    }
                    
                    alert('✅ CHECKLIST SUBMITTED SUCCESSFULLY!\n\n📧 Report sent to: save-jSnJTgoL5CnR@3.basecamp.com\n📄 PDF link included in email\n\nThe form has been reset and is ready for the next submission.');
                    
                    // Reset the form
                    resetChecklistForm();
                } else {
                    throw new Error('Form submission failed');
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                showError('Error submitting checklist. Please try again.');
            }
        }
        
        // Keep old function for backward compatibility
        async function submitChecklistOld() {
            const store = document.getElementById('checklistStore').value;
            const manager = document.getElementById('checklistManager').value;
            
            if (!store || !manager) {
                alert('Please fill in store location and manager name before submitting.');
                return;
            }
            
            try {
                // Save checklist data first
                saveChecklistData();
                
                // Generate report content
                const checklist = checklists[currentChecklist];
                const checklistDateTime = document.getElementById('checklistDate').value;
                let formattedDateTime = checklistDateTime ? new Date(checklistDateTime).toLocaleString() : new Date().toLocaleString();
                
                // Generate detailed email body
                let report = `${checklist.title}\n`;
                report += `${'='.repeat(50)}\n\n`;
                report += `SUBMISSION DETAILS:\n`;
                report += `Store: ${store}\n`;
                report += `Manager: ${manager}\n`;
                report += `Completed: ${formattedDateTime}\n`;
                report += `${'='.repeat(50)}\n\n`;
                
                // Calculate completion stats
                let totalItems = 0;
                let completedItems = 0;
                let photosIncluded = 0;
                
                // Add detailed checklist results
                report += `CHECKLIST RESULTS:\n\n`;
                checklist.sections.forEach(section => {
                    report += `[${section.title.toUpperCase()}]\n`;
                    report += `${'-'.repeat(section.title.length + 2)}\n`;
                    
                    section.items.forEach(item => {
                        const value = checklistData[currentChecklist] ? checklistData[currentChecklist][item.id] : null;
                        totalItems++;
                        
                        if (item.type === 'checkbox') {
                            if (currentChecklist === 'weekly' || currentChecklist === 'monthly') {
                                if (value === 'pass') {
                                    report += `✓ ${item.label}: PASS\n`;
                                    completedItems++;
                                } else if (value === 'needs-work') {
                                    report += `⚠ ${item.label}: NEEDS WORK\n`;
                                    completedItems++;
                                } else if (value === 'fail') {
                                    report += `✗ ${item.label}: FAIL\n`;
                                    completedItems++;
                                } else {
                                    report += `○ ${item.label}: NOT ASSESSED\n`;
                                }
                            } else {
                                report += `${value ? '✓' : '✗'} ${item.label}\n`;
                                if (value) completedItems++;
                            }
                        } else if (item.type === 'rating') {
                            report += `★ ${item.label}: ${value || 0}/5 stars\n`;
                            if (value) completedItems++;
                        } else if (item.type === 'text') {
                            report += `📝 ${item.label}: ${value || 'Not filled'}\n`;
                            if (value) completedItems++;
                        } else if (item.type === 'photo') {
                            const hasPhoto = checklistPhotos[currentChecklist] && checklistPhotos[currentChecklist][item.id];
                            report += `📷 ${item.label}: ${hasPhoto ? 'PHOTO TAKEN' : 'No photo'}\n`;
                            if (hasPhoto) {
                                completedItems++;
                                photosIncluded++;
                            }
                        }
                    });
                    report += '\n';
                });
                
                // Add summary statistics
                const completionRate = Math.round((completedItems / totalItems) * 100);
                report += `${'='.repeat(50)}\n`;
                report += `SUMMARY STATISTICS:\n`;
                report += `Total Items: ${totalItems}\n`;
                report += `Completed Items: ${completedItems}\n`;
                report += `Completion Rate: ${completionRate}%\n`;
                report += `Photos Included: ${photosIncluded}\n`;
                report += `${'='.repeat(50)}\n\n`;
                
                // Generate PDF filename with timestamp to ensure uniqueness
                const timestamp = Date.now();
                const pdfFilename = `${currentChecklist}_${store.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}_${timestamp}.pdf`;
                
                report += `PDF Report: ${pdfFilename}\n`;
                report += `\nNOTE: The PDF with photos has been saved locally on the device.\n`;
                report += `To share: The submitter should upload the PDF to Basecamp.\n\n`;
                report += `Generated by Couchman Companies QSR Navigator`;
                
                const subject = `[COMPLETED] ${checklist.title} - ${store} - ${new Date().toLocaleDateString()}`;
                
                // Generate PDF first to get base64
                const doc = generatePDF();
                const pdfBase64 = doc.output('datauristring').split(',')[1];
                
                // Try to upload PDF and get URL
                let pdfUrl = '';
                try {
                    const uploadResponse = await fetch('/.netlify/functions/store-pdf', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: pdfFilename,
                            pdfData: pdfBase64
                        })
                    });
                    
                    if (uploadResponse.ok) {
                        const uploadResult = await uploadResponse.json();
                        pdfUrl = uploadResult.url;
                        console.log('PDF URL:', pdfUrl);
                    }
                } catch (error) {
                    console.error('PDF upload error:', error);
                }
                
                // Submit to Netlify Forms with all fields including PDF URL
                const formData = new FormData();
                formData.append('form-name', 'checklist-email');
                formData.append('to', 'save-jSnJTgoL5CnR@3.basecamp.com');
                formData.append('subject', subject);
                formData.append('message', report);
                formData.append('store', store);
                formData.append('manager', manager);
                formData.append('datetime', formattedDateTime);
                
                // Add PDF report field if we have a URL
                if (pdfUrl) {
                    formData.append('pdf-report', pdfUrl);
                }
                
                // Add completion rate (already calculated above)
                formData.append('completion-rate', completionRate.toString());
                
                console.log('Submitting form to Netlify...');
                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    // Download PDF locally after successful submission
                    doc.save(pdfFilename);
                    
                    // Clear photos from memory AFTER PDF generation
                    if (checklistPhotos[currentChecklist]) {
                        delete checklistPhotos[currentChecklist];
                    }
                    
                    alert('✅ CHECKLIST SUBMITTED SUCCESSFULLY!\n\n📧 Report sent to: save-jSnJTgoL5CnR@3.basecamp.com\n📄 PDF downloaded to your device\n\n⚠️ IMPORTANT: Please attach the PDF to the Basecamp task.');
                    
                    // Reset the form
                    resetChecklistForm();
                } else {
                    throw new Error('Form submission failed');
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                alert('⚠️ Error submitting checklist. Please try again or contact support.');
            }
        }

        // Complete checklist and auto-email with PDF (keeping for backward compatibility)
        async function completeChecklistAndEmail() {
            console.log('completeChecklistAndEmail called');
            
            const store = document.getElementById('checklistStore').value;
            const manager = document.getElementById('checklistManager').value;
            
            console.log('Store:', store, 'Manager:', manager);
            
            if (!store || !manager) {
                console.log('Missing store or manager');
                alert('Please fill in store location and manager name before completing checklist.');
                return;
            }
            
            try {
                // Mark checklist as completed
                const completionTime = new Date().toISOString();
                
                // Update checklist data with completion info
                if (!checklistData[currentChecklist]) {
                    checklistData[currentChecklist] = {};
                }
                checklistData[currentChecklist]['_completed'] = true;
                checklistData[currentChecklist]['_completedAt'] = completionTime;
                checklistData[currentChecklist]['_completedBy'] = manager;
                
                console.log('Saving checklist data...');
                // Save the completion
                saveChecklistData();
                
                console.log('Generating PDF...');
                // Generate PDF
                const doc = generatePDF();
                
                // Get PDF as base64
                const pdfBase64 = doc.output('datauristring').split(',')[1];
                const pdfFilename = `${currentChecklist}_${store}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Save PDF locally
                doc.save(pdfFilename);
                
                console.log('Sending email via Netlify Forms...');
                // Send email via Netlify Forms
                await sendChecklistEmail(store, manager, pdfBase64, pdfFilename);
                
            } catch (error) {
                console.error('Error in completeChecklistAndEmail:', error);
                alert('Error completing checklist: ' + error.message);
            }
        }
        
        
        function sendEmailDirectly(store, manager, formattedDateTime, checklist) {
            // Generate comprehensive report
            let report = `${checklist.title}\n`;
            report += `Store: ${store}\n`;
            report += `Manager: ${manager}\n`;
            report += `Completed: ${formattedDateTime}\n`;
            report += `From: reportautomation12@gmail.com\n\n`;
            report += `*** PDF REPORT ATTACHED ***\n\n`;
            report += `This checklist has been completed and the detailed PDF report is attached to this email.\n\n`;
            
            // Add summary
            let totalItems = 0;
            let completedItems = 0;
            let passedItems = 0;
            let failedItems = 0;
            
            checklist.sections.forEach(section => {
                section.items.forEach(item => {
                    const value = checklistData[currentChecklist] ? checklistData[currentChecklist][item.id] : null;
                    totalItems++;
                    
                    if (item.type === 'checkbox') {
                        if (currentChecklist === 'weekly' || currentChecklist === 'monthly') {
                            if (value === 'pass') { completedItems++; passedItems++; }
                            else if (value === 'needs-work') completedItems++;
                            else if (value === 'fail') { completedItems++; failedItems++; }
                        } else {
                            if (value) completedItems++;
                        }
                    } else if (item.type === 'rating' || item.type === 'text' || item.type === 'photo') {
                        if (value) completedItems++;
                    }
                });
            });
            
            report += `SUMMARY:\n`;
            report += `Total Items: ${totalItems}\n`;
            report += `Completed Items: ${completedItems}\n`;
            if (currentChecklist === 'weekly' || currentChecklist === 'monthly') {
                report += `Passed Items: ${passedItems}\n`;
                report += `Failed Items: ${failedItems}\n`;
            }
            report += `Completion Rate: ${Math.round((completedItems/totalItems)*100)}%\n\n`;
            
            report += `Please see attached PDF for complete details including photos.\n\n`;
            report += `Generated automatically by Couchman Companies QSR Navigator Restaurant Management System`;
            
            const subject = `[COMPLETED] ${checklist.title} - ${store} - ${new Date().toLocaleDateString()}`;
            
            // Generate PDF and get base64 data
            const { jsPDF } = window.jspdf;
            const doc = generatePDF();
            const pdfBase64 = doc.output('datauristring').split(',')[1]; // Remove data:application/pdf;base64, prefix
            
            // Send email via Netlify Forms
            sendAutomaticEmail(subject, report, pdfBase64)
                .then(success => {
                    if (success) {
                        alert('✅ CHECKLIST SUBMITTED SUCCESSFULLY!\n\n📧 Email notification sent to: save-jSnJTgoL5CnR@3.basecamp.com\n📄 PDF report saved to your device\n✨ Checklist data saved to database\n\nThe submission has been forwarded via Netlify Forms.');
                        
                        // Reset the checklist after successful submission
                        resetChecklistForm();
                    } else {
                        // Show error and still try fallback
                        alert('⚠️ Submission error. Please check your internet connection and try again.');
                        setTimeout(() => fallbackToMailto(subject, report), 1000);
                    }
                })
                .catch(error => {
                    console.log('All automatic methods failed:', error);
                    alert('⚠️ Automatic email failed. Opening email client as backup...');
                    setTimeout(() => fallbackToMailto(subject, report), 1000);
                });
        }
        
        async function sendChecklistEmail(store, manager, pdfBase64, pdfFilename) {
            const checklist = checklists[currentChecklist];
            const checklistDateTime = document.getElementById('checklistDate').value;
            
            // Format the date/time for display
            let formattedDateTime = 'Not specified';
            if (checklistDateTime) {
                const dateObj = new Date(checklistDateTime);
                formattedDateTime = dateObj.toLocaleString();
            }
            
            // Generate summary for email body
            let totalItems = 0;
            let completedItems = 0;
            let passItems = 0;
            let needsWorkItems = 0;
            
            checklist.sections.forEach(section => {
                section.items.forEach(item => {
                    const value = checklistData[currentChecklist] ? checklistData[currentChecklist][item.id] : null;
                    totalItems++;
                    if (value) {
                        completedItems++;
                        if (value === 'pass') passItems++;
                        else if (value === 'needs-work') needsWorkItems++;
                    }
                });
            });
            
            const completionRate = Math.round((completedItems / totalItems) * 100);
            
            // Create Netlify form submission
            const emailBody = `${checklist.title}
Store: ${store}
Manager: ${manager}
Completed: ${formattedDateTime}

SUMMARY:
Total Items: ${totalItems}
Completed Items: ${completedItems}
${passItems > 0 || needsWorkItems > 0 ? `Passed: ${passItems}
Needs Work: ${needsWorkItems}` : ''}
Completion Rate: ${completionRate}%

Please see the attached PDF for complete checklist details.

Generated by Couchman Companies QSR Navigator`;

            // Convert base64 to blob for file upload
            const base64Response = await fetch(`data:application/pdf;base64,${pdfBase64}`);
            const pdfBlob = await base64Response.blob();
            
            // Create FormData for Netlify submission
            const formData = new FormData();
            formData.append('form-name', 'checklist-submission');
            formData.append('email', 'save-jSnJTgoL5CnR@3.basecamp.com');
            formData.append('subject', `[COMPLETED] ${checklist.title} - ${store} - ${new Date().toLocaleDateString()}`);
            formData.append('message', emailBody);
            formData.append('pdf-report', pdfBlob, pdfFilename);
            formData.append('store', store);
            formData.append('manager', manager);
            formData.append('completion-rate', completionRate);
            
            // Submit to Netlify Forms
            fetch('/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    alert(`✅ Checklist Sent Successfully!

📧 Email notification sent to: save-jSnJTgoL5CnR@3.basecamp.com
📎 PDF report included
✨ Processed via Netlify Forms

Check your Netlify dashboard for the submission!`);
                    
                    // Reset the checklist form
                    resetChecklistForm();
                } else {
                    console.error('Netlify form submission failed');
                    alert(`❌ Submission Failed

Unable to submit the checklist. Please try again.
If the problem persists, contact support.

The PDF has been downloaded for your records.`);
                }
            })
            .catch(error => {
                console.error('Error submitting to Netlify:', error);
                alert(`❌ Network Error

Unable to submit the checklist due to a network error.
Please check your internet connection and try again.

The PDF has been downloaded for your records.`);
            });
        }
        
        function resetChecklistForm() {
            console.log('Resetting checklist form...');
            
            // Clear the current checklist data
            if (checklistData[currentChecklist]) {
                delete checklistData[currentChecklist];
            }
            
            // Clear photos for current checklist
            if (checklistPhotos[currentChecklist]) {
                delete checklistPhotos[currentChecklist];
            }
            
            // Clear form inputs
            document.getElementById('checklistStore').value = '';
            document.getElementById('checklistManager').value = '';
            document.getElementById('checklistDate').value = '';
            
            // Clear all checklist items
            const checklist = checklists[currentChecklist];
            checklist.sections.forEach(section => {
                section.items.forEach(item => {
                    const element = document.getElementById(item.id);
                    if (element) {
                        if (item.type === 'checkbox') {
                            element.checked = false;
                            // Also clear any pass/fail/needs-work radio buttons
                            const passRadio = document.querySelector(`input[name="${item.id}_status"][value="pass"]`);
                            const needsWorkRadio = document.querySelector(`input[name="${item.id}_status"][value="needs-work"]`);
                            const failRadio = document.querySelector(`input[name="${item.id}_status"][value="fail"]`);
                            if (passRadio) passRadio.checked = false;
                            if (needsWorkRadio) needsWorkRadio.checked = false;
                            if (failRadio) failRadio.checked = false;
                        } else if (item.type === 'text' || item.type === 'textarea') {
                            element.value = '';
                        } else if (item.type === 'date') {
                            element.value = '';
                        } else if (item.type === 'rating') {
                            // Clear rating stars
                            const stars = document.querySelectorAll(`#${item.id}-rating .star`);
                            stars.forEach(star => star.classList.remove('active'));
                            // Clear hidden input
                            const ratingInput = document.getElementById(`${item.id}-value`);
                            if (ratingInput) ratingInput.value = '';
                        }
                    }
                });
            });
            
            // Clear any photos
            if (checklistPhotos[currentChecklist]) {
                delete checklistPhotos[currentChecklist];
            }
            
            // Clear photo displays - target the correct preview elements
            document.querySelectorAll('[id$="-preview"]').forEach(preview => {
                preview.innerHTML = '';
            });
            
            // Clear all file inputs
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.value = '';
            });
            
            // Clear photo data from localStorage
            const checklistKey = getLocationStorageKey('checklist', currentUser.email);
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith(`${checklistKey}_photo_${currentChecklist}_`)) {
                    localStorage.removeItem(key);
                }
            });
            
            // Save the cleared state
            saveChecklistData();
            
            console.log('Checklist form reset complete');
        }
        
        function sendViaFormSubmission(subject, detailedReport, pdfFilename) {
            // Create a hidden form that submits to a service
            const form = document.createElement('form');
            form.style.display = 'none';
            form.method = 'POST';
            form.action = 'https://formsubmit.co/save-jSnJTgoL5CnR@3.basecamp.com';
            
            // Add form fields
            const fields = {
                '_subject': subject,
                'message': detailedReport,
                'pdf_filename': pdfFilename,
                '_captcha': 'false',
                '_template': 'table',
                '_autoresponse': 'Thank you! Your checklist has been submitted to Basecamp.',
                '_next': window.location.href
            };
            
            Object.keys(fields).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            });
            
            // Show confirmation before sending
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; color: #2c3e50;">📧 Ready to Send Checklist Report</h2>
                    
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 5px 0; color: #155724;"><strong>To:</strong> save-jSnJTgoL5CnR@3.basecamp.com</p>
                        <p style="margin: 5px 0; color: #155724;"><strong>Subject:</strong> ${subject}</p>
                        <p style="margin: 5px 0; color: #155724;"><strong>PDF:</strong> ${pdfFilename} (download separately)</p>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #856404;"><strong>Note:</strong> The PDF has been downloaded to your computer. You'll need to attach it manually to the Basecamp task after the email is sent.</p>
                    </div>
                    
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                        <h4 style="margin: 0 0 10px 0;">Report Preview:</h4>
                        <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; margin: 0;">${detailedReport}</pre>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="document.getElementById('hiddenChecklistForm').submit(); closeEmailModal();" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-paper-plane"></i> Send Report to Basecamp
                        </button>
                        <button onclick="closeEmailModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            `;
            
            // Add form to page
            form.id = 'hiddenChecklistForm';
            document.body.appendChild(form);
            document.body.appendChild(modal);
            window.currentEmailModal = modal;
        }
        
        function showEmailSetupInstructions(subject, emailBody, pdfFilename) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; color: #2c3e50;">📧 Email Setup Instructions</h2>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #856404;">⚠️ One-Time Setup Required</h3>
                        <p style="margin: 0; color: #856404;">To enable automatic email sending, you need to set up EmailJS with your Gmail account.</p>
                    </div>
                    
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #155724;">✅ For Now: Manual Email</h3>
                        <p style="margin: 5px 0; color: #155724;"><strong>PDF Downloaded:</strong> ${pdfFilename}</p>
                        <p style="margin: 5px 0; color: #155724;"><strong>Email To:</strong> save-jSnJTgoL5CnR@3.basecamp.com</p>
                        <p style="margin: 5px 0; color: #155724;"><strong>Subject:</strong> ${subject}</p>
                    </div>
                    
                    <div style="background: #e8f4f8; border: 1px solid #bee5eb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #0c5460;">🔧 To Enable Automatic Sending:</h3>
                        <ol style="margin: 10px 0 0 20px; color: #0c5460;">
                            <li style="margin: 5px 0;">Go to <a href="https://www.emailjs.com" target="_blank">EmailJS.com</a> and create a free account</li>
                            <li style="margin: 5px 0;">Add Gmail as your email service</li>
                            <li style="margin: 5px 0;">Create an email template with these variables:
                                <ul style="margin: 5px 0 0 20px;">
                                    <li>{{to_email}} - Recipients email</li>
                                    <li>{{subject}} - Email subject</li>
                                    <li>{{message}} - Email body</li>
                                    <li>{{pdf_data}} - PDF attachment (if supported)</li>
                                </ul>
                            </li>
                            <li style="margin: 5px 0;">Get your Public Key, Service ID, and Template ID</li>
                            <li style="margin: 5px 0;">Contact your administrator to update the configuration</li>
                        </ol>
                    </div>
                    
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0;">Email Content:</h4>
                        <textarea style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-family: monospace; font-size: 12px;" readonly>${emailBody}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="copyToClipboard(\`${emailBody}\`)" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-copy"></i> Copy Email Content
                        </button>
                        <button onclick="closeEmailModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentEmailModal = modal;
        }
        
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Content copied to clipboard!');
        }
        
        async function sendAutomaticEmail(subject, body, pdfBase64) {
            try {
                // Use Netlify Forms for email notification
                const netlifyFormData = new FormData();
                netlifyFormData.append('form-name', 'checklist-email');
                netlifyFormData.append('to', 'save-jSnJTgoL5CnR@3.basecamp.com');
                netlifyFormData.append('subject', subject);
                netlifyFormData.append('message', body);
                netlifyFormData.append('store', CURRENT_USER.currentLocation || 'Not specified');
                netlifyFormData.append('manager', document.getElementById('checklistManager')?.value || 'Not specified');
                netlifyFormData.append('datetime', new Date().toISOString());
                
                const netlifyResponse = await fetch('/', {
                    method: 'POST',
                    body: netlifyFormData
                });

                if (netlifyResponse.ok) {
                    console.log('Email notification sent via Netlify Forms');
                    return true;
                } else {
                    console.error('Netlify form submission failed:', netlifyResponse.status);
                    return false;
                }
            } catch (error) {
                console.error('Email sending error:', error);
                return false;
            }
        }
        
        function createFormData(subject, body) {
            const form = document.createElement('form');
            form.style.display = 'none';
            
            const emailField = document.createElement('input');
            emailField.name = 'to_email';
            emailField.value = 'save-jSnJTgoL5CnR@3.basecamp.com';
            form.appendChild(emailField);
            
            const subjectField = document.createElement('input');
            subjectField.name = 'subject';
            subjectField.value = subject;
            form.appendChild(subjectField);
            
            const messageField = document.createElement('textarea');
            messageField.name = 'message';
            messageField.value = body;
            form.appendChild(messageField);
            
            document.body.appendChild(form);
            return form;
        }
        
        // Helper function to convert base64 to blob
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }
        
        function fallbackToMailto(subject, report) {
            // Copy report to clipboard automatically
            if (navigator.clipboard) {
                navigator.clipboard.writeText(report).then(() => {
                    console.log('Report copied to clipboard');
                }).catch(err => {
                    console.log('Could not copy to clipboard', err);
                });
            }
            
            // Auto-send email using mailto as fallback
            const mailtoLink = `mailto:save-jSnJTgoL5CnR@3.basecamp.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(report)}`;
            
            setTimeout(() => {
                window.location.href = mailtoLink;
                
                setTimeout(() => {
                    alert(`📧 Email client opened as fallback\n\n📧 To: save-jSnJTgoL5CnR@3.basecamp.com\n📎 PDF downloaded - please attach manually\n📋 Email content ready\n\nAutomatic sending unavailable, using email client instead.`);
                }, 500);
            }, 1000);
        }
        
        function generateEmailContentDisplay(store, manager, pdfFilename) {
            const checklist = checklists[currentChecklist];
            const checklistDateTime = document.getElementById('checklistDate').value;
            
            // Format the date/time for display
            let formattedDateTime = 'Not specified';
            if (checklistDateTime) {
                const dateObj = new Date(checklistDateTime);
                formattedDateTime = dateObj.toLocaleString();
            }
            
            // Generate email content
            let emailContent = `${checklist.title}\n`;
            emailContent += `Store: ${store}\n`;
            emailContent += `Manager: ${manager}\n`;
            emailContent += `Completed: ${formattedDateTime}\n`;
            emailContent += `From: reportautomation12@gmail.com\n\n`;
            emailContent += `*** PDF REPORT ATTACHED: ${pdfFilename} ***\n\n`;
            
            // Add summary
            let totalItems = 0;
            let completedItems = 0;
            
            checklist.sections.forEach(section => {
                section.items.forEach(item => {
                    const value = checklistData[currentChecklist] ? checklistData[currentChecklist][item.id] : null;
                    totalItems++;
                    if (value) completedItems++;
                });
            });
            
            const completionRate = Math.round((completedItems / totalItems) * 100);
            
            emailContent += `SUMMARY:\n`;
            emailContent += `Total Items: ${totalItems}\n`;
            emailContent += `Completed Items: ${completedItems}\n`;
            emailContent += `Completion Rate: ${completionRate}%\n\n`;
            
            // Add detailed results
            checklist.sections.forEach(section => {
                emailContent += `\n${section.title.toUpperCase()}\n`;
                emailContent += '='.repeat(section.title.length) + '\n';
                
                section.items.forEach(item => {
                    const value = checklistData[currentChecklist] ? checklistData[currentChecklist][item.id] : null;
                    
                    if (item.type === 'checkbox') {
                        emailContent += `${item.label}: ${value ? '✓ CHECKED' : '✗ NOT CHECKED'}\n`;
                    } else if (item.type === 'rating') {
                        emailContent += `${item.label}: ${value || 0}/5 stars\n`;
                    } else if (item.type === 'text' || item.type === 'date') {
                        emailContent += `${item.label}: ${value || 'Not filled'}\n`;
                    } else if (item.type === 'photo') {
                        const hasPhoto = checklistPhotos[currentChecklist] && checklistPhotos[currentChecklist][item.id];
                        emailContent += `${item.label}: ${hasPhoto ? 'Photo attached' : 'No photo'}\n`;
                    }
                });
            });
            
            emailContent += `\n\nGenerated automatically by Couchman Companies QSR Navigator Restaurant Management System`;
            
            // Create modal to display email instructions
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; color: #2c3e50;">✅ Checklist Completed Successfully!</h2>
                    
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #155724;">📄 PDF Downloaded: ${pdfFilename}</h3>
                        <p style="margin: 0; color: #155724;">The PDF report has been saved to your Downloads folder.</p>
                    </div>
                    
                    <div style="background: #e8f4f8; border: 1px solid #bee5eb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #0c5460;">📧 Email Instructions:</h3>
                        <p style="margin: 5px 0; color: #0c5460;"><strong>To:</strong> save-jSnJTgoL5CnR@3.basecamp.com</p>
                        <p style="margin: 5px 0; color: #0c5460;"><strong>Subject:</strong> [COMPLETED] ${checklist.title} - ${store} - ${new Date().toLocaleDateString()}</p>
                        <p style="margin: 5px 0; color: #0c5460;"><strong>Attachment:</strong> ${pdfFilename}</p>
                    </div>
                    
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0;">Email Content (copy this):</h4>
                        <textarea id="emailContentTextarea" style="width: 100%; height: 300px; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-family: monospace; font-size: 12px;" readonly>${emailContent}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="copyEmailContent()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-copy"></i> Copy Email Content
                        </button>
                        <button onclick="closeEmailModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentEmailModal = modal;
        }
        
        function copyEmailContent() {
            const textarea = document.getElementById('emailContentTextarea');
            textarea.select();
            document.execCommand('copy');
            alert('Email content copied to clipboard!');
        }
        
        function closeEmailModal() {
            if (window.currentEmailModal) {
                window.currentEmailModal.remove();
                window.currentEmailModal = null;
            }
            // Also remove the form if it exists
            const form = document.getElementById('hiddenChecklistForm');
            if (form) {
                form.remove();
            }
        }
        
        function showEmailDialog(store, manager, formattedDateTime, checklist) {
            let report = `${checklist.title}\n`;
            report += `Store: ${store}\n`;
            report += `Manager: ${manager}\n`;
            report += `Completed: ${formattedDateTime}\n`;
            report += `From: reportautomation12@gmail.com\n\n`;
            report += `*** PDF REPORT ATTACHED ***\n\n`;
            report += `This checklist has been completed and the detailed PDF report is attached to this email.\n\n`;
            
            // Add summary
            let totalItems = 0;
            let completedItems = 0;
            let passedItems = 0;
            let failedItems = 0;
            
            checklist.sections.forEach(section => {
                section.items.forEach(item => {
                    const value = checklistData[currentChecklist] ? checklistData[currentChecklist][item.id] : null;
                    totalItems++;
                    
                    if (item.type === 'checkbox') {
                        if (currentChecklist === 'weekly' || currentChecklist === 'monthly') {
                            if (value === 'pass') { completedItems++; passedItems++; }
                            else if (value === 'needs-work') completedItems++;
                            else if (value === 'fail') { completedItems++; failedItems++; }
                        } else {
                            if (value) completedItems++;
                        }
                    } else if (item.type === 'rating' || item.type === 'text' || item.type === 'photo') {
                        if (value) completedItems++;
                    }
                });
            });
            
            report += `SUMMARY:\n`;
            report += `Total Items: ${totalItems}\n`;
            report += `Completed Items: ${completedItems}\n`;
            if (currentChecklist === 'weekly' || currentChecklist === 'monthly') {
                report += `Passed Items: ${passedItems}\n`;
                report += `Failed Items: ${failedItems}\n`;
            }
            report += `Completion Rate: ${Math.round((completedItems/totalItems)*100)}%\n\n`;
            
            report += `Please see attached PDF for complete details.\n\n`;
            report += `Generated automatically by Couchman Companies QSR Navigator Restaurant Management System`;
            
            const subject = `[COMPLETED] ${checklist.title} - ${store} - ${new Date().toLocaleDateString()}`;
            
            // Create modal dialog
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">📧 Email Ready to Send</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>To:</strong> save-jSnJTgoL5CnR@3.basecamp.com</p>
                        <p><strong>From:</strong> jasonadams@theopt.net</p>
                        <p><strong>Subject:</strong> ${subject}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px;">Email Body:</label>
                        <textarea id="emailBody" style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 12px;">${report}</textarea>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #27ae60;">
                        <p style="margin: 0; font-size: 14px;"><strong>📎 Instructions:</strong></p>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">
                            1. Copy the email content above<br>
                            2. The PDF has been downloaded to your computer<br>
                            3. Send this email manually and attach the PDF file<br>
                            4. Or use the "Open in Email Client" button below
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="copyEmailContent()" class="btn btn-primary">
                            📋 Copy Email Content
                        </button>
                        <button onclick="openEmailClient('${encodeURIComponent(subject)}', '${encodeURIComponent(report)}')" class="btn btn-secondary">
                            📧 Open in Email Client
                        </button>
                        <button onclick="closeEmailDialog()" class="btn btn-secondary">
                            ✖️ Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentEmailModal = modal;
        }
        
        function copyEmailContent() {
            const textarea = document.getElementById('emailBody');
            textarea.select();
            document.execCommand('copy');
            alert('Email content copied to clipboard!');
        }
        
        function openEmailClient(subject, body) {
            const mailtoLink = `mailto:save-jSnJTgoL5CnR@3.basecamp.com?subject=${subject}&body=${body}`;
            window.open(mailtoLink);
        }
        
        function closeEmailDialog() {
            if (window.currentEmailModal) {
                document.body.removeChild(window.currentEmailModal);
                window.currentEmailModal = null;
            }
        }
        
        function debugPhotos() {
            console.log('=== PHOTO DEBUG INFO ===');
            console.log('Current checklist:', currentChecklist);
            console.log('All photo data:', checklistPhotos);
            console.log('Current checklist photos:', checklistPhotos[currentChecklist]);
            
            let photoCount = 0;
            let debugInfo = 'Photo Debug Info:\n\n';
            
            if (checklistPhotos[currentChecklist]) {
                Object.keys(checklistPhotos[currentChecklist]).forEach(itemId => {
                    const photoData = checklistPhotos[currentChecklist][itemId];
                    photoCount++;
                    debugInfo += `Item ID: ${itemId}\n`;
                    debugInfo += `Data Type: ${typeof photoData}\n`;
                    debugInfo += `Data Length: ${photoData ? photoData.length : 'null'}\n`;
                    debugInfo += `Starts with: ${photoData ? photoData.substring(0, 50) : 'null'}...\n\n`;
                    console.log(`Photo ${photoCount}:`, { itemId, dataType: typeof photoData, length: photoData?.length });
                });
            }
            
            debugInfo += `Total photos found: ${photoCount}`;
            alert(debugInfo);
        }

        function generateChecklistReport() {
            const store = document.getElementById('checklistStore').value;
            const manager = document.getElementById('checklistManager').value;
            const checklistDateTime = document.getElementById('checklistDate').value;
            
            if (!store || !manager) {
                showError('Please fill in store location and manager name before generating report.');
                return;
            }
            
            // Format the date/time for display
            let formattedDateTime = 'Not specified';
            if (checklistDateTime) {
                const dateObj = new Date(checklistDateTime);
                formattedDateTime = dateObj.toLocaleString();
            }
            
            const checklist = checklists[currentChecklist];
            
            let report = `${checklist.title}\n`;
            report += `Store: ${store}\n`;
            report += `Manager: ${manager}\n`;
            report += `Completed: ${formattedDateTime}\n\n`;
            
            checklist.sections.forEach(section => {
                report += `${section.title}\n`;
                report += '='.repeat(section.title.length) + '\n';
                
                section.items.forEach(item => {
                    const value = checklistData[currentChecklist] ? checklistData[currentChecklist][item.id] : null;
                    if (item.type === 'checkbox') {
                        // For weekly/monthly checklists, show Pass/Needs Work/Fail
                        if (currentChecklist === 'weekly' || currentChecklist === 'monthly') {
                            let status = 'Not assessed';
                            if (value === 'pass') status = '✓ PASS';
                            else if (value === 'needs-work') status = '⚠ NEEDS WORK';
                            else if (value === 'fail') status = '✗ FAIL';
                            report += `${item.label}: ${status}\n`;
                        } else {
                            // For opening/closing checklists, show checkmarks
                            report += `${item.label}: ${value ? '✓' : '✗'}\n`;
                        }
                    } else if (item.type === 'rating') {
                        report += `${item.label}: ${value || 0}/5 stars\n`;
                    } else if (item.type === 'text') {
                        report += `${item.label}: ${value || 'Not filled'}\n`;
                    } else if (item.type === 'photo') {
                        const hasPhoto = checklistPhotos[currentChecklist] && checklistPhotos[currentChecklist][item.id];
                        report += `${item.label}: ${hasPhoto ? 'Photo attached' : 'No photo'}\n`;
                    }
                });
                report += '\n';
            });
            
            // Hard-coded Basecamp email
            const basecampEmail = 'save-jSnJTgoL5CnR@3.basecamp.com';
            const subject = encodeURIComponent(`${checklist.title} - ${store} - ${new Date().toLocaleDateString()}`);
            const body = encodeURIComponent(report);
            
            // Create a proper mailto link
            const mailtoLink = `mailto:${basecampEmail}?subject=${subject}&body=${body}`;
            
            console.log('Generating email to:', basecampEmail);
            console.log('Subject:', decodeURIComponent(subject));
            console.log('Mailto link:', mailtoLink);
            
            // Create a temporary link and click it
            const tempLink = document.createElement('a');
            tempLink.href = mailtoLink;
            tempLink.style.display = 'none';
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
            
            showSuccess(`Email report generated for ${basecampEmail}! Your email client should open.`);
            
            // Also provide copy to clipboard as backup
            setTimeout(() => {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(report).then(() => {
                        console.log('Report also copied to clipboard as backup');
                    });
                }
            }, 1000);
        }

        // Initialize app after scripts are loaded
        // Wait for rolepermissions.js to be loaded
        function waitForRolePermissions() {
            if (typeof getSecurityCodeForRole !== 'undefined') {
                initApp();
            } else {
                setTimeout(waitForRolePermissions, 100);
            }
        }
        waitForRolePermissions();
        
        // Ticket System Integration
        (function() {
            // API key provided by the user
            const API_KEY = "k8GwKS2nQEiNsAWq70Bq";

            // IMPORTANT: The Freshdesk API endpoint for creating a ticket
            const API_ENDPOINT = "https://optmanagementservices.freshdesk.com/api/v2/tickets";

            // Wait for DOM to be ready
            function initTicketSystem() {
                // Get DOM elements
                const createTicketBtn = document.getElementById('createTicketBtn');
                const ticketModal = document.getElementById('ticketModal');
                const closeModalBtn = document.getElementById('closeModalBtn');
                const ticketForm = document.getElementById('ticketForm');
                const submitButton = document.getElementById('submitButton');
                const messageArea = document.getElementById('messageArea');

                if (!createTicketBtn || !ticketModal) {
                    console.log('Ticket system elements not found, retrying...');
                    setTimeout(initTicketSystem, 500);
                    return;
                }

                // Modal functionality
                createTicketBtn.addEventListener('click', () => {
                    ticketModal.style.display = 'block';
                    // Pre-fill email if user is logged in
                    const userEmailField = document.getElementById('userEmail');
                    if (currentUser && currentUser.email && userEmailField) {
                        userEmailField.value = currentUser.email;
                    }
                });

                closeModalBtn.addEventListener('click', () => {
                    ticketModal.style.display = 'none';
                    ticketForm.reset();
                    messageArea.innerHTML = '';
                });

                // Close modal when clicking outside
                window.addEventListener('click', (event) => {
                    if (event.target === ticketModal) {
                        ticketModal.style.display = 'none';
                        ticketForm.reset();
                        messageArea.innerHTML = '';
                    }
                });

                // Form submission logic
                ticketForm.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    const userEmail = document.getElementById('userEmail').value.trim();
                    const ticketSubject = document.getElementById('ticketSubject').value.trim();
                    const department = document.getElementById('ticketDepartment').value;
                    const description = document.getElementById('ticketDescription').value.trim();
                    const attachment = document.getElementById('ticketAttachment').files[0];

                    if (!userEmail || !ticketSubject || !department || !description) {
                        displayTicketMessage("Please fill out all required fields.", true);
                        return;
                    }
                    
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

                    try {
                        const formData = new FormData();
                        formData.append('email', userEmail);
                        formData.append('subject', ticketSubject);
                        formData.append('description', `Department: ${department}\n\n${description}`);
                        formData.append('status', 2); // Open
                        formData.append('priority', 1); // Low
                        formData.append('tags[]', department);

                        if (attachment) {
                            formData.append('attachments[]', attachment);
                        }

                        const response = await fetch(API_ENDPOINT, {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Basic ' + btoa(API_KEY + ':X')
                            },
                            body: formData
                        });

                        if (response.ok) {
                            const data = await response.json();
                            displayTicketMessage(`Ticket created successfully! Ticket ID: ${data.id}`);
                            ticketForm.reset();
                            setTimeout(() => {
                                ticketModal.style.display = 'none';
                                messageArea.innerHTML = '';
                            }, 3000);
                        } else {
                            const errorData = await response.json();
                            displayTicketMessage(`Error creating ticket: ${errorData.errors ? errorData.errors.map(err => err.message).join(', ') : 'Unknown error'}`, true);
                        }
                    } catch (error) {
                        displayTicketMessage("A network error occurred. Please try again.", true);
                        console.error("Fetch error:", error);
                    } finally {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Create Ticket';
                    }
                });

                function displayTicketMessage(text, isError = false) {
                    messageArea.innerHTML = '';
                    const message = document.createElement('div');
                    message.textContent = text;
                    message.className = `alert ${isError ? 'alert-danger' : 'alert-success'}`;
                    message.style.cssText = `padding: 10px; border-radius: 4px; margin-top: 10px; ${isError ? 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;' : 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;'}`;
                    messageArea.appendChild(message);
                }
            }

            // Initialize ticket system when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initTicketSystem);
            } else {
                initTicketSystem();
            }
        })();
        
        // Update checklist tabs based on brand/location
        function updateChecklistTabs() {
            const tabsContainer = document.getElementById('checklistTabs');
            if (!tabsContainer) return;
            
            const currentBrand = getCurrentBrand();
            const currentLocation = getCurrentLocation();
            
            console.log('updateChecklistTabs - Brand:', currentBrand, 'Location:', currentLocation);
            
            // Check if Field Manager tab should be shown
            const showFieldManager = currentBrand === 'Office Administration' && currentLocation === 'Office';
            console.log('Show Field Manager tab?', showFieldManager);
            
            // Check if Field Manager tab already exists
            let fieldManagerTab = tabsContainer.querySelector('[data-checklist="fieldmanager"]');
            
            if (showFieldManager && !fieldManagerTab) {
                // Add Field Manager tab
                const fieldManagerButton = document.createElement('button');
                fieldManagerButton.className = 'tab';
                fieldManagerButton.setAttribute('data-checklist', 'fieldmanager');
                fieldManagerButton.innerHTML = '<i class="fas fa-user-tie"></i> Field Manager';
                fieldManagerButton.addEventListener('click', () => {
                    switchChecklist('fieldmanager');
                });
                tabsContainer.appendChild(fieldManagerButton);
            } else if (!showFieldManager && fieldManagerTab) {
                // Remove Field Manager tab and switch to opening if it was active
                if (fieldManagerTab.classList.contains('active')) {
                    switchChecklist('opening');
                }
                fieldManagerTab.remove();
            }
        }
        
        // Initialize checklist functionality with universal device support
        function initializeChecklistUI() {
            console.log('Initializing checklist UI...');
            document.querySelectorAll('[data-checklist]').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchChecklist(tab.getAttribute('data-checklist'));
                });
            });
            
            // Universal button handlers - work on all devices
            const checklistButtons = {
                'submitChecklistBtn': submitChecklist
            };
            
            // Universal event listeners with mobile touch support
            Object.entries(checklistButtons).forEach(([btnId, handler]) => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    // Add pointer events for better mobile support
                    btn.style.cursor = 'pointer';
                    
                    // Use pointerup event which works for both mouse and touch
                    btn.addEventListener('pointerup', function(e) {
                        e.stopPropagation();
                        console.log(`${btnId} activated via pointer`);
                        handler();
                    });
                    
                    // Fallback for older browsers
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        console.log(`${btnId} clicked (fallback)`);
                        handler();
                    });
                }
            });
            
            ['checklistStore', 'checklistManager', 'checklistDate'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveChecklistData);
                }
            });
            
            // Update checklist tabs on initialization
            updateChecklistTabs();
        }
        
        // Initialize checklist UI when DOM is ready
        setTimeout(initializeChecklistUI, 1000);
        
        // Ensure submit function is globally accessible for mobile debugging
        window.submitChecklist = submitChecklist;
        
        // Export debug function to window for console access
        window.debugLocationData = debugLocationData;
        
        // Edit User Form Functions
        function toggleEditBrandSelection() {
            const editBrandAccessType = document.getElementById('editBrandAccessType').value;
            const editBrandSelectionGroup = document.getElementById('editBrandSelectionGroup');
            
            if (editBrandAccessType === 'specific') {
                editBrandSelectionGroup.style.display = 'block';
                updateEditLocationCheckboxes();
            } else {
                editBrandSelectionGroup.style.display = 'none';
                // Uncheck all brand checkboxes
                document.querySelectorAll('.edit-brand-checkbox').forEach(cb => cb.checked = false);
                updateEditLocationCheckboxes();
            }
        }
        
        function filterEditBrands() {
            const searchValue = document.getElementById('editBrandSearch').value.toLowerCase();
            const brandOptions = document.querySelectorAll('.edit-brand-option');
            
            brandOptions.forEach(option => {
                const brandText = option.textContent.toLowerCase();
                if (brandText.includes(searchValue)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }
        
        function selectAllEditBrands() {
            const visibleBrands = document.querySelectorAll('.edit-brand-option:not([style*="display: none"]) .edit-brand-checkbox');
            const allChecked = Array.from(visibleBrands).every(cb => cb.checked);
            
            visibleBrands.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            updateEditLocationCheckboxes();
        }
        
        function filterEditLocations() {
            const searchValue = document.getElementById('editLocationSearch').value.toLowerCase();
            const locationLabels = document.querySelectorAll('#editLocationCheckboxContainer label');
            
            locationLabels.forEach(label => {
                const locationText = label.textContent.toLowerCase();
                if (locationText.includes(searchValue)) {
                    label.style.display = 'block';
                } else {
                    label.style.display = 'none';
                }
            });
        }
        
        function selectAllEditLocations() {
            const visibleLocations = document.querySelectorAll('#editLocationCheckboxContainer label:not([style*="display: none"]) .edit-location-checkbox');
            const allChecked = Array.from(visibleLocations).every(cb => cb.checked);
            
            visibleLocations.forEach(cb => {
                cb.checked = !allChecked;
            });
        }
        
        function toggleEditLocationSelection() {
            const editLocationAccessType = document.getElementById('editLocationAccessType').value;
            const editLocationSelectionGroup = document.getElementById('editLocationSelectionGroup');
            
            if (editLocationAccessType === 'specific') {
                editLocationSelectionGroup.style.display = 'block';
                updateEditLocationCheckboxes();
            } else {
                editLocationSelectionGroup.style.display = 'none';
            }
        }
        
        function updateEditLocationCheckboxes() {
            const container = document.getElementById('editLocationCheckboxContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Get selected brands
            let selectedBrands = [];
            const editBrandAccessType = document.getElementById('editBrandAccessType');
            
            if (editBrandAccessType && editBrandAccessType.value === 'all') {
                // Get all unique brands
                selectedBrands = [...new Set(LOCATION_BRAND_MAP.map(item => item.brand))];
            } else {
                // Get checked brands
                selectedBrands = Array.from(document.querySelectorAll('.edit-brand-checkbox:checked'))
                    .map(cb => cb.value);
            }
            
            // Update brand selection count
            const brandCount = document.getElementById('editBrandSelectionCount');
            if (brandCount) {
                if (editBrandAccessType && editBrandAccessType.value === 'all') {
                    brandCount.textContent = 'All brands selected';
                } else {
                    brandCount.textContent = selectedBrands.length > 0 
                        ? `${selectedBrands.length} brand(s) selected` 
                        : 'No brands selected';
                }
            }
            
            // If no brands selected, show message
            if (selectedBrands.length === 0 && !(editBrandAccessType && editBrandAccessType.value === 'all')) {
                container.innerHTML = '<p style="color: #6c757d; margin: 10px 0;">Please select at least one brand first</p>';
                return;
            }
            
            // Group locations by brand
            const locationsByBrand = {};
            LOCATION_BRAND_MAP.forEach(item => {
                if (selectedBrands.includes(item.brand)) {
                    if (!locationsByBrand[item.brand]) {
                        locationsByBrand[item.brand] = [];
                    }
                    locationsByBrand[item.brand].push(item.location);
                }
            });
            
            // Create checkboxes grouped by brand
            let totalLocations = 0;
            Object.keys(locationsByBrand).sort().forEach(brand => {
                if (locationsByBrand[brand].length > 0) {
                    // Add brand header
                    const brandHeader = document.createElement('div');
                    brandHeader.style.cssText = 'font-weight: bold; margin: 10px 0 5px 0; color: #495057;';
                    brandHeader.textContent = brand + ':';
                    container.appendChild(brandHeader);
                    
                    // Add "Select All" for this brand
                    const selectAllLabel = document.createElement('label');
                    selectAllLabel.style.cssText = 'display: block; margin: 3px 0 3px 20px; font-weight: 500; color: #007bff; cursor: pointer;';
                    
                    const selectAllCheckbox = document.createElement('input');
                    selectAllCheckbox.type = 'checkbox';
                    selectAllCheckbox.className = 'edit-brand-select-all';
                    selectAllCheckbox.dataset.brand = brand;
                    selectAllCheckbox.onchange = function() {
                        const brandLocations = container.querySelectorAll(`input.edit-location-checkbox[data-brand="${brand}"]`);
                        brandLocations.forEach(cb => cb.checked = this.checked);
                    };
                    
                    selectAllLabel.appendChild(selectAllCheckbox);
                    selectAllLabel.appendChild(document.createTextNode(' Select All'));
                    container.appendChild(selectAllLabel);
                    
                    locationsByBrand[brand].forEach(location => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display: block; margin: 3px 0 3px 30px;';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = location;
                        checkbox.className = 'edit-location-checkbox';
                        checkbox.dataset.brand = brand;
                        
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(' ' + location));
                        container.appendChild(label);
                        totalLocations++;
                    });
                }
            });
            
            // Show total count
            if (totalLocations === 0) {
                container.innerHTML = '<p style="color: #6c757d; margin: 10px 0;">No locations available for selected brands</p>';
            }
        }
        
        // Toggle brand selection UI
        function toggleBrandSelection() {
            const brandAccessType = document.getElementById('brandAccessType').value;
            const brandSelectionGroup = document.getElementById('brandSelectionGroup');
            
            if (brandAccessType === 'specific') {
                brandSelectionGroup.style.display = 'block';
                updateLocationCheckboxes();
            } else {
                brandSelectionGroup.style.display = 'none';
                // Uncheck all brand checkboxes
                document.querySelectorAll('.brand-checkbox').forEach(cb => cb.checked = false);
                updateLocationCheckboxes();
            }
        }
        
        // Filter brands based on search
        function filterBrands() {
            const searchValue = document.getElementById('brandSearch').value.toLowerCase();
            const brandOptions = document.querySelectorAll('.brand-option');
            
            brandOptions.forEach(option => {
                const brandName = option.textContent.toLowerCase();
                if (brandName.includes(searchValue)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }
        
        // Select all visible brands
        function selectAllBrands() {
            const visibleBrands = document.querySelectorAll('.brand-option:not([style*="display: none"]) .brand-checkbox');
            const allChecked = Array.from(visibleBrands).every(cb => cb.checked);
            
            visibleBrands.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            updateLocationCheckboxes();
        }
        
        // Filter locations based on search
        function filterLocations() {
            const searchValue = document.getElementById('locationSearch').value.toLowerCase();
            const locationLabels = document.querySelectorAll('#locationCheckboxContainer label');
            
            locationLabels.forEach(label => {
                const locationName = label.textContent.toLowerCase();
                if (locationName.includes(searchValue)) {
                    label.style.display = 'block';
                } else {
                    label.style.display = 'none';
                }
            });
        }
        
        // Select all visible locations
        function selectAllLocations() {
            const visibleLocations = document.querySelectorAll('#locationCheckboxContainer label:not([style*="display: none"]) .location-checkbox');
            const allChecked = Array.from(visibleLocations).every(cb => cb.checked);
            
            visibleLocations.forEach(cb => {
                cb.checked = !allChecked;
            });
        }
        
        // Toggle location selection UI
        function toggleLocationSelection() {
            const locationAccessType = document.getElementById('locationAccessType').value;
            const locationSelectionGroup = document.getElementById('locationSelectionGroup');
            
            if (locationAccessType === 'specific') {
                locationSelectionGroup.style.display = 'block';
                updateLocationCheckboxes();
            } else {
                locationSelectionGroup.style.display = 'none';
            }
        }
        
        // Update location checkboxes based on selected brands
        function updateLocationCheckboxes() {
            const container = document.getElementById('locationCheckboxContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Get selected brands
            const brandAccessType = document.getElementById('brandAccessType');
            const locationAccessType = document.getElementById('locationAccessType');
            let selectedBrands = [];
            
            if (brandAccessType && brandAccessType.value === 'all') {
                // Get all unique brands
                selectedBrands = [...new Set(LOCATION_BRAND_MAP.map(item => item.brand))];
            } else {
                // Get checked brands
                selectedBrands = Array.from(document.querySelectorAll('.brand-checkbox:checked'))
                    .map(cb => cb.value);
            }
            
            // Update brand selection count
            const brandCount = document.getElementById('brandSelectionCount');
            if (brandCount) {
                if (brandAccessType && brandAccessType.value === 'all') {
                    brandCount.textContent = 'All brands selected';
                } else {
                    brandCount.textContent = selectedBrands.length > 0 
                        ? `${selectedBrands.length} brand(s) selected` 
                        : '';
                }
            }
            
            // If location access is "all", just show a message
            if (locationAccessType && locationAccessType.value === 'all') {
                container.innerHTML = '<p style="color: #28a745; font-weight: 500;">All locations will be accessible for the selected brands</p>';
                return;
            }
            
            // Get locations for selected brands
            const availableLocations = getLocationsByBrand(selectedBrands);
            
            // Group locations by brand for better display
            const locationsByBrand = {};
            LOCATION_BRAND_MAP.forEach(item => {
                if (selectedBrands.includes(item.brand) || (brandAccessType && brandAccessType.value === 'all')) {
                    if (!locationsByBrand[item.brand]) {
                        locationsByBrand[item.brand] = [];
                    }
                    locationsByBrand[item.brand].push(item.location);
                }
            });
            
            // Create checkboxes grouped by brand
            let totalLocations = 0;
            Object.keys(locationsByBrand).sort().forEach(brand => {
                if (locationsByBrand[brand].length > 0) {
                    const brandHeader = document.createElement('div');
                    brandHeader.style.cssText = 'font-weight: bold; margin-top: 10px; margin-bottom: 5px; color: #495057;';
                    brandHeader.textContent = `${brand} (${locationsByBrand[brand].length} locations)`;
                    container.appendChild(brandHeader);
                    
                    // Add "Select All" for this brand
                    const selectAllLabel = document.createElement('label');
                    selectAllLabel.style.cssText = 'display: block; margin: 3px 0 3px 15px; color: #007bff; cursor: pointer;';
                    
                    const selectAllCheckbox = document.createElement('input');
                    selectAllCheckbox.type = 'checkbox';
                    selectAllCheckbox.className = 'brand-select-all';
                    selectAllCheckbox.dataset.brand = brand;
                    selectAllCheckbox.onchange = function() {
                        const brandLocations = container.querySelectorAll(`input.location-checkbox[data-brand="${brand}"]`);
                        brandLocations.forEach(cb => cb.checked = this.checked);
                    };
                    
                    selectAllLabel.appendChild(selectAllCheckbox);
                    selectAllLabel.appendChild(document.createTextNode(' Select All'));
                    container.appendChild(selectAllLabel);
                    
                    locationsByBrand[brand].forEach(location => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display: block; margin: 3px 0 3px 30px;';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = location;
                        checkbox.className = 'location-checkbox';
                        checkbox.dataset.brand = brand;
                        
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(' ' + location));
                        container.appendChild(label);
                        totalLocations++;
                    });
                }
            });
            
            if (container.children.length === 0) {
                if (selectedBrands.length === 0) {
                    container.innerHTML = '<p style="color: #6c757d; font-style: italic;">Select brands first to see available locations</p>';
                } else {
                    container.innerHTML = '<p style="color: #dc3545;">No locations available for selected brands</p>';
                }
            } else {
                // Add total count at bottom
                const totalDiv = document.createElement('div');
                totalDiv.style.cssText = 'margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; color: #6c757d;';
                totalDiv.textContent = `Total: ${totalLocations} locations available`;
                container.appendChild(totalDiv);
            }
        }
        
        // Make functions available globally
        window.toggleBrandSelection = toggleBrandSelection;
        window.toggleLocationSelection = toggleLocationSelection;
        window.updateLocationCheckboxes = updateLocationCheckboxes;
        window.updateRoleSelectOptions = updateRoleDropdownOptions;
    </script>
    
    <!-- Hidden form for Netlify Forms detection -->
    <form name="checklist-submission" netlify netlify-honeypot="bot-field" hidden>
        <input type="email" name="email">
        <input type="text" name="subject">
        <textarea name="message"></textarea>
        <input type="file" name="pdf-report">
        <input type="text" name="store">
        <input type="text" name="manager">
        <input type="text" name="completion-rate">
    </form>
    
    <!-- Load database operations before other scripts -->
    <script src="database-operations.js"></script>
    
    <script>
        // Load users from database after DB_API is available
        if (typeof DB_API !== 'undefined') {
            // Load users from database on startup
            window.loadAllUsersFromDatabase = async function() {
                try {
                    const dbUsers = await DB_API.users.get();
                    if (dbUsers && Array.isArray(dbUsers)) {
                        dbUsers.forEach(dbUser => {
                            const email = dbUser.email.toLowerCase();
                            if (!GLOBAL_USERS[email]) {
                                USERS[email] = {
                                    id: dbUser.id,
                                    name: dbUser.name,
                                    role: dbUser.role,
                                    password: dbUser.password,
                                    brands: typeof dbUser.brands === 'string' ? JSON.parse(dbUser.brands) : dbUser.brands,
                                    locations: typeof dbUser.locations === 'string' ? JSON.parse(dbUser.locations) : dbUser.locations
                                };
                            }
                        });
                        console.log('Loaded users from database:', Object.keys(USERS).length);
                    }
                } catch (error) {
                    console.error('Error loading users from database:', error);
                }
            }
            
            // Load users on page load
            loadAllUsersFromDatabase();
        }
    </script>

    <!-- Ticket Modal -->
    <div id="ticketModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="border-bottom: 1px solid #ecf0f1; margin-bottom: 20px;">
                <h2 style="margin: 0;">New Ticket</h2>
                <span id="closeModalBtn" class="close" style="font-size: 28px; cursor: pointer;">&times;</span>
            </div>
            
            <!-- Ticket creation form -->
            <form id="ticketForm" style="display: flex; flex-direction: column; gap: 15px;">
                <div class="form-group">
                    <label for="userEmail" style="font-weight: 600; margin-bottom: 5px; display: block;">Your Email Address</label>
                    <input type="email" id="userEmail" class="form-control" placeholder="email@example.com" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div class="form-group">
                    <label for="ticketSubject" style="font-weight: 600; margin-bottom: 5px; display: block;">Ticket Subject</label>
                    <input type="text" id="ticketSubject" class="form-control" placeholder="Brief description of the issue" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div class="form-group">
                    <label for="ticketDepartment" style="font-weight: 600; margin-bottom: 5px; display: block;">Department</label>
                    <select id="ticketDepartment" class="form-control" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Select Department</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Accounting">Accounting</option>
                        <option value="Payroll">Payroll</option>
                        <option value="Human Resources">Human Resources</option>
                        <option value="Purchasing">Purchasing</option>
                        <option value="Operations">Operations</option>
                        <option value="IT">IT</option>
                        <option value="Marketing">Marketing</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ticketDescription" style="font-weight: 600; margin-bottom: 5px; display: block;">Description</label>
                    <textarea id="ticketDescription" rows="4" class="form-control" placeholder="Describe the request..." required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="ticketAttachment" style="font-weight: 600; margin-bottom: 5px; display: block;">Attach a file (optional):</label>
                    <input type="file" id="ticketAttachment" class="form-control" style="width: 100%; padding: 5px;">
                </div>
                
                <button type="submit" id="submitButton" class="btn btn-success" style="padding: 12px 24px; font-size: 16px; margin-top: 10px;">
                    <i class="fas fa-paper-plane"></i> Create Ticket
                </button>
            </form>
            
            <div id="messageArea" style="margin-top: 20px;"></div>
        </div>
    </div>
</body>
</html>
